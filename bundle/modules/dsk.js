var Da=Object.defineProperty;var ss=(o,e,t)=>e in o?Da(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var m=(o,e)=>Da(o,"name",{value:e,configurable:!0});var z=(o,e,t)=>(ss(o,typeof e!="symbol"?e+"":e,t),t);function Ia(){Hooks.on("getImagePopoutHeaderButtons",(o,e)=>{e.unshift({class:"posttochat",icon:"fas fa-comment",onclick:async()=>is(o)})})}m(Ia,"initImagePopoutTochat");async function is(o){let e=o.object,t=await renderTemplate("systems/dsk/templates/chat/imagetochat.html",{image:e});ChatMessage.create(h.chatDataSetup(t))}m(is,"postImage");function Aa(o){let e=o.currentTarget.dataset;h.showArtwork(e,!1)}m(Aa,"showPopout");var A={};A.statusEffects=[{icon:"icons/svg/skull.svg",id:"dead",name:"dsk.CONDITION.defeated",label:"dsk.CONDITION.defeated",description:"dsk.CONDITIONDESCRIPTION.defeated",flags:{dsk:{value:null,editable:!0}}},{id:"inpain",name:"dsk.CONDITION.inpain",icon:"icons/svg/blood.svg",description:"dsk.CONDITIONDESCRIPTION.inpain",changes:[{key:"system.status.inpain",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"encumbered",name:"dsk.CONDITION.encumbered",icon:"icons/svg/anchor.svg",description:"dsk.CONDITIONDESCRIPTION.encumbered",changes:[{key:"system.status.encumbered",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"stunned",name:"dsk.CONDITION.stunned",icon:"icons/svg/daze.svg",description:"dsk.CONDITIONDESCRIPTION.stunned",changes:[{key:"system.status.stunned",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"feared",name:"dsk.CONDITION.feared",icon:"icons/svg/terror.svg",description:"dsk.CONDITIONDESCRIPTION.feared",changes:[{key:"system.status.feared",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"selfconfidence",name:"dsk.CONDITION.selfconfidence",icon:"icons/svg/up.svg",description:"dsk.CONDITIONDESCRIPTION.selfconfidence",changes:[{key:"system.status.selfconfidence",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"prone",name:"dsk.CONDITION.prone",icon:"icons/svg/falling.svg",description:"dsk.CONDITIONDESCRIPTION.prone",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500},{key:"system.meleeStats.attack",mode:2,value:-4},{key:"system.rangeStats.attack",mode:2,value:-4},{key:"system.meleeStats.parry",mode:2,value:-2}],flags:{dsk:{value:null,editable:!0}}},{id:"rooted",name:"dsk.CONDITION.rooted",icon:"icons/svg/net.svg",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500}],description:"dsk.CONDITIONDESCRIPTION.rooted",flags:{dsk:{value:null,editable:!0}}},{id:"unconscious",name:"dsk.CONDITION.unconscious",icon:"icons/svg/unconscious.svg",description:"dsk.CONDITIONDESCRIPTION.unconscious",flags:{dsk:{value:null,editable:!0}}},{id:"blind",name:"dsk.CONDITION.blind",icon:"icons/svg/blind.svg",description:"dsk.CONDITIONDESCRIPTION.blind",changes:[{key:"system.meleeStats.attack",mode:2,value:-8},{key:"system.rangeStats.attack",mode:2,value:-100},{key:"system.meleeStats.parry",mode:2,value:-100}],flags:{dsk:{value:null,editable:!0}}},{id:"constricted",name:"dsk.CONDITION.constricted",icon:"icons/svg/cave.svg",description:"dsk.CONDITIONDESCRIPTION.constricted",flags:{dsk:{value:null,editable:!0}}},{id:"fixated",name:"dsk.CONDITION.fixated",icon:"icons/svg/padlock.svg",description:"dsk.CONDITIONDESCRIPTION.fixated",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500},{key:"system.meleeStats.parry",mode:2,value:-2}],flags:{dsk:{value:null,editable:!0}}},{id:"hallucinating",name:"dsk.CONDITION.hallucinating",icon:"icons/svg/padlock.svg",description:"dsk.CONDITIONDESCRIPTION.hallucinating",flags:{dsk:{value:null,editable:!0}}},{id:"incapacitated",name:"dsk.CONDITION.incapacitated",icon:"icons/svg/sleep.svg",description:"dsk.CONDITIONDESCRIPTION.incapacitated",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500}],flags:{dsk:{value:null,editable:!0}}},{id:"panic",name:"dsk.CONDITION.panic",icon:"icons/svg/terror.svg",description:"dsk.CONDITIONDESCRIPTION.panic",flags:{dsk:{value:null,editable:!0}}},{id:"bloodrush",name:"dsk.CONDITION.rage",icon:"icons/svg/bones.svg",description:"dsk.CONDITIONDESCRIPTION.rage",changes:[{key:"system.meleeStats.attack",mode:2,value:4},{key:"system.meleeStats.parry",mode:2,value:-100},{key:"system.rangeStats.attack",mode:2,value:-100}],flags:{dsk:{value:null,editable:!0}}},{id:"mute",name:"dsk.CONDITION.mute",icon:"icons/svg/silenced.svg",description:"dsk.CONDITIONDESCRIPTION.mute",flags:{dsk:{value:null,editable:!0}}},{id:"deaf",name:"dsk.CONDITION.deaf",icon:"icons/svg/deaf.svg",description:"dsk.CONDITIONDESCRIPTION.deaf",changes:[{key:"system.skillModifiers.step",mode:0,value:"Sinnessch\xE4rfe -4;Perception -4"}],flags:{dsk:{value:null,editable:!0}}},{id:"surprised",name:"dsk.CONDITION.surprised",icon:"icons/svg/hazard.svg",description:"dsk.CONDITIONDESCRIPTION.surprised",changes:[{key:"system.meleeStats.parry",mode:2,value:-100}],flags:{dsk:{value:null,editable:!0}}},{id:"invisible",name:"dsk.CONDITION.invisible",icon:"icons/svg/circle.svg",description:"dsk.CONDITIONDESCRIPTION.invisible",flags:{dsk:{value:null,editable:!0}}},{id:"poisoned",name:"dsk.CONDITION.poisoned",icon:"icons/svg/poison.svg",description:"dsk.CONDITIONDESCRIPTION.poisoned",flags:{dsk:{value:null,editable:!0}}}];A.StFs={A:"A",B:"B",C:"C",D:"D",E:"E"};A.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /ah [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk sinnessch\xE4rfe"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq bet\xF6ren"},{name:"twoD20Check",command:"/ch",example:"/ch"}];A.meleeRangeVision=()=>({"+0":"dsk.meleeVisionDisruption.0","-1":"dsk.meleeVisionDisruption.1","-2":"dsk.meleeVisionDisruption.2","-3":"dsk.meleeVisionDisruption.3","-5000":"dsk.meleeVisionDisruption.4"});A.addvantageRules={};A.removevantageRules={};A.vantagesNeedingAdaption={};A.addAbilityRules={};A.removeAbilityRules={};A.AbilitiesNeedingAdaption={};A.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[5,5,5,5,5,5,5,5,5,5,5,5,5,10,15,20,25,30,35,40,45,50,55,60,65,70],Eig:[20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,40,60,80,100,120,140,160,180,200,220,240]};A.specialAbilityCategories={general:"dsk.SPECIALABILITYCATEGORIES.general",Combat:"dsk.SPECIALABILITYCATEGORIES.combat",ahnen:"dsk.SPECIALABILITYCATEGORIES.ahnen",language:"dsk.SPECIALABILITYCATEGORIES.language"};A.shieldSizes={short:"dsk.SIZE.small",medium:"dsk.SIZE.average",long:"dsk.SIZE.big"};A.combatSkillSubCategories={0:"dsk.COMBATSKILLCATEGORY.0",1:"dsk.COMBATSKILLCATEGORY.1",2:"dsk.COMBATSKILLCATEGORY.2",3:"dsk.COMBATSKILLCATEGORY.3",4:"dsk.COMBATSKILLCATEGORY.4"};A.gearModifyableCalculatedAttributes=["schips","ini","gs","AeP","LeP","sk","zk"];A.rangeWeaponModifiers={short:"dsk.RangeMod.short",medium:"dsk.RangeMod.medium",long:"dsk.RangeMod.long",rangesense:"dsk.RangeMod.rangesense",extreme:"dsk.RangeMod.extreme"};A.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}};A.regnerationCampLocations={0:"dsk.regnerationCampLocations.normal","-1":"dsk.regnerationCampLocations.bad",1:"dsk.regnerationCampLocations.good"};A.regenerationInterruptOptions={0:"dsk.regenerationInterruptOptions.none","-1":"dsk.regenerationInterruptOptions.small","-2":"dsk.regenerationInterruptOptions.big"};A.equipmentCategories=["meleeweapon","rangeweapon","equipment","ammunition","armor","poison"];A.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8};A.aimOptions={0:"dsk.aimOptions.0",2:"dsk.aimOptions.1",4:"dsk.aimOptions.2"};A.rangeVision={0:"dsk.VisionDisruption.step0","-2":"dsk.VisionDisruption.step1","-4":"dsk.VisionDisruption.step2","-6":"dsk.VisionDisruption.step3","-5000":"dsk.VisionDisruption.step4"};A.targetMomevementOptions={0:"dsk.rangeMovementOptions.SLOW","-2":"dsk.rangeMovementOptions.FAST",2:"dsk.rangeMovementOptions.STATIONARY"};A.shooterMovementOptions={0:"dsk.rangeMovementOptions.SHOOTERSTATIONARY","-2":"dsk.rangeMovementOptions.SHOOTERMOVING","-4":"dsk.rangeMovementOptions.SHOOTERRUNNING"};A.mountedRangeOptions={0:"dsk.mountedRangeOptions.STATIONARY","-4":"dsk.mountedRangeOptions.SCHRITT","-8":"dsk.mountedRangeOptions.GALOPP"};A.rangeSizeCategories={tiny:"dsk.RANGESIZE.tiny",small:"dsk.RANGESIZE.small",average:"dsk.RANGESIZE.average",big:"dsk.RANGESIZE.big",giant:"dsk.RANGESIZE.giant"},A.meleeSizeCategories={tiny:"dsk.MELEESIZE.tiny",small:"dsk.MELEESIZE.small",average:"dsk.MELEESIZE.average",big:"dsk.MELEESIZE.big",giant:"dsk.MELEESIZE.giant"};A.narrowSpaceModifiers={weaponshort:{attack:2,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:0,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-2,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:0,parry:2,label:"dsk.NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:0,parry:0,label:"dsk.NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-2,parry:-2,label:"dsk.NarrowSpaceModifiers.shield.long"}};A.meleeSizeModifier={tiny:-4,small:0,average:0,big:0,giant:0};A.sizeCategories={tiny:"dsk.SIZE.tiny",small:"dsk.SIZE.small",average:"dsk.SIZE.average",big:"dsk.SIZE.big",giant:"dsk.SIZE.giant"};A.equipmentTypes={misc:"dsk.Equipment.misc",clothes:"dsk.Equipment.clothes",tools:"dsk.Equipment.tools",light:"dsk.Equipment.light",healing:"dsk.Equipment.healing",bags:"dsk.Equipment.bags",wealth:"dsk.Equipment.wealth",writing:"dsk.Equipment.writing",alchemy:"dsk.Equipment.alchemy",service:"dsk.Equipment.service",luxus:"dsk.Equipment.luxus",blessed:"dsk.Equipment.blessed",food:"dsk.Equipment.food",animals:"dsk.Equipment.animals"};A.systemTables=[{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}},{name:"Ahnen",attrs:"",roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}}];A.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4};A.effectTextStyle=CONFIG.canvasTextStyle.clone();A.effectTextStyle.fontSize="30";A.effectTextStyle.fontFamily="GentiumBasic";A.ammunitiongroups={"-":"-",arrow:"dsk.ammunition.arrow",bolt:"dsk.ammunition.bolt",bullet:"dsk.ammunition.bullet",stone:"dsk.ammunition.stone",dart:"dsk.ammunition.dart",mag:"dsk.ammunition.mag",infinite:"dsk.ammunition.infinite"};A.traitCategories={meleeAttack:"dsk.closeCombatAttacks",rangeAttack:"dsk.rangeCombatAttacks",armor:"TYPES.Item.armor",force:"dsk.force",specialty:"dsk.specialty"};A.meleeRanges={short:"dsk.Range.short",medium:"dsk.Range.medium",long:"dsk.Range.long"};A.magicResistanceModifiers={"-":"-",sk:"dsk.soulpower",zk:"dsk.toughness"};A.weapontypes={melee:"TYPES.Item.meleeweapon",range:"TYPES.Item.rangeweapon"};A.characteristics={mu:"dsk.characteristics.mu.name",kl:"dsk.characteristics.kl.name",in:"dsk.characteristics.in.name",ch:"dsk.characteristics.ch.name",ff:"dsk.characteristics.ff.name",ge:"dsk.characteristics.ge.name",ko:"dsk.characteristics.ko.name",kk:"dsk.characteristics.kk.name"};A.skillBurdens={yes:"dsk.yes",no:"dsk.no",maybe:"dsk.maybe"};A.skillDifficultyLabels={eeasy:"dsk.Skill-eeasy",veasy:"dsk.Skill-veasy",easy:"dsk.Skill-easy",challenging:"dsk.Skill-challenging",difficult:"dsk.Skill-difficult",hard:"dsk.Skill-hard",vhard:"dsk.Skill-vhard"};A.skillDifficultyModifiers={eeasy:16,veasy:8,easy:4,challenging:0,difficult:-4,hard:-8,vhard:-16};A.skillGroups={body:"dsk.SKILL.body",social:"dsk.SKILL.social",knowledge:"dsk.SKILL.knowledge",trade:"dsk.SKILL.trade"};CONFIG.time.roundTime=2;CONFIG.time.turnTime=0;var w=A;async function rs(){if(!game.settings.get("dsk","defaultConfigFinished")){console.log("Configuring default token settings");let o=game.settings.get("core","defaultToken");o.displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,o.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,o.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,o.bar1={attribute:"status.wounds"},await game.settings.set("core","defaultToken",o),await game.settings.set("core","leftClickRelease",!0),await game.settings.set("dsk","defaultConfigFinished",!0)}}m(rs,"setupDefaulTokenConfig");async function ns(o,e){await Ze(),await game.settings.set("dsk","migrationVersion",e)}m(ns,"migrateDSK");async function Ze(){let e=await(await fetch("systems/dsk/lazy/updatenotes.json")).json();new nt(e).render(!0)}m(Ze,"showPatchViewer");function wa(){Hooks.once("ready",async function(){if(!game.user.isGM)return;await rs();let o=await game.settings.get("dsk","migrationVersion"),e=26;o<e&&ns(o,e)})}m(wa,"migrateWorld");var nt=class extends Application{constructor(e,t){super(t),this.json=e}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],mergeObject(e,{classes:e.classes.concat(["dsk","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),e.template="systems/dsk/templates/system/patchviewer.html",e.resizable=!0,e}async getData(){let e=this.json.notes[this.json.notes.length-1],t=this.json.default.replace(/VERSION/g,e.version),a=`<h1>CHANGELOG</h1><p>${t}. </br><b>Important updates</b>: ${e.text}</p><p>For details or proposals visit our github page at <a href="https://github.com/Plushtoast/dsk-foundryVT" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>`;await ChatMessage.create(h.chatDataSetup(a,"roll"));let s=game.i18n.lang,i=await renderTemplate(`systems/dsk/lazy/patchhtml/changelog_${s}_${e.version}.html`),r=await renderTemplate(`systems/dsk/lazy/patchhtml/news_${s}_${e.version}.html`),n=[this.json.notes[this.json.notes.length-2]].filter(p=>p!=null),l=n.length>0,c=l?await Promise.all(n.map(async p=>await renderTemplate(`systems/dsk/lazy/patchhtml/changelog_${s}_${p.version}.html`))):[],u=l?await Promise.all(n.map(async p=>await renderTemplate(`systems/dsk/lazy/patchhtml/news_${s}_${p.version}.html`))):[],d=await renderTemplate(`systems/dsk/lazy/patchhtml/modules_${s}.html`);return{patchName:t,changelog:i,news:r,prevVersions:n,prevChangeLogs:c,prevNews:u,modules:d}}};m(nt,"PatchViewer");var va=class{static simpleAdoption(e,t,a,s){if(s[a].activeEffect){let i=duplicate(s[a].activeEffect);i.value=`${t.name} ${i.value}`;let r={changes:[i],duration:{},icon:"icons/svg/aura.svg",label:`${a} (${t.name})`,transfer:!0,flags:{dsk:{value:null,editable:!0,description:`${a} (${t.name})`,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}},tint:""};e.effects.push(r)}}static reverseAdoptionCalculation(e,t,a){let s=[w.vantagesNeedingAdaption,w.AbilitiesNeedingAdaption];for(let i of s)if(i[t.name]){let r=e.items.find(n=>i[t.name].items.includes(n.type)&&n.name==t.special);r&&(a.system.ap=a.system.ap.split("/")[r.system.StF.charCodeAt(0)-65],va.simpleAdoption(a,r,t.name,i));break}return a}static hasItem(e,t,a){return e.items.find(s=>a.includes(s.type)&&s.name==t)!=null}static itemStep(e,t,a){let s=e.items.find(i=>a.includes(i.type)&&i.name==t);return s?Number(s.system.level):0}static itemAsModifier(e,t,a,s,i=!1,r=!1){let n=[],l=i?new RegExp(`^${h.escapeRegex(`${t} (`)}`):new RegExp(`^${h.escapeRegex(t)}$`),c=e.items.find(u=>s.includes(u.type)&&l.test(u.name));return c&&n.push({name:c.name,value:Number(c.system.level)*a,selected:r,source:c.name}),n}},B=va;m(B,"ItemRulesDSK"),z(B,"children",{});var x=class extends B{static setupFunctions(){}static async abilityAdded(e,t){w.addAbilityRules[t.name]&&w.addAbilityRules[t.name](e,t)}static async abilityRemoved(e,t){w.removeAbilityRules[t.name]&&w.removeAbilityRules[t.name](e,t);let a=t.system.ap*t.system.level;if(/;/.test(t.system.ap)){let s=t.system.ap.split(";").map(i=>Number(i.trim()));a=0;for(let i=0;i<t.system.level;i++)a+=s[i]}await e._updateAPs(-1*a)}static async _specialabilityReturnFunction(e,t,a,s){if(t==null)return;if(t=duplicate(t),s!=null){if(/,/.test(t.system.ap)){let r=`${t.name.replace(" ()","")} (${s.name}`;t.system.ap=t.system.ap.split(",")[e.items.filter(n=>n.type==t.type&&n.name.includes(r)).length].trim()}x.simpleAdoption(t,s,t.name,w.AbilitiesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${s.name}${s.customEntry?", "+s.customEntry:""})`,s.data&&s.system.StF&&/\//.test(t.system.ap)&&(t.system.ap=t.system.ap.split("/")[s.system.StF.charCodeAt(0)-65].trim())}let i=e.items.find(r=>r.type==a&&r.name==t.name);if(i){let r=duplicate(i),n=/;/.test(r.system.ap)?r.system.ap.split(";").map(l=>Number(l.trim()))[r.system.level]:r.system.ap;r.system.level+1<=r.system.max&&await e.checkEnoughXP(n)&&(r.system.level+=1,await e._updateAPs(n,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[r]),await x.abilityAdded(e,r))}else{let r=t.system.ap.split(";").map(n=>n.trim())[0];await e.checkEnoughXP(r)&&(await x.abilityAdded(e,t),await e._updateAPs(r,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}}static async needsAdoption(e,t,a){let s=w.AbilitiesNeedingAdaption[t.name];if(s){let i,r;if(s.items=="text")i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-string-dialog.html",{original:t}),r=m(function(n){let l={name:n.find('[name="entryselection"]').val()};x._specialabilityReturnFunction(e,t,a,l)},"callback");else if(s.items=="array"){let n=s.elems.map(l=>({name:l}));i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:s.area}),r=m(function(l){let c=n.find(u=>u.name==l.find('[name="entryselection"]').val());x._specialabilityReturnFunction(e,t,a,c)},"callback")}else{let n=e.items.filter(l=>s.items.includes(l.type)).sort((l,c)=>l.name.localeCompare(c.name));i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:s.area}),r=m(function(l){let c=n.find(u=>u.name==l.find('[name="entryselection"]').val());c.customEntry=l.find('[name="custom"]').val(),x._specialabilityReturnFunction(e,t,a,c)},"callback")}await new Dialog({title:game.i18n.localize("dsk.DIALOG.ItemRequiresAdoption"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:r},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}else x._specialabilityReturnFunction(e,t,a,null)}static hasAbility(e,t){return super.hasItem(e,t,["specialability"])}static abilityStep(e,t){return super.itemStep(e,t,["specialability"])}static abilityAsModifier(e,t,a=1,s=!1){return super.itemAsModifier(e,t,a,["specialability"],s)}};m(x,"SpecialabilityRulesDSK");B.children.SpecialabilityRulesDSK=x;var _=class{static _getFunctionData(e){return{data:e.currentTarget.dataset,actor:h.getSpeaker({token:e.currentTarget.dataset.token,actor:e.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}static multipleDefenseValue(e,t){let a=-2;return getProperty(t,"system.combatskill")==game.i18n.localize("dsk.LocalizedIDs.wrestle")&&x.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.masterfulDodge"))?a=-2:x.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.mightyMasterfulParry"))?a=-1:x.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.masterfulParry"))&&(a=-2),Math.min(0,a)}static isYieldedTwohanded(e){let t=this.regex2h.test(e.name),a=e.system.worn.wrongGrip;return t&&!a||!t&&a}static obfuscateDropData(e,t){if(t)for(let a of t)mergeObject(e,{system:{obfuscation:{[a]:!0}}})}static _buildDuration(e){let t={duration:{startTime:game.time.worldTime,rounds:e,seconds:e*5}};return game.combat&&mergeObject(t,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),t}static increment(e,t,a,s=void 0){let i=e.ctrlKey?10:1,r=e.button==2?-1:1,n=getProperty(t,a)+i*r;s!=null&&(n=Math.max(s,n)),setProperty(t,a,n)}};m(_,"RuleChaos"),z(_,"regex2h",/\(2H/);var F=class{static chatListeners(e){e.on("click",".openJournalBrowser",()=>game.dsk.apps.journalBrowser.render(!0));let t=$('<a class="button showHelp" data-tooltip="dsk.HELP.showHelp"><i class="fas fa-question"></i></a>');t.click(()=>{F.getHelp()}),$(e.find(".control-buttons")).prepend(t),e.on("click",".showPatchViewer",()=>Ze()),e.on("click",".functionswitch",a=>_[a.currentTarget.dataset.function](a)),e.on("click",".panToToken",a=>F.panToToken(a)),e.on("click",".popoutImage",a=>Aa(a))}static async panToToken(e){let t=await fromUuid(e.currentTarget.dataset.uuid);!t||(canvas.animatePan({x:t.x,y:t.y}),t.isOwner&&t.object.control({releaseOthers:!0}))}static postStatus(e){let t=CONFIG.statusEffects.find(s=>s.id==e),a=`<h2><a class="chat-condition chatButton" data-id="${e}"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="${t.icon}"/>${game.i18n.localize(t.name)}</h2></a><p>${game.i18n.localize(t.description)}</p>`;ChatMessage.create(h.chatDataSetup(a,"roll"))}static getHelp(){let e=w.helpContent.map(t=>`<h2>${game.i18n.localize(`dsk.HELP.${t.name}`)}</h2>
            <p><b>${game.i18n.localize("dsk.HELP.command")}</b>: ${t.command}</p>
            <p><b>${game.i18n.localize("dsk.HELP.example")}</b>: ${t.example}</p>
            <p><b>${game.i18n.localize("dsk.description")}</b>: ${game.i18n.localize(`dsk.HELP.descr${t.name}`)}`).join("")+`<br>
            <p>${game.i18n.localize("dsk.HELP.default")}</p>`;ChatMessage.create(h.chatDataSetup(e,"roll"))}static showConditions(){let t=duplicate(CONFIG.statusEffects).map(a=>(a.name=game.i18n.localize(a.name),a)).sort((a,s)=>a.name.localeCompare(s.name)).map(a=>`<a class="chat-condition chatButton" data-id="${a.id}"><img src="${a.icon}"/>${a.name}</a>`).join(" ");ChatMessage.create(h.chatDataSetup(t,"roll"))}static async check3D20(e,t,a={}){let s=12;e?(e=e.get(0),t=await h.skillByName(e.textContent),e.dataset.attrs&&(s=e.dataset.attrs.split("|"))):t&&(t=await h.skillByName(t)),t&&(t=t.toObject()),t||(t={name:"2d20",type:"skill",system:{level:0,characteristic1:"mu",characteristic2:"kl",encumbers:"no"}});let i=await h.emptyActor(s);i.setupSkill(t,a,"emptyActor").then(r=>{i.basicTest(r)})}static async showTables(){let e=await renderTemplate("systems/dsk/templates/tables/systemtables.html",{tables:w.systemTables});ChatMessage.create(h.chatDataSetup(e,"roll"))}};m(F,"DSKChatListeners");var O=class{static bindButtons(e){e.find(".chat-condition").each(function(t,a){a.setAttribute("draggable",!0),a.addEventListener("dragstart",s=>{let i={data:{type:"condition",payload:{id:$(s.currentTarget).attr("data-id")}}};s.dataTransfer.setData("text/plain",JSON.stringify(i))})}),e.on("click",".chat-condition",t=>F.postStatus($(t.currentTarget).attr("data-id")))}static createCustomEffect(e,t="",a){a=a||game.i18n.localize("dsk.CONDITION.custom"),t==""&&(t=a),e.addCondition({label:a,icon:"icons/svg/aura.svg",origin:e.uuid,flags:{dsk:{value:null,editable:!0,description:t,custom:!0}}})}static async addCondition(e,t,a=1,s=!1,i=!0){if(!e.isOwner)return"Not owned";if(e.compendium)return"Can not add in compendium";if(s&&a<1)return this.removeCondition(e,t,a,i,s);if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(n=>n.id==t))),!t)return"No Effect Found";let r=this.hasCondition(e,t.id);return r&&r.flags.dsk.value==null?r:r?await O.updateEffect(e,r,a,s,i,t):await O.createEffect(e,t,a,i)}static async createEffect(e,t,a,s){let i=this.immuneToEffect(e,t);if(i)return i;t.name=game.i18n.localize(t.name),s?(t.flags.dsk.auto=Math.min(t.flags.dsk.max,a),t.flags.dsk.manual=0):(t.flags.dsk.manual=Math.min(t.flags.dsk.max,a),t.flags.dsk.auto=0),t.flags.dsk.value=Math.min(4,t.flags.dsk.manual+t.flags.dsk.auto),t.id&&(t.statuses=[t.id]),t.id=="dead"&&(t["flags.core.overlay"]=!0);let r=await e.createEmbeddedDocuments("ActiveEffect",[duplicate(t)]);return delete t.id,r}static async removeCondition(e,t,a=1,s=!0,i=!1){if(!e.isOwner)return"Not owned";if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(n=>n.id==t))),!t)return"No Effect Found";let r=this.hasCondition(e,t.id);if(r&&r.flags.dsk.value==null)return e.token&&(e=e.token.actor),await e.deleteEmbeddedDocuments("ActiveEffect",[r.id]);if(r)return await O.removeEffect(e,r,a,i,s)}static async removeEffect(e,t,a,s,i){let r=i?s?a:Math.max(0,t.flags.dsk.auto-a):t.flags.dsk.auto,n=i?t.flags.dsk.manual:s?a:t.flags.dsk.manual-a,l={flags:{dsk:{auto:r,manual:n,value:Math.max(0,Math.min(t.flags.dsk.max,n+r))}}};return l.flags.dsk.auto<1&&l.flags.dsk.manual==0?await e.deleteEmbeddedDocuments("ActiveEffect",[t.id]):await t.update(l)}static async updateEffect(e,t,a,s,i,r=void 0){let n=this.immuneToEffect(e,t,!0);if(n)return n;let l,c,u;return i?(c=Math.min(t.flags.dsk.max,s?a:t.flags.dsk.auto+a),l=c-t.flags.dsk.auto,u={flags:{dsk:{auto:c,manual:t.flags.dsk.manual}}}):(c=s?a:t.flags.dsk.manual+a,l=c-t.flags.dsk.manual,u={flags:{dsk:{manual:c,auto:t.flags.dsk.auto}}}),l==0||(u.flags.dsk.value=Math.max(0,Math.min(t.flags.dsk.max,u.flags.dsk.manual+u.flags.dsk.auto)),r.duration&&(u.duration=r.duration,u.duration.startTime=game.time.worldTime),await t.update(u)),t}static immuneToEffect(e,t,a=!0){if((getProperty(e,"system.immunities")||[]).includes(t.id)){let i=game.i18n.format("dsk.DSKError.immuneTo",{name:e.name,condition:game.i18n.localize(`dsk.CONDITION.${t.id}`)});return ui.notifications&&!a&&ui.notifications.warn(i),i}return!1}static resistantToEffect(e,t){let a=[...t.statuses][0];return a?(getProperty(e,"system.resistances.effects")||[]).reduce((i,r)=>(r.target==a&&(i+=Number(r.value)),i),0):0}static hasCondition(e,t){return e!=null&&t&&e.effects?e.effects.find(a=>a.statuses.has(t)):!1}static prepareActiveEffects(e,t){let a=duplicate(CONFIG.statusEffects),s=[];t.conditions=[],t.transferedConditions=[];let i;e.documentName=="Item"?i=e.effects:(i=Array.from(e.allApplicableEffects()),game.user.isGM||(i=i.filter(n=>!n.getFlag("dsk","hidePlayers"))));for(let n of i){let l=n.toObject();l.boolean=n.getFlag("dsk","value")==null;let c=[...n.statuses][0];c&&(l.value=n.getFlag("dsk","value"),l.editable=n.getFlag("dsk","editable"),l.descriptor=c,l.manual=n.getFlag("dsk","manual"),s.push(c)),e.documentName=="Item"||n.parent?.documentName!="Item"&&!n.notApplicable?t.conditions.push(l):n.notApplicable||(l.uuid=n.uuid,t.transferedConditions.push(l))}t.manualConditions=a.filter(n=>!s.includes(n.id));let r=[];for(let n of Object.keys(e.system?.status||{}))if(e.system.status[n]){let l=w.statusEffects.find(c=>c.id==n);r.push({icon:l.icon,id:n,name:game.i18n.localize(l.name),value:e.system.status[n]})}t.cumulativeConditions=r}static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:-1*(t.system.status[e]||0)}static ModifierIsSelected(e,t={},a){return t.mode!="damage"}static getRollModifiers(e,t,a={}){let s=game.i18n.localize("dsk.status")+"/"+game.i18n.localize("dsk.condition"),i=[];for(let r of Object.keys(e.system.status))if(e.system.status[r]){let n=game.dsk.config.statusEffectClasses[r]||O;i.push({name:game.i18n.localize(`dsk.CONDITION.${r}`),value:n.calculateRollModifier(r,e,t,a),selected:n.ModifierIsSelected(t,a,e),source:s})}return i}};m(O,"DSKStatusEffects");var ot=class extends O{static ModifierIsSelected(e,t={},a){let s=e.type=="skill"&&e.system.encumbers=="yes",i=!["skill","ahnengabe","rangeweapon"].includes(e.type)&&t.mode!="damage";return s||i}static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"||a.type=="skill"&&a.system.encumbers=="no"?0:super.calculateRollModifier(e,t,a,s)}};m(ot,"EncumberedEffect");var lt=class extends O{static ModifierIsSelected(e,t={},a){return a.effects.find(s=>Array.from(s.statuses).includes("bloodrush"))==null}};m(lt,"PainEffect");var ct=class extends O{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:t.system.status.selfconfidence||0}};m(ct,"SelfconfidenceEffect");w.statusEffectClasses={encumbered:ot,inpain:lt,selfconfidence:ct};var E=class extends B{static setupFunctions(){}static async vantageAdded(e,t){game.dsk.config.addvantageRules[t.name]&&game.dsk.config.addvantageRules[t.name](e,t)}static async vantageRemoved(e,t){game.dsk.config.removevantageRules[t.name]&&game.dsk.config.removevantageRules[t.name](e,t)}static async _vantageReturnFunction(e,t,a,s){if(t==null)return;if(t=duplicate(t),/,/.test(t.system.ap)){let r=t.name.replace(" ()","");t.system.ap=t.system.ap.split(",")[e.items.filter(n=>n.type==t.type&&n.name.includes(r)).length].trim()}s!=null&&(E.simpleAdoption(t,s,t.name,w.vantagesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${s.name})`,s.data&&(t.system.ap=t.system.ap.split("/")[s.system.StF.charCodeAt(0)-65].trim()));let i=e.items.find(r=>r.type==a&&r.name==t.name);if(i){let r=duplicate(i),n=/;/.test(r.system.ap)?r.system.ap.split(";").map(l=>Number(l.trim()))[r.system.level]:r.system.ap;r.system.level+1<=r.system.max&&await e.checkEnoughXP(n)&&(r.system.level+=1,await e._updateAPs(n,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[r]),await E.vantageAdded(e,r))}else await e.checkEnoughXP(t.system.ap.split(";").map(r=>r.trim())[0])&&(await E.vantageAdded(e,t),await e._updateAPs(t.system.ap.split(";").map(r=>r.trim())[0],{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}static async needsAdoption(e,t,a){if(w.vantagesNeedingAdaption[t.name]){let s,i;if(w.vantagesNeedingAdaption[t.name].items=="text")s=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-string-dialog.html",{original:t}),i=m(function(r){let n={name:r.find('[name="entryselection"]').val()};E._vantageReturnFunction(e,t,a,n)},"callback");else{let r=e.items.filter(n=>w.vantagesNeedingAdaption[t.name].items.includes(n.type));s=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:r,original:t}),i=m(function(n){let l=r.find(c=>c.name==n.find('[name="entryselection"]').val());E._vantageReturnFunction(e,t,a,l)},"callback")}await new Dialog({title:game.i18n.localize("dsk.DIALOG.ItemRequiresAdoption"),content:s,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:i},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}else E._vantageReturnFunction(e,t,a,null)}static hasVantage(e,t){return super.hasItem(e,t,["advantage","disadvantage"])}static vantageStep(e,t){return super.itemStep(e,t,["advantage","disadvantage"])}static getVantageAsModifier(e,t,a=1,s=!1,i=!1){return super.itemAsModifier(e,t,a,["advantage","disadvantage"],s,i)}};m(E,"AdvantageRulesDSK");B.children.AdvantageRulesDSK=E;var U=class{static rangeFinder(e,t){let a=canvas.scene.grid.size,i=new Ray(e,t).distance/a,r=i*canvas.scene.grid.distance,n=Math.abs((getProperty(e,"system.elevation")||0)-(getProperty(t,"system.elevation")||0)),l=Math.hypot(r,n);return{elevation:n,distance:r,distanceSum:l,tileDistance:i,unit:canvas.scene.grid.units}}static inDistance(e){for(let t of canvas.scene.tokens)if(t.isOwner&&this.rangeFinder(e,t.object).tileDistance<=2)return!0;return!1}static distanceModifier(e,t,a){if(!game.settings.get("dsk","enableDPS")||!e)return 1;let s={};for(let i of game.user.targets){let r=U.rangeFinder(e,i);(s.distanceSum||0)<r.distanceSum&&(s=r)}if(s.unit==game.i18n.localize("dsk.gridUnits")){let i=Number(getProperty(a,"system.rangeMultiplier"))||1,r=t.system.rw.split("/").map(l=>Number(l)*i),n=0;for(;n<2&&r[n]<s.distanceSum;)n++;return n}else return 1}static initDoorMinDistance(){let e=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(t){return!game.user.isGM&&game.settings.get("dsk","enableDPS")&&!U.inDistance(this)?ui.notifications.warn(game.i18n.localize("dsk.DSKError.notInRangeToLoot")):e.apply(this,arguments)}}};m(U,"DPS");var ve=class extends Dialog{static async getDialog(e){let t=Array.from(game.user.targets).map(i=>i.id),a=[],s=canvas.scene?canvas.scene.tokens.get(e.token)?.object:void 0;return game.combat&&game.combat.combatants.forEach(i=>{if(!!i.visible){if(i.isSelected=t.includes(i.token.id),s&&i.token){let r=canvas.scene.tokens.get(i.token.id).object;i.distance=U.rangeFinder(s,r),i.distance.distanceSum=Number(i.distance.distanceSum.toFixed(1))}a.push(i)}}),new ve({title:game.i18n.localize("dsk.DIALOG.addTarget"),content:await renderTemplate("systems/dsk/templates/dialog/addTarget-dialog.html",{selectables:a}),default:"yes",buttons:{}})}activateListeners(e){super.activateListeners(e);let t=e.find(".combatant");t.click(a=>this.setTargets(a)),t.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),t.mousedown(a=>this._onRightClick(a))}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);if(t.token)return canvas.animatePan({x:t.token.x,y:t.token.y})}}_getCombatApp(){return game.combats.apps[0]}async setTargets(e){let t=e.originalEvent.shiftKey;t||$(e.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(e.currentTarget).addClass("selectedTarget");let a=e.currentTarget.dataset.combatantId;game.combat.combatants.get(a).token.object.setTarget(!0,{user:game.user,releaseOthers:!t,groupSelection:!0})}};m(ve,"AddTargetDialog");var Ie=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk5Decent"])}),e}static async getDialog(){let e=game.users.filter(t=>t.active&&!t.isGM);return new Ie({title:game.i18n.localize("dsk.DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsk/templates/dialog/selectForUserDialog.html",{users:e}),default:"yes",buttons:{}})}static registerButtons(){Hooks.on("getSceneControlButtons",e=>{if(!game.user.isGM)return;let t={name:"targetUser",title:game.i18n.localize("dsk.CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:async()=>{(await Ie.getDialog()).render(!0)}};e[0].tools.splice(2,0,t)})}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){let t=Array.from(game.user.targets).map(i=>i.id),a=e.currentTarget.dataset.userId;game.users.get(a).updateTokenTargets(t),game.socket.emit("userActivity",a,{targets:t}),this.close()}};m(Ie,"SelectUserDialog");var Te=class extends Dialog{static async getDialog(e){let t=game.users.filter(a=>a.active&&!a.isGM);new Te({title:game.i18n.localize("dsk.SHEET.PostItem"),content:await renderTemplate("systems/dsk/templates/dialog/usermultipickdialog.html",{users:t}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:a=>{this.postContent(a,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}static async postContent(e,t){let a=h.chatDataSetup(t);if(!e.find("#sel_all").is(":checked")){let s=[];e.find(".usersel:checked").each(function(){s.push($(this).val())}),a.whisper=s}ChatMessage.create(a)}activateListeners(e){super.activateListeners(e),e.find('[name="sel_all"]').change(t=>{e.find(".usersel").prop("disabled",t.currentTarget.checked).prop("checked",t.currentTarget.checked)})}};m(Te,"UserMultipickDialog");var Ta=class extends Dialog{recallSettings(e,t,a){return this.recallData=game.dsk.memory.recall(e,t,a),this.dialogData={mode:a,speaker:e,source:t},this}async _render(e,t){await super._render(e,t),this.prepareFormRecall($(this._element))}setRollButtonWarning(){return this.dialogData.mode=="attack"?`<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("dsk.DIALOG.noTarget")}</span>`:""}setMultipleTargetsWarning(){return this.dialogData.mode=="attack"?`<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("dsk.DIALOG.multipleTarget")}</span>`:""}renderRollValueDie(){if(this.dialogData.rollValue&&this.dialogData.mode!="damage"){let e=this.dialogData.mode=="attack"?"die-mu":"die-in",t=this.dialogData.modifier||0;return`<span class="rollValue ${e} d20">${this.dialogData.rollValue+t}</span>`}else return""}async updateRollButton(e){let t=this.renderRollValueDie()+game.i18n.localize("dsk.Roll");e.length>0?e.length>1&&(t+=this.setMultipleTargetsWarning()):t+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(t)}async updateTargets(e,t){let a=await renderTemplate("systems/dsk/templates/dialog/parts/targets.html",{targets:t});e.find(".targets").html(a),this.updateRollButton(t)}removeTarget(e){let t=e.currentTarget.dataset.id;$(e.currentTarget).remove();let a=[];game.user.targets.forEach(s=>{t!=s.id&&a.push(s.id)}),game.user.updateTokenTargets(a)}readTargets(){let e=[];return game.user.targets.forEach(t=>{t.actor&&e.push({name:t.actor.name,img:t.actor.img,id:t.id})}),e}compareTargets(e,t){let a=this.readTargets();return JSON.stringify(t)!=JSON.stringify(a)&&(t=a,this.updateTargets(e,t)),t}activateListeners(e){super.activateListeners(e),e.find(".quantity-click").mousedown(t=>{let a=t.currentTarget.dataset.quantityfocus,s=$(t.currentTarget);if(a&&!s.is(":focus")){setTimeout(function(){s.select()});return}let i={val:Number(s.val())};_.increment(t,i,"val"),s.val(i.val)}),e.find(".modifiers option").mousedown(t=>(t.preventDefault(),$(t.currentTarget).prop("selected",!$(t.currentTarget).prop("selected")),!1)),e.on("click",".rollTarget",t=>this.removeTarget(t)),e.on("click",".addTarget",t=>this.addTarget(t))}async addTarget(e){(await ve.getDialog(this.dialogData.speaker)).render(!0)}prepareFormRecall(e){if(this.recallData)for(let t in this.recallData)if(t=="specAbs")for(let a of this.recallData[t]){let s=e.find(`.specAbs[data-id="${a.id}"]`);s.addClass("active").attr("data-step",a.step),s.find(".step").text(Ta.roman[a.step])}else{let a=e.find(`[name="${t}"]`);if(Array.isArray(this.recallData[t])){let s=a.find("option");for(let i of s){let r=this.recallData[t].find(n=>n.name==$(i).text().trim());r&&(i.selected=r.selected)}}else a.attr("type")=="checkbox"?a[0].checked=this.recallData[t]:a.val(this.recallData[t])}}},V=Ta;m(V,"DialogShared"),z(V,"roman",[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"]);var Z=class extends V{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}activateListeners(e){super.activateListeners(e);let t=e.find(".specAbs");t.mouseenter(i=>{if(i.currentTarget.getElementsByClassName("hovermenu").length==0){let r=document.createElement("div");r.classList.add("hovermenu");let n=document.createElement("i");n.classList.add("fas","fa-comment"),n.title=game.i18n.localize("dsk.SHEET.PostItem"),n.addEventListener("mousedown",this._postItem,!1),r.appendChild(n),i.currentTarget.appendChild(r)}}),t.mouseleave(i=>{let r=i.toElement||i.relatedTarget;r.parentNode==this||r==this||i.currentTarget.querySelectorAll(".hovermenu").forEach(n=>n.remove())}),e.on("mousedown",".specAbs",i=>{if(e.find(".opportunityAttack").is(":checked")){ui.notifications.error(game.i18n.localize("dsk.DSKError.opposedAttackNoSpecAbs"));return}let r=$(i.currentTarget),n=Number(r.attr("data-step")),l=Number(r.attr("data-maxStep")),c=Number(r.attr("data-category"));if(i.button==0){if(n=Math.min(l,n+1),[0,1].includes(c)&&game.settings.get("dsk","limitCombatSpecAbs")){let u=r.siblings(`[data-category="${c}"]`);u.removeClass("active").attr("data-step",0),u.find(".step").text(V.roman[0])}}else i.button==2&&(n=Math.clamped(l,0,n-1));r.attr("data-step",n),n>0?r.addClass("active"):r.removeClass("active"),r.find(".step").text(V.roman[n]),this.calculateModifier()}),e.find(".opportunityAttack").change(i=>{if($(i.currentTarget).is(":checked"))for(let r of e.find(".specAbs"))$(r).removeClass("active").attr("data-step",0).find(".step").text("")}),e.on("change","input,select",i=>this.calculateModifier(i)),e.find(".modifiers option").mousedown(i=>{this.calculateModifier(i)}),e.find(".quantity-click").mousedown(i=>this.calculateModifier(i));let a=this.readTargets();this.calculateModifier();let s=this;this.checkTargets=setInterval(function(){a=s.compareTargets(e,a)},500)}async close(e={}){return clearInterval(this.checkTargets),await super.close(e)}_postItem(e){e.stopPropagation();let t=$(e.currentTarget).closest(".specAbs"),a=t.attr("data-actor"),s=t.attr("data-id");return game.actors.get(a).items.get(s).postItem(),!1}recallSettings(e,t,a){return super.recallSettings(e,t,a),this.prepareWeapon(),this}prepareWeapon(){let e,t=this.dialogData.source,a=h.getSpeaker(this.dialogData.speaker);if(a)if(["meleeweapon","rangeweapon"].includes(t.type)){let s=t.system.combatskill,i=D._calculateCombatSkillValues(a.items.find(r=>r.type=="combatskill"&&r.name==s).toObject(),a.system);switch(t.type){case"meleeweapon":e=D._prepareMeleeWeapon(t,[i],a);break;case"rangeweapon":e=D._prepareRangeWeapon(t,[],[i],a);break}this.dialogData.mode=="attack"&&(this.dialogData.rollValue=e.attack)}else this.dialogData.mode=="attack"&&(this.dialogData.rollValue=Number(t.system.at))}prepareFormRecall(e){if(super.prepareFormRecall(e),canvas.scene&&game.settings.get("dsk","sightAutomationEnabled")){let t=canvas.scene?canvas.scene.darkness:0,a=game.settings.get("dsk","sightOptions").split("|").map(n=>Number(n)),s=0;for(;a[s]<=t;)s+=1;let i=h.getSpeaker(this.dialogData.speaker);if(i){let n=E.vantageStep(i,game.i18n.localize("dsk.LocalizedIDs.darksight"))+x.abilityStep(i,game.i18n.localize("dsk.LocalizedIDs.sappeurStyle")),l=x.abilityStep(i,game.i18n.localize("dsk.LocalizedIDs.blindFighting"));s<4&&s>0&&(n>1?s=0:(s=Math.max(0,s-n),s=Math.min(4,s+E.vantageStep(i,game.i18n.localize("dsk.LocalizedIDs.nightBlind"))))),s=Math.max(0,s-l)}let r=e.find(`[name="vision"] option:nth-child(${s+1})`);r.length&&(r[0].selected=!0)}}calculateModifier(){if(this.dialogData.mode=="damage")return;let e=this.dialogData.source,t=e.type=="trait"&&getProperty(e,"system.traitType")=="meleeAttack"||e.type=="meleeweapon",a={source:this.dialogData.source,extra:{options:{}}},s=h.getSpeaker(this.dialogData.speaker);t?Z.resolveMeleeDialog(a,{},this.element,s,{},-2,this.dialogData.mode):Z.resolveRangeDialog(a,{},this.element,s,{},this.dialogData.mode,-2),this.dialogData.modifier=_DiceDSK._situationalModifiers(a),this.updateRollButton(this.readTargets())}static resolveMeleeDialog(e,t,a,s,i,r,n){this._resolveDefault(e,t,a,s,i);let l=new FormDataExtended(a.find("form")[0]).object;e.opposingWeaponSize=l.weaponsize,e.narrowSpace=l.narrowSpace,e.attackOfOpportunity=this.attackOfOpportunity(e.situationalModifiers,l),e.situationalModifiers.push(C.parseValueType(game.i18n.localize("dsk.sight"),l.vision||0),{name:game.i18n.localize("dsk.attackFromBehind"),value:l.attackFromBehind?-4:0},{name:game.i18n.localize("dsk.MODS.damage"),damageBonus:l.damageModifier,value:0,step:1},{name:game.i18n.format("dsk.defenseCount",{malus:-1*r}),dmmalus:(Number(l.defenseCount)||0)*r*-1,value:(Number(l.defenseCount)||0)*r*-1,type:"defenseMalus"},{name:game.i18n.localize("dsk.wrongHand"),value:l.wrongHand?-4:0},{name:game.i18n.localize("dsk.advantageousPosition"),value:l.advantageousPosition?2:0},{name:game.i18n.localize("dsk.sizeCategory"),value:w.meleeSizeModifier[l.size]},...C.getSpecAbModifiers(a,n)),n=="attack"&&e.situationalModifiers.push({name:game.i18n.localize("dsk.doubleAttack"),value:l.doubleAttack?-3+Math.floor(x.abilityStep(s,game.i18n.localize("dsk.LocalizedIDs.twoWeaponCombat"))*1.5):0})}static resolveRangeDialog(e,t,a,s,i,r){this._resolveDefault(e,t,a,s,i);let n=new FormDataExtended(a.find("form")[0]).object;e.rangeModifier=n.distance,e.situationalModifiers.push({name:game.i18n.localize("dsk.target")+" "+a.find('[name="targetMovement"] option:selected').text(),value:Number(n.targetMovement)||0},{name:game.i18n.localize("dsk.shooter")+" "+a.find('[name="shooterMovement"] option:selected').text(),value:Number(n.shooterMovement)||0},{name:game.i18n.localize("dsk.mount")+" "+a.find('[name="mountedOptions"] option:selected').text(),value:Number(n.mountedOptions)||0},{name:game.i18n.format("dsk.defenseCount",{malus:-1*r}),dmmalus:(Number(n.defenseCount)||0)*r*-1,value:(Number(n.defenseCount)||0)*r*-1,type:"defenseMalus"},{name:game.i18n.localize("dsk.rangeMovementOptions.QUICKCHANGE"),value:n.quickChange?-4:0},{name:game.i18n.localize("dsk.MODS.combatTurmoil"),value:n.combatTurmoil?-2:0},{name:game.i18n.localize("dsk.aim"),value:Number(n.aim)||0},{name:game.i18n.localize("dsk.MODS.damage"),damageBonus:n.damageModifier,value:0,step:1},{name:game.i18n.localize("dsk.sight"),value:Number(n.vision||0)},...C.getSpecAbModifiers(a,"attack"),{name:game.i18n.localize("dsk.sizeCategory"),value:w.rangeSizeModifier[n.size]})}static _resolveDefault(e,t,a,s,i){t.rollMode=a.find('[name="rollMode"]').val(),e.situationalModifiers=D._parseModifiers(a),D.schipsModifier(a,e.situationalModifiers),e.vw=a.find('[name="vw"]').val(),mergeObject(e.extra.options,i)}static attackOfOpportunity(e,t){let a=t.opportunityAttack?-8:0;if(a){e.push({name:game.i18n.localize("dsk.opportunityAttack"),value:a});let s=game.i18n.localize("dsk.LocalizedIDs.enemySense");game.user.targets.forEach(i=>{if(i.actor&&i.actor.items.find(r=>r.type=="specialability"&&r.name==s)){e.push({name:s,value:a});return}})}return a!=0}static getRollButtons(e,t,a,s){let i=q.getRollButtons(e,t,a,s);if(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType=="rangeAttack"){let r=e.source.type=="trait"?Number(e.source.system.lz):D.calcLZ(e.source,e.extra.actor),n=e.source.system.reloadTimeprogress;n<r&&mergeObject(i,{reloadButton:{label:`${game.i18n.localize("dsk.WEAPON.reload")} (${n}/${r})`,callback:async()=>{await(await h.getSpeaker(e.extra.speaker)).updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTimeprogress":n+1}]);let c=game.i18n.format("dsk.WEAPON.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${n+1}/${r}`});await ChatMessage.create(h.chatDataSetup(c))}}})}return i}};m(Z,"DSKCombatDialog");var Ae=class extends V{static getRollButtons(e,t,a,s){let i=q.getRollButtons(e,t,a,s);i.rollButton.label=game.i18n.localize("dsk.Opposed");let r={nonOpposedButton:{label:game.i18n.localize("dsk.Roll"),callback:n=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,n),e.opposable=!1,a(t.callback(n))}}};return mergeObject(r,i),r}activateListeners(e){super.activateListeners(e),e.on("change","input,select",s=>this.rememberFormData(s));let t=this.readTargets(),a=this;this.checkTargets=setInterval(function(){t=a.compareTargets(e,t)},500),this.rememberFormData(),e.on("mousedown",".quantity-click",s=>this.rememberFormData(s)),e.find(".modifiers option").mousedown(s=>{this.rememberFormData(s)})}rememberFormData(e){let t=new FormDataExtended(this.element.find("form")[0]).object;t.situationalModifiers=D._parseModifiers(this._element)}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}};m(Ae,"SkillDialogDSK");var Xe=class extends V{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}prepareFormRecall(e){super.prepareFormRecall(e),e.find(".spellModifier").trigger("change")}static getRollButtons(e,t,a,s){let i=q.getRollButtons(e,t,a,s);if(["spell","liturgy"].includes(e.source.type)){let r=Number(e.source.system.castingTime.value),n=e.source.system.castingTime.progress,l=e.source.system.castingTime.modified;if(r&&e.extra.speaker.token!="emptyActor"){let c=l>0?` (${n}/${l})`:"";mergeObject(i,{reloadButton:{label:`${game.i18n.localize("dsk.SPELL.reload")}${c}`,callback:async u=>{let d=await h.getSpeaker(e.extra.speaker),p={_id:e.source._id,"system.castingTime.progress":n+1};l==0&&(l=Number(u.find(".castingTime").text())-1,p["system.castingTime.modified"]=l),await d.updateEmbeddedDocuments("Item",[p]);let f=game.i18n.format("dsk.SPELL.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${n+1}/${l}`});await ChatMessage.create(h.chatDataSetup(f))}}})}}return i}async recalcSpellModifiers(e,t){let a=e,s=duplicate(this.dialogData.source),i=a.find(".castingTime"),r=a.find(".aspcost"),n=a.find(".reach"),l=a.find(".maintainCost"),c=a.find(".ritual").length>0,u=a.find(".maxMods");if(a.find(".spellModifier:checked").length>Number(u.text())){t&&(t.currentTarget.checked=!1),u.addClass("emphasize"),setTimeout(function(){u.removeClass("emphasize")},600);return}let d=s.system.AeP,p=s.system.range,f=2,b=d;a.find(".variableBaseCost")[s.system.variableBaseCost=="true"?"show":"hide"]();let T=0;a.find(".spellModifier[data-cost]:checked").each(function(y,v){b=b*(v.value<0?.5:2),T+=Number(v.value)}),b<1?t&&(t.currentTarget.checked=!1):(r.text(b),r.attr("data-mod",T)),T=0,b=f,a.find(".spellModifier[data-castingTime]:checked").each(function(y,v){if(c){let k=Xe.bigTimes.indexOf(Number(b));if(k!=null){let I=k+(v.value>0?1:-1);I<Xe.bigTimes.length&&I>=0?b=Xe.bigTimes[I]:ui.notifications.error(game.i18n.localize("dsk.DSKError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("dsk.DSKError.TimeCannotBeParsed"))}else b=b*(v.value>0?2:.5);T+=Number(v.value)}),b<1?t&&(t.currentTarget.checked=!1):(i.text(b),i.attr("data-mod",T)),T=0;let g=game.i18n.localize("dsk.ReverseSpellRanges."+p);n.text(p),a.find(".spellModifier[data-reach]:checked").each(function(y,v){if(g=="self")v.checked=!1;else if(g=="touch")n.text("4 "+game.i18n.localize("dsk.step")),T+=Number(v.value);else{let k=p.split(" ");g=Number(k[0]),isNaN(g)?(t&&(t.currentTarget.checked=!1),ui.notifications.error(game.i18n.localize("dsk.DSKError.RangeCannotBeParsed"))):(n.text(g*2+" "+game.i18n.localize("dsk.step")),T+=Number(v.value))}}),n.attr("data-mod",T),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2)}activateListeners(e){super.activateListeners(e),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2),e.find(".specAbs").mousedown(s=>{$(s.currentTarget).toggleClass("active"),this.recalcSpellModifiers(e)}),e.find(".variableBaseCost").change(s=>{let i=$(s.currentTarget).parents(".skill-test"),r=i.find(".aspcost").attr("data-base"),n=$(s.currentTarget).val();i.find(".aspcost").attr("data-base",n),i.find(".aspcost").text(Number(i.find(".aspcost").text())*n/r)}),e.find(".spellModifier").change(s=>this.recalcSpellModifiers(e,s));let t=this.readTargets();t.length==0&&this.setRollButtonWarning();let a=this;this.checkTargets=setInterval(function(){t=a.compareTargets(e,t)},500)}},pe=Xe;m(pe,"DSKpellDialog"),z(pe,"rollChanges",["defenseMalus"]),z(pe,"bigTimes",[5,30,120,480,960,1920]);var q=class extends V{static getDialogForItem(e){switch(e){case"rangeweapon":case"meleeweapon":case"trait":return Z;case"ahnengabe":return pe;case"skill":return Ae}return q}static getRollButtons(e,t,a,s){let i={rollButton:{label:game.i18n.localize("dsk.check"),callback:r=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,r),a(t.callback(r))}}};return game.user.isGM&&mergeObject(i,{cheat:{label:game.i18n.localize("dsk.DIALOG.cheat"),callback:r=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,r),a(t.callback(r,{cheat:!0}))}}}),i}activateListeners(e){super.activateListeners(e),e.find(".dieButton").click(t=>{let a=$(t.currentTarget);a.attr("data-single")=="true"&&a.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),a.toggleClass("dieSelected")})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}};m(q,"DSKDialog");function $a(o,e={}){h.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}m($a,"automatedAnimation");async function Ea(o,e,t,a,s,i={}){let r={};if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else{let l=await game.packs.get(o).getDocuments({name:e});if(!l.length){for(let c of game.packs.filter(u=>u.documentName=="Macro"&&/\(internal\)/.test(u.metadata.label)))if(l=await c.getDocuments({name:e}),l.length)break}if(l.length){let c=`(async () => {${l[0].command}})()`,u=Function("actor","item","qs","automatedAnimation","args",c);try{i.result=r;let d=mergeObject({automatedAnimation:$a},this);await u.call(d,t,a,s,$a,i)}catch(d){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(d),r.error=!0}}else ui.notifications.error(game.i18n.format("dsk.DSKError.macroNotFound",{name:e}))}return r}m(Ea,"callMacro");var W=class extends ActiveEffectConfig{static get defaultOptions(){return mergeObject(super.defaultOptions,{resizable:!0})}static async onEffectRemove(e,t){let a=getProperty(t,"flags.dsa5.onRemove");if(a)if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let s=Object.getPrototypeOf(async function(){}).constructor;await new s("effect","actor",a).call(this,t,e)}catch(s){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(s),console.warn(s.stack)}}async checkTimesUpInstalled(){let e=h.moduleEnabled("times-up");return!e&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("dsk.DSKError.shouldTimesUp")),e}async _render(e=!1,t={}){await super._render(e,t);let a=-1,s=["none","systemEffect","macro","creature"].map(u=>({name:`dsk.ActiveEffects.advancedFunctions.${u}`,index:a+=1})),i=getProperty(this.object,"parent.type"),r={hasSpellEffects:["ahnengabe","consumable","poison","ammunition","meleeweapon","rangeweapon"].includes(i)||["specialability"].includes(i)&&getProperty(this.object,"parent.system.category")=="Combat"||i=="trait"&&["meleeAttack","rangeAttack"].includes(getProperty(this.object,"parent.system.traitType")),hasDamageTransformation:["ammunition"].includes(i)};r.hasDamageTransformation&&s.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5});let n={systemEffects:this.getStatusEffects(),canEditMacros:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")},l=$(this._element);l.find(".tabs").append(`<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>${game.i18n.localize("dsk.advanced")}</a>`);let c=await renderTemplate("systems/dsk/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:s,effectConfigs:r,config:n});l.find('.tab[data-tab="effects"]').after($(c)),l.find(".advancedSelector").change(u=>{let d=this.object;d.flags.dsk.advancedFunction=$(u.currentTarget).val(),renderTemplate("systems/dsk/templates/status/advanced_functions.html",{effect:d,config:n}).then(p=>{l.find(".advancedFunctions").html(p)})}),this.checkTimesUpInstalled()}async _onSubmit(e,{updateData:t=null,preventClose:a=!1,preventRender:s=!1}={}){return getProperty(this.object,"system.document.parent.documentName")!="Actor"&&getProperty(this.object,"system.document.parent.parent")&&ui.notifications.error(game.i18n.localize("dsk.DSKError.nestedEffectNotSupported")),await super._onSubmit(e,{updateData:t,preventClose:a,preventRender:s})}getStatusEffects(){return duplicate(CONFIG.statusEffects).map(e=>({id:e.id,label:game.i18n.localize(e.name)})).sort((e,t)=>e.name.localeCompare(t.name))}getData(e){return super.getData(e)}static applyRollTransformation(e,t,a){let s="",i=t.origin;for(let r of i.effects)try{if(Number(getProperty(r,"flags.dsk.advancedFunction"))==a)if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let n=Object.getPrototypeOf(function(){}).constructor;new n("ef","callMacro","actor","msg","source",getProperty(r,"flags.dsa5.args3")).call(this,r,Ea,e,s,i)}catch(n){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(n),console.warn(n.stack)}}catch(n){console.warn("Unable to apply advanced effect",n,r)}return t.origin=i,{msg:s,options:t}}static async applyAdvancedFunction(e,t,a,s,i,r=!0){let n="",l=[],c=!1,u=[],d=new Set;for(let p of t){p.origin&&delete p.origin;let f=Number(getProperty(p,"flags.dsk.specStep"))||0;try{let b=Number(getProperty(p,"flags.dsk.advancedFunction")),T=Math.min(s.qualityStep||0,6),g=getProperty(p,"flags.dsk.resistRoll");if(g&&!r){let y=g.split(" "),v=`${y.pop()}`;l.push({skill:y.join(" "),mod:Math.round(Roll.safeEval(`${v}`.replace(/q(l|s)/i,T).replace("step",f)))||0,effect:p,target:e,token:e.token?e.token.id:void 0})}else if(c=!0,d.has(p.name)||d.add(p.name),p.changes&&p.changes.length>0&&u.push(p),b)switch(b){case 1:{let v=duplicate(CONFIG.statusEffects.find(I=>I.id==getProperty(p,"flags.dsk.args0"))),k=`${getProperty(p,"flags.dsk.args1")}`||"1";v.duration=p.duration,/,/.test(k)?k=Number(k.split(",")[T-1]):k=Number(k.replace(game.i18n.localize("dsk.CHARAbbrev.QS"),T)),await e.addCondition(v,k,!1,!1)}break;case 2:if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let v=Object.getPrototypeOf(async function(){}).constructor;await new v("effect","actor","callMacro","msg","source","actor","sourceActor","testData","qs",getProperty(p,"flags.dsa5.args3")).call(this,p,e,Ea,n,a,e,i,s,T)}catch(v){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(v),console.warn(v.stack)}break;case 3:let y=(getProperty(p,"flags.dsk.args4")||"").split(",").map(v=>`@Compendium[${v.trim().replace(/(@Compendium\[|\])/)}]`).join(" ");n+=`<p><b>${game.i18n.localize("dsk.ActiveEffects.advancedFunctions.creature")}</b>:</p><p>${y}</p>`;break}}catch(b){console.warn("Unable to apply advanced effect"),console.warn(b),console.warn(p)}}return await e.createEmbeddedDocuments("ActiveEffect",u.map(p=>(p.origin=e.uuid,p))),{msg:n,resistRolls:l,effectApplied:c,effectNames:Array.from(d)}}static async resistEffect(e){let t=e.currentTarget.dataset,a={token:t.token,actor:t.actor,scene:canvas.id},s=h.getSpeaker(a);if(s){let i=s.items.find(r=>r.type=="skill"&&r.name==t.skill);s.setupSkill(i,{modifier:t.mod},t.token).then(async r=>{r.testData.opposable=!1,((await s.basicTest(r)).result.qualityStep||0)<1&&await this.applyEffect(t.message,t.mode,[a],{effectIds:[t.effect],skipResistRolls:!0})})}else console.warn("Actor not found for resist roll.")}static async applyEffect(e,t,a,s={}){let i=game.messages.get(e),r=i.flags.data.preData.source,n=i.flags.data.postData,l=i.speaker;["poison","disease"].includes(r.type)&&(n.qualityStep=n.successLevel>0?2:1);let c=h.getSpeaker(l)||h.getSpeaker(getProperty(i.flags,"data.preData.extra.speaker"))||game.actors.get(getProperty(i.flags,"data.preData.extra.actor.id")),u=c,d=await this._parseEffectDuration(r,n,i.flags.data.preData,c);s.effectIds&&(d=d.filter(f=>s.effectIds.includes(f._id)));let p=[];if(t=="self"?c&&p.push(c):a?p=a.map(f=>h.getSpeaker(f)):game.user.targets.size&&game.user.targets.forEach(f=>{f.actor&&p.push(f.actor)}),game.user.isGM)for(let f of p){let{msg:b,resistRolls:T,effectApplied:g,effectNames:y}=await W.applyAdvancedFunction(f,d,r,n,u,s.skipResistRolls||!1);if(g){let k=`${game.i18n.format("dsk.ActiveEffects.appliedEffect",{target:f.token?.name||f.name,source:y.join(", ")})}${b||""}`;await ChatMessage.create(h.chatDataSetup(k))}T.length&&await this.createResistRollMessage(T,e,t)}else game.socket.emit("system.dsk",{type:"addEffect",payload:{mode:t,id:e,actors:p.map(f=>({token:f.token?f.token.id:void 0,actor:f.id,scene:canvas.scene.id}))}})}static async createResistRollMessage(e,t,a){for(let s of e){let i=await renderTemplate("systems/dsk/templates/chat/roll/resist-roll.html",{resist:s,id:t,mode:a});await ChatMessage.create(h.chatDataSetup(i))}}static async _parseEffectDuration(e,t,a,s){let i={};for(let u of a.situationalModifiers.filter(d=>d.specAbId))i[u.specAbId]=u.step;let r=Object.keys(i),n=s?s.items.filter(u=>r.includes(u.id)):[],l=e.effects?duplicate(e.effects):[];for(let u of n){let d=duplicate(u).effects;for(let p of d)setProperty(p,"flags.dsk.specStep",i[u.id]);l.push(...d)}let c=getProperty(e,"system.duration")||"";c=c.replace(" x "," * ").replace(game.i18n.localize("dsk.CHARAbbrev.QS"),t.qualityStep);try{let u=[{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.days"),"gi"),seconds:86400},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.weeks"),"gi"),seconds:604800},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.months"),"gi"),seconds:2592e3},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.years"),"gi"),seconds:3024e4}];for(let d of u)if(d.regEx.test(c)){let p=c.replace(d.regEx,"").trim(),f=await _DiceDSK._stringToRoll(p);if(!isNaN(f))for(let b of l){let T=f*d.seconds,g=getProperty(b,"flags.dsk.customDuration");if(g){let y=g.split(",")[t.qualityStep-1];y&&y!="-"&&(T=Number(y))}b.duration.seconds=T,b.duration.rounds=b.duration.seconds/5}break}}catch{console.error(`Could not parse duration '${c}' of '${e.name}'`)}return l}dropDownMenu(){let e=game.i18n.localize("dsk.MODS.FW"),t=game.i18n.localize("TYPES.Item.skill"),a=game.i18n.localize("dsk.regenerate"),s=game.i18n.localize("dsk.MODS.FP"),i=game.i18n.localize("dsk.stepValue"),r=game.i18n.localize("dsk.MODS.QS"),n=game.i18n.localize("dsk.MODS.partChecks"),l=`${game.i18n.localize("dsk.LocalizedIDs.perception")} 1`,c=`${game.i18n.localize("dsk.LocalizedIDs.wrestle")} 1`,u=game.i18n.localize("dsk.closeCombatAttacks"),d=game.i18n.localize("dsk.rangeCombatAttacks"),p=`${a} (${game.i18n.localize("dsk.CHARAbbrev.CR")})`,f=game.i18n.localize("dsk.AePCost"),b=`${game.i18n.localize("dsk.description")} 1`,T=`${game.i18n.localize("Healing")} 1`,g=[{name:game.i18n.localize("dsk.protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:`${game.i18n.localize("dsk.resistanceModifier")} (${game.i18n.localize("dsk.condition")})`,val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("dsk.carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.AW")}`,val:"system.meleeStats.attack",mode:2,ph:"1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.VW")}`,val:"system.meleeStats.parry",mode:2,ph:"1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:`${u} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("dsk.MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:"Elementar 1"},{name:`${d} - ${game.i18n.localize("dsk.CHARAbbrev.AW")}`,val:"system.rangeStats.attack",mode:2,ph:"1"},{name:`${d} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:`${d} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:`${game.i18n.localize("TYPES.Item.ahnengabe")} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.spellStats.damage",mode:2,ph:"1"},{name:f,val:"system.aepModifier",mode:2,ph:"1"},{name:`${t} - ${e}`,val:"system.skillModifiers.FW",mode:0,ph:l},{name:`${t} - ${s}`,val:"system.skillModifiers.FP",mode:0,ph:l},{name:`${t} - ${i}`,val:"system.skillModifiers.step",mode:0,ph:l},{name:`${t} - ${r}`,val:"system.skillModifiers.QL",mode:0,ph:l},{name:`${t} - ${n}`,val:"system.skillModifiers.TPM",mode:0,ph:l},{name:`${game.i18n.localize("dsk.vulnerability")} - ${game.i18n.localize("TYPES.Item.combatskill")}`,val:"system.vulnerabilities.combatskill",mode:0,ph:c},{name:`${t} - ${game.i18n.localize("dsk.MODS.global")}`,val:"system.skillModifiers.global",mode:0,ph:"1"},{name:`${p} - ${game.i18n.localize("dsk.LeP")}`,val:"system.repeatingEffects.startOfRound.LeP",mode:0,ph:"1d6"},{name:`${p} - ${game.i18n.localize("dsk.AeP")}`,val:"system.repeatingEffects.startOfRound.AeP",mode:0,ph:"1d6"},{name:`${a} - ${game.i18n.localize("dsk.LeP")}`,val:"system.stats.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:`${a} - ${game.i18n.localize("dsk.AeP")}`,val:"system.stats.regeneration.AePgearmodifier",mode:2,ph:"1"},{name:`${game.i18n.localize("dsk.advanced")} - ${f}`,val:"system.skillModifiers.conditional.AePCost",mode:0,ph:b}],y=["ahnengabe","skill","feature"];for(let k of y){let I=k=="skill"?"skillglobal":k,H=h.categoryLocalization(I);g.push({name:`${H} - ${e}`,val:`system.skillModifiers.${k}.FW`,mode:0,ph:l},{name:`${H} - ${s}`,val:`system.skillModifiers.${k}.FP`,mode:0,ph:l},{name:`${H} - ${i}`,val:`system.skillModifiers.${k}.step`,mode:0,ph:l},{name:`${H} - ${r}`,val:`system.skillModifiers.${k}.QL`,mode:0,ph:l},{name:`${H} - ${n}`,val:`system.skillModifiers.${k}.TPM`,mode:0,ph:l})}let v=["inpain","selfconfidence","encumbered","stunned","feared"];for(let k of v)g.push({name:game.i18n.localize(`dsk.CONDITION.${k}`),val:`system.status.${k}`,mode:2,ph:1});for(let k of Object.keys(w.characteristics))g.push({name:game.i18n.localize(`dsk.characteristics.${k}.name`),val:`system.characteristics.${k}.gearmodifier`,mode:2,ph:"1"});for(let k of w.gearModifyableCalculatedAttributes)g.push({name:game.i18n.localize(`dsk.${k}`),val:`system.stats.${k}.gearmodifier`,mode:2,ph:"1"});g=g.sort((k,I)=>k.name.localeCompare(I.name));for(let k of g)(!k.ph||k.mode==null)&&console.warn(k);return g=g.map(k=>`<option value="${k.val}" data-mode="${k.mode}" data-ph="${k.ph}">${k.name}</option>`).join(`
`),`<select class="selMenu">${g}</select>`}activateListeners(e){super.activateListeners(e);let t=this.dropDownMenu();e.find(".changes-list .effect-change .key").append(t),e.find(".selMenu").change(a=>{let s=$(a.currentTarget);s.siblings("input").val(s.val());let i=s.closest(".effect-change"),r=s.find("option:selected");i.find(".mode select").val(r.attr("data-mode")),i.find(".value input").attr("placeholder",r.attr("data-ph")),s.blur()})}};m(W,"DSKActiveEffectConfig");var K=class{static async playEffect(e,t,a,s=void 0,i=!1){let r=await this.getSound(e,t,a);if(r)try{s?(game.socket.emit("system.dsk",{type:"playWhisperSound",payload:{whisper:s,soundPath:r}}),i||AudioHelper.play({src:r,volume:.8,loop:!1},!1)):AudioHelper.play({src:r,volume:.8,loop:!1},!0)}catch{console.warn(`Could not play item sound effect ${r}`)}}static async loadSoundConfig(){let e=await game.settings.get("dsk","soundConfig");if(e)try{let a=await(await fetch(e)).json();this.sounds=a,console.log("DSK | Sound Config Loaded")}catch(t){console.warn(t)}}static successLevelToString(e){switch(e){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}static async getSound(e,t,a){if(!this.sounds&&!this.triedInit&&(await this.loadSoundConfig(),this.triedInit=!0),!this.sounds)return;let s=this.successLevelToString(a),i=[],r;switch(t.type){case"meleeweapon":case"rangeweapon":i=[...s.map(n=>`${t.type}.manual.${t.name}.${e}_${n}`),`${t.type}.manual.${t.name}.${e}`,`${t.type}.manual.${t.name}.default.${e}`,`${t.type}.manual.${t.name}.default`,...s.map(n=>`${t.type}.${t.system.combatskill}.${e}_${n}`),`${t.type}.${t.system.combatskill}.${e}`,...s.map(n=>`${t.type}.${t.system.combatskill}.default_${n}`),`${t.type}.${t.system.combatskill}.default`];break;case"skill":i=[...s.map(n=>`${t.type}.${t.name}.${e}_${n}`),`${t.type}.${t.name}.${e}`,...s.map(n=>`${t.type}.${t.name}.default_${n}`),`${t.type}.${t.name}.default`];break;case"ahnengabe":i=[...s.map(n=>`${t.type}.${t.name}.${e}_${n}`),`${t.type}.${t.name}.${e}`,...s.map(n=>`${t.type}.${t.name}.default_${n}`),`${t.type}.${t.name}.default`];break}i.push(...s.map(n=>`${t.type}.default_${n}`),`${t.type}.default`);for(let n of i)if(!!hasProperty(this.sounds,n)&&(r=getProperty(this.sounds,n),r&&(typeof r=="string"||r instanceof String)))break;return r}static async playMoneySound(e=!1){if(!game.modules.get("gAudioBundle-3"))return;let t=["modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"],a=t[Math.floor(Math.random()*t.length)];await this.playSoundPath(a,e)}static async playEquipmentWearStatusChange(e,t=!1){let a=[],s=game.modules.get("gAudioBundle-2"),i=game.modules.get("gAudioBundle-3"),r=game.modules.get("gAudioBundle-4");switch(e.type){case"armor":s&&a.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg");break;case"meleeweapon":s&&a.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),i&&a.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg");break;case"rangeweapon":r&&a.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg");break}if(a.length==0&&s&&a.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg"),a.length>0){let n=a[Math.floor(Math.random()*a.length)];await this.playSoundPath(n,t,.5)}}static async playSoundPath(e,t=!1,a=.8){if(!!game.settings.get("dsk","inventorySound"))try{AudioHelper.play({src:e,volume:a,loop:!1},t)}catch{console.warn(`Could not play item sound effect ${e}`)}}};m(K,"DSKSoundEffect"),z(K,"sounds"),z(K,"triedInit",!1);var Y=class{constructor(e){this.item=e}async callMacro(e,t,a={}){let i=await game.packs.get(e).getDocuments({name:t});if(!i.length){for(let n of game.packs.filter(l=>l.documentName=="Macro"&&/\(internal\)/.test(l.metadata.label)))if(i=await n.getDocuments({name:t}),i.length)break}let r={};if(i.length){let n=`(async () => {${i[0].command}})()`,l=Function("args","actor","item",n);try{a.result=r,await l.call(this,a,this.item.actor,this.item)}catch(c){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(c),r.error=!0}}else ui.notifications.error(game.i18n.format("dsk.DSKError.macroNotFound",{name:t}));return r}async executeOnUseEffect(){if(!game.user.can("MACRO_SCRIPT"))return ui.notifications.warn("You are not allowed to use JavaScript macros.");if(!this.item.actor)return;let t=`(async () => {${Y.getOnUseEffect(this.item)}})()`,a=Function("item","actor",t);try{await a.call(this,this.item,this.item.actor)}catch(s){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(s),console.warn(s.stack)}}static getOnUseEffect(e){return e.getFlag("dsk","onUseEffect")}async automatedAnimation(e,t={}){h.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}effectDummy(e,t,a){return{label:e,icon:"icons/svg/aura.svg",changes:t,duration:a,flags:{dsk:{value:null,editable:!0,customizable:!0,description:e,custom:!0}}}}async socketedConditionAddActor(e,t){if(game.user.isGM){let a=typeof t=="string";a&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let s=[];for(let i of e)a?await i.addCondition(t,1,!1,!1):await i.addCondition(t),s.push(i.name);await this.createInfoMessage(t,s)}else{let a={id:this.item.uuid,data:t,actors:e.map(s=>s.id)};game.socket.emit("system.dsk",{type:"socketedConditionAddActor",payload:a})}}async createInfoMessage(e,t,a=!0){if(t.length){let s=a?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",i=game.i18n.format(s,{source:e.label,target:t.join(", ")});await ChatMessage.create(h.chatDataSetup(i))}}async socketedRemoveCondition(e,t,a=1){if(game.user.isGM){let s=[];for(let r of e){let n=canvas.tokens.get(r);n.actor&&(await n.actor.removeCondition(t,a,!1),s.push(n.name))}let i=CONFIG.statusEffects.find(r=>r.id==t);i.name=game.i18n.localize(i.name),await this.createInfoMessage(i,s,!1)}else{let s={id:this.item.uuid,coreId:t,targets:e};game.socket.emit("system.dsk",{type:"socketedRemoveCondition",payload:s})}}async socketedActorTransformation(e,t){if(game.user.isGM)for(let a of e){let s=canvas.tokens.get(a);s.actor&&await s.actor.update(t)}else{let a={id:this.item.uuid,targets:e,update:t};game.socket.emit("system.dsk",{type:"socketedActorTransformation",payload:a})}}async socketedConditionAdd(e,t){if(game.user.isGM){let a=typeof t=="string";a&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let s=[];for(let i of e){let r=canvas.tokens.get(i);r.actor&&(a?await r.actor.addCondition(t,1,!1,!1):await r.actor.addCondition(t),s.push(r.name))}await this.createInfoMessage(t,s)}else{let a={id:this.item.uuid,data:t,targets:e};game.socket.emit("system.dsk",{type:"socketedConditionAdd",payload:a})}}};m(Y,"OnUseEffect");var ee=class{static async showBotchCard(e,t={}){t.speaker={token:e.token,actor:e.actor,scene:e.scene},t.source=e.source;let a=w.systemTables.find(u=>u.name==e.table),s=await ee.getRollTable(a.pack[game.i18n.lang],game.i18n.localize(`dsk.TABLENAMES.${e.table}`),e),i=t.speaker?await ee.hasEffect(s):!1,r=h.replaceDies(h.replaceConditions(s.results[0].text)),n=`${game.i18n.localize("dsk.TABLENAMES."+e.table)}`,l=await renderTemplate("systems/dsk/templates/tables/tableCard.html",{result:r,title:n,hasEffect:i}),c=await this.buildEffects(s,i);ChatMessage.create({user:game.user.id,content:l,whisper:t.whisper,blind:t.blind,flags:{data:{preData:{source:{effects:c},extra:{actor:{id:t.speaker.actor},speaker:t.speaker},situationalModifiers:[]},postData:{}},dsk:{hasEffect:i,options:t}}})}static async hasEffect(e){return getProperty(e.results[0],"flags.dsk")||!1}static async buildEffects(e,t){let a=[];if(t&&t.resistEffect){let s=new Y().effectDummy(t.resistEffect.fail.description,t.resistEffect.changes||[],t.resistEffect.duration||{});t.resistEffect.fail.systemEffect&&mergeObject(s,{_id:"botchEffect",flags:{dsk:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:'await actor.addCondition("prone");'}}}),a.push(s)}return a}static async getRollTable(e,t,a={}){let i=(await game.packs.get(e).getDocuments({name__in:[t]}))[0],r=await i.draw({displayChat:!1});return a.weaponless=="true"&&r.roll.total<7&&(r.roll.editRollAtIndex([{index:0,val:r.roll.total+5}]),r=await i.draw({displayChat:!1,roll:r.roll})),r}static async tableEnabledFor(e){let t=w.systemTables.find(a=>a.name==e);return t?game.settings.get(t.setting.module,t.setting.key):!1}static rollCritBotchButton(e,t,a){let s=game.i18n.localize(`dsk.TABLENAMES.${e}`),i=a.extra.speaker,r=a.source._id;return`, <a class="roll-button botch-roll" data-table="${e}" data-weaponless="${t}" data-source="${r}" data-token="${i.token}" data-actor="${i.actor}" data-scene="${i.scene}"><i class="fas fa-dice"></i>${s}</a>`}static async defaultBotch(){return", "+game.i18n.localize("dsk.selfDamage")+(await new Roll("1d6+2").evaluate({async:!0})).total}static defaultAttackCrit(e){let t=", "+game.i18n.localize("dsk.halfDefense");return e&&(t+=", "+game.i18n.localize("dsk.doubleDamage")),t}static defaultParryCrit(){return", "+game.i18n.localize("dsk.attackOfOpportunity")}};m(ee,"DSKTables");var le=class{constructor(){le.skills.length==0&&h.allSkills(["skill"]).then(e=>{le.skills=e.map(t=>({name:t.name,type:"skill"})).concat(Object.values(game.dsk.config.characteristics).map(t=>({name:game.i18n.localize(t),type:"attribute"})).concat({name:game.i18n.localize("dsk.regenerate"),type:"regeneration"}))}),this.regex,this.filtering=!1}get regex(){return new RegExp(`^/(${le.cmds.join(" |")})`)}async chatListeners(e){let t=this;this.anchor=$("#chat-message").parent(),$("#chat-message").off("keydown",ui.chat._onChatKeyDownBinding),e.on("keyup","#chat-message",async function(a){t._parseInput(a)}),e.on("click",".quick-item",async function(a){t._quickSelect($(a.currentTarget))}),e.on("keydown","#chat-message",function(a){t._navigateQuickFind(a)})}_parseInput(e){let t=e.target.value;if(this.regex.test(t)){if([38,40,13,9].includes(e.which))return!1;if(e.which==27)return this._closeQuickfind(),!1;let a=this._getCmd(t),s=t.substring(1+a.length).toLowerCase().trim();this[`_filter${a}`](s),this.filtering=!0}else this._closeQuickfind()}_getCmd(e){return e.substring(1,3).toUpperCase().trim()}_completeCurrentEntry(e){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+e.text())+""}_closeQuickfind(){this.filtering=!1,this.anchor.find(".quickfind").remove()}_filterW(e){let t=game.users.contents.filter(a=>a.active&&a.name.toLowerCase().trim().indexOf(e)!=-1).map(a=>({name:a.name,type:"user"}));this._checkEmpty(t),this._setList(t,"W")}_filterAT(e){let{actor:t,tokenId:a}=le._getActor();if(t){let s=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],r=t.items.filter(n=>(s.includes(n.type)&&n.system.worn.value==!0||n.type=="trait"&&i.includes(n.system.traitType))&&n.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(n=>({name:n.name,type:"item"}));this._checkEmpty(r),this._setList(r,"AT")}}_filterAH(e){let{actor:t,tokenId:a}=le._getActor();if(t){let s=["ahnengabe"],i=t.items.filter(r=>s.includes(r.type)&&r.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(r=>({name:r.name,type:"item"}));this._checkEmpty(i),this._setList(i,"SP")}}_checkEmpty(e){e.length||e.push({name:game.i18n.localize("dsk.DSKError.noMatch"),type:"none"})}_getSkills(e,t=void 0){e=e.replace(/(-|\+)?\d+/g,"").trim();let a=le.skills.filter(s=>s.name.toLowerCase().trim().indexOf(e)!=-1&&(t==null||t==s.type)).slice(0,5);return this._checkEmpty(a),a}_filterCH(e){this._setList(this._getSkills(e),"CH")}_filterSK(e){this._setList(this._getSkills(e),"SK")}_filterRQ(e){this._setList(this._getSkills(e),"RQ")}_setList(e,t){let a=$(`<div class="quickfind dsklist"><ul>${e.map(i=>`<li data-type="${i.type}" data-category="${t}" class="quick-item">${i.name}</li>`).join("")}</ul></div>`);a.find(".quick-item:first").addClass("focus");let s=this.anchor.find(".quickfind");s.length?s.replaceWith(a):this.anchor.append(a)}_navigateQuickFind(e){if(this.filtering){let t=this.anchor.find(".focus");switch(e.which){case 38:return t.prev(".quick-item").length&&t.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return t.next(".quick-item").length&&t.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if(t.attr("data-category")=="W")break;return e.stopPropagation(),e.preventDefault(),this._quickSelect(t),!1;case 9:return e.stopPropagation(),e.preventDefault(),this._completeCurrentEntry(t),!1}}ui.chat._onChatKeyDown(e)}static _getActor(){let e=ChatMessage.getSpeaker(),t;return e.token&&(t=game.actors.tokens[e.token]),t||(t=game.actors.get(e.actor)),t?{actor:t,tokenId:e.token}:(ui.notifications.error(game.i18n.localize("dsk.DSKError.noProperActor")),{})}_quickSelect(e){let t=e.attr("data-category");switch(t){case"NM":case"RQ":case"CH":this[`_quick${t}`](e);break;case"W":this._completeCurrentEntry(e);break;default:let{actor:a,tokenId:s}=le._getActor();a&&(this._resetChatAutoCompletion(),this[`_quick${t}`](e,a,s))}}_quickW(e,t,a){}_quickCH(e){F.check3D20(e),this._resetChatAutoCompletion()}_quickSK(e,t,a){switch(e.attr("data-type")){case"skill":let s=t.items.find(r=>r.name==e.text()&&r.type=="skill");s&&t.setupSkill(s,{},a).then(r=>{t.basicTest(r)});break;case"attribute":let i=Object.keys(game.dsk.config.characteristics).find(r=>game.i18n.localize(game.dsk.config.characteristics[r])==e.text());t.setupCharacteristic(i,{},a).then(r=>{t.basicTest(r)});break;case"regeneration":t.setupRegeneration("regenerate",{},a).then(r=>{t.basicTest(r)});break}}_resetChatAutoCompletion(){$("#chat-message").val(""),this.anchor.find(".quickfind").remove()}_quickRQ(e){let t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(),X.showRQMessage(e.text(),t)}_quickAT(e,t,a){let s=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],r=t.items.find(n=>s.includes(n.type)&&n.name==e.text());r||(r=t.items.find(n=>n.type=="trait"&&n.name==e.text()&&i.includes(n.system.traitType))),r&&t.setupWeapon(r,"attack",{},a).then(n=>{t.basicTest(n)})}_quickSP(e,t,a){let s=["ahnengabe"],i=t.items.find(r=>s.includes(r.type)&&r.name==e.text());i&&t.setupSpell(i,{},a).then(r=>{t.basicTest(r)})}static async infoItemAsync(e){(await fromUuid(e)).postItem()}static bindRollCommands(e){e.on("click",".request-roll",t=>(X.showRQMessage(t.currentTarget.dataset.name,Number(t.currentTarget.dataset.modifier)||0),t.stopPropagation(),!1)),e.on("click",".postInfo",t=>{let a=fromUuidSync(t.currentTarget.dataset.uuid);return a&&(typeof a.postItem=="function"?a.postItem():this.infoItemAsync(t.currentTarget.dataset.uuid)),t.stopPropagation(),!1}),e.on("click",".postContentChat",async t=>{let a=$(t.currentTarget).closest(".postChatSection").find(".postChatContent").html();Te.getDialog(a)}),e.on("click",".request-CH",t=>(F.check3D20(void 0,t.currentTarget.dataset.name,{modifier:Number(t.currentTarget.dataset.modifier)||0}),t.stopPropagation(),!1))}},G=le;m(G,"DSKChatAutoCompletion"),z(G,"skills",[]),z(G,"cmds",["sk","at","ah","rq","w","ch"]);var X=class{static async requestRoll(e,t,a=0){let{actor:s,tokenId:i}=G._getActor();if(s){game.user.updateTokenTargets([]);let r={modifier:a};switch(e){case"attribute":let n=Object.keys(game.dsk.config.characteristics).find(c=>game.i18n.localize(game.dsk.config.characteristics[c])==t);s.setupCharacteristic(n,r,i).then(c=>{s.basicTest(c)});break;case"regeneration":s.setupRegeneration("regenerate",r,i).then(c=>{s.basicTest(c)});break;default:let l=s.items.find(c=>c.name==t&&c.type==e);s.setupSkill(l,r,i).then(c=>{s.basicTest(c)})}}}static showRQMessage(e,t=0){let a=t<0?` ${t}`:t>0?` +${t}`:"",s=G.skills.find(r=>r.name==e).type,i=game.i18n.format("dsk.CHATNOTIFICATION.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${s}" data-modifier="${t}" data-name="${e}"><i class="fas fa-dice"></i> ${e}${a}</a>`});ChatMessage.create(h.chatDataSetup(i))}static async updateInformationRoll(e,t,a){let s=t.result.qualityStep||0;if(s>0){let i=await fromUuid(e.uuid),r=[`<p><b>${i.name}</b></p>`];for(let l=1;l<=s;l++){let c=`qs${l}`;i.system[c]&&r.push(`<p>${i.system[c]}</p>`)}let n=h.chatDataSetup(r.join(""));e.recipients.length&&(n.whisper=e.recipients),ChatMessage.create(n)}}static async informationRequestRoll(e){let t=e.currentTarget.dataset.mod,a=e.currentTarget.dataset.uuid,{actor:s,tokenId:i}=G._getActor();if(!s)return;let r=game.settings.get("dsk","informationDistribution"),n=[];r==1?(n=game.users.filter(u=>u.isGM).map(u=>u.id),n.push(game.user.id)):r==2&&(n=game.users.filter(u=>u.isGM).map(u=>u.id));let l={modifier:t,postFunction:{functionName:"game.dsk.apps.RequestRoll.updateInformationRoll",uuid:a,recipients:n}},c=s.items.find(u=>u.name==e.currentTarget.dataset.skill&&u.type=="skill");s.setupSkill(c,l,i).then(async u=>{u.testData.opposable=!1;let d=await s.basicTest(u);this.updateInformationRoll(l.postFunction,d)})}static chatListeners(e){e.on("click",".request-roll",t=>{let a=t.currentTarget.dataset;X.requestRoll(a.type,a.name,Number(a.modifier)||0)}),e.on("click",".informationRequestRoll",t=>X.informationRequestRoll(t))}};m(X,"RequestRoll");var ce=class extends B{static async traitAdded(e,t){w.addTraitRules[t.name]&&await w.addTraitRules[t.name](e,t)}static hasTrait(e,t){return super.hasItem(e,t,["trait"])}};m(ce,"TraitRulesDSK");var _DiceDSK=class{static async rollTest(o){let e;switch(o.source.type){case"ahnengabe":e=await this.rollSpell(o);break;case"skill":e=await this.rollTalent(o);break;case"combatskill":e=await this.rollCombatskill(o);break;case"regenerate":e=await this.rollRegeneration(o);break;case"trait":e=o.mode=="damage"?await this.rollDamage(o):await this.rollCombatTrait(o),o.mode!="damage"&&await this.updateDefenseCount(e);break;case"meleeweapon":case"rangeweapon":e=o.mode=="damage"?await this.rollDamage(o):await this.rollWeapon(o),o.mode!="damage"&&await this.updateDefenseCount(e);break;case"poison":e=await this.rollItem(o);break;default:e=await this.rollAttribute(o)}return mergeObject(e,deepClone(o.extra)),e}static async updateDefenseCount(o){game.combat&&await game.combat.updateDefenseCount(Array.from(game.user.targets).map(e=>e.id))}static async setupDialog({dialogOptions:o,testData:e,cardOptions:t}){let a=await game.settings.get("core","rollMode"),s=0;typeof e.source.toObject=="function"&&(e.source=e.source.toObject(!1)),mergeObject(e,{testDifficulty:s}),mergeObject(o.data,{testDifficulty:s,testModifier:o.data.modifier||0});let i=o.data.situationalModifiers||(e.extra.actor?O.getRollModifiers(e.extra.actor,e.source):[]);e.extra.options.moreModifiers!=null&&i.push(...e.extra.options.moreModifiers);let r=[];if(game.user.targets.forEach(n=>{n.actor&&r.push({name:n.actor.name,id:n.id,img:n.actor.img})}),mergeObject(o.data,{hasSituationalModifiers:i.length>0,situationalModifiers:i,rollMode:o.data.rollMode||a,rollModes:CONFIG.Dice.rollModes,defenseCount:await this.getDefenseCount(e),targets:r}),mergeObject(t,{user:game.user.id}),e.extra.options.bypass)return t.rollMode=e.extra.options.rollMode||a,e.situationalModifiers||(e.situationalModifiers=[]),{testData:e,cardOptions:t};{let n=await renderTemplate(o.template,o.data);return new Promise((l,c)=>{let u=q.getDialogForItem(e.source.type);new u({title:o.title,content:n,buttons:u.getRollButtons(e,o,l,c),default:"rollButton"}).recallSettings(e.extra.speaker,e.source,e.mode).render(!0)})}}static _appendSituationalModifiers(o,e,t,a=""){let s=o.situationalModifiers.find(i=>i.name==e);s?s.value=t:o.situationalModifiers.push({name:e,value:t,type:a})}static _situationalPartCheckModifiers(o){return o.situationalModifiers.reduce(function(e,t){if(t.type=="TPM"){let a=t.value.split("|");return a.length!=2||(e[0]=e[0]+Number(a[0]),e[1]=e[1]+Number(a[1])),e}else return e},[0,0])}static _situationalModifiers(o,e=""){return o.situationalModifiers.reduce(function(t,a){return t+((a.type==e||e==""&&a.type==null)&&Number(a.value)||0)},0)}static async getDefenseCount(o){let e=Array.from(game.user.targets);return game.combat&&e[0]?await game.combat.getDefenseCount({token:e[0].id}):0}static async rollTalent(o){let e=await this._roll2D20(o);return e.rollType="talent",e}static async rollAttribute(o){let e=await this._roll2D20(o);return e.rollType="attribute",e}static get2D20SuccessLevel(o,e,t=20,a=1){let s=o.terms.filter(r=>r.results&&r.results[0].result<=a).length,i=o.terms.filter(r=>r.results&&r.results[0].result>=t).length;return s>=2?s:i>=2?i*-1:e>=0?1:-1}static async _addRollDiceSoNice(o,e,t){if(o.rollMode){for(let a=0;a<e.dice.length;a++)mergeObject(e.dice[a].options,t);await this.showDiceSoNice(e,o.rollMode)}}static async rollSpell(o){let e=await this._roll2D20(o);if(e.rollType=o.source.types,e.preData.calculatedSpellModifiers.finalcost=Number(e.preData.calculatedSpellModifiers.cost),e.successLevel>=2){let t=10;e.description=e.description+", "+game.i18n.localize("dsk.additionalQLs")+" "+t,e.qualityStep=Math.min(6,Math.ceil(e.result/5)+2),e.preData.calculatedSpellModifiers.finalcost=Math.round(e.preData.calculatedSpellModifiers.cost/2)}else e.successLevel<=-2&&(e.description+=ee.rollCritBotchButton("Ahnen",!1,o));if(e.successLevel>0&&o.source.system.effectFormula!=""){let t=o.source.system.effectFormula.replace(game.i18n.localize("dsk.CHARAbbrev.QS"),e.qualityStep).replace(/[Ww]/g,"d"),a=[];for(let n of o.situationalModifiers)n.armorPen&&a.push(n.armorPen);/(,|;)/.test(t)&&(t=t.split(/[,;]/)[e.qualityStep-1]);let s=o.damageRoll?Roll.fromData(o.damageRoll):await _DiceDSK.manualRolls(await new Roll(t).evaluate({async:!0}),"dsk.CHAR.DAMAGE",o.extra.options);this._addRollDiceSoNice(o,s,game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),e.calculatedEffectFormula=t;for(let n of s.terms)if(n instanceof Die||n.class=="Die")for(let l of n.results)e.characteristics.push({char:"effect",res:l.result,die:"d"+n.faces});let i=[],r=await _DiceDSK._stringToRoll(o.extra.actor.system.spellStats.damage,o);r!=0&&i.push(game.i18n.localize("dsk.statuseffects")+" "+r),e.armorPen=a,e.damageRoll=damageRoll.toJSON(),e.damage=s.total+r,e.damagedescription=i.join(`
`)}return this.calculateEnergyCost(e,o),e}static calculateEnergyCost(o,e){let t=[];if(o.successLevel<0){let n=["traditionWitch","traditionFjarning","braniborian"].map(c=>game.i18n.localize(`dsk.LocalizedIDs.${c}`)),l=e.extra.actor.items.some(c=>c.type=="specialability"&&n.includes(c.name))?3:2;o.preData.calculatedSpellModifiers.finalcost=Math.round(o.preData.calculatedSpellModifiers.finalcost/l)}let a="AePCost",s=game.i18n.localize("dsk.LocalizedIDs.weakAstralBody"),i=game.i18n.localize(`dsk.LocalizedIDs.${o.successLevel>0?"energyControl":"smallEnergyControl"}`),r={val:"aepModifier",name:"AeP"};t.push({name:s,value:E.vantageStep(e.extra.actor,s)},{name:i,value:x.abilityStep(e.extra.actor,i)*-1},{name:`${game.i18n.localize("dsk.statuseffects")} (${game.i18n.localize("dsk.CHARAbbrev."+r.name)})`,value:e.extra.actor.system[r.val]+this._situationalModifiers(e,a)}),t=t.filter(n=>n.value!=0),o.preData.calculatedSpellModifiers.description=t.map(n=>`${n.name} ${n.value}`).join(`
`),o.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(o.preData.calculatedSpellModifiers.finalcost)+t.reduce((n,l)=>n+l.value,0))}static async _stringToRoll(o,e){let t=[],a=/\d{1}[dDwW]\d/g,s=`${o}`;s.replace(a,function(n){t.push(new Roll(n.replace(/[Ww]/,"d")).evaluate({async:!0}))});let i=await Promise.all(t),r=s.replace(a,()=>{let n=i.shift();return e&&_DiceDSK._addRollDiceSoNice(e,n,game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),n.total});return await Roll.safeEval(r)}static async detailedWeaponResult(o,e,t){if(e.mode=="attack")switch(o.successLevel){case 2:o.description+=ee.defaultAttackCrit(!0),o.doubleDamage=!0;break;case-2:let a=t.type=="meleeweapon"||getProperty(t,"system.traitType")=="meleeAttack",s=getProperty(t,"system.combatskill")==game.i18n.localize("dsk.LocalizedIDs.wrestle")||t.type=="trait";a?o.description+=ee.rollCritBotchButton("Melee",s,e):o.description+=ee.rollCritBotchButton("Range",!1,e);break}}static async evaluateDamage(o,e,t,a,s){let i=t.system.tp.replace(/[Ww]/g,"d"),r=[],n=t.dmgMultipliers||[],l=n.map(g=>`${g.name} *${g.val}`),c=[],u=0;for(let g of o.situationalModifiers){let y=0;if(g.armorPen&&c.push(g.armorPen),g.damageBonus){if(/^\*/.test(g.damageBonus)){n.push({name:g.name,val:Number(g.damageBonus.replace("*",""))});continue}let v=/^=/.test(g.damageBonus),k=`${g.damageBonus}`.replace(/^=/,""),I=await _DiceDSK._stringToRoll(k,o);if(y=I*(g.step||1),v){i=k.replace(/[Ww]/,"d"),r.push({name:g.name,roll:I});continue}else g.damageBonus=I,u+=y}}let d=o.damageRoll?Roll.fromData(o.damageRoll):await _DiceDSK.manualRolls(await new Roll(i).evaluate({async:!0}),"dsk.damage",o.extra.options),p=d.total,f=0;for(let g of d.terms)if(g instanceof Die||g.class=="Die")for(let y of g.results)f+=Number(y.result),e.characteristics.push({char:"damage",res:y.result,die:"d"+g.faces});let b=p-f;if(r.length>0)l.push(r[0].name+" "+p);else{p+=u,l.push(game.i18n.localize("dsk.Roll")+" "+f),b!=0&&l.push(game.i18n.localize("dsk.weaponModifier")+" "+b),o.situationalModifiers.reduce((v,k)=>{if(k.damageBonus){let I=/^\*/.test(k.damageBonus)?k.damageBonus:Number(k.damageBonus)*(k.step||1);l.push(`${k.name} ${I}`)}},l),o.situationalModifiers.find(v=>v.name.indexOf(game.i18n.localize("dsk.CONDITION.bloodrush"))>-1)&&(p+=2,l.push(game.i18n.localize("dsk.CONDITION.bloodrush")+" "+2)),t.extraDamage&&(p=Number(t.extraDamage)+Number(p),l.push(game.i18n.localize("dsk.damageThreshold")+" "+t.extraDamage));let g;if(a){let v=w.rangeMods[o.rangeModifier||"medium"].damage;p+=v,v!=0&&l.push(game.i18n.localize("dsk.distance")+" "+v),g=o.extra.actor.system.rangeStats.damage}else g=o.extra.actor.system.meleeStats.damage;let y=await _DiceDSK._stringToRoll(g,o);y!=0&&(p+=y,l.push(game.i18n.localize("dsk.statuseffects")+" "+y))}let T=game.i18n.localize("dsk.LocalizedIDs.feint");e.qualityStep>0&&!o.situationalModifiers.find(g=>g.name==T)&&(p+=e.qualityStep,l.push(game.i18n.localize("dsk.qualityStep")+" "+e.qualityStep)),s&&(p=p*3,l.push(game.i18n.localize("dsk.doubleDamage")));for(let g of n)p=p*g.val;e.armorPen=c,e.damagedescription=l.join(", "),e.damage=Math.round(p),e.damageRoll=d.toJSON()}static parseEffect(o){let e=o.system.effect?o.system.effect:void 0,t=[];if(e){let s=/^[a-z]+\|[a-zA-z ]+$/;for(let i of e.split(";"))if(s.test(i.trim())){let r=i.split("|").map(n=>n.trim());if(r[0]=="condition"){let n=CONFIG.statusEffects.find(l=>l.id==r[1]);t.push(`<a class="chat-condition chatButton" data-id="${n.id}">
                            <img src="${n.icon}"/>${game.i18n.localize(n.name)}
                            </a>`)}else t.push(`<a class="roll-button roll-item" data-name="${r[1]}" data-type="${r[0]}"><i class="fas fa-dice"></i>${game.i18n.localize(r[0])}: ${r[1]}</a>`)}}let a=getProperty(o,"flags.dsk.poison");return a&&t.push(`<a class="roll-button roll-item" data-removecharge="${!a.permanent}" data-name="${a.name}" data-type="poison"><i class="fas fa-dice"></i>${game.i18n.localize("TYPES.Item.poison")}: ${a.name}</a>`),t.join(", ")}static async _roll2D20(o){let e=o.roll?Roll.fromData(o.roll):await new Roll("1d20+1d20").evaluate({async:!0}),t=[],a=0;if(o.testDifficulty&&this._appendSituationalModifiers(o,game.i18n.localize("dsk.Difficulty"),o.testDifficulty),o.vw){let f=o.situationalModifiers.reduce((T,g)=>T+(Number(g.dmmalus)||0),0),b=Math.max(0,Number(o.vw)-f);this._appendSituationalModifiers(o,game.i18n.localize("dsk.ABBR.VW"),-1*b)}let s=this._situationalModifiers(o),i=this._situationalPartCheckModifiers(o,"TPM"),r=o.source.attack||Number(o.source.system.at);r||(o.source.system.level==null?r=-5+o.extra.actor.system.characteristics[o.source.system.characteristic1].value+o.extra.actor.system.characteristics[o.source.system.characteristic2].value:r=o.source.system.level+5+Math.round((o.extra.actor.system.characteristics[o.source.system.characteristic1].value+o.extra.actor.system.characteristics[o.source.system.characteristic2].value)/2));let n=r+this._situationalModifiers(o,"FW")+i[0]+i[1]+s;o.advancedModifiers&&(n+=o.advancedModifiers.fws+o.advancedModifiers.chars[0]+o.advancedModifiers.chars[1]);let l=n-e.terms[0].results[0].result-e.terms[2].results[0].result,c=1,u=20;if(o.source.type=="skill"&&E.hasVantage(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.incompetent")} (${o.source.name})`)){let f=await new Roll("1d20").evaluate({async:!0}),b=res.reduce((g,y,v,k)=>y<k[g]?v:g,0),T=e.terms[b*2].total;l+=Math.max(res[b],0),l-=Math.max(0,f.total-tar[b]),e.editRollAtIndex([{index:b,val:f.total}]),this._addRollDiceSoNice(o,f,e.terms[b*2].options),t.push(game.i18n.format("dsk.CHATNOTIFICATION.unableReroll",{die:b+1,oldVal:T,newVal:f.total}))}let d=0;o.source.type=="skill"&&ce.hasTrait(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.automaticSuccess")} (${o.source.name})`)?(t.push(game.i18n.localize("dsk.LocalizedIDs.automaticSuccess")),a=1,d=1):o.source.type=="skill"&&ce.hasTrait(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.automaticFail")} (${o.source.name})`)?(t.push(game.i18n.localize("dsk.LocalizedIDs.automaticFail")),a=-1):(a=_DiceDSK.get2D20SuccessLevel(e,l,u,c),o.routine&&(a=1),t.push(_DiceDSK.getSuccessDescription(a))),t=t.join(", ");let p=0;return a>0&&(l+=this._situationalModifiers(o,"FP"),p=Math.max(1,(l==0?1:l>0?Math.ceil(l/5):0)+(o.qualityStep!=null?Number(o.qualityStep):0))+(o.advancedModifiers?.qls||0)+this._situationalModifiers(o,"QL")),p<d&&(p=d),{result:l,characteristics:[0,1].map(f=>({char:o.source.system[`characteristic${f+1}`]||o.source.type,res:e.terms[f*2].results[0].result,tar:o.extra.actor?.system.characteristics[o.source.system[`characteristic${f+1}`]]?.value})),qualityStep:p,pw:n,roll:e,description:t,preData:o,successLevel:a,modifiers:s,extra:{}}}static async renderRollCard(chatOptions,testData,rerenderMessage){let applyEffect=this.addApplyEffectData(testData),preData=deepClone(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:preData.mode=="attack";await Hooks.call("postProcessDSKRoll",chatOptions,testData,rerenderMessage,hideDamage),delete preData.extra.actor,delete testData.actor,delete testData.preData;let hasAreaTemplate=testData.successLevel>0&&preData.source.system.target&&preData.source.system.target.type in game.dsk.config.areaTargetTypes,chatData={title:chatOptions.title,testData,hideData:game.user.isGM,preData,hideDamage,modifierList:preData.situationalModifiers.filter(o=>o.value!=0),applyEffect,hasAreaTemplate};if(preData.advancedModifiers&&(preData.advancedModifiers.chars.some(o=>o!=0)&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.partChecks"),value:preData.advancedModifiers.chars}),preData.advancedModifiers.fws!=0&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.FW"),value:preData.advancedModifiers.fws}),preData.advancedModifiers.qls!=0&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter(o=>o.isGM).map(o=>o.id)),chatOptions.rollMode==="blindroll"?chatOptions.blind=!0:chatOptions.rollMode==="selfroll"&&(chatOptions.whisper=[game.user.id]),K.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSKRoll:!0},rerenderMessage){let html=await renderTemplate(chatOptions.template,chatData),actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.user).character,rollData=actor?actor.getRollData():{},enriched=await TextEditor.enrichHTML(html,{rollData,async:!0});chatOptions.content=enriched;let postFunction=getProperty(rerenderMessage,"flags.data.preData.extra.options.postFunction");postFunction&&(testData.messageId=rerenderMessage.id,eval(postFunction.functionName)(postFunction,{result:testData},preData.source));let newMsg=await rerenderMessage.update({content:chatOptions.content,["flags.data"]:chatOptions["flags.data"]});return ui.chat.updateMessage(newMsg),newMsg}else return chatOptions.content=await renderTemplate(chatOptions.template,chatData),await ChatMessage.create(chatOptions,!1)}static addApplyEffectData(o){let e=o.preData.source;if(["ahnengabe","meleeweapon","rangeweapon"].includes(e.type)){if(o.successLevel>0&&e.effects.length>0)return!0}else{if(["poison"].includes(e.type))return e.effects.length>0;if(e.type=="trait"&&e.effects.length>0&&o.successLevel>0)return!0}let t=o.preData.situationalModifiers.filter(a=>a.specAbId).map(a=>a.specAbId);if(t.length>0){let a=o.preData.extra.actor.items.filter(s=>t.includes(s._id));for(let s of a)if(s.effects.length>0)return!0}return!1}static getSuccessDescription(o){return game.i18n.localize(["dsk.CriticalFailure","dsk.Failure","","dsk.Success","dsk.CriticalSuccess"][o+2])}static async showDiceSoNice(o,e){if(h.moduleEnabled("dice-so-nice")){let t=null,a=!1;switch(e){case"blindroll":a=!0,t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"gmroll":t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"selfroll":t=[];break}let s=game.dice3d.showForRoll(o,game.user,!0,t,a);game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")||await s}}static async manualRolls(o,e="",t={}){if(t.cheat||game.settings.get("dsk","allowPhysicalDice"))if(t.predefinedResult)o.editRollAtIndex(t.predefinedResult);else{let a=!1,s,i=[];for(let n of o.terms)if(n instanceof Die||n.class=="Die")for(let l of n.results)i.push({faces:n.faces,val:l.result});let r=await renderTemplate("systems/dsk/templates/dialog/manualroll-dialog.html",{dice:i,description:e});if([a,s]=await new Promise((n,l)=>{new q({title:game.i18n.localize(t.cheat?"dsk.DIALOG.cheat":"dsk.SETTINGS.allowPhysicalDice"),content:r,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:c=>{n([!0,c])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{n([!1,0])}}}}).render(!0)}),a){let n=[];s.find(".dieInput").each(function(l){let c=Number($(this).val());c>0&&n.push({val:c,index:l}),l++}),o.editRollAtIndex(n)}}return o}static _getNarrowSpaceModifier(o,e){return e.narrowSpace?game.i18n.localize("dsk.LocalizedIDs.Shields")==o.system.combatskill?w.narrowSpaceModifiers["shield"+o.system.shieldsize][e.mode]:w.narrowSpaceModifiers["weapon"+o.system.rw][e.mode]:0}static async rollCombatTrait(o){let e=o.source,t=e.system.traitType=="meleeAttack",a=e;t?this._appendSituationalModifiers(o,game.i18n.localize("dsk.narrowSpace"),this._getNarrowSpaceModifier(a,o)):this._appendSituationalModifiers(o,game.i18n.localize("dsk.distance"),w.rangeMods[o.rangeModifier||"medium"].attack);let s=await this._roll2D20(o);await this.detailedWeaponResult(s,o,e),o.mode=="attack"&&s.successLevel>0&&await _DiceDSK.evaluateDamage(o,s,a,!t,s.doubleDamage),s.rollType="weapon";let i=_DiceDSK.parseEffect(a);return i&&(s.parsedEffect=i),s}static async rollWeapon(o){let e,t=o.source,a=o.extra.actor,s=t.system.combatskill,i=D._calculateCombatSkillValues(a.items.find(c=>c.type=="combatskill"&&c.name==s),a.system),r=t.type=="meleeweapon";r?(e=D._prepareMeleeWeapon(t,[i],o.extra.actor),this._appendSituationalModifiers(o,game.i18n.localize("dsk.narrowSpace"),this._getNarrowSpaceModifier(e,o))):(e=D._prepareRangeWeapon(t,[],[i],o.extra.actor),this._appendSituationalModifiers(o,game.i18n.localize("dsk.distance"),w.rangeMods[o.rangeModifier||"medium"].attack));let n=await this._roll2D20(o);await this.detailedWeaponResult(n,o,t),o.mode=="attack"&&n.successLevel>0&&await _DiceDSK.evaluateDamage(o,n,e,!r,n.doubleDamage),n.rollType="weapon";let l=_DiceDSK.parseEffect(e);return l&&(n.parsedEffect=l),n}static async rollRegeneration(o){let e=this._situationalModifiers(o),t=o.roll,a=[],s={rollType:"regenerate",preData:o,modifiers:e,extra:{}},i=[];o.regenerateLeP&&i.push("LeP"),o.extra.actor.system.isMage&&o.regenerateAeP&&i.push("AeP");let r=0;if(o.extra.actor.effects.some(l=>l.statuses.includes("sick"))){this._appendSituationalModifiers(o,game.i18n.localize("dsk.CONDITION.sick"),"*0");for(let l of i)a.push({char:l,res:0,die:"d6"}),s[l]=0,r+=2}else for(let l of i)this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.regeneration${l}`),E.vantageStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.regeneration${l}`)),l),this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.weakRegeneration${l}`),E.vantageStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.weakRegeneration${l}`))*-1,l),this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.advancedRegeneration${l}`),x.abilityStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.advancedRegeneration${l}`)),l),this._appendSituationalModifiers(o,`${game.i18n.localize(`CHARAbbrev.${l}`)} ${game.i18n.localize("dsk.Modifier")}`,o[`${l}Modifier`],l),this._appendSituationalModifiers(o,`${game.i18n.localize(`CHARAbbrev.${l}`)} ${game.i18n.localize("dsk.regenerate")}`,o[`regeneration${l}`],l),a.push({char:l,res:t.terms[r].results[0].result,die:"d6"}),s[l]=Math.round(Math.max(0,Number(t.terms[r].results[0].result)+Number(e)+this._situationalModifiers(o,l))*Number(o.regenerationFactor)),r+=2;return s.characteristics=a,s}static async rollDices(o,e){if(!o.roll){let t=game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration,a;switch(o.source.type){case"char":case"ahnengabe":case"skill":a=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t(o.source.system.characteristic1)),mergeObject(a.dice[1].options,t(o.source.system.characteristic2));break;case"regenerate":let s=[];o.regenerateLeP&&s.push("1d6"),o.extra.actor.isMage&&o.regenerateAeP&&s.push("1d6"),a=await new Roll(s.join("+")).evaluate({async:!0}),o.regenerateLeP&&mergeObject(a.dice[0].options,t("mu")),o.extra.actor.isMage&&o.regenerateAeP&&mergeObject(a.dice[s.length-1].options,t("ge"));break;case"meleeweapon":case"rangeweapon":case"combatskill":if(o.mode=="damage"){let r=await this.damageFormula(o);a=await new Roll(r).evaluate({async:!0});for(let n=0;n<a.dice.length;n++)mergeObject(a.dice[n].options,t("damage"))}else a=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t("attack")),mergeObject(a.dice[1].options,t("attack"));break;case"trait":if(o.mode=="damage"){let r=await this.damageFormula(o);a=await new Roll(r).evaluate({async:!0});for(let n=0;n<a.dice.length;n++)mergeObject(a.dice[n].options,t("damage"))}else a=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t("attack")),mergeObject(a.dice[1].options,t("attack"));break;case"poison":case"disease":let i=t("in");a=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,i),mergeObject(a.dice[1].options,i);break;default:console.error("Unexpected roll mode")}a=await _DiceDSK.manualRolls(a,o.source.type,o.extra.options),await this.showDiceSoNice(a,e.rollMode),o.roll=duplicate(a),o.rollMode=e.rollMode}return o}static async rollItem(o){o.source.attack=20+2*o.source.system.level;let e=await this._roll2D20(o);switch(o.source.type){case"poison":let t=o.source.system.duration.split(" / ").map(s=>s.trim()),a=o.source.system.effect.split(" / ").map(s=>s.trim());e.duration=t.length>1?e.successLevel>0?t[0]:t[1]:t[0],e.effect=a.length>1?e.successLevel>0?a[0]:a[1]:a[0];break;case"disease":break}return e}static async damageFormula(o){let e;if(o.source.type=="meleeweapon"){let t=D._calculateCombatSkillValues(o.extra.actor.items.find(a=>a.type=="combatskill"&&a.name==o.source.system.combatskill),o.extra.actor.system);e=D._prepareMeleeWeapon(o.source,[t],o.extra.actor)}else if(o.source.type=="rangeweapon"){let t=D._calculateCombatSkillValues(o.extra.actor.items.find(a=>a.type=="combatskill"&&a.name==o.source.system.combatskill),o.extra.actor.system);e=D._prepareRangeWeapon(o.source,[],[t],o.extra.actor)}else e=o.source.system;return o.source.system.tp.replace(/[Ww]/g,"d")+`+${e.extraDamage||0}`}static async rollDamage(o){let e=this._situationalModifiers(o),t=[],a=o.roll,s=a.total+e;for(let i of a.terms)if(i instanceof Die||i.class=="Die")for(let r of i.results)t.push({char:o.mode,res:r.result,die:"d"+i.faces});return{rollType:"damage",damage:s,characteristics:t,preData:o,modifiers:e,extra:{}}}static async _rollEdit(o){let e=$(o.currentTarget),t=e.parents(".message").attr("data-message-id"),a=game.messages.get(t),s=a.flags.data,i=s.preData;i.extra.actor=h.getSpeaker(i.extra.speaker).toObject(!1),i.extra.options.cheat&&delete i.extra.options.cheat;let r;switch(e.attr("data-edit-type")){case"roll":r=e.attr("data-edit-id");let l=Number(e.val());if(i.roll.terms.length>r*2){let u=Roll.fromData(i.roll);u.editRollAtIndex([{index:r,val:l}]),i.roll=u}else{let u=Roll.fromData(s.postData.damageRoll);r=r-i.roll.terms.filter(d=>d.results).length,u.editRollAtIndex([{index:r,val:l}]),i.damageRoll=u}break;case"mod":r=i.situationalModifiers.findIndex(u=>u.name==game.i18n.localize("dsk.chatEdit")),r>0&&i.situationalModifiers.splice(r,1);let c={name:game.i18n.localize("dsk.chatEdit"),value:Number(e.val())-this._situationalModifiers(i)};i.situationalModifiers.push(c);break}let n={template:s.template,rollMode:s.rollMode,title:s.title,speaker:a.speaker,user:a.user.id};["gmroll","blindroll"].includes(n.rollMode)&&(n.whisper=game.users.filter(l=>l.isGM).map(l=>l.id)),n.rollMode==="blindroll"&&(n.blind=!0),["poison","disease"].includes(i.source.type)?new C(i.source,{temporary:!0})[`${s.postData.postFunction}`]({testData:i,cardOptions:n},{rerenderMessage:a}):h.getSpeaker(a.speaker)[`${s.postData.postFunction}`]({testData:i,cardOptions:n},{rerenderMessage:a})}static async chatListeners(o){o.on("click",".expand-mods",e=>{e.preventDefault();let t=$(e.currentTarget);t.find("i").toggleClass("fa-minus fa-plus"),t.siblings("ul,div").fadeToggle()}),o.on("click",".edit-toggle",e=>{e.preventDefault(),$(e.currentTarget).parents(".chat-card").find(".display-toggle").toggle()}),o.on("click",".botch-roll",e=>ee.showBotchCard(e.currentTarget.dataset)),o.on("click",".roll-item",e=>_DiceDSK._itemRoll(e)),o.on("change",".roll-edit",e=>_DiceDSK._rollEdit(e)),o.on("click",".applyEffect",async e=>{_DiceDSK.wrapLock(e,async(t,a)=>{let s=a.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await W.applyEffect(s,i)})}),o.on("click",".applyTableEffect",async e=>{_DiceDSK.wrapLock(e,async(t,a)=>{let s=a.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await TableEffects.applyEffect(s,i)})}),o.on("click",".placeTemplate",async e=>MeasuredTemplateDSK.placeTemplateFromChat(e)),o.on("click",".resistEffect",e=>W.resistEffect(e)),o.on("click",".resistPain",e=>_DiceDSK.rollResistPain(e)),X.chatListeners(o)}};m(_DiceDSK,"DiceDSK");Hooks.once("ready",async()=>{if(!M.creatureData){let o=await fetch(`systems/dsk/lazy/creaturetype/${game.i18n.lang}.json`);M.creatureData=await o.json(),M.magical=game.i18n.localize("dsk.WEAPON.magical"),M.clerical=game.i18n.localize("dsk.WEAPON.clerical"),M.silverPlated=game.i18n.localize("dsk.WEAPON.silverPlated"),game.dsk.apps.CreatureType=M}});var os=m(o=>!(!o||o.length===0),"isNotEmpty"),se=class{constructor(e){this.creatureClass=e,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}static detectCreatureType(e){let t=e.system.details.species;return Object.keys(se.creatureData.types).filter(s=>t.indexOf(s)>=0).map(s=>this.getClass(se.creatureData.types[s],t))}static getClass(e,t){let a={DemonType:pt,ChimeraType:dt,DaimonidType:mt,DragonType:ut,ElementalType:ft,FairyType:gt,GhostType:ht,GolemType:yt,HomunculiType:kt,IntelligentCreatureType:bt,PlantType:wt,AnimalType:vt,UndeadType:Tt,SupernaturalType:St,MagicalConstructType:Ct,WerCreatureType:Mt,VampireType:Dt}[e];return new a(t)}static creatureTypeName(e){if(e.type=="creature"){let t=e.system.species;return Object.keys(se.creatureData.types).filter(a=>t.indexOf(a)>=0)[0]}else return e.system.details.species}static addCreatureTypeModifiers(e,t,a,s){let i=se.detectCreatureType(e),r=["spell","ceremony","liturgy","ritual"].includes(t.type);for(let n of i){let l=n.damageModifier(t);if(r)for(let c of l)c.armorPen=n.spellResistanceModifier(e);a.push(...l)}a.push(...this.creatureBonusDamage(e,s)),se.addVulnerabilitiesToSource(e,t,a)}static addVulnerabilitiesToSource(e,t,a){let s=getProperty(e,"system.vulnerabilities");s&&["meleeweapon","rangeweapon"].includes(t.type)&&getProperty(s,"combatskill").reduce((r,n)=>{if(n.target==t.system.combatskill){let c=(/\*/.test(n.value)?Number(n.value.replace("*",""))>1:Number(n.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";a.push(...se.buildDamageMod(`${game.i18n.format(c,{name:t.system.combatskill})} (${n.source})`,n.value))}},a)}ignoredCondition(e){return!1}damageModifier(e){return[]}static creatureBonusDamage(e,t){let a=[],s=e.system.details.species,i=getProperty(t,"system.creatureBonus");for(let r of i)s.indexOf(r.target)>=0&&a.push(...this.buildDamageMod(r.source,r.value,!0));return a}spellImmunity(e){return this.spellImmunities.some(t=>e.includes(t))}spellArmorModifier(e){return 0}poisonImmunity(){return this.poisonImmunity}diseaseImmunity(){return this.diseaseImmunity}spellResistanceModifier(e){return 0}static buildDamageMod(e,t,a=!0){return[{name:e,value:t,selected:a,type:"dmg",source:game.i18n.localize("dsk.target")}]}weaponAttributes(e){return getProperty(e,"system.effect.attributes")||""}getTypeByClass(e){return Object.keys(se.creatureData.types).find(t=>se.creatureData.types[t]===e)}isAttackItem(e){return["meleeweapon","trait","rangeweapon"].includes(e.type)&&os(this.weaponAttributes(e))}attributesRegex(e){let t=this.weaponAttributes(e);return new RegExp(`(${t.split(",").map(a=>h.escapeRegex(a.split("(")[0].trim())).join("|")})`,"i")}},M=se;m(M,"CreatureType"),z(M,"creatureData"),z(M,"magical"),z(M,"clerical");var $e=class extends M{damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfLife){let s=`${M.clerical} (${a})`;if(t.test(s))return M.buildDamageMod(s,"*2")}}return super.damageModifier(e)}};m($e,"VulnerableToLifeGods");var dt=class extends $e{};m(dt,"ChimeraType");var mt=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation"].map(t=>game.i18n.localize(`Features.${t}`))}damageModifier(e){return this.isAttackItem(e)&&this.attributesRegex(e).test(M.clerical)?M.buildDamageMod(M.clerical,"*2"):super.damageModifier(e)}};m(mt,"DaimonidType");var ut=class extends M{};m(ut,"DragonType");var pt=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);if(t.test(M.clerical))return M.buildDamageMod(`${M.clerical} (${M.creatureData.opposingGod})`,"*2",!1);if(t.test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("DemonType"),"*0.5")}spellArmorModifier(e){return Number(e.system.stats.soulpower.max)}spellResistanceModifier(e){return Number(e.system.stats.soulpower.max)}ignoredCondition(e){return!0}};m(pt,"DemonType");var ft=class extends M{constructor(e){super(e),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*1");return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*0.5")}spellArmorModifier(e){return Number(e.system.stats.soulpower.max)}spellResistanceModifier(e){return Number(e.system.stats.soulpower.max)}ignoredCondition(e){return!0}};m(ft,"ElementalType");var gt=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}};m(gt,"FairyType");var ht=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion","Healing","Telekinesis","Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfDeath){let s=`${M.clerical} (${a})`;if(t.test(s))return[]}if(t=this.attributesRegex(e),t.test(M.clerical))return M.buildDamageMod(M.clerical,"*0.5");if(t.test(M.magical))return M.buildDamageMod(M.magical,"*0.5")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(M.magical,"*0.5");return M.buildDamageMod(this.getTypeByClass("GhostType"),"*0")}ignoredCondition(e){return!["feared","inpain","confused"].includes(e)}};m(ht,"GhostType");var yt=class extends $e{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["confused","paralysed"].includes(e)}};m(yt,"GolemType");var kt=class extends $e{constructor(e){super(e),this.spellImmunities=["Healing"].map(t=>game.i18n.localize(`Features.${t}`))}ignoredCondition(e){return!["inpain","encumbered","stunned","feared","paralysed","confused"].includes(e)}};m(kt,"HomunculiType");var bt=class extends M{};m(bt,"IntelligentCreatureType");var wt=class extends M{};m(wt,"PlantType");var vt=class extends M{};m(vt,"AnimalType");var Tt=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfDeath){let s=`${M.clerical} (${a})`;if(t.test(s))return M.buildDamageMod(s,"*2")}}return super.damageModifier(e)}ignoredCondition(e){return!["paralysed"].includes(e)}};m(Tt,"UndeadType");var St=class extends M{};m(St,"SupernaturalType");var Ct=class extends M{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["stunned","feared","paralysed","confused"].includes(e)}};m(Ct,"MagicalConstructType");var Mt=class extends M{damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.silverPlated))return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*2")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*0.5")}};m(Mt,"WerCreatureType");var Dt=class extends M{damageModifier(e){return["spell","ceremony","liturgy","ritual"].includes(e.type)?super.damageModifier(e):M.buildDamageMod(this.getTypeByClass("VampireType"),"*0.5")}};m(Dt,"VampireType");var C=class extends Item{static defaultImages(e,t=""){let a=`${e}${t}`;return{effectwrapper:"icons/svg/aura.svg",information:"systems/dsk/icons/categories/DSK-Auge.webp",ammunition:"systems/dsk/icons/categories/arrow.webp",equipment:"systems/dsk/icons/categories/equipment.webp",advantage:"systems/dsk/icons/categories/advantage.webp",disadvantage:"systems/dsk/icons/categories/disadvantage.webp",specialability:"systems/dsk/icons/categories/specialability.webp",combatskill:"systems/dsk/icons/categories/combatskill.webp",ahnengabe:"systems/dsk/icons/categories/ahnengabe.webp",armor:"systems/dsk/icons/categories/armor.webp",rangeweapon:"systems/dsk/icons/categories/rangeweapon.webp",meleeweapon:"systems/dsk/icons/categories/meleeweapon.webp",ahnengeschenk:"systems/dsk/icons/categories/ahnengeschenk.webp",culture:"systems/dsk/icons/categories/culture.webp",profession:"systems/dsk/icons/categories/profession.webp",poison:"systems/dsk/icons/categories/poison.webp",trait:"systems/dsk/icons/categories/trait.webp",consumable:"systems/dsk/icons/categories/consumable.webp"}[a]}static defaultIcon(e){(!e.img||e.img=="")&&(e.img=this.defaultImages(e.type)||"systems/dsk/icons/blank.webp")}setupEffect(e,t={},a){return C.getSubClass(this.type).setupDialog(e,t,this,a)}async itemTest({testData:e,cardOptions:t},a={}){e=await _DiceDSK.rollDices(e,t);let s=await _DiceDSK.rollTest(e);if(s.postFunction="itemTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("dsk.Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}return a.suppressMessage||_DiceDSK.renderRollCard(t,s,a.rerenderMessage),{result:s,cardOptions:t}}static attackStatEffect(e,t){t!=0&&e.push({name:game.i18n.localize("dsk.statuseffects"),value:t,selected:!0})}static prepareRangeAttack(e,t,a,s,i,r,n=void 0){e.push(...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.restrictedSenseSight"),-2)),this.getCombatSkillModifier(t,s,e);let l=this.getTargetSizeAndModifier(t,s,e,a),c=Number(t.system.rangeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("dsk.statuseffects")} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0});let u={...w.rangeWeaponModifiers};delete u[E.hasVantage(t,game.i18n.localize("dsk.LocalizedIDs.senseOfRange"))?"long":"rangesense"],x.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.extremeShot"))||delete u.extreme;let p=x.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.drivingArcher"))?duplicate(w.drivingArcherOptions):duplicate(w.mountedRangeOptions);mergeObject(a,{rangeOptions:u,rangeDistance:Object.keys(u)[U.distanceModifier(game.canvas.tokens.get(i),s,n)],sizeOptions:w.rangeSizeCategories,visionOptions:w.rangeVision,mountedOptions:p,shooterMovementOptions:w.shooterMovementOptions,targetMovementOptions:w.targetMomevementOptions,targetSize:l,combatSpecAbs:r,aimOptions:w.aimOptions})}async addCondition(e,t=1,a=!1,s=!0){return await O.addCondition(this,e,t,a,s)}async removeCondition(e,t=1,a=!0,s=!1){return O.removeCondition(this,e,t,a,s)}hasCondition(e){return O.hasCondition(this,e)}static async _onCreateDocuments(e,t){for(let a of e)a.actor&&await D.postUpdateConditions(a.actor);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)a.actor&&await D.postUpdateConditions(a.actor);return super._onUpdateDocuments(e,t)}static async _onDeleteDocuments(e,t){for(let a of e)a.actor&&await D.postUpdateConditions(a.actor);return super._onDeleteDocuments(e,t)}static prepareMeleeAttack(e,t,a,s,i,r){let n="short";game.user.targets.forEach(u=>{if(u.actor){let d=u.actor.items.filter(p=>p.type=="meleeweapon"&&p.system.worn.value||p.type=="trait"&&p.system.traitType=="meleeAttack"&&p.system.pa);d.length>0&&(n=d[0].system.rw)}});let l=this.getTargetSizeAndModifier(t,s,e,a);this.getCombatSkillModifier(t,s,e);let c=Number(t.system.meleeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("dsk.statuseffects")} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0}),mergeObject(a,{visionOptions:w.meleeRangeVision(),weaponSizes:w.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:n,combatSpecAbs:i,meleeSizeOptions:w.meleeSizeCategories,targetSize:l,constricted:t.hasCondition("constricted"),wrongHandDisabled:r,offHand:!r&&getProperty(s,"system.worn.offHand")})}static parseValueType(e,t){let a="";return/^\*/.test(t)&&(a="*",t=t.substring(1).replace(",",".")),{name:e,value:Number(t),type:a}}static getSpecAbModifiers(e,t){let a=[];for(let s of e.find(".specAbs")){let i=Number($(s).attr("data-step"));if(i>0){let r=t=="attack"?$(s).attr("data-atbonus"):$(s).attr("data-pabonus"),n=r.split(",").reduce((l,c)=>l+Number(c),0);a.push({name:$(s).find("a").text(),value:isNaN(n)?Number(r.replace("*","")):Number(n)*i,damageBonus:$(s).attr("data-tpbonus"),dmmalus:$(s).attr("data-dmmalus")*i,step:i,specAbId:$(s).attr("data-id"),type:/^\*/.test(r)?"*":void 0})}}return a}static getTargetSizeAndModifier(e,t,a,s){let i="average",r=0;return game.user.targets.forEach(n=>{if(n.actor){let l=getProperty(n.actor,"system.details.size");l&&(i=l),M.addCreatureTypeModifiers(n.actor,t,a,e),r=Math.max(r,n.actor.system.maxDefense.parry)}}),s.vw=r,i}static getCombatSkillModifier(e,t,a){if(t.type=="trait")return;let s=e.items.find(i=>i.type=="combatskill"&&i.name==t.system.combatskill);for(let i of s.effects)for(let r of i.changes)switch(r.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":a.push({name:`${s.name} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:r.value*-1,type:"defenseMalus",selected:!0});break}}static buildCombatSpecAbs(e,t,a,s){let i;a?(a.push(game.i18n.localize("dsk.LocalizedIDs.all")),a=a.map(p=>p.toLowerCase()),i=m((p,f)=>p.system.combatskills.split(/;|,/).map(b=>b.trim().toLowerCase()).filter(b=>f.includes(b.replace(/ \([a-zA-Z ]*\)/,""))).length>0,"searchFilter")):i=m(()=>!0,"searchFilter");let r=e.items.filter(p=>p.type=="specialability"&&t.includes(p.system.category)&&p.system.effect!=""&&i(p,a)),n=[],l=game.i18n.localize("dsk.LocalizedAbilityModifiers.at"),c=game.i18n.localize("dsk.LocalizedAbilityModifiers.tp"),u=game.i18n.localize("dsk.LocalizedAbilityModifiers.pa"),d=game.i18n.localize("dsk.LocalizedAbilityModifiers.dm");if(s=="attack")for(let p of r){let f=C.parseEffect(p.system.effect,e),b=f[l]||0,T=f[c]||0,g=f[d]||0;if(b!=0||T!=0||g!=0||p.effects.size>0){let y=game.i18n.localize(w.combatSkillSubCategories[p.system.subcategory]);n.push({name:p.name,atbonus:b,tpbonus:T,dmmalus:g,label:`${l}: ${b}, ${c}: ${T}, ${d}: ${g}`,steps:p.system.level,category:{id:p.system.subcategory,css:`ab_${p.system.subcategory}`,name:y},id:p.id,actor:e.id})}}else for(let p of r){let b=C.parseEffect(p.system.effect,e)[u]||0;if(b!=0){let T=game.i18n.localize(w.combatSkillSubCategories[p.system.subcategory]);n.push({name:p.name,pabonus:b,tpbonus:0,dmmalus:0,label:`${u}: ${b}`,steps:p.system.level,category:{id:p.system.category.sub,css:`ab_${p.system.subcategory}`,name:T},id:p.id,actor:e.id})}}return n}_setupCardOptions(e,t,a){let s=ChatMessage.getSpeaker();return{speaker:{alias:s.alias,scene:s.scene},flags:{img:s.token?canvas.tokens.get(s.token).document.img:this.img},title:t,template:e}}static getSkZkModifier(e,t){let a=[],s=[],i=["ahnengabe"].includes(t.type)&&t.system.effectFormula.trim()=="";game.user.targets.size&&game.user.targets.forEach(r=>{if(r.actor){let n=0;i&&(n=M.detectCreatureType(r.actor).reduce((c,u)=>c+u.spellResistanceModifier(r.actor),0)),a.push(r.actor.system.stats.sk.max*-1-n),s.push(r.actor.system.stats.zk.max*-1-n)}}),mergeObject(e,{SKModifier:a.length>0?Math.min(...a):0,ZKModifier:s.length>0?Math.min(...s):0})}static async create(e,t){return this.defaultIcon(e),await super.create(e,t)}static changeChars(e,t,a){e.system.characteristic1=t,e.system.characteristic2=a}static getSubClass(e){return game.dsk.config.ItemSubClasses[e]||C}static areEquals(e,t){return e.type!=t.type?!1:C.getSubClass(e.type).checkEquality(e,t)}static checkEquality(e,t){return t.type==e.type&&e.name==t.name&&e.system.description.value==t.system.description.value}static setupDialog(e,t,a,s,i){return null}static buildSpeaker(e,t){return{token:t,actor:e?e.id:void 0,scene:canvas.scene?canvas.scene.id:null}}static async stackItems(e,t,a){return await C.getSubClass(e.type).combineItem(e,t,a)}static async combineItem(e,t,a){return e=duplicate(e),e.system.quantity+=t.system.quantity,await a.updateEmbeddedDocuments("Item",[e])}static _chatLineHelper(e,t){return`<b>${game.i18n.localize(e)}</b>: ${t||"-"}`}static setupSubClasses(){game.dsk.config.ItemSubClasses={meleeweapon:Ot,rangeweapon:xt,armor:zt,ammunition:Nt,equipment:Pt,species:_t,culture:Rt,profession:Lt,advantage:Qe,disadvantage:Ft,specialability:Ht,ahnengeschenk:jt,ahnengabe:Ee,poison:Bt,skill:Gt,combatskill:qt,effectwrapper:At,information:It,trait:$t,consumable:Et}}static hasSchips(e){return getProperty(e.system,"stats.schips.value")>0}async postItem(){C.getSubClass(this.type)._postItem(this)}static parseEffect(e,t){let a={},s=new RegExp(game.i18n.localize("dsk.CHARAbbrev.GS"),"gi");for(let i of e.split(/,|;/).map(r=>r.trim())){let r=i.replace(/(\s+)/g," ").trim().split(" ");r[0]=r[0].replace(s,t.system.stats.gs.max),r.length==2&&(!isNaN(r[0])||/(=)?[+-]\d([+-]\d)?/.test(r[0])||/(=)?\d[dDwW]\d/.test(r[0])||/=\d+/.test(r[0])||/\*\d(\.\d)*/.test(r[0]))&&(a[r[1].toLowerCase()]==null?a[r[1].toLowerCase()]=[r[0]]:a[r[1].toLowerCase()].push(r[0]))}return a}static chatData(e,t){return[]}static async _postItem(e){let t=duplicate(e),a=getProperty(t,"system.obfuscation.details"),s=getProperty(t,"system.obfuscation.description");mergeObject(t,{properties:a?[]:C.getSubClass(e.type).chatData(duplicate(t.system),e.name),descriptionObfuscated:s}),t.hasPrice="price"in t.system&&!a,t.hasPrice&&t.properties.push(`<b>${game.i18n.localize("dsk.price")}</b>: ${t.system.price}`),e.pack&&(t.itemLink=e.link),t.img.includes("/blank.webp")&&(t.img=null);let i=await renderTemplate("systems/dsk/templates/chat/post-item.html",t),r=h.chatDataSetup(i);ChatMessage.create(r)}};m(C,"ItemDSK");var It=class extends C{static async _postItem(e){let t=await renderTemplate("systems/dsk/templates/chat/informationRequestRoll.html",{item:e}),a=h.chatDataSetup(t);ChatMessage.create(a)}};m(It,"ItemInformation");var At=class extends C{};m(At,"ItemEffectwrapper");var $t=class extends C{static chatData(e,t){let a=[];switch(e.traitType){case"meleeAttack":a=[this._chatLineHelper("dsk.ABBR.AW",e.at),this._chatLineHelper("dsk.damage",e.damage),this._chatLineHelper("dsk.range",e.rw)];break;case"rangeAttack":a=[this._chatLineHelper("dsk.ABBR.AW",e.at),this._chatLineHelper("dsk.damage",e.damage),this._chatLineHelper("dsk.range",e.rw),this._chatLineHelper("dsk.reloadTime",e.lz)];break;case"armor":a=[this._chatLineHelper("dsk.protection",e.damage)];break}return a}static getSituationalModifiers(e,t,a,s,i){s=h.toObjectIfPossible(s);let r=s.system.traitType,n=C.buildCombatSpecAbs(t,["Combat","animal"],void 0,a.mode);a.mode=="attack"&&r=="meleeAttack"?this.prepareMeleeAttack(e,t,a,s,n,!1):a.mode=="attack"&&r=="rangeAttack"&&this.prepareRangeAttack(e,t,a,s,i,n),this.attackStatEffect(e,Number(t.system[r=="meleeAttack"?"meleeStats":"rangeStats"][a.mode]))}static setupDialog(e,t,a,s,i){let r=t.mode,n=a.name+" "+game.i18n.localize("dsk."+r+"test");mergeObject(a.system,{characteristic1:"attack",characteristic2:"attack"});let l={opposable:!0,source:a,mode:r,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}},c=_.multipleDefenseValue(s,a.toObject()),u={rollMode:t.rollMode,mode:r,hasSchips:this.hasSchips(s),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*c})},d=getProperty(a,"system.traitType"),p=s?O.getRollModifiers(s,a,{mode:r}):[];this.getSituationalModifiers(p,s,u,a,i),u.situationalModifiers=p;let f={title:n,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:u,callback:(T,g={})=>(d=="meleeAttack"?Z.resolveMeleeDialog(l,b,T,s,g,c,r):Z.resolveRangeDialog(l,b,T,s,g,c),l.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&s.reduceSchips(0),l.isRangeDefense=u.isRangeDefense,Hooks.call("callbackDialogCombatDSK",l,s,T,a,i),{testData:l,cardOptions:b})},b=s._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:f,testData:l,cardOptions:b})}};m($t,"ItemTrait");var Et=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.consumable.effect",e[`effect${e.qs}`]),this._chatLineHelper("dsk.consumable.ingredients",e.ingredients)]}static consumablePrice(e){let t=`${e.system.price}`.split(";");return Number(t[[e.system.qs]]||t[0])}};m(Et,"ItemConsumable");var Ot=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.damage",e.tp),this._chatLineHelper("dsk.ABBR.awvw",`${e.aw} / ${e.vw}`),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill),this._chatLineHelper("dsk.range",game.i18n.localize(`dsk.Range.${e.rw}`))]}static getSituationalModifiers(e,t,a,s){let i=E.hasVantage(t,game.i18n.localize("dsk.LocalizedIDs.ambidextrous"));s=h.toObjectIfPossible(s);let r=[s.system.combatskill],n=C.buildCombatSpecAbs(t,["Combat"],r,a.mode);a.mode=="attack"&&this.prepareMeleeAttack(e,t,a,s,n,i),this.attackStatEffect(e,Number(t.system.meleeStats[a.mode]))}static setupDialog(e,t,a,s,i){let r=t.mode,n=a.name+" "+game.i18n.localize("dsk."+r+"test"),l=s.items.find(T=>T.type=="combatskill"&&T.name==a.system.combatskill);mergeObject(a.system,{characteristic1:l.system.characteristic1,characteristic2:l.system.characteristic2});let c={opposable:!0,source:a,mode:r,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}},u=_.multipleDefenseValue(s,c.source),d={rollMode:t.rollMode,mode:r,hasSchips:this.hasSchips(s),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*u})},p=s?O.getRollModifiers(s,a,{mode:r}):[];this.getSituationalModifiers(p,s,d,a),d.situationalModifiers=p;let f={title:n,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:d,callback:(T,g={})=>(Z.resolveMeleeDialog(c,b,T,s,g,u,r),c.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&s.reduceSchips(0),Hooks.call("callbackDialogCombatDSK",c,s,T,a,i),c.isRangeDefense=d.isRangeDefense,{testData:c,cardOptions:b})},b=s._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:f,testData:c,cardOptions:b})}};m(Ot,"ItemMeleeweapon");var xt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.damage",e.tp),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill),this._chatLineHelper("dsk.range",e.rw)]}static getSituationalModifiers(e,t,a,s,i){if(a.mode=="attack"){let r=h.toObjectIfPossible(s),n=[r.system.combatskill],l=C.buildCombatSpecAbs(t,["Combat"],n,a.mode),c=t.items.get(r.system.currentAmmo);if(c){c=c.toObject(!1);let u=getProperty(c.flags,"dsk.poison");u&&mergeObject(s.flags,{dsk:{poison:u}})}if(this.prepareRangeAttack(e,t,a,r,i,l,c),c){if(c.system.atmod&&e.push({name:`${c.name} - ${game.i18n.localize("dsk.atmod")}`,value:c.system.atmod,selected:!0,specAbId:r.system.currentAmmo}),c.system.damageMod||c.system.armorMod){let u={name:`${c.name} - ${game.i18n.localize("dsk.MODS.damage")}`,value:c.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:r.system.currentAmmo};c.system.armorMod&&(u.armorPen=c.system.armorMod),e.push(u)}c.effects.length&&e.push({name:`${c.name} - ${game.i18n.localize("dsk.effect")}`,value:1,type:game.i18n.localize("dsk.effect"),selected:!0,specAbId:r.system.currentAmmo})}}this.attackStatEffect(e,Number(t.system.rangeStats[a.mode]))}static async checkAmmunitionState(e,t,a,s){let i=!0;if(s!="damage"){let r=e.system;if(r.ammunitionType!="infinite")if(r.ammunitionType=="-")t.extra.ammo=duplicate(e),i=t.extra.ammo.system.quantity>0;else{let n=a.items.get(r.currentAmmo);n?(t.extra.ammo=n.toObject(),r.ammunitionType=="mag"?i=t.extra.ammo.system.quantity>1||t.extra.ammo.system.mag.value>0&&t.extra.ammo.system.quantity>0:i=t.extra.ammo.system.quantity>0):i=!1}!i&&a.type=="creature"&&(i=!0)}return i||ui.notifications.error(game.i18n.localize("dsk.DSKError.NoAmmo")),i}static async setupDialog(e,t,a,s,i){let r=t.mode,n=a.name+" "+game.i18n.localize("dsk."+r+"test"),l=s.items.find(T=>T.type=="combatskill"&&T.name==a.system.combatskill);mergeObject(a.system,{characteristic1:l.system.characteristic1,characteristic2:l.system.characteristic2});let c={opposable:!0,source:a,mode:r,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}};if(!await this.checkAmmunitionState(a,c,s,r))return;let u=_.multipleDefenseValue(s,c.source),d={rollMode:t.rollMode,mode:r,hasSchips:this.hasSchips(s),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*u})},p=s?O.getRollModifiers(s,a,{mode:r}):[];this.getSituationalModifiers(p,s,d,a,i),d.situationalModifiers=p;let f={title:n,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:d,callback:(T,g={})=>(Z.resolveRangeDialog(c,b,T,s,g,u),c.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&s.reduceSchips(0),Hooks.call("callbackDialogCombatDSK",c,s,T,a,i),{testData:c,cardOptions:b})},b=s._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:f,testData:c,cardOptions:b})}};m(xt,"ItemRangeweapon");var zt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.protection",e.rs)]}};m(zt,"ItemArmor");var Nt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.ammunitionType",game.i18n.localize(`dsk.ammunition.${e.ammunitionType}`))]}};m(Nt,"ItemAmmunition");var Pt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.equipmentType",game.i18n.localize(`dsk.Equipment.${e.category}`))]}};m(Pt,"ItemEquipment");var _t=class extends C{};m(_t,"ItemSpecies");var Rt=class extends C{};m(Rt,"ItemCulture");var Lt=class extends C{};m(Lt,"ItemProfession");var Qe=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.rule",e.rule)]}};m(Qe,"ItemAdvantage");var Ft=class extends Qe{};m(Ft,"ItemDisadvantage");var Ht=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.rule",e.rule)]}};m(Ht,"ItemSpecialability");var jt=class extends C{};m(jt,"ItemAhnengeschenk");var Ee=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.AeP",e.AeP),this._chatLineHelper("dsk.distribution",e.distribution),this._chatLineHelper("dsk.duration",e.duration),this._chatLineHelper("dsk.range",e.range),this._chatLineHelper("dsk.targetCategory",e.targetCategory)]}static async getCallbackData(e,t,a){e.testDifficulty=0,e.situationalModifiers=D._parseModifiers(t),D.schipsModifier(t,e.situationalModifiers),e.situationalModifiers.some(i=>i.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0);let s=new FormDataExtended(t.find("form")[0]).object;e.calculatedSpellModifiers={castingTime:t.find(".castingTime").text(),cost:t.find(".aspcost").text(),reach:t.find(".reach").text()},e.situationalModifiers.push({name:game.i18n.localize("dsk.removeGesture"),value:Number(s.removeGesture)||0},{name:game.i18n.localize("dsk.removeFormula"),value:Number(s.removeFormula)||0},{name:game.i18n.localize("dsk.zkModifier"),value:s.zkModifier||0},{name:game.i18n.localize("dsk.skModifier"),value:s.skModifier||0}),e.extensions=Ee.getSpecAbModifiers(t),e.advancedModifiers={chars:[0,1].map(i=>s[`ch${i}`]),fws:s.fw,qls:s.qs},C.changeChars(e.source,...[0,1].map(i=>s[`characteristics${i}`]))}static getSpecAbModifiers(e){let t=[];for(let a of e.find(".specAbs.active"))t.push({name:a.dataset.name,title:a.getAttribute("title"),uuid:a.dataset.uuid});return t}static getSituationalModifiers(e,t,a,s){e.push(...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.magicalAttunement"),1,!0),...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.magicalRestriction"),-1,!0),...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.boundToArtifact"),-1,!0)),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&M.addCreatureTypeModifiers(i.actor,s,e,t)}),e.push(...t.getSkillModifier(s.name,s.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value});this.getSkZkModifier(a,s)}static setupDialog(e,t,a,s,i){let r="ahnen",n=a.name+" "+game.i18n.localize("dsk.probe")+(t.subtitle||""),l={opposable:!!a.system.effectFormula,source:a,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)},advancedModifiers:{chars:[0,0],fws:0,qls:0}},c={rollMode:t.rollMode,hasSKModifier:a.system.resist=="sk",hasZKModifier:a.system.resist=="zk",spellReach:a.system.range,hasSchips:this.hasSchips(s),characteristics:[1,2].map(f=>a.system[`characteristic${f}`])},u=s?O.getRollModifiers(s,a):[];this.getSituationalModifiers(u,s,c,a),c.situationalModifiers=u;let d={title:n,template:`/systems/dsk/templates/dialog/${r}-enhanced-dialog.html`,data:c,callback:async(f,b={})=>(p.rollMode=f.find('[name="rollMode"]').val(),await this.getCallbackData(l,f,s),mergeObject(l.extra.options,b),{testData:l,cardOptions:p})},p=s._setupCardOptions("systems/dsk/templates/chat/roll/spell-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:d,testData:l,cardOptions:p})}};m(Ee,"ItemAhnengabe");var Bt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.stepValue",e.level),this._chatLineHelper("dsk.poisonType",e.category),this._chatLineHelper("dsk.start",e.start),this._chatLineHelper("dsk.duration",e.duration),this._chatLineHelper("dsk.resistanceModifier",e.resist),this._chatLineHelper("dsk.effect",h.replaceConditions(h.replaceDies(e.effect)))]}static getSituationalModifiers(e,t,a,s){s=h.toObjectIfPossible(s),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&e.push(...E.getVantageAsModifier(i.actor,game.i18n.localize("dsk.LocalizedIDs.poisonResistance"),-1,!1,!0))}),this.getSkZkModifier(a,s),mergeObject(a,{hasSKModifier:s.system.resist=="SK",hasZKModifier:s.system.resist=="ZK"})}static setupDialog(e,t,a,s,i){let r=a.name+" "+game.i18n.localize("TYPES.Item."+a.type)+" "+game.i18n.localize("dsk.check"),n={opposable:!1,source:a,extra:{options:t,speaker:C.buildSpeaker(s,i)}},l={rollMode:t.rollMode},c=[];this.getSituationalModifiers(c,s,l,a),l.situationalModifiers=c;let u={title:r,template:"/systems/dsk/templates/dialog/poison-dialog.html",data:l,callback:(p,f={})=>(d.rollMode=p.find('[name="rollMode"]').val(),n.situationalModifiers=D._parseModifiers(p),n.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:p.find('[name="zkModifier"]').val()||0}),n.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:p.find('[name="skModifier"]').val()||0}),mergeObject(n.extra.options,f),{testData:n,cardOptions:d})},d=a._setupCardOptions(`systems/dsk/templates/chat/roll/${a.type}-card.html`,r,i);return _DiceDSK.setupDialog({dialogOptions:u,testData:n,cardOptions:d})}};m(Bt,"ItemPoison");var Gt=class extends C{static getSituationalModifiers(e,t,a,s){e.push(...t.getSkillModifier(s.name,s.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value})}static setupDialog(e,t,a,s,i){let r=a.name+" "+game.i18n.localize("dsk.probe")+(t.subtitle||""),n={opposable:!0,source:a,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}},l={rollMode:t.rollMode,modifier:t.modifier||0,difficultyLabels:w.skillDifficultyLabels,hasSchips:this.hasSchips(s),characteristics:[1,2].map(d=>a.system[`characteristic${d}`]),situationalModifiers:s?O.getRollModifiers(s,a):[]};t.situationalModifiers&&l.situationalModifiers.push(...t.situationalModifiers),this.getSituationalModifiers(l.situationalModifiers,s,l,a);let c={title:r,template:"/systems/dsk/templates/dialog/skill-dialog.html",data:l,callback:(d,p={})=>(u.rollMode=d.find('[name="rollMode"]').val(),n.situationalModifiers=D._parseModifiers(d),D.schipsModifier(d,n.situationalModifiers),n.situationalModifiers.some(f=>f.name==game.i18n.localize("dsk.schips"))&&s.reduceSchips(0),n.testDifficulty=w.skillDifficultyModifiers[d.find('[name="testDifficulty"]').val()],n.advancedModifiers={chars:[0,1].map(f=>Number(d.find(`[name="ch${f}"]`).val())),fws:Number(d.find('[name="fw"]').val()),qls:Number(d.find('[name="qs"]').val())},C.changeChars(n.source,...[0,1].map(f=>d.find(`[name="characteristics${f}"]`).val())),mergeObject(n.extra.options,p),{testData:n,cardOptions:u})},u=s._setupCardOptions("systems/dsk/templates/chat/roll/skill-card.html",r,i);return _DiceDSK.setupDialog({dialogOptions:c,testData:n,cardOptions:u})}};m(Gt,"ItemSkill");var qt=class extends C{};m(qt,"ItemCombatskill");function Oa(o,e=320,t=40){o.attr({width:e*.8,viewBox:`0 0 ${e} ${t}`});let a=o.find("text"),s=a.get(0).getBBox(),i=e/s.width,r=t/s.height,n=i<r,l=n?i:r;isFinite(l)&&a.attr({transform:"matrix("+l+", 0, 0, "+l+", 0,0)",x:Math.max(0,(e-s.width)/2),y:t*.75/(n?1:l)})}m(Oa,"svgAutoFit");function xa(o,e,t,a="div"){if(e=o.find(e)[0],!e)return;e.classList.add("slist");let s=e.querySelectorAll(a),i=null;for(let r of s)r.draggable=!0,r.addEventListener("dragstart",function(n){i=this}),r.addEventListener("dragover",function(n){n.preventDefault()}),r.addEventListener("drop",async function(n){if(n.preventDefault(),this!=i){let l=0,c=0;for(let u=0;u<s.length;u++)i==s[u]&&(l=u),this==s[u]&&(c=u);l<c?this.parentNode.insertBefore(i,this.nextSibling):this.parentNode.insertBefore(i,this),await t(e)}})}m(xa,"slist");function za(o){let e=$(".tinyNotifications");e.length||($("body").append('<ul class="tinyNotifications"></ul>'),e=$(".tinyNotifications"));let t=$(`<li>${o}</li>`);e.prepend(t),setTimeout(function(){t.remove()},1500)}m(za,"tinyNotification");async function Wt(o,e,t=!0){let a,s;o.type=="Actor"?(a=await Actor.implementation.fromDropData(o),s=e===a.id):(a=await Item.implementation.fromDropData(o),s=e===a.parent?.uuid);let i=a?.type;return t&&(a=a.toObject()),o.amount&&(a.system.quantity.value=Number(o.amount)),{item:a,typeClass:i,selfTarget:s}}m(Wt,"itemFromDrop");var L=class{static async handleOpposedTarget(e){if(!e)return;let t=h.getSpeaker(e.speaker);if(!t)return;let a=e.flags.data.postData,s=e.flags.data.preData;game.user.targets.size&&e.flags.data.isOpposedTest&&!e.flags.data.defenderMessage&&!e.flags.data.attackerMessage&&(console.log("start opposed"),L.createOpposedTest(t,e,a,s)),await this.showDamage(e),await this.showSpellWithoutTarget(e)}static async createOpposedTest(e,t,a,s){let i;t.speaker.token?i=canvas.tokens.get(t.speaker.token).document:i=e.prototypeToken,a.successLevel>0?game.user.targets.forEach(async r=>{if(r.actor)switch(a.rollType){case"weapon":await L.evaluateAttack(e,t,a,s,i,r);break;default:let n=L.opposeMessage(i,r,!1);await ChatMessage.create({user:game.user.id,content:n,speaker:t.speaker,["flags.unopposeData"]:{attackMessageId:t.id,targetSpeaker:{scene:r.scene.id,token:r.id,alias:r.document.name}}})}}):game.user.targets.forEach(async r=>{r.actor&&await ChatMessage.create({user:game.user.id,content:L.opposeMessage(i,r,!0),speaker:t.speaker})})}static async evaluateAttack(e,t,a,s,i,r){if(a.qualityStep>0){a.source=s.source;let n=L._calculateOpposedDamage(a,r),l=[n.armorMod!=0?`${n.armorMod+" "+game.i18n.localize("dsk.Modifier")}`:"",n.armorMultiplier!=1?"*"+n.armorMultiplier+" "+game.i18n.localize("dsk.Modifier"):"",n.spellArmor!=0?`${n.spellArmor} ${game.i18n.localize("dsk.spellArmor")}`:""].join(""),c=`<b>${game.i18n.localize("dsk.damage")}</b>: ${n.damage}<i class="lighticon fa attackWeaponless" data-tooltip="Roll"></i> - <span data-tooltip="${l}">${n.armor}</span><i class="lighticon fa fa-shield-alt" data-tooltip="protection"></i> = ${n.sum}`,u={winner:"attacker",damage:{description:c,value:n.sum,sp:n.damage}};u=L.formatOpposedResult(u,i,r,a),await L.renderOpposedResult(u,{}),await L.playAutomatedJBA2(u.speakerAttack,u.speakerDefend,u)}}static _calculateOpposedDamage(e,t,a={}){let s=t.actor;a.origin=e.source,a.damage=e.damage;let i=W.applyRollTransformation(s,a,5).options.damage,{wornArmor:r,armor:n}=D.armorValue(s,a),l=[],c=0,u=e.armorPen||[];for(let f of u)/^\*/.test(f)?l.push(Number(f.replace("*",""))):c+=Number(f);let d=0;["ahnengabe"].includes(e.source.type)&&(d+=s.system.spellArmor||0),n+=c;let p=l.reduce((f,b)=>f*b,1);return n=Math.max(Math.round(n*p),0),n+=d,{damage:i,armor:n,armorMod:c,spellArmor:d,armorMultiplier:p,sum:i-n}}static formatOpposedResult(e,t,a,s){let i=e.differenceSL?"winsFP":"wins";return e.winner=="attacker"?(e.result=game.i18n.format("dsk.OPPOSED."+i,{winner:t.name,loser:a.name,SL:e.differenceSL}),e.img=t.img):e.winner=="defender"&&(e.result=game.i18n.format("dsk.OPPOSED."+i,{winner:a.name,loser:t.name,SL:e.differenceSL}),e.img=a.img),e.speakerAttack=L.tokenDude(t,s),e.speakerDefend=L.tokenDude(a,{}),e}static tokenDude(e,t){return{speaker:{token:e.id,actor:e.actor?.id,scene:canvas.scene?.id},img:L.videoOrImgTag(e.document?.texture.src||e.texture.src),testResult:t}}static async renderOpposedResult(e,t={}){e.hideData=await game.settings.get("dsk","hideOpposedDamage");let a=await renderTemplate("systems/dsk/templates/chat/roll/opposed-result.html",e),s={user:game.user.id,content:a,"flags.opposeData":e,"flags.hideData":e.hideData,whisper:t.whisper,blind:t.blind};await ChatMessage.create(s)}static opposeMessage(e,t,a){return`<div class="opposed-message">
            <b>${e.name}</b> ${game.i18n.localize("dsk.ROLL.Targeting")} <b>${t.document.name}</b> ${a?game.i18n.localize("dsk.ROLL.failed"):""}
            </div>
            <div class="opposed-tokens row-section">
                <div class="col two attacker">${L.videoOrImgTag(e.texture.src)}</div>
                <div class="col two defender">${L.videoOrImgTag(t.document.texture.src)}</div>
            </div>
             `}static async playAutomatedJBA2(e,t,a){if(h.moduleEnabled("autoanimations")){let s=h.getSpeaker(e.speaker).getActiveTokens()[0],i=h.getSpeaker(t.speaker).getActiveTokens()[0];if(!s||!s.actor||!i||!i.actor)return;let r=s.actor.items.get(e.testResult.source._id);if(r||(r=new C(e.testResult.source,{temporary:!0})),!r)return;let n=[i],l=a.winner=="attacker"?n:[];AutomatedAnimations.playAnimation(s,r,{targets:n,hitTargets:l,playOnMiss:!0})}}static videoOrImgTag(e){return/\.webm$/.test(e)?`<video loop autoplay src="${e}" width="50" height="50"></video>`:`<img src="${e}" width="50" height="50"/>`}static async showDamage(e,t=!1){game.user.isGM?(!t||!e.flags.data.hideDamage)&&e.flags.data.postData.damageRoll&&(await e.update({content:e.content.replace(`data-hide-damage="${!t}"`,`data-hide-damage="${t}"`),"flags.data.hideDamage":t}),t||_DiceDSK._addRollDiceSoNice(e.flags.data.preData,Roll.fromData(e.flags.data.postData.damageRoll),game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"))):game.socket.emit("system.dsk",{type:"showDamage",payload:{id:e.id,hide:t}})}static async showSpellWithoutTarget(e){if(h.moduleEnabled("autoanimations")){let t=getProperty(e,"flags.data");if(!t||t.isOpposedTest)return;if((getProperty(t,"postData.result")||-1)>0){let s=h.getSpeaker(t.postData.speaker).getActiveTokens()[0];if(!s||!s.actor)return;let i=Array.from(game.user.targets),r=s.actor.items.get(t.preData.source._id);i.length||(i=[s]),AutomatedAnimations.playAnimation(s,r,{targets:i})}}}};m(L,"OpposedDSK");var N=class extends Actor{static async create(e,t){if(e instanceof Array||e.items)return await super.create(e,t);(!e.img||e.img=="icons/svg/mystery-man.svg")&&(e.img="icons/svg/mystery-man-black.svg");let a=["skill","combatskill"];["character","npc"].includes(e.type)&&a.push("meleeweapon","specialability"),e.items=await h.allSkills(a);let s={character:3,npc:1,creature:0},i=getProperty(e,"system.stats.schips.current")||s[e.type]||0;return e.system={stats:{schips:{current:i,value:i}}},e.type!="creature"&&[void 0,0].includes(getProperty(e,"system.stats.LeP.value"))&&mergeObject(e,{system:{stats:{LeP:{value:16}}}}),await super.create(e,t)}prepareDerivedData(){let e=this.system;try{e.canAdvance=this.isOwner&&this.type=="character";for(let n of Object.values(e.characteristics))n.value=n.initial+n.advances+(n.modifier||0)+n.gearmodifier;e.totalWeight=0;let t=[],a=new Map,s=this.items.filter(n=>n.type=="equipment"&&n.system.category=="bags");for(let n of s)a.set(n.id,[]);for(let n of this.items)if(N._baseCarryItems.has(n.type)){let l=getProperty(n,"system.parent_id");if(l&&l!=n._id&&a.has(l)){a.get(l).push(n);continue}n.type=="armor"?(n.system.preparedWeight=parseFloat((n.system.weight*n.system.quantity).toFixed(3)),e.totalWeight+=parseFloat((n.system.weight*(n.system.worn.value?Math.max(0,n.system.quantity-1):n.system.quantity)).toFixed(3)),n.system.worn.value&&t.push(n)):(n.system.preparedWeight=parseFloat((n.system.weight*n.system.quantity).toFixed(3)),e.totalWeight+=Number(n.system.preparedWeight))}else switch(n.type){case"ahnengabe":case"ahnengeschenk":e.isMage=!0;break;case"specialability":N._mageSpecs.has(n.system.category)&&(e.isMage=!0);break}for(let n of s){let l=getProperty(n,"system.parent_id");(!l||!a.has(l))&&(e.totalWeight+=this._calcBagweight(n,a,!0))}e.carrycapacity=e.characteristics.kk.value*2+e.carryModifier,e.canAdvance&&(e.details.experience.current=e.details.experience.total-e.details.experience.spent),(this.type=="character"||this.type=="npc")&&(e.stats.LeP.current=e.stats.LeP.initial+e.characteristics.ko.value*2,e.stats.AeP.current=!e.guidevalue||e.guidevalue=="-"?0:N._attrFromCharacteristic(e.guidevalue,e),e.stats.sk.value=(e.stats.sk.initial||0)+Math.round((e.characteristics.mu.value+e.characteristics.kl.value+e.characteristics.in.value)/3)-10,e.stats.zk.value=(e.stats.zk.initial||0)+Math.round((e.characteristics.ko.value+e.characteristics.ko.value+e.characteristics.kk.value)/3)-10,e.stats.ini.value=Math.round((e.characteristics.mu.value+e.characteristics.ge.value)/2)+(e.stats.ini.modifier||0),e.stats.LeP.min=-1*e.characteristics.ko.value),this.type=="creature"&&(e.stats.LeP.current=e.stats.LeP.initial,e.stats.AeP.current=e.stats.AeP.initial,e.stats.ini.value=e.stats.ini.current+(e.stats.ini.modifier||0)),e.stats.schips.max=Number(e.stats.schips.current)+Number(e.stats.schips.modifier)+e.stats.schips.gearmodifier,e.stats.regeneration.LePmax=e.stats.regeneration.LePTemp+e.stats.regeneration.LePMod+e.stats.regeneration.LePgearmodifier,e.stats.regeneration.AePmax=e.stats.regeneration.AePTemp+e.stats.regeneration.AePMod+e.stats.regeneration.AePgearmodifier,e.stats.LeP.max=Math.round((e.stats.LeP.current+e.stats.LeP.modifier+e.stats.LeP.advances)*e.stats.LeP.multiplier+e.stats.LeP.gearmodifier),e.stats.AeP.max=e.stats.AeP.current+e.stats.AeP.modifier+e.stats.AeP.advances+e.stats.AeP.gearmodifier,e.stats.gs.max=Math.max(0,e.stats.gs.initial+(e.stats.gs.modifier||0)+e.stats.gs.gearmodifier),e.stats.sk.max=e.stats.sk.value+e.stats.sk.modifier+e.stats.sk.gearmodifier,e.stats.zk.max=e.stats.zk.value+e.stats.zk.modifier+e.stats.zk.gearmodifier;let i=0;e.stats.ini.value+=e.stats.ini.gearmodifier-Math.min(4,i);let r=Number((.01*e.stats.ini.value).toFixed(2));e.stats.ini.value*=e.stats.ini.multiplier||1,e.stats.ini.value=Math.round(e.stats.ini.value)+r;for(let n of Object.keys(e.status))e.status[n]=Math.clamped(e.status[n],0,8);e.armorEncumbrance=this.getArmorEncumbrance(this,t),this.effectivePain(e),e.maxDefense=this.maxDefenseValue()}catch(t){console.error("Something went wrong with preparing actor data: "+t+t.stack),ui.notifications.error(game.i18n.format("dsk.DSKError.PreparationError",{name:this.name})+t+t.stack)}}static async deferredEffectAddition(e,t,a){let i=(t.effects.find(n=>n.statuses.has(e))?.flags.dsk.auto||0)!=a,r=`changing${e}`;t[r]=i,i&&await t.addCondition(e,a,!0).then(()=>t[r]=void 0)}static async postUpdateConditions(e){let t=e.system,a=e.isMerchant();if(!ce.hasTrait(e,game.i18n.localize("dsk.LocalizedIDs.painImmunity"))){let i=e.woundPain(t);await this.deferredEffectAddition("inpain",e,i*2)}let s=t.armorEncumbrance;(e.type!="creature"||e.canAdvance)&&!a&&(s+=Math.max(0,Math.ceil((t.totalWeight-t.carrycapacity-5)/5))*2),await this.deferredEffectAddition("encumbered",e,s),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.blind"))&&await e.addCondition("blind"),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.mute"))&&await e.addCondition("mute"),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.deaf"))&&await e.addCondition("deaf"),a&&e.prepareMerchant()}static async _onCreateDocuments(e,t){for(let a of e)await N.postUpdateConditions(a);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)await N.postUpdateConditions(a);return super._onUpdateDocuments(e,t)}_calcBagweight(e,t,a=!0){let s=0;if(t.has(e._id)){let i=0;!e.system.worn.value&&a&&(s-=e.system.preparedWeight);for(let r of t.get(e._id))r.system.preparedWeight=Number(parseFloat((r.system.weight*r.system.quantity).toFixed(3))),t.has(r._id)?i+=this._calcBagweight(r,t,!1):i+=r.system.preparedWeight;a?e.system.worn.value&&(s+=i):s+=i+e.system.preparedWeight,e.system.bagweight=`${i.toFixed(3)}/${e.system.capacity||0}`}return s}effectivePain(e){let t=e.status.inpain||0;t<8&&(t-=E.vantageStep(this,game.i18n.localize("dsk.LocalizedIDs.ruggedFighter"))),t>0&&(t+=E.vantageStep(this,game.i18n.localize("dsk.LocalizedIDs.sensitiveToPain"))),t=Math.clamped(t,0,8),e.status.inpain=t}woundPain(e){let t=0;return e.stats.LeP.max>0&&(this.type!="creature"||e.stats.LeP.max>=20?(t=Math.floor((1-e.stats.LeP.value/e.stats.LeP.max)*4),e.stats.LeP.value<=5&&(t=4)):t=Math.floor(5-5*e.stats.LeP.value/e.stats.LeP.max)),Math.clamped(t,0,4)}static _calculateCombatSkillValues(e,t){return e=N._calculatePW(e,t),e.system.attack=e.PW,e.system.weapontype=="melee"?e.system.parry=Math.round(e.PW*.25):e.system.parry=0,e.cost=game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(e.system.level,e.system.StF)}),e}async prepareMerchant(){if(getProperty(this,"system.merchant.merchantType")=="loot"){if(getProperty(this,"system.merchant.locked")&&!this.hasCondition("locked"))await this.addCondition(N.lockedCondition());else if(!getProperty(this,"system.merchant.locked")){let e=this.effects.find(t=>t.statuses.has("locked"));e&&await this.deleteEmbeddedDocuments("ActiveEffect",[e.id])}}}static lockedCondition(){return{id:"locked",name:game.i18n.localize("dsk.MERCHANT.locked"),icon:"icons/svg/padlock.svg",flags:{dsk:{value:null,editable:!0,noEffect:!0,hidePlayers:!0,description:game.i18n.localize("dsk.MERCHANT.locked"),custom:!0}}}}isMerchant(){return["merchant","loot"].includes(getProperty(this,"system.merchant.merchantType"))}applyActiveEffects(){let e={};this.statuses??(this.statuses=new Set);let t=new Map;for(let n of Object.values(CONFIG.specialStatusEffects))t.set(n,this.statuses.has(n));this.statuses.clear();let a=[],s=1;for(let n of this.effects){if(n.disabled)continue;s=1;let l=n.getFlag("dsk","value");l&&(s=Number(l));for(let c=0;c<s;c++)a.push(...n.changes.map(u=>(u=foundry.utils.duplicate(u),u.effect=n,u.priority=u.priority?u.priority:u.mode*10,u)));for(let c of n.statuses)this.statuses.add(c)}let i=!0;for(let n of this.items)for(let l of n.effects)if(!l.disabled){switch(i=!0,n.type){case"meleeweapon":case"rangeweapon":case"armor":i=n.system.worn.value;break;case"equipment":i=!n.system.worn.wearable||n.system.worn.wearable&&n.system.worn.value;break;case"trait":i=!["meleeAttack","rangeAttack"].includes(n.system.traitType);break;case"ammunition":case"combatskill":case"poison":case"ahnengabe":case"consumable":case"ahnengeschenk":i=!1;break;case"specialability":i=n.system.category!="Combat"||[2,3].includes(n.system.subcategory),s=Number(n.system.level)||1;break;case"advantage":case"disadvantage":s=Number(n.system.level)||1;break}if(l.notApplicable=!i,!!i){for(let c=0;c<s;c++)a.push(...l.changes.map(u=>(u=foundry.utils.duplicate(u),u.effect=l,u.priority=u.priority?u.priority:u.mode*10,u)));for(let c of l.statuses)this.statuses.add(c)}}a.sort((n,l)=>n.priority-l.priority);for(let n of a){if(!n.key)continue;let l=n.effect.apply(this,n);Object.assign(e,l)}this.overrides=foundry.utils.expandObject(e);let r;for(let[n,l]of t){let c=this.statuses.has(n);if(c!==l){r??(r=this.getActiveTokens());for(let u of r)u._onApplyStatusEffect(n,c)}}}maxDefenseValue(){let e={parry:0,name:game.i18n.localize("dsk.noDefense")},t=[],a=[];for(let s of this.items)if(s.type=="combatskill")t.push(N._calculateCombatSkillValues(s,this.system));else if(s.type=="meleeweapon")getProperty(s,"system.worn.value")&&a.push(s);else if(s.type=="trait"&&s.system.traitType=="meleeAttack"){let i=N._prepareMeleetrait(s,this);i.parry>e.parry&&(e=i)}for(let s of a){let i=N._prepareMeleeWeapon(s,t,this,a.filter(r=>r._id!=s._id&&!_.isYieldedTwohanded(r)));i.parry>=e.parry&&(e=i)}return e}preparePostRollAction(e){let t=e.flags.data,a={flags:{img:e.flags.img},rollMode:t.rollMode,speaker:e.speaker,template:t.template,title:t.title,user:e.user};return t.attackerMessage&&(a.attackerMessage=t.attackerMessage),t.defenderMessage&&(a.defenderMessage=t.defenderMessage),t.unopposedStartMessage&&(a.unopposedStartMessage=t.unopposedStartMessage),a}async useFateOnRoll(e,t,a){if(t=="isTalented"||h.fateAvailable(this,a==1)){let s=e.flags.data,i=this.preparePostRollAction(e),r,n;a==0?(r=this.system.stats.schips.value-1,n="PointsRemaining"):(r=game.settings.get("dsk","groupschips").split("/")[0],n="GroupPointsRemaining");let l=`<h3 class="center"><b>${game.i18n.localize("dsk.CHATFATE.fatepointUsed")}</b></h3>
                  ${game.i18n.format("dsk.CHATFATE."+t,{character:"<b>"+this.name+"</b>"})}<br>
                  <b>${game.i18n.localize(`dsk.CHATFATE.${n}`)}</b>: ${r}`,c=s.preData;c.extra.actor=h.getSpeaker(c.extra.speaker).toObject(!1),this[`fate${t}`](l,i,c,e,s,a)}}resetTargetAndMessage(e,t){e.originalTargets?.size&&(game.user.targets=e.originalTargets,game.user.targets.user=game.user),!e.defenderMessage&&e.startMessagesList&&(t.startMessagesList=e.startMessagesList)}async fatererollDamage(e,t,a,s,i,r){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let n=await renderTemplate("systems/dsk/templates/dialog/fateReroll-dialogDamage.html",{testData:a,postData:i.postData,singleDie:i.postData.characteristics.filter(l=>l.char=="damage").length==1});new q({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async l=>{let c=l.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let u=Roll.fromData(i.postData.damageRoll),d=await _DiceDSK.manualRolls(await new Roll(u.formula||u._formula).evaluate({async:!0}),"dsk.CHATCONTEXT.rerollDamage");await _DiceDSK.showDiceSoNice(d,a.rollMode);for(let T=0;T<d.dice.length;T++)d.dice[T].options.colorset="black";let p=0,f=[],b=[];for(let T of c)f.push(`${u.terms[(T-2)*2].results[0].result}/${d.terms[p*2].results[0].result}`),b.push({index:(T-2)*2,val:d.terms[p*2].results[0].result}),p+=1;u.editRollAtIndex(b),a.damageRoll=u,e+=`<br><b>${game.i18n.localize("dsk.Roll")}</b>: ${f.join(", ")}`,ChatMessage.create(h.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointDamageRerollUsed":!0}),await this.reduceSchips(r)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async fatereroll(e,t,a,s,i,r){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let n=await renderTemplate("systems/dsk/templates/dialog/fateReroll-dialog.html",{testData:a,postData:i.postData,singleDie:i.postData.characteristics.filter(l=>l.char!="damage").length==1});new q({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async l=>{let c=l.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let u=[];for(let g of c){let y=a.roll.terms[g*2];u.push(y.number+"d"+y.faces+"["+y.options.colorset+"]")}u=await _DiceDSK.manualRolls(await new Roll(u.join("+")).evaluate({async:!0}),"dsk.CHATCONTEXT.Reroll"),await _DiceDSK.showDiceSoNice(u,a.rollMode);let d=0,p=[],f=h.getSpeaker(a.extra.speaker),b=game.i18n.localize("dsk.LocalizedIDs.traditionPhex"),T=f.items.some(g=>g.type=="specialability"&&g.name==b);for(let g of c){let y=a.source.system[`characteristic${g+1}`],v=y?`${game.i18n.localize(`dsk.characteristics.${y}.abbr`)} - `:"";p.push(`${v}${a.roll.terms[g*2].results[0].result}/${u.terms[d*2].results[0].result}`),T?a.roll.terms[g*2].results[0].result=Math.min(u.terms[d*2].results[0].result,a.roll.terms[g*2].results[0].result):a.roll.terms[g*2].results[0].result=u.terms[d*2].results[0].result,d+=1}e+=`<br><b>${game.i18n.localize("dsk.Roll")}</b>: ${p.join(", ")}`,ChatMessage.create(h.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointRerollUsed":!0}),await this.reduceSchips(r)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async fateisTalented(e,t,a,s,i){t.talentedRerollUsed=!0,this.resetTargetAndMessage(i,t),e=`<h3 class="center"><b>${game.i18n.localize("dsk.CHATFATE.fatepointUsed")}</b></h3>
              ${game.i18n.format("dsk.CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"})}<br>`;let r=await renderTemplate("systems/dsk/templates/dialog/isTalentedReroll-dialog.html",{testData:a,postData:i.postData});new q({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:r,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async n=>{let l=n.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(l.length>0){let c=[];for(let p of l){let f=a.roll.terms[p*2];c.push(f.number+"d"+f.faces+"["+f.options.colorset+"]")}c=await _DiceDSK.manualRolls(await new Roll(c.join("+")).evaluate({async:!0}),"dsk.CHATCONTEXT.talentedReroll"),await _DiceDSK.showDiceSoNice(c,a.rollMode);let u=0,d=[];for(let p of l){let f=a.source.system[`characteristic${p+1}`],b=f?`${game.i18n.localize(`dsk.characteristics.${f}.abbr`)} - `:"";d.push(`${b}${a.roll.terms[p*2].results[0].result}/${c.terms[u*2].results[0].result}`),a.roll.terms[p*2].results[0].result=c.terms[u*2].results[0].result,u+=1}e+=`<b>${game.i18n.localize("dsk.Roll")}</b>: ${d.join(", ")}`,ChatMessage.create(h.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.talentedRerollUsed":!0})}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async reduceSchips(e){e==0?await this.update({"system.stats.schips.value":this.system.stats.schips.value-1}):await N.reduceGroupSchip()}async modifyTokenAttribute(e,t,a=!1,s=!0){let i=foundry.utils.getProperty(this.system,e),r;return s?(a&&(t=Math.clamped(i.min||0,Number(i.value)+t,i.max)),r={[`system.${e}.value`]:t}):(a&&(t=Number(i)+t),r={[`system.${e}`]:t}),Hooks.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:a,isBar:s},r)!==!1?this.update(r):this}static armorValue(e,t={}){let a=e.items.filter(r=>r.type=="armor"&&r.system.worn.value==!0);t.origin&&(a=a.map(r=>{let n=mergeObject(duplicate(t),{armor:r});return W.applyRollTransformation(e,n,4).options.armor}));let s=a.reduce((r,n)=>r+n.system.rs,0),i=e.items.filter(r=>r.type=="trait"&&r.system.traitType=="armor").reduce((r,n)=>r+Number(n.system.at),0);return{wornArmor:a,armor:s+i+(e.system.totalArmor||0)}}prepareBaseData(){let e=this.system;mergeObject(e,{skillModifiers:{FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AePCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],AePCost:[]},...["ahnengabe","skill"].reduce((t,a)=>(t[a]={FP:[],step:[],QL:[],TPM:[],FW:[]},t),{})},repeatingEffects:{startOfRound:{LeP:[],AeP:[]}},aepModifier:0,creatureBonus:[],stats:{initiative:{multiplier:1},LeP:{multiplier:1},regeneration:{LePgearmodifier:0,AePgearmodifier:0}},status:{encumbered:0,stunned:0,feared:0,inpain:0,selfconfidence:0},spellStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},totalArmor:0,carryModifier:0});for(let t of Object.values(e.stats))t.gearmodifier=0;for(let t of Object.values(e.characteristics))t.gearmodifier=0}prepareSheet(e){let t=duplicate(this),a={system:{characteristics:{}}};if(mergeObject(a,this.prepareItems(e)),a.canAdvance){let s=["LeP","AeP"];for(let i of s)mergeObject(a.system,{stats:{[i]:{cost:game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(t.system.stats[i].advances,"D")}),refund:game.i18n.format("dsk.refundCost",{cost:h._calculateAdvCost(t.system.stats[i].advances,"D",0)})}}});for(let[i,r]of Object.entries(this.system.characteristics))a.system.characteristics[i]={cost:game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(r.initial+r.advances,"Eig")}),refund:game.i18n.format("dsk.refundCost",{cost:h._calculateAdvCost(r.initial+r.advances,"Eig",0)})}}return a}_perpareItemAdvancementCost(e){return e.cost=game.i18n.format("dsk.advancementCost",{cost:h._calculateAdvCost(e.system.level,e.system.StF)}),e.refund=game.i18n.format("dsk.refundCost",{cost:h._calculateAdvCost(e.system.level,e.system.StF,0)}),e.canAdvance=this.system.canAdvance,e}static _prepareRangeTrait(e,t){return e.attack=Number(e.system.at)+Number(t.system.rangeStats.attack),e.LZ=Number(e.system.lz),e.LZ>0&&N.buildReloadProgress(e),this._parseDmg(e)}static _prepareRangeWeapon(e,t,a,s){let i=a.find(n=>n.name==e.system.combatskill);e.calculatedRange=e.system.rw;let r;if(i){if(e.attack=Number(i.system.attack)+Number(s.system.rangeStats.attack),e.system.ammunitionType!="-"&&(e.ammo=t.filter(n=>n.system.ammunitionType==e.system.ammunitionType),r=t.find(n=>n._id==e.system.currentAmmo),r)){let n=Number(r.system.rangeMultiplier)||1;e.calculatedRange=e.calculatedRange.split("/").map(l=>Math.round(Number(l)*n)).join("/"),e.attack+=Number(r.system.atmod)||0,r.system.ammunitionType=="mag"&&(e.ammoMax=r.system.mag.max,e.ammoCurrent=r.system.mag.value)}e.LZ=N.calcLZ(e,s),e.LZ>0&&N.buildReloadProgress(e)}else ui.notifications.error(game.i18n.format("dsk.DSKError.unknownCombatSkill",{skill:e.system.combatskill,item:e.name}));return this._parseDmg(e,r)}static _prepareMeleetrait(e,t){return e.attack=Number(e.system.at),e.parry=Math.max(0,(Number(e.system.pa)||Math.round(e.attack/4))+Number(t.system.meleeStats.parry)),this._parseDmg(e)}static _prepareMeleeWeapon(e,t,a,s=null){let i=t.find(r=>r.name==e.system.combatskill);if(i){e.attack=Number(i.system.attack)+Number(e.system.aw),e.parry=Math.max(0,i.system.parry+Number(e.system.vw)+Number(a.system.meleeStats.parry)+(e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Shields")?Number(e.system.vw):0)),e.yieldedTwoHand=_.isYieldedTwohanded(e),e.yieldedTwoHand||(s||(s=duplicate(a.items).filter(n=>n.type=="meleeweapon"&&n.system.worn.value&&n._id!=e._id&&!_.isYieldedTwohanded(n))),s.length>0&&(e.parry+=Math.max(...s.map(n=>n.system.vwoffhand)),e.attack+=Math.max(...s.map(n=>n.system.awoffhand))));let r=0;e.system.worn.wrongGrip&&e.yieldedTwoHand&&(e.parry-=1,r+=1),e=this._parseDmg(e),r>0&&(e.extraDamage=r,e.damageAdd=Roll.safeEval(e.damageAdd+" + "+Number(r)),e.damageAdd=(e.damageAdd>0?"+":"")+e.damageAdd)}else ui.notifications.error(game.i18n.format("dsk.DSKError.unknownCombatSkill",{skill:e.system.combatskill,item:e.name}));return e}static _parseDmg(e,t=void 0){let a=new Roll(e.system.tp.replace(/[Ww]/g,"d"),{async:!1}),s="",i="",r="+";for(let n of a.terms)n.faces?s=n.number+"d"+n.faces:n.operator?r=n.operator:n.number&&(i+=Number(`${r}${n.number}`));if(t){let n=getProperty(t,"system.damageMod");Number(n)?i+=`+${Number(n)}`:n&&(e.damageBonusDescription=`, ${n} ${game.i18n.localize("dsk.CHARAbbrev.damage")} ${t.name}`)}return i&&(i=Roll.safeEval(i)),e.damagedie=s||"0d6",e.damageAdd=i!=""?(Number(i)>=0?"+":"")+i:"",e}static calcLZ(e,t){let a=1,s=0;e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Throwing Weapons")?s=x.abilityStep(t,game.i18n.localize("dsk.LocalizedIDs.quickdraw"))*-1:e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Crossbows")&&x.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.quickload"))?a=.5:s=x.abilityStep(t,game.i18n.localize("dsk.LocalizedIDs.quickload"))*-1;let i=`${e.system.lz}`.split("/");if(e.system.ammunitionType=="mag"){let r=t.items.find(l=>l.id==e.system.currentAmmo||l._id==e.system.currentAmmo),n=0;r&&(r=h.toObjectIfPossible(r),r.system.mag.value<=0&&(n=1)),i=i[n]||i[0]}else i=i[0];return Math.max(0,Math.round(Number(i)*a)+s)}_setOnUseEffect(e){getProperty(e,"flags.dsk.onUseEffect")&&(e.OnUseEffect=!0)}static _attrFromCharacteristic(e,t){return t.characteristics[e].value}static _calculatePW(e,t){return e.PW=Math.round((N._attrFromCharacteristic(e.system.characteristic1,t)+N._attrFromCharacteristic(e.system.characteristic2,t))/2)+5+(e.system.level||0),e}static buildReloadProgress(e){let t=e.system.reloadTimeprogress/e.LZ;e.title=game.i18n.format("dsk.WEAPON.loading",{status:`${e.system.reloadTimeprogress}/${e.LZ}`}),e.progress=`${e.system.reloadTimeprogress}/${e.LZ}`,t>=1&&(e.title=game.i18n.localize("dsk.WEAPON.loaded")),this.progressTransformation(e,t)}static progressTransformation(e,t){t>=.5?(e.transformRight="181deg",e.transformLeft=`${Math.round(t*360-179)}deg`):(e.transformRight=`${Math.round(t*360+1)}deg`,e.transformLeft=0)}getArmorEncumbrance(e,t){let a=t.reduce((s,i)=>(i.system.calculatedEncumbrance=Number(i.system.encumbrance),s+=i.system.calculatedEncumbrance),0);return Math.max(0,a-x.abilityStep(e,game.i18n.localize("dsk.LocalizedIDs.inuredToEncumbrance")))}prepareItems(e){let t=this.toObject(!1),a=[],s=[],i=[],r=[],n=[],l=[],c=[],u=[],d=[],p=[],f=Object.fromEntries(Object.keys(w.specialAbilityCategories).map(S=>[S,[]])),b=Object.fromEntries(Object.keys(w.traitCategories).map(S=>[S,[]])),T={hasSpells:this.system.isMage,ahnengabe:[],ahnengeschenk:[]},g={body:[],social:[],knowledge:[],trade:[]},y={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},poison:{items:[],show:!1,dataType:"poison"},consumable:{items:[],show:!1,dataType:"consumable"}};for(let S in w.equipmentTypes)y[S]={items:[],show:!1,dataType:S};y.misc.show=!0;for(let S=1;S<=Number(t.system.stats.schips.max);S++)p.push({value:S,cssClass:S<=Number(t.system.stats.schips.value)?"fullSchip":"emptySchip"});let v=new Map;for(let S of t.items.filter(j=>j.type=="equipment"&&j.system.category=="bags"))v.set(S._id,[]);t.items=t.items.sort((S,j)=>S.name.localeCompare(j.name));let k=t.system.totalArmor||0,I=!1;for(let S of t.items)try{let j=getProperty(S,"system.parent_id");if(S.type=="ammunition"&&d.push(N._prepareitemStructure(S)),j&&j!=S._id&&v.has(j)){v.get(j).push(S);continue}switch(e.details&&e.details.includes(S._id)&&(S.detailed="shown"),S.type){case"skill":g[S.system.group].push(N._calculatePW(this._perpareItemAdvancementCost(S,t.system),t.system));break;case"information":r.push(S);break;case"ahnengabe":T[S.type].push(N._calculatePW(this._perpareItemAdvancementCost(S),t.system));break;case"ahnengeschenk":T[S.type].push(S);break;case"combatskill":a.push(N._calculateCombatSkillValues(this._perpareItemAdvancementCost(S,t.system),t.system));break;case"ammunition":y.ammunition.items.push(N.prepareMag(S)),y.ammunition.show=!0;break;case"consumable":y.consumable.items.push(S),y.consumable.show=!0;break;case"meleeweapon":S.toggleValue=getProperty(S.system,"worn.value")||!1,S.toggle=!0,this._setOnUseEffect(S),S.system.notInInventory||(y.meleeweapons.items.push(N._prepareitemStructure(S)),y.meleeweapons.show=!0),S.toggleValue&&u.push(S);break;case"rangeweapon":S.toggleValue=getProperty(S.system,"worn.value")||!1,S.toggle=!0,this._setOnUseEffect(S),y.rangeweapons.items.push(N._prepareitemStructure(S)),y.rangeweapons.show=!0;break;case"armor":S.toggleValue=getProperty(S.system,"worn.value")||!1,y.armor.items.push(N._prepareitemStructure(S)),y.armor.show=!0,S.toggle=!0,this._setOnUseEffect(S),S.system.worn.value&&(k+=Number(S.system.rs),n.push(S));break;case"trait":switch(S.system.traitType){case"rangeAttack":S=N._prepareRangeTrait(S,t);break;case"meleeAttack":S=N._prepareMeleetrait(S,t);break;case"armor":k+=Number(S.system.at);break}b[S.system.traitType].push(S),I=!0;break;case"poison":y.poison.items.push(S),y.poison.show=!0;break;case"equipment":S.toggle=getProperty(S,"system.worn.wearable")||!1,S.toggle&&(S.toggleValue=getProperty(S.system,"worn.value")||!1),this._setOnUseEffect(S),y[S.system.category].items.push(N._prepareitemStructure(S)),y[S.system.category].show=!0;break;case"advantage":this._setOnUseEffect(S),s.push(S);break;case"disadvantage":this._setOnUseEffect(S),i.push(S);break;case"specialability":this._setOnUseEffect(S),f[S.system.category].push(S);break}}catch(j){this._itemPreparationError(S,j)}for(let S of y.bags.items)this._setBagContent(S,v);for(let S of y.rangeweapons.items)try{S.system.worn.value&&l.push(N._prepareRangeWeapon(S,d,a,this))}catch(j){this._itemPreparationError(S,j)}for(let S of u)try{c.push(N._prepareMeleeWeapon(S,a,t,u.filter(j=>j._id!=S._id&&!_.isYieldedTwohanded(j))))}catch(j){this._itemPreparationError(S,j)}let H=duplicate(w.characteristics);return H["-"]="-",{totalWeight:parseFloat(this.system.totalWeight.toFixed(3)),armorSum:k,encumbrance:this.system.condition?.encumbered||0,carrycapacity:this.system.carrycapacity,wornRangedWeapons:l,guidevalues:H,wornMeleeWeapons:c,advantages:s,disadvantages:i,specAbs:f,information:r,combatskills:a,hasTrait:I,traits:b,wornArmor:n,inventory:y,canAdvance:this.system.canAdvance,sheetLocked:t.system.sheetLocked,magic:T,allSkillsLeft:{body:g.body,social:g.social},allSkillsRight:{knowledge:g.knowledge,trade:g.trade},schips:p}}setupWeapon(e,t,a,s){return a.mode=t,C.getSubClass(e.type).setupDialog(null,a,e,this,s)}setupSpell(e,t={},a){return C.getSubClass(e.type).setupDialog(null,t,e,this,a)}static _prepareitemStructure(e){let t=getProperty(e,"flags.dsk.enchantments");return t&&t.length>0?e.enchantClass="rar":e.effects.length>0&&(e.enchantClass="common"),e}async checkEnoughXP(e){if(!this.system.canAdvance||isNaN(e)||e==null||Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=e)return!0;if(Number(this.system.details.experience.total==0)){let t=`<p>${game.i18n.localize("dsk.DSKError.zeroXP")}</p><label>${game.i18n.localize("dsk.APValue")}: </label><input type="number" name="APsel" value="150"/>`,a=0,s=!1;if([s,a]=await new Promise((i,r)=>{new Dialog({title:game.i18n.localize("dsk.DSKError.NotEnoughXP"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:n=>{i([!0,n.find('[name="APsel"]')[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{i([!1,0])}}}}).render(!0)}),s)return await this.update({"system.details.experience.total":Number(a)}),!0}return ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughXP")),!1}getSkillModifier(e,t){let a=[],s=["FP","step","QL","TPM","FW"];for(let i of s){let r=i=="step"?"":i;a.push(...this.system.skillModifiers[i].filter(n=>n.target==e).map(n=>({name:n.source,value:n.value,type:r}))),this.system.skillModifiers[t]&&a.push(...this.system.skillModifiers[t][i].map(n=>({name:n.source,value:n.value,type:r})))}return a}setupSkill(e,t={},a){return C.getSubClass(e.type).setupDialog(null,t,e,this,a)}static prepareMag(e){return e.system.ammunitiongroup=="mag"&&(e.structureMax=e.system.mag.max,e.structureCurrent=e.system.mag.value),e}async _updateAPs(e,t={},a={}){if(this.system.canAdvance)if(!isNaN(e)&&e!=null){let s=Number(e);t["system.details.experience.spent"]=Number(this.system.details.experience.spent)+s,await this.update(t,a);let i=game.i18n.format(s>0?"dsk.advancementCost":"dsk.refundCost",{cost:Math.abs(s)});za(i)}else ui.notifications.error(game.i18n.localize("dsk.DSKError.APUpdateError"))}setupRegeneration(e,t={},a){let s=game.i18n.localize("dsk.regenerationTest"),i={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this.actor,a)}};i.extra.actor.isMage=this.system.isMage;let r=O.getRollModifiers(i.extra.actor,i.source),n={title:s,template:"/systems/dsk/templates/dialog/regeneration-dialog.html",data:{rollMode:t.rollMode,regenerationInterruptOptions:w.regenerationInterruptOptions,regnerationCampLocations:w.regnerationCampLocations,showAepModifier:this.system.isMage,situationalModifiers:r,modifier:t.modifier||0},callback:(c,u={})=>{i.situationalModifiers=N._parseModifiers(c),l.rollMode=c.find('[name="rollMode"]').val(),i.situationalModifiers.push({name:game.i18n.localize("dsk.camplocation")+" - "+c.find('[name="regnerationCampLocations"] option:selected').text(),value:c.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("dsk.interruption")+" - "+c.find('[name="regenerationInterruptOptions"] option:selected').text(),value:c.find('[name="regenerationInterruptOptions"]').val()}),i.regenerationFactor=c.find('[name="badEnvironment"]').is(":checked")?.5:1;let d=["LeP","AeP"],p={};for(let f of d){i[`${f}Modifier`]=Number(c.find(`[name="${f}Modifier"]`).val()||0),i[`regeneration${f}`]=Number(this.system.stats.regeneration[`${f}max`]);let b=c.find(`[name="regenerate${f}"]`).is(":checked")?1:0;i[`regenerate${f}`]=b,b&&(p[`system.stats.regeneration.${f}Temp`]=0)}return mergeObject(i.extra.options,u),this.update(p),{testData:i,cardOptions:l}}},l=this._setupCardOptions("systems/dsk/templates/chat/roll/regeneration-card.html",s,a);return _DiceDSK.setupDialog({dialogOptions:n,testData:i,cardOptions:l})}setupCharacteristic(e,t={},a){let s=this.system.characteristics[e],i=game.i18n.localize(`dsk.characteristics.${e}.name`)+" "+game.i18n.localize("dsk.probe"),r={opposable:!1,source:{type:"char",system:{characteristic1:e,characteristic2:e}},extra:{characteristicId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this,a)}},n={title:i,template:"/systems/dsk/templates/dialog/characteristic-dialog.html",data:{rollMode:t.rollMode,modifier:t.modifier||0,characteristics:[1,2].map(c=>e),hasSchips:C.hasSchips(this)},callback:(c,u={})=>(l.rollMode=c.find('[name="rollMode"]').val(),r.situationalModifiers=N._parseModifiers(c),N.schipsModifier(c,r.situationalModifiers),r.situationalModifiers.some(d=>d.name==game.i18n.localize("dsk.schips"))&&this.reduceSchips(0),C.changeChars(r.source,...[0,1].map(d=>c.find(`[name="characteristics${d}"]`).val())),mergeObject(r.extra.options,u),{testData:r,cardOptions:l})},l=this._setupCardOptions("systems/dsk/templates/chat/roll/characteristic-card.html",i,a);return _DiceDSK.setupDialog({dialogOptions:n,testData:r,cardOptions:l})}_setupCardOptions(e,t,a){let s=game.canvas.tokens.get(a),i={speaker:{alias:s?s.name:this.prototypeToken.name,actor:this.id},title:t,template:e,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)i.speaker.alias=this.token.name,i.speaker.token=this.token.id,i.speaker.scene=canvas.scene.id,i.flags.img=this.token.img;else{let r=ChatMessage.getSpeaker();r.actor==this.id&&(i.speaker.alias=r.alias,i.speaker.token=r.token,i.speaker.scene=r.scene,i.flags.img=r.token?canvas.tokens.get(r.token).img:i.flags.img)}return i}static _parseModifiers(e,t){let a=[];return e.find('[name="situationalModifiers"] option:selected').each(function(){let s=$(this).val(),i={name:$(this).text().trim().split("[")[0],value:isNaN(s)?s:Number(s),type:$(this).attr("data-type")};i.type=="dmg"&&(i.damageBonus=i.value,i.value=0),$(this).attr("data-specAbId")&&(i.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(i.armorPen=$(this).attr("data-armorPen")),a.push(i)}),a.push({name:game.i18n.localize("dsk.manual"),value:Number(e.find('[name="testModifier"]').val()),type:""}),a}static async schipsModifier(e,t){e.find('[name="schips"]').is(":checked")&&t.push({name:game.i18n.localize("dsk.schips"),value:5,type:""})}async consumeAmmunition(e){if(e.extra.ammo&&!e.extra.ammoDecreased){if(e.extra.ammoDecreased=!0,e.extra.ammo._id){let t={_id:e.extra.ammo._id};e.extra.ammo.system.ammunitionType=="mag"?e.extra.ammo.system.mag.value<=0?(e.extra.ammo.system.quantity--,t["system.quantity"]=e.extra.ammo.system.quantity,t["system.mag.value"]=e.extra.ammo.system.mag.max-1):t["system.mag.value"]=e.extra.ammo.system.mag.value-1:(e.extra.ammo.system.quantity--,t["system.quantity"]=e.extra.ammo.system.quantity),await this.updateEmbeddedDocuments("Item",[t,{_id:e.source._id,"system.reloadTimeprogress":0}])}}else(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType=="rangeAttack")&&!e.extra.ammoDecreased?(e.extra.ammoDecreased=!0,await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTimeprogress":0}])):["ahnengabe"].includes(e.source.type)&&e.extra.speaker.token!="emptyActor"&&await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}])}async basicTest({testData:e,cardOptions:t},a={}){e=await _DiceDSK.rollDices(e,t);let s=await _DiceDSK.rollTest(e);if(e.extra.options.other&&(s.other||(s.other=[]),s.other.push(...e.extra.options.other)),s.postFunction="basicTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("dsk.Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}if(await this.consumeAmmunition(e),!a.suppressMessage){let i=await _DiceDSK.renderRollCard(t,s,a.rerenderMessage);await L.handleOpposedTarget(i),s.messageId=i.id}return{result:s,cardOptions:t,options:a}}tokenScrollingText(e){let t=this.isToken?[this.token?.object]:this.getActiveTokens(!0);for(let a of t){if(!a)continue;let s=0;for(let i of e)canvas.interface.createScrollingText(a.center,i.value,{anchor:s,direction:i.value>0?2:1,fontSize:game.settings.get("dsk","scrollingFontsize"),stroke:i.stroke,strokeThickness:1,jitter:.25,duration:1e3}),s+=1}}async _preUpdate(e,t,a){await super._preUpdate(e,t,a);let s={LeP:9109504,AeP:723929},i=[];for(let r of Object.keys(s)){let n=getProperty(e,`system.stats.${r}.value`);n&&i.push({value:n-this.system.stats[r].value,stroke:s[r]})}i.length&&this.tokenScrollingText(i)}_itemPreparationError(e,t){console.error("Something went wrong with preparing item "+e.name+": "+t),console.warn(t),console.warn(e),ui.notifications.error("Something went wrong with preparing item "+e.name+": "+t)}_setBagContent(e,t){if(t.has(e._id)){e.children=[];for(let a of t.get(e._id))e.children.push(N._prepareitemStructure(a)),t.has(a._id)&&this._setBagContent(a,t)}}async applyDamage(e){let t=Math.min(this.system.stats.LeP.max,this.system.stats.LeP.value-e);await this.update({"system.stats.LeP.value":t})}async applyRegeneration(e,t){let a={"system.stats.LeP.value":Math.min(this.system.stats.LeP.max,this.system.stats.LeP.value+(e||0)),"system.stats.AeP.value":Math.min(this.system.stats.AeP.max,this.system.stats.AeP.value+(t||0))};await this.update(a)}async applyMana(e){let t=Math.min(this.system.stats.AeP.max,this.system.stats.AeP.value-e);return t>=0?(await this.update({["data.stats.AeP.value"]:t}),!0):(ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughAeP")),!1)}async actorEffects(){let e=["dead"];return game.user.isGM||this.testUserPermission(game.user,"OBSERVER")||!await game.settings.get("dsk","hideEffects")?this.effects.filter(a=>!a.disabled&&!a.notApplicable&&(game.user.isGM||!a.getFlag("dsk","hidePlayers"))&&!a.getFlag("dsk","hideOnToken")&&(a.origin==this.uuid||!a.origin)):this.effects.filter(a=>e.some(s=>a.statuses.has(s)))}async _preCreate(e,t,a){await super._preCreate(e,t,a);let s={};e.img||(s.img="icons/svg/mystery-man-black.svg"),e.type=="character"&&mergeObject(s,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(s)}async markDead(e){let t=this.getActiveTokens();for(let a of t)a.combatant&&await a.combatant.update({defeated:e})}async addCondition(e,t=1,a=!1,s=!0){if(e=="bleeding")return await _.bleedingMessage(this);if(this.isToken&&!this.token?.object){console.warn("Actor token object is null for",this.name);return}return await O.addCondition(this,e,t,a,s)}async removeCondition(e,t=1,a=!0,s=!1){return await O.removeCondition(this,e,t,a,s)}hasCondition(e){return O.hasCondition(this,e)}},D=N;m(D,"ActorDSK"),z(D,"_baseCarryItems",new Set(["armor","meleeweapon","ammunition","rangeweapon","plant","poison","money","consumable","equipment"])),z(D,"_mageSpecs",new Set(["ahnen"]));function Na(){let o={Rq:"roll"},e={Rq:"dice"},t={Rq:""},a=/(-|\+)?\d+/,s=/\[[a-zA-z&; -]+/,i=/[\[\]]/g;if(!w.statusRegex){let r=w.statusEffects.map(l=>game.i18n.localize(l.name).toLowerCase()),n=["dsk.status","dsk.condition","dsk.level","dsk.levels"].map(l=>game.i18n.localize(l)).join("|");w.statusRegex={effects:r,regex:new RegExp(`(${n}) (${r.join("|")})`,"gi")}}CONFIG.TextEditor.enrichers.push({pattern:/@(Rq|Ch)\[[a-zA-z&; -]+ (-|\+)?\d+\]/g,enricher:(r,n)=>{let l=r[0],c=r[1],u=Number(l.match(a)[0]),d=l.replace(u,"").match(s)[0].replace(i,"").trim();return $(`<a class="roll-button request-${o[c]}" data-type="skill" data-modifier="${u}" data-name="${d}"><em class="fas fa-${e[c]}"></em>${t[c]}${d} ${u}</a>`)[0]}},{pattern:w.statusRegex.regex,enricher:(r,n)=>$(Sa(r))[0]},{pattern:/@Info\[[a-zA-z&; -\.0-9]+\]/g,enricher:async(r,n)=>{let l=r[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1),c=await fromUuid(l);if(!c||c.type!="information")return $('<a class="content-link broken"><i class="fas fa-unlink"></i>info</a>')[0];if(!game.user.isGM)return $(`<a class="content-link"><i class="fas fa-mask"></i>${game.i18n.localize("dsk.GM notes")}</a>`)[0];let u=await renderTemplate("systems/dsk/templates/items/infopreview.html",{item:c});return $(u)[0]}},{pattern:/@PostChat\[(.*?)\]/g,enricher:async(r,n)=>{let l=r[1];return $(`<div class="row-section wrap maskfield postChatSection"><div class="col ninety"></div><div class="col ten center postContentChat" data-tooltip="dsk.SHEET.PostItem"><em class="far fa-comment-dots"></em></div><div class="col postChatContent">${l}</div></div>`)[0]}})}m(Na,"setEnrichers");function Sa(o){let t=o[0].split(" "),a=t.shift();t=t.join(" ");let s=w.statusEffects[w.statusRegex.effects.indexOf(t.toLowerCase())];return`<span>${a} <a class="chatButton chat-condition" data-id="${s.id}"><img src="${s.icon}"/>${t}</a></span>`}m(Sa,"conditionsMatcher");var h=class{static chatDataSetup(e,t,a){let s={user:game.user.id,rollMode:t||game.settings.get("core","rollMode"),content:e};return["gmroll","blindroll"].includes(s.rollMode)&&(s.whisper=ChatMessage.getWhisperRecipients("GM").map(i=>i.id)),s.rollMode==="blindroll"?s.blind=!0:s.rollMode==="selfroll"&&(s.whisper=[game.user]),a&&(s.speaker=ChatMessage.getSpeaker(),s.whisper=ChatMessage.getWhisperRecipients(a)),s}static categoryLocalization(e){return game.i18n.localize(`TYPES.Item.${e}`)}static fateAvailable(e,t){return e.system.stats.schips.value>0}static isActiveGM(){let e=game.users.find(t=>t.active&&t.isGM);return e&&game.user.id==e.id}static parseAbilityString(e){return{original:e.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:e.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((e.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(e.match(/\(([^()]+)\)/)||["",""])[1],type:e.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":e.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:e.match(/[-+]\d{1,2}$/)!=null}}static async allSkills(e=["skill","combatskill","specialability"]){let t=game.i18n.lang=="de"?"dsk.default":"dsk.defaulten";return await this.getCompendiumEntries(t,e)}static escapeRegex(e){return(typeof e=="string"||e instanceof String?e:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}static replaceDies(e,t=!1){let a=/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,s=t?"":"/roll ";return e.replace(a,function(i){return` [[${s}${i.replace(/[DwW]/,"d")}]]`})}static toObjectIfPossible(e){return typeof e.toObject=="function"?e.toObject(!1):duplicate(e)}static async allSkillsList(e=["skill","combatskill","specialability"]){let t=await this.allSkills(e),a=[],s=[],i=[];for(let r of t)r.type=="skill"?a.push(r.name):r.type=="combatskill"&&(r.system.weapontype=="melee"?i.push(r.name):s.push(r.name));return{skills:a.sort((r,n)=>r.localeCompare(n)),rangeSkills:s.sort((r,n)=>r.localeCompare(n)),meleeSkills:i.sort((r,n)=>r.localeCompare(n))}}static replaceConditions(e){return e&&e.replace(w.statusRegex.regex,t=>Sa([t]))}static moduleEnabled(e){return game.modules.get(e)&&game.modules.get(e).active}static getSpeaker(e){let t=ChatMessage.getSpeakerActor(e);if(!t&&canvas.tokens){let a=canvas.tokens.get(e.token);a&&(t=a.actor)}if(!t){let a=game.scenes.get(e.scene);try{a&&(t=new Token(a.getEmbeddedDocument("Token",e.token))?.actor)}catch{}}return t}static async showArtwork({img:e,name:t,uuid:a,isOwner:s},i=!1){new ImagePopout(e,{title:i?s?t:"-":t,shareable:!0,uuid:a}).render(!0)}static renderToggle(e){e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}static async skillByName(e){let t=game.packs.get(game.i18n.lang=="de"?"dsk.default":"dsk.defaulten");await t.getIndex();let a=t.index.find(s=>s.name===e);return await t.getDocument(a._id)}static async emptyActor(e=12){Array.isArray(e)||(e=[e,e,e,e,e,e,e,e]);let t=await D.create({name:"Alricat",type:"npc",items:[],system:{stats:{LeP:{value:50},schips:{}},characteristics:{mu:{initial:e[0]},kl:{initial:e[1]},in:{initial:e[2]},ch:{initial:e[3]},ff:{initial:e[4]},ge:{initial:e[5]},ko:{initial:e[6]},kk:{initial:e[7]}}}},{temporary:!0,noHook:!0});return t.prepareData(),t}static calcTokenSize(e,t){let a=game.dsk.config.tokenSizeCategories[e.system.details.size];if(a)if(a<1)mergeObject(t,{texture:{scaleX:a,scaleY:a},width:1,height:1});else{let s=Math.floor(a),i=Math.max(a/s,.25);mergeObject(t,{width:s,height:s,texture:{scaleX:i,scaleY:i}})}}static _calculateAdvCost(e,t,a=1){return w.advancementCosts[t][Number(e)+a]}static async getCompendiumEntries(e,t){let a=await game.packs.get(e);if(!a)return ui.notifications.error("No content found"),[];let s=Array.isArray(t)?t:[t];return(await a.getDocuments()).filter(r=>s.includes(r.type)).map(r=>r.toObject())}static async getFolderForType(e,t=null,a=null,s=0,i="",r=void 0){let n=await game.folders.contents.find(l=>l.name==a&&l.type==e&&l.folder?.id==t);return n||(n=await Folder.create({name:a,type:e,sorting:r||(e=="JournalEntry"?"a":"m"),color:i,sort:s,parent:t})),n}};m(h,"DSKUtility");var fe=class{static async showDialog(e){let[t]=await new Promise((a,s)=>{new Dialog({title:game.i18n.localize("dsk.Migrakel.Migration"),content:e,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{a([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{a([!1])}}},close:()=>{a([!1])}}).render(!0)});return t}static async refreshStatusEffects(e){let t=[];for(let a of e.effects)if(a.origin){let s;try{s=await fromUuid(a.origin)}catch{}s||t.push(a.id)}await e.deleteEmbeddedDocuments("ActiveEffect",t)}static async updateVals(e,t,a){let s=game.dsk.itemLibrary,i=[],r=[],n=new Map;if(await this.refreshStatusEffects(e),t({type:"equipment"})){let l=[],c=[];for(let d of e.items.filter(p=>p.type=="equipment"&&p.system.category=="bags")){let p=await s.findCompendiumItem(d.name,d.type);if(p.length>0){if(p=p.find(b=>b.name==d.name&&b.type==d.type),!p)continue;console.log(`MIGRATION - Updated ${d.name}`);let f=mergeObject(d.toObject(),a(p));c.push(f),l.push(d.id)}}let u=await e.createEmbeddedDocuments("Item",c);for(let d=0;d<u.length;d++)n.set(l[d],u[d].id);await e.deleteEmbeddedDocuments("Item",l)}for(let l of e.items.filter(c=>t(c)&&!(c.type=="equipment"&&c.system.category=="bags"))){let c=await s.findCompendiumItem(l.name,l.type);if(c.length>0){if(c=c.find(d=>d.name==l.name&&d.type==l.type),!c)continue;console.log(`MIGRATION - Updated ${l.name}`);let u=mergeObject(l.toObject(),a(c));u.system.parent_id&&n.has(u.system.parent_id)&&(u.system.parent_id=n.get(u.system.parent_id)),r.push(u),i.push(l.id)}}await e.createEmbeddedDocuments("Item",r),await e.deleteEmbeddedDocuments("Item",i),ui.notifications.notify(game.i18n.localize("dsk.Migrakel.migrationDone"))}static async updateSpellsAndLiturgies(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.spells"))){let t=m(s=>["spell","liturgy","ritual","ceremony","spellextension"].includes(s.type),"condition"),a=m(s=>({effects:s.effects.toObject()}),"updator");await this.updateVals(e,t,a)}}static async updateSpecialAbilities(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.abilities"))){let t=m(s=>{let i={system:{effect:{value:s.system.effect}},effects:s.effects.toObject()};return s.type=="specialability"&&mergeObject(i,{system:{category:{sub:s.system.category.sub||0},list:{value:s.system.list.value}}}),this.updateMacro(i,s),i},"updator"),a=m(s=>["specialability","advantage","disadvantage","trait"].includes(s.type),"condition");await this.updateVals(e,a,t)}}static async updateCombatskills(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.cskills"))){let t=m(s=>({effects:s.effects.toObject()}),"updator"),a=m(s=>["combatskill"].includes(s.type),"condition");await this.updateVals(e,a,t)}}static async updateSkills(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.skills"))){let t=m(s=>["skill"].includes(s.type),"condition"),a=m(s=>({img:s.img}),"updator");await this.updateVals(e,t,a)}}static updateMacro(e,t){let a=t.getFlag("dsk","onUseEffect");a&&mergeObject(e,{flags:{dsk:{onUseEffect:a}}})}static async updateGear(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.gear"))){let t=m(s=>["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(s.type),"condition"),a=m(s=>{let i={img:s.img,effects:s.effects.toObject()};return this.updateMacro(i,s),i},"updator");await this.updateVals(e,t,a)}}};m(fe,"Migrakel");var ge=class extends Dialog{constructor(e,t){super(t),this.actor=e,this.lock=!1}static async buildDialog(e){let t=await renderTemplate("systems/dsk/templates/actors/parts/actorConfig.html",{actor:e});new ge(e,{title:game.i18n.localize("dsk.SHEET.actorConfig"),content:t,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.save"),callback:a=>{e.update({"system.config.autoBar":a.find('[name="autoBar"]').is(":checked"),"system.config.autoSize":a.find('[name="autoSize"]').is(":checked")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async updateWrapper(e,t){return ui.notifications.warn("There is nothing to migrate yet.")}activateListeners(e){super.activateListeners(e),e.find(".updateSpells").click(async t=>this.updateWrapper("updateSpellsAndLiturgies",t)),e.find(".updateAbilities").click(async t=>this.updateWrapper("updateSpecialAbilities",t)),e.find(".updatecSkills").click(async t=>this.updateWrapper("updateCombatskills",t)),e.find(".updateSkills").click(async t=>this.updateWrapper("updateSkills",t)),e.find(".updateGear").click(async t=>this.updateWrapper("updateGear",t))}};m(ge,"DialogActorConfig");function Se(o,e="img"){!game.user.isGM||o.find(e).each(function(t,a){a.setAttribute("draggable",!0),a.addEventListener("dragstart",s=>ls(s))})}m(Se,"bindImgToCanvasDragStart");var ls=m(o=>{canvas.tiles.activate();let e=o.currentTarget.src,t=o.currentTarget,a=canvas.dimensions.sceneHeight/t.naturalHeight,s=canvas.dimensions.sceneWidth/t.naturalWidth,i=Math.min(1,s,a),r=Math.round(canvas.dimensions.size/i),n={type:"Tile",texture:{src:e},tileSize:r};o.dataTransfer.setData("text/plain",JSON.stringify(n));let l=t.naturalWidth*i*canvas.stage.scale.x,c=t.naturalHeight*i*canvas.stage.scale.y,u=DragDrop.createDragImage(t,l,c);o.dataTransfer.setDragImage(u,l/2,c/2)},"dragTileImg");var ie=class extends ActorSheet{async _render(e=!1,t={}){this._saveSearchFields(),this._saveCollapsed(),await super._render(e,t),this._setCollapsed(),this._restoreSeachFields();let a=$(this._element),s={".close":"dsk.SHEET.Close",".configure-sheet":"dsk.SHEET.Configure",".configure-token":"dsk.SHEET.Token",".import":"dsk.SHEET.Import",".locksheet":"dsk.SHEET.Lock",".library":"dsk.SHEET.Library",".playerview":"dsk.SHEET.switchLimited",".actorConfig":"dsk.SHEET.actorConfig"};for(let i of Object.keys(s))a.find(i).attr("data-tooltip",game.i18n.localize(s[i]));this.currentFocus&&(a.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null)}async swapWeaponHand(e){let t=this._getItemId(e),a=this.actor.items.get(t);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.wrongGrip":!a.system.worn.wrongGrip}])}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],mergeObject(e,{width:770,height:740,scrollY:[".save-scroll"],dragDrop:[{dragSelector:".content .item",dropSelector:null},{dragSelector:".mainEffects .statusEffect",dropSelector:null}]}),e}_saveSearchFields(){if(this.form===null)return;let e=$(this.form).parent();this.searchFields={talentFiltered:$(e.find(".filterTalents")).hasClass("filtered"),searchText:$(e.find(".talentSearch")).val(),gearSearch:$(e.find(".gearSearch")).val()}}_restoreSeachFields(){if(this.searchFields!=null){let e=$(this.form).parent();this.searchFields.talentFiltered&&($(e.find(".filterTalents")).addClass("filtered"),$(e.find(".allTalents")).removeClass("showAll"));let t=$(e.find(".talentSearch"));t.val(this.searchFields.searchText),this.searchFields.searchText!=""&&this._filterTalents(t);let a=$(e.find(".gearSearch"));a.val(this.searchFields.gearSearch),this.searchFields.searchText!=""&&this._filterGear(a)}}_saveCollapsed(){if(this.form===null)return;let e=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];let t=e.find(".ch-collapse i");for(let a of t)this.collapsedBoxes.push($(a).attr("class"));for(let a of $(e.find(".expandDetails.shown")))this.openDetails.push($(a).closest(".item").attr("data-item-id"))}_setCollapsed(){let e=$(this.form).parent();if(this.collapsedBoxes){let t=e.find(".ch-collapse i");for(let a=0;a<t.length;a++)$(t[a]).attr("class",this.collapsedBoxes[a]),this.collapsedBoxes[a]&&this.collapsedBoxes[a].indexOf("fa-angle-down")!=-1&&$(t[a]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}}async getData(e){let t=await super.getData(e),a={actor:t.actor,editable:t.editable,limited:t.limited,owner:t.owner};return a.prepare=this.actor.prepareSheet({details:this.openDetails}),a.sizeCategories=w.sizeCategories,a.isGM=game.user.isGM,a.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},O.prepareActiveEffects(this.actor,a),a.enrichedOwnerdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.owner"),{secrets:this.object.isOwner,async:!0}),a.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.gm"),{secrets:this.object.isOwner,async:!0}),a.enrichedNotes=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.description"),{secrets:this.object.isOwner,async:!0}),a.enrichedBiography=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.biography"),{secrets:this.object.isOwner,async:!0}),a}async _openLibrary(){game.dsk.itemLibrary.render(!0)}async _configActor(){ge.buildDialog(this.actor)}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"library",icon:"fas fa-university",onclick:async()=>this._openLibrary()}),this.actor.isOwner&&e.unshift({class:"actorConfig",icon:"fas fa-link",onclick:async()=>this._configActor()}),this.actor.system.canAdvance&&e.unshift({class:"locksheet",icon:`fas fa-${this.actor.system.sheetLocked?"":"un"}lock`,onclick:async t=>this._changeAdvanceLock(t)}),e}async _changeAdvanceLock(e){await this.actor.update({"system.sheetLocked":!this.actor.system.sheetLocked}),$(e.currentTarget).find("i").toggleClass("fa-unlock fa-lock")}showLimited(){return!game.user.isGM&&this.actor.limited}getTokenId(){return this.token?this.token.id:void 0}activateListeners(e){super.activateListeners(e);let t=m(d=>{this.actor.items.get(this._getItemId(d)).postItem()},"posthand");e.find(".schip").click(d=>{d.preventDefault();let p=Number(d.currentTarget.getAttribute("data-val"));p==1&&$(this.form).find(".fullSchip").length==1&&(p=0),this.actor.update({"system.stats.schips.value":p})}),e.find(".swapWeaponHand").click(d=>this.swapWeaponHand(d)),e.find(".loadWeapon").mousedown(async d=>{let p=this._getItemId(d),f=this.actor.items.get(p).toObject();if(getProperty(f,"system.currentAmmo")==="")return;let b={_id:p};if(d.button==0){let T=f.type=="trait"?f.system.lz:D.calcLZ(f,this.actor);b["system.reloadTimeprogress"]=Math.min(f.system.reloadTimeprogress+1,T)}else d.button==2&&(b["system.reloadTimeprogress"]=0);await this.actor.updateEmbeddedDocuments("Item",[b])}),e.find(".item-swapMag").click(async d=>{await this.actor.swapMag(this._getItemId(d))}),e.find(".ammo-selector").change(async d=>{d.preventDefault();let p=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.currentAmmo":$(d.currentTarget).val()}])}),e.find(".condition-edit").click(async d=>{(d.currentTarget.dataset.uuid?await fromUuid(d.currentTarget.dataset.uuid):this.actor.effects.get(d.currentTarget.dataset.id)).sheet.render(!0)}),e.find(".ch-collapse").click(d=>{$(d.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(d.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()}),e.find(".item-toggle").click(d=>{let p=this._getItemId(d),f=this.actor.items.get(p).toObject();switch(f.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.worn.value":!f.system.worn.value}]),K.playEquipmentWearStatusChange(f);break}}),e.find(".status-create").click(d=>{let p=$(d.currentTarget).closest(".statusEffectMenu").find("ul");p.fadeIn("fast",()=>{p.find("input").focus()})}),e.find(".statusEffectMenu ul").mouseleave(d=>$(d.currentTarget).fadeOut()),e.find(".status-add").click(async d=>{let p=$(d.currentTarget).attr("data-id");p=="custom"?O.createCustomEffect(this.actor):await this.actor.addCondition(p,1,!1,!1)}),e.find(".skill-select").mousedown(d=>{let p=this._getItemId(d),f=this.actor.items.get(p);d.button==0?this.actor.setupSkill(f,{},this.getTokenId()).then(b=>{this.actor.basicTest(b)}):d.button==2&&f.sheet.render(!0)}),e.find(".advance-attribute").mousedown(d=>this.advanceWrapper(d,"_advanceAttribute",$(d.currentTarget).attr("data-attr"))),e.find(".refund-attribute").mousedown(d=>this.advanceWrapper(d,"_refundAttributeAdvance",$(d.currentTarget).attr("data-attr"))),e.find(".advance-item").mousedown(d=>this.advanceWrapper(d,"_advanceItem",this._getItemId(d))),e.find(".refund-item").mousedown(d=>this.advanceWrapper(d,"_refundItemAdvance",this._getItemId(d))),e.find(".advance-points").mousedown(d=>this.advanceWrapper(d,"_advancePoints",$(d.currentTarget).attr("data-attr"))),e.find(".refund-points").mousedown(d=>this.advanceWrapper(d,"_refundPointsAdvance",$(d.currentTarget).attr("data-attr"))),e.find(".spell-select").mousedown(d=>{let p=this._getItemId(d),f=this.actor.items.get(p);d.button==0?this.actor.setupSpell(f,{},this.getTokenId()).then(b=>this.actor.basicTest(b)):d.button==2&&f.sheet.render(!0)}),e.find(".quantity-click").mousedown(d=>{let p=this._getItemId(d),f=this.actor.items.get(p).toObject();_.increment(d,f,"system.quantity",0),this.actor.updateEmbeddedDocuments("Item",[f])}),e.find(".item-post").click(d=>t(d)),e.find(".item-dropdown").click(d=>{d.preventDefault(),$(d.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")}),e.find(".condition-show").mousedown(d=>{d.preventDefault();let p=d.currentTarget.dataset.id,f=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");if(d.button==0){let b=$(d.currentTarget).parents(".statusEffect").attr("data-origin");if(b)fromUuid(b).then(T=>T.sheet.render(!0));else{let T,g;f?(T=CONFIG.statusEffects.find(v=>v.id==f),g=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${T.id}"><img src="${T.icon}"/>${game.i18n.localize(T.name)}</a></b>: ${game.i18n.localize(T.description)}</div>`)):(T=this.actor.effects.find(v=>v.id==p),T&&(g=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${T.id}"><img src="${T.icon}"/>${game.i18n.localize(T.name)}</a></b>: ${game.i18n.localize(T.flags.dsk.description)}</div>`)));let y=$(d.currentTarget).closest(".groupbox").find(".effectDescription");y.fadeOut("fast",function(){y.html(g).fadeIn("fast")})}}else d.button==2&&!d.currentTarget.dataset.locked&&this._deleteActiveEffect(p)}),e.on("click",".chat-condition",d=>F.postStatus($(d.currentTarget).attr("data-id"))),e.find(".skill-advances").change(async d=>{let p=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.level":Number(d.target.value)}])}),e.find(".item-edit").click(d=>{d.preventDefault();let p=this._getItemId(d);this.actor.items.get(p).sheet.render(!0)}),e.find(".disableRegeneration").click(d=>{let f=`system.repeatingEffects.disabled.${d.currentTarget.dataset.type}`;this.actor.update({[f]:!getProperty(this.actor,f)})}),e.find(".consume-item").mousedown(d=>{if(d.button==2){let p=this._getItemId(d),f=this.actor.items.get(p);this.consumeItem(f)}}),e.find(".ch-value").click(d=>{d.preventDefault();let p=d.currentTarget.attributes["data-char"].value;this.actor.setupCharacteristic(p,{},this.getTokenId()).then(f=>this.actor.basicTest(f))}),e.find(".ch-regenerate").click(d=>{d.preventDefault(),this.actor.setupRegeneration("regenerate",{},this.getTokenId()).then(p=>this.actor.basicTest(p))}),e.find(".item-create").click(d=>this._onItemCreate(d)),e.find(".ch-rollCombat").click(d=>{d.preventDefault();let p=this._getItemId(d),f=$(d.currentTarget).attr("data-mode"),b=this.actor.items.get(p);this.actor.setupWeapon(b,f,{},this.getTokenId()).then(T=>this.actor.basicTest(T))});let a=m(d=>this._deleteItem(d),"deletehand");e.find(".onUseItem").click(d=>this._onMacroUseItem(d)),e.find(".cards .item").mouseenter(d=>{if(d.currentTarget.getElementsByClassName("hovermenu").length==0){let p=document.createElement("div");p.classList.add("hovermenu");let f=document.createElement("i");f.classList.add("fas","fa-times"),f.title=game.i18n.localize("dsk.SHEET.DeleteItem"),f.addEventListener("click",a,!1);let b=document.createElement("i");b.classList.add("fas","fa-comment"),b.title=game.i18n.localize("dsk.SHEET.PostItem"),b.addEventListener("click",t,!1),p.appendChild(b),p.appendChild(f),d.currentTarget.appendChild(p)}}),e.find(".cards .item").mouseleave(d=>{let p=d.toElement||d.relatedTarget;!p||p.parentNode==this||p==this||d.currentTarget.querySelectorAll(".hovermenu").forEach(f=>f.remove())});let s=this.actor.uuid;e.find(".actorDrag").each(function(d,p){p.setAttribute("draggable",!0),p.addEventListener("dragstart",f=>{let b={type:"Actor",uuid:s};f.dataTransfer.setData("text/plain",JSON.stringify(b))})}),e.find(".item-delete").click(d=>this._deleteItem(d)),e.find(".filterTalents").click(d=>{$(d.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(d.currentTarget).toggleClass("filtered")}),e.find(".condition-value").mousedown(async d=>{let p=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");d.button==0?await this.actor.addCondition(p,1,!1,!1):d.button==2&&await this.actor.removeCondition(p,1,!1)}),e.find(".condition-toggle").mousedown(async d=>{if(!this.isEditable)return;let p=$(d.currentTarget).parents(".statusEffect").attr("data-id"),f=this.actor.effects.get(p);await f.update({disabled:!f.disabled})}),e.find(".charimg").mousedown(d=>{d.button==2&&h.showArtwork(this.actor,!0)}),G.bindRollCommands(e);let i=m(d=>this._filterTalents($(d.currentTarget)),"filterTalents"),r=e.find(".talentSearch");r.keyup(d=>this._filterTalents($(d.currentTarget))),r[0]&&r[0].addEventListener("search",i,!1);let n=m(d=>this._filterConditions($(d.currentTarget)),"filterConditions"),l=e.find(".conditionSearch");l.keyup(d=>this._filterConditions($(d.currentTarget))),l[0]&&l[0].addEventListener("search",n,!1);let c=m(d=>this._filterGear($(d.currentTarget)),"filterGear"),u=e.find(".gearSearch");u.keyup(d=>this._filterGear($(d.currentTarget))),u[0]&&u[0].addEventListener("search",c,!1),Se(e,"img.charimg")}async advanceWrapper(e,t,a){let s=$(e.currentTarget).find("i");s.hasClass("fa-spin")||(s.addClass("fa-spin fa-spinner"),await this[t](a),s.removeClass("fa-spin fa-spinner"))}async _advanceAttribute(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial),a=h._calculateAdvCost(t,"Eig");await this._checkEnoughXP(a)&&await this._updateAPs(a,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)+1})}async _refundAttributeAdvance(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial);if(Number(this.actor.system.characteristics[e].advances)>0){let a=h._calculateAdvCost(t,"Eig",0)*-1;await this._updateAPs(a,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)-1})}}async _advancePoints(e){let t=Number(this.actor.system.stats[e].advances),a=h._calculateAdvCost(t,"D");await this._checkEnoughXP(a)&&this._checkMaximumPointAdvancement(e,t+1)&&await this._updateAPs(a,{[`system.stats.${e}.advances`]:Number(this.actor.system.stats[e].advances)+1})}async _refundPointsAdvance(e){let t=Number(this.actor.system.stats[e].advances);if(t>0){let a=h._calculateAdvCost(t,"D",0)*-1;await this._updateAPs(a,{[`system.stats.${e}.advances`]:Number(this.actor.system.stats[e].advances)-1})}}async _advanceItem(e){let t=this.actor.items.get(e).toObject(),a=h._calculateAdvCost(Number(t.system.level),t.system.StF);await this._checkEnoughXP(a)&&this._checkMaximumItemAdvancement(t,Number(t.system.level)+1)&&(await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.level":t.system.level+1}]),await this._updateAPs(a))}async _refundItemAdvance(e){let t=this.actor.items.get(e).toObject();if(t.system.level>0){let a=h._calculateAdvCost(Number(t.system.level),t.system.StF,0)*-1;await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.level":t.system.level-1}]),await this._updateAPs(a)}}_checkMaximumItemAdvancement(e,t){let a=!1;switch(e.type){case"combatskill":a=t<=this.maxByAttr(e,"dsk.LocalizedIDs.exceptionalCombatTechnique");break;case"ahnengabe":case"skill":a=t<=this.maxByAttr(e,"dsk.LocalizedIDs.exceptionalSkill");break}return a||ui.notifications.error(game.i18n.localize("dsk.DSKError.AdvanceMaximumReached")),a}maxByAttr(e,t){return Math.max(this.actor.system.characteristics[e.system.characteristic1].value,this.actor.system.characteristics[e.system.characteristic2].value)+2+E.vantageStep(this.actor,`${game.i18n.localize(t)} (${e.name})`)}async _checkEnoughXP(e){return await this.actor.checkEnoughXP(e)}_checkMaximumPointAdvancement(e,t){let a=!1;switch(e){case"LeP":a=t<=this.actor.system.characteristics.ko.value;break;case"AeP":a=t<=(this.actor.system.characteristics[this.actor.system.guidevalue]==null?0:this.actor.system.characteristics[this.actor.system.guidevalue].value);break}return a||ui.notifications.error(game.i18n.localize("dsk.DSKError.AdvanceMaximumReached")),a}_onItemCreate(e){e.preventDefault();let t=e.currentTarget,a=duplicate(t.dataset);w.equipmentTypes[a.type]&&(a.type="equipment",a=mergeObject(a,{"system.category":e.currentTarget.attributes["item-section"].value,"system.effect":""})),["aggregatedTest","ahnengabe"].includes(a.type)||(a["system.weight"]=0,a["system.quantity"]=0),C.defaultIcon(a),a.name=h.categoryLocalization(a.type),this.actor.createEmbeddedDocuments("Item",[a])}_onMacroUseItem(e){let t=this.actor.items.get(this._getItemId(e));new OnUseEffect(t).executeOnUseEffect()}_filterGear(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.element).find(".inventory .item");a.removeClass("filterHide"),a.filter(function(){return $(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}_filterTalents(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.form).parent().find(".allTalents");a.find(".item, .table-header, .table-title").removeClass("filterHide"),a.addClass("showAll").find(".item").filter(function(){return $(this).find(".talentName").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide"),t.length>0?(a.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),a.addClass("filterfull")):a.removeClass("filterfull")}}_filterConditions(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.form).find(".statusEffectMenu li:not(.search)");a.removeClass("filterHide"),a.filter(function(){return game.i18n.localize($(this).find("a").attr("data-tooltip")).toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async _deleteActiveEffect(e){if(!this.isEditable)return;let t=this.actor.effects.find(a=>a.id==e);t&&(this.token?this.token.actor:this.actor)&&await this.actor.deleteEmbeddedDocuments("ActiveEffect",[t.id])}_deleteItem(e){if(!this.isEditable)return;let t=this._getItemId(e),a=this.actor.items.get(t),s=game.i18n.format("dsk.DIALOG.DeleteItemDetail",{item:a.name});renderTemplate("systems/dsk/templates/dialog/delete-item-dialog.html",{message:s}).then(i=>{new Dialog({title:game.i18n.localize("dsk.DIALOG.deleteConfirmation"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>this._cleverDeleteItem(t)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)})}async _addVantage(e,t){E.needsAdoption(this.actor,e,t)}async _addSpecialAbility(e,t){x.needsAdoption(this.actor,e,t)}async _cleverDeleteItem(e){let t=this.actor.items.get(e),a=[e];switch(t.type){case"advantage":case"disadvantage":{await E.vantageRemoved(this.actor,t);let s=t.system.ap*(t.system.level||1);if(/;/.test(t.system.ap)){let i=t.system.ap.split(";").map(r=>Number(r.trim()));s=0;for(let r=0;r<t.system.level;r++)s+=i[r]}await this._updateAPs(-1*s,{},{render:!1})}break;case"specialability":await x.abilityRemoved(this.actor,t);break;case"ahnengeschenk":await this._updateAPs(-1);break;case"ahnengabe":{let s=0;for(let i=0;i<=t.system.level;i++)s+=h._calculateAdvCost(i,t.system.StF,0);await this._updateAPs(s*-1,{},{render:!1})}break}await this.actor.deleteEmbeddedDocuments("Item",a)}_getItemId(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}_onDragStart(e){let t=e.currentTarget;if(e.target.classList.contains("content-link"))return;let a;t.dataset.itemId&&(a=this.actor.items.get(t.dataset.itemId).toDragData(),t.dataset.mod&&(a.mod=t.dataset.mod)),t.dataset.id&&(a=this.actor.effects.get(t.dataset.id).toDragData()),a&&e.dataTransfer.setData("text/plain",JSON.stringify(a))}async _addUniqueItem(e){if(e=duplicate(e),!this.actor.items.some(t=>C.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async handleItemCopy(e,t){if(w.equipmentCategories.includes(t))return e.name+=" (Copy)",await this._addLoot(e)}async _addLoot(e){e=duplicate(e);let t=this.actor.items.find(a=>C.areEquals(e,a));return t?(await C.stackItems(t,e,this.actor))[0]:(this._tabs[0].active=="combat"&&e.system.worn&&(e.system.worn.value=!0),(await this.actor.createEmbeddedDocuments("Item",[e]))[0])}async _manageDragItems(e,t){switch(t){case"meleeweapon":case"rangeweapon":case"equipment":case"ammunition":case"consumable":case"armor":case"poison":return await this._addLoot(e);case"disadvantage":case"advantage":await this._addVantage(e,t);break;case"specialability":await this._addSpecialAbility(e,t);break;case"information":case"skill":await this._addUniqueItem(e);break;case"ahnengabe":case"ahnengeschenk":await this._addSpellOrLiturgy(e);break;case"effectwrapper":await this._handleEffectWrapper(e);break;default:ui.notifications.error(game.i18n.format("dsk.DSKError.canNotBeAdded",{item:e.name,category:game.i18n.localize(e.type)}))}}async _updateAPs(e,t={},a={}){await this.actor._updateAPs(e,t,a)}async _addSpellOrLiturgy(e){let t=this.actor.items.find(s=>s.type==e.type&&s.name==e.name),a;if(e=duplicate(e),!t){switch(e.type){case"ahnengabe":a=h._calculateAdvCost(0,e.system.StF,0);break;case"ahnengeschenk":a=1;break;default:return}await this.actor.checkEnoughXP(a)&&(await this._updateAPs(a,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}}async _addUniqueItem(e){if(e=duplicate(e),!this.actor.items.some(t=>C.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async _handleEffectWrapper(e){this.actor.createEmbeddedDocuments("ActiveEffect",e.effects.map(t=>(t.origin=null,t)))}async _onDropItemCreate(e){return e instanceof Array?this.actor.createEmbeddedDocuments("Item",e):await this._manageDragItems(e,e.type)}async _onDropActor(e,t){if(!this.actor.isOwner)return!1;let{item:a,typeClass:s,selfTarget:i}=await Wt(t,this.id,!1);if(!i)return await this._manageDragItems(a,s)}async _onDropActiveEffect(e,t){let a=await ActiveEffect.implementation.fromDropData(t);if(!this.actor.isOwner||!a||this.actor.uuid===a.parent?.uuid)return!1;let s=a.toObject();return s.origin=this.actor.uuid,ActiveEffect.create(s,{parent:this.actor})}async _onDropItem(e,t){if(!this.actor.isOwner)return!1;let a=await Item.implementation.fromDropData(t),s=a.toObject();_.obfuscateDropData(s,t.tabsinvisible);let i,r=$(e.target).parents(".item");r&&r.attr("data-category")=="bags"&&w.equipmentCategories.includes(a.type)&&r.attr("data-item-id")!=a.id&&(i=r.attr("data-item-id"));let n=this.actor.uuid===a.parent?.uuid;if(n)if(e.ctrlKey)await this.handleItemCopy(s,a.type);else if(i){let l={_id:a.id,"system.parent_id":i};a.system.worn&&a.system.worn.value&&(l["system.worn.value"]=!1),await this.actor.updateEmbeddedDocuments("Item",[l])}else w.equipmentCategories.includes(a.type)&&await this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,system:{parent_id:0}}]);else await this._onDropItemCreate(s);e.altKey&&!n&&w.equipmentCategories.includes(a.type)&&await this._handleRemoveSourceOnDrop(a)}};m(ie,"ActorSheetDSK");var he=m(o=>class extends o{async obfuscateItem(e){e.stopPropagation(),e.preventDefault();let t=e.currentTarget.dataset.obfuscate;await this.item.update({[`system.obfuscation.${t}`]:!this.isObfuscated(t)})}isObfuscated(e){return getProperty(this.item,`system.obfuscation.${e}`)}activateListeners(e){super.activateListeners(e),e.on("click",".obfuscateSection",t=>this.obfuscateItem(t))}obfuscationCss(e){return this.isObfuscated(e)?"":" pale"}async _render(e=!1,t={}){await super._render(e,t);let a=["details","effects","description","enchantment"],s=!1;for(let i of a){let r=$(this._element).find(`nav [data-tab="${i}"]`);if(!r.length)continue;let n=t.tabsinvisible||this.isObfuscated(i),l=game.i18n.localize(`dsk.SHEET.${n?"deobfuscateItem":"obfuscateItem"}`);if(game.user.isGM){let c=`obfuscateSection${this.obfuscationCss(i)}`,u=r.find(`.${c}`),d=`<a data-tooltip="${l}" class="obfuscationBtn ${c}" data-obfuscate="${i}"><i class="fas fa-mask"></i></a>`;u.length?u.replaceWith(d):r.append(` ${d}`)}else n&&(r.hasClass("active")&&(s=!0),r.remove(),i=="details"&&$(this._element).find('[name="system.price"]').replaceWith("<label>?</label>"))}if(s){let i=$(this._element).find("nav .item:first-child");if(i.length)this.activateTab(i.attr("data-tab"));else{let r=await renderTemplate("systems/dsk/templates/items/obfuscatedItem.html",{item:this.item});$(this._element).find(".content").html(r)}}}},"ItemSheetObfuscation");var R=class extends ItemSheet{static setupSheets(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsk",Jt,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsk",Zt,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsk",Xt,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsk",Qt,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsk",ea,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsk",ta,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsk",aa,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsk",sa,{makeDefault:!0,types:["profession"]}),Items.registerSheet("dsk",et,{makeDefault:!0,types:["advantage"]}),Items.registerSheet("dsk",ia,{makeDefault:!0,types:["disadvantage"]}),Items.registerSheet("dsk",ra,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsk",na,{makeDefault:!0,types:["ahnengeschenk"]}),Items.registerSheet("dsk",oa,{makeDefault:!0,types:["ahnengabe"]}),Items.registerSheet("dsk",la,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsk",tt,{makeDefault:!0,types:["skill"]}),Items.registerSheet("dsk",ca,{makeDefault:!0,types:["combatskill"]}),Items.registerSheet("dsk",Vt,{makeDefault:!0,types:["information"]}),Items.registerSheet("dsk",Kt,{makeDefault:!0,types:["effectwrapper"]}),Items.registerSheet("dsk",Ut,{makeDefault:!0,types:["trait"]}),Items.registerSheet("dsk",Yt,{makeDefault:!0,types:["consumable"]})}setupEffect(e){this.item.setupEffect().then(t=>this.item.itemTest(t))}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:async()=>this.item.postItem()}),e}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content"}],mergeObject(e,{classes:e.classes.concat(["dsk","item"]),width:450,height:500}),e}get template(){return`systems/dsk/templates/items/item-${this.item.type}-sheet.html`}async getData(e){let t=super.getData(e).data;return mergeObject(t,{isOwned:this.item.actor,editable:this.isEditable,item:this.item,isGM:game.user.isGM,enrichedDescription:await TextEditor.enrichHTML(getProperty(this.item.system,"description.value"),{secrets:this.object.isOwner,async:!0}),enrichedGmdescription:await TextEditor.enrichHTML(getProperty(this.item.system,"description.gminfo"),{secrets:this.object.isOwner,async:!0})}),O.prepareActiveEffects(this.item,t),t}async advanceWrapper(e,t){let s=$(e.currentTarget).find("i");s.hasClass("fa-spin")||(s.addClass("fa-spin fa-spinner"),await this[t](),s.removeClass("fa-spin fa-spinner"))}activateListeners(e){super.activateListeners(e),e.find(".advance-step").mousedown(a=>this.advanceWrapper(a,"_advanceStep")),e.find(".refund-step").mousedown(a=>this.advanceWrapper(a,"_refundStep")),e.find('[data-edit="img"]').mousedown(a=>{a.button==2&&h.showArtwork(this.item)}),e.find(".status-add").click(()=>{this.item.actor?ui.notifications.error(game.i18n.localize("dsk.DSKError.nestedEffectNotSupported")):O.createCustomEffect(this.item,"",this.item.name)}),e.find(".condition-show").mousedown(a=>{a.preventDefault();let s=$(a.currentTarget).attr("data-id");a.button==0?this.item.effects.get(s).sheet.render(!0):a.button==2&&this.item.deleteEmbeddedDocuments("ActiveEffect",[s])}),e.find(".condition-toggle").mousedown(a=>{let s=$(a.currentTarget).parents(".statusEffect").attr("data-id"),i=this.item.effects.get(s);i.update({disabled:!i.system.disabled})}),e.find(".condition-edit").click(a=>{this.item.effects.get($(a.currentTarget).attr("data-id")).sheet.render(!0)}),G.bindRollCommands(e),O.bindButtons(e);let t=e.find(".item-header");if(t.length){let a=t.find("svg");if(a){new ResizeObserver(function(r){let n=r[0];Oa(a,n.contentRect.width)}).observe(t.get(0));let i=t.find("input");i.get(0).disabled||(a.click(()=>{a.hide(),i.show(),i.focus()}),i.blur(function(){a.show(),i.hide()}))}}}};m(R,"ItemSheetDSK");var Kt=class extends R{};m(Kt,"ItemSheetEffectwrapper");var Ut=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{traitCategories:w.traitCategories,ranges:w.meleeRanges}),t}};m(Ut,"ItemSheetTrait");var Vt=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{allSkills:(await h.allSkillsList(["skill"])).skills}),t}};m(Vt,"ItemSheetInformation");var Yt=class extends he(R){async getData(e){let t=await super.getData(e);return mergeObject(t,{calculatedPrice:game.dsk.config.ItemSubClasses.consumable.consumablePrice(this.item)}),t}};m(Yt,"ItemSheetConsumable");var Jt=class extends he(R){async getData(e){let t=await super.getData(e),a=!1,s="";if(!a)s="wrongGrip.yieldTwo";else switch(game.i18n.localize(`dsk.LocalizedCTs.${this.item.system.combatskill}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":new RegExp(game.i18n.localize("dsk.wrongGrip.wrongGripBastardRegex")).test(this.item.name)?s="wrongGrip.yieldOneBastard":s="wrongGrip.yieldOneSwordBlunt";break;default:s="wrongGrip.yieldOnePolearms"}if(mergeObject(t,{twoHanded:a,wrongGripLabel:a?"wrongGrip.oneHanded":"wrongGrip.twoHanded",wrongGripHint:s,isShield:this.item.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Shields"),combatskills:(await h.allSkillsList(["combatskill"])).meleeSkills,ranges:w.meleeRanges,shieldSizes:w.shieldSizes}),this.item.actor){let i=this.item.actor.items.find(r=>r.type=="combatskill"&&r.name==this.item.system.combatskill);t.canBeOffHand=i&&!i.system.weapontype.twoHanded&&this.item.system.worn.value,t.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize(`dsk.LocalizedCTs.${this.item.system.combatskill}`))}return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),t}};m(Jt,"ItemSheetMeleeweapon");var Zt=class extends he(R){async getData(e){let t=await super.getData(e);return mergeObject(t,{canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),ammunitiongroups:w.ammunitiongroups,combatskills:(await h.allSkillsList(["combatskill"])).rangeSkills}),t}};m(Zt,"ItemSheetRangeweapon");var Xt=class extends he(R){};m(Xt,"ItemSheetArmor");var Qt=class extends he(R){async getData(e){let t=await super.getData(e);return mergeObject(t,{ammunitiongroups:w.ammunitiongroups}),t}};m(Qt,"ItemSheetAmmunition");var ea=class extends he(R){async getData(e){let t=await super.getData(e);if(mergeObject(t,{equipmentTypes:w.equipmentTypes,canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")}),this.isBagWithContents()){let a=0;mergeObject(t,{containerContent:this.item.actor.items.filter(s=>w.equipmentCategories.includes(s.type)&&s.system.parent_id==this.item.id).map(s=>(s.weight=parseFloat((s.system.weight*s.system.quantity).toFixed(3)),a+=Number(s.weight),s)),weightSum:parseFloat(a.toFixed(3)),weightWidth:`style="width: ${Math.min(this.item.system.capacity?a/this.item.system.capacity*100:0,100)}%"`,weightExceeded:a>Number(this.item.system.capacity)?"exceeded":""})}return t}async breakOverflow(e,t){let a=$(await renderTemplate("systems/dsk/templates/items/baghover.html",e)),s=t.offset().top+52,i=t.offset().left-75;return a.appendTo($("body")),a.css({position:"absolute",left:i+"px",top:s+"px",bottom:"auto",right:"auto","z-index":1e4}),a}activateListeners(e){super.activateListeners(e);let t=e.find(".slot");t.mouseenter(async a=>{let s=$(a.currentTarget),i=await this.breakOverflow({name:s.attr("data-name"),weight:s.attr("data-weight"),quantity:s.attr("data-quantity")},s);i.fadeIn(),s.mouseleave(()=>{i.remove(),s.off("mouseleave")})}),t.mousedown(async a=>{let s=$(a.currentTarget).attr("data-item-id"),i=this.actor.items.get(s);a.button==0?i.sheet.render(!0):a.button==2&&($(".itemInfo").remove(),await i.update({"system.parent_id":0}),this.render(!0))})}isBagWithContents(){return this.item.actor&&getProperty(this.item,"system.category")=="bags"}async _onDrop(e){if(this.isBagWithContents()){let t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:a,typeClass:s,selfTarget:i}=await Wt(t,void 0),r=this.item.id==a.id,n=this.item.parent.id==t.actorId;if(w.equipmentCategories.includes(s)&&!r){a.system.parent_id=this.item.id,a.system.worn&&a.system.worn.value&&(a.system.worn.value=!1),n?await this.item.actor.updateEmbeddedDocuments("Item",[a]):await this.item.actor.sheet._addLoot(a),this.render(!0);return}}await super._onDrop(e)}};m(ea,"ItemSheetEquipment");var ta=class extends R{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:530,height:570}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{hasLocalization:game.i18n.has(`dsk.Racedescr.${this.item.name}`)}),t}};m(ta,"ItemSheetSpecies");var aa=class extends R{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}};m(aa,"ItemSheetCulture");var sa=class extends R{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{enrichedClothing:await TextEditor.enrichHTML(getProperty(this.item.system,"description.gear"),{secrets:this.object.isOwner,async:!0})}),t}};m(sa,"ItemSheetProfession");var et=class extends R{async getData(e){let t=await super.getData(e);return t.enrichedRule=await TextEditor.enrichHTML(getProperty(this.item.system,"rule"),{secrets:this.object.isOwner,async:!0}),t}_advancable(){return this.item.system.max>0}async _refundStep(){let e,t;this.item.system.level>1&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(a=>Number(a.trim())),e=t[this.item.system.level-1]),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.level":this.item.system.level-1}))}async _advanceStep(){let e,t;this.item.system.level<this.item.system.max&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(a=>Number(a.trim())),e=t[this.item.system.level]),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.level":this.item.system.level+1})))}};m(et,"ItemSheetAdvantage");var ia=class extends et{};m(ia,"ItemSheetDisadvantage");var ra=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{categories:w.specialAbilityCategories,subCategories:w.combatSkillSubCategories,enrichedRule:await TextEditor.enrichHTML(getProperty(this.item.system,"rule"),{secrets:this.object.isOwner,async:!0}),canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")}),t}async _refundStep(){let e,t;this.item.system.level>1&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(a=>Number(a.trim())),e=t[this.item.system.level-1]),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.level":this.item.system.level-1}))}async _advanceStep(){let e,t;this.item.system.level<this.item.system.max&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(a=>Number(a.trim())),e=t[this.item.system.level]),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.level":this.item.system.level+1})))}_advancable(){return this.item.system.max>0}};m(ra,"ItemSheetSpecialability");var na=class extends R{async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async setupEffect(e){if(this.item.actor.system.stats.AeP.value<1)return ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughAeP"));let t=game.dsk.config.ItemSubClasses.ahnengeschenk;await this.item.actor.update({"system.stats.AeP.value":this.item.actor.system.stats.AeP.value-=1});let a=`<p><b>${this.item.name} - ${game.i18n.localize("TYPES.Item.ahnengeschenk")} ${game.i18n.localize("dsk.probe")}</b></p><p>${this.item.system.description.value}</p><p>${t.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(h.chatDataSetup(a))}};m(na,"ItemSheetAhnengeschenk");var oa=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{characteristics:w.characteristics,StFs:w.StFs,resistances:w.magicResistanceModifiers}),t}};m(oa,"ItemSheetAhnengabe");var la=class extends he(R){async getData(e){let t=await super.getData(e);return mergeObject(t,{resistances:w.magicResistanceModifiers}),t}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}};m(la,"ItemSheetPoison");var tt=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{characteristics:w.characteristics,skillGroups:w.skillGroups,skillBurdens:w.skillBurdens,hasLocalization:game.i18n.has(`dsk.SKILLdescr.${this.item.name}`),StFs:w.StFs}),t}};m(tt,"ItemSheetSkill");var ca=class extends tt{async getData(e){let t=await super.getData(e);return mergeObject(t,{weapontypes:w.weapontypes,hasLocalization:game.i18n.has(`dsk.Combatskilldescr.${this.item.name}`)}),t}};m(ca,"ItemSheetCombatskill");var J=class extends Application{constructor(e){super(e),this.items=[],this.errors=[],this.attributes=[],this.updating=!1}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsk","largeDialog"]),width:750,height:640}),e.resizable=!0,e}async updateSkill(e,t,a=1,s=!0){let i=[];for(let r of e){if(["","-"].includes(r.trim()))continue;let n=h.parseAbilityString(r.trim()),l=this.actor.items.find(c=>c.type==t&&c.name==n.name);if(l){let c=duplicate(l);c.system.level=Math.max(0,a*n.step+(s?Number(c.system.level):0)),i.push(c)}else console.warn(`Could not find ${t} ${r}`),this.errors.push(`${h.categoryLocalization(t)}: ${r}`)}await this.actor.updateEmbeddedDocuments("Item",i,{},{render:!1})}async findCompendiumItem(e,t){for(let a of t){let s=await game.dsk.itemLibrary.findCompendiumItem(e,a);if(s.length)return s.find(i=>i.name==e&&i.type==a&&i.system)}}async parseToItem(e,t){return e.trim()==""?[]:await Promise.all(e.split(", ").map(async a=>{let s=h.parseAbilityString(a.trim()),i=await this.findCompendiumItem(s.original,t);if(i||(i=await this.findCompendiumItem(s.name,t)),i){let n=i.uuid;i=duplicate(i),i.uuid=n,i.tooltip=game.i18n.localize("dsk.details"),i=B.reverseAdoptionCalculation(this.actor,s,i),i.system.ap&&(i.APunparseable=isNaN(i.system.ap),i.apCost=i.APunparseable?i.system.ap:s.step*Number(i.system.ap))}else{console.warn(`Not found <${a}>`);let n=t.map(l=>h.categoryLocalization(l)).join("/");this.errors.push(`${n}: ${a}`),i={name:a.trim(),notFound:!0,tooltip:game.i18n.localize("dsk.DSKError.itemNotFound"),apCost:"?"}}i.replaceName=s.original,i.step=s.step;let r=this.actor.items.find(n=>t.includes(n.type)&&n.name==s.original)!=null;return i.disabled=r||i.notFound||i.APunparseable,r&&(i.tooltip=game.i18n.localize("dsk.YouAlreadyHaveit")),i}))}activateListeners(e){super.activateListeners(e),e.find("button.ok").click(()=>{this.updating||(this.updating=!0,this.updateCharacter().then(()=>this.updating=!1))}),e.find("button.cancel").click(()=>{this.close()}),e.find(".show-item").click(t=>{let a=$(t.currentTarget).attr("data-id");this.items.find(i=>i.id==a).sheet.render(!0)}),e.find(".optional").change(t=>{let a=$(t.currentTarget).closest(".content"),s=Number(a.attr("data-cost"));a.find(".optional:checked").each(function(){s+=Number($(this).attr("data-cost"))});let i=a.find(".apCost");i.text(s),J.flashElem(i,"emphasize2")}),e.find(".exclusive").change(t=>{let a=$(t.currentTarget).closest(".content"),s=$(t.currentTarget).attr("data-sel"),i=a.find(`.allowedCount_${s}`),r=Number(i.attr("data-count"));if(a.find(`.exclusive_${s}:checked`).length>r){t.currentTarget.checked=!1,J.flashElem(i);return}})}_validateInput(e){let t=new Set,a=/^exclusive_/;for(let s of e.find(".exclusive"))t.add(s.className.split(/\s+/).filter(i=>a.test(i))[0]);for(let s of t){let i=e.find(".allowedCount_"+s.split("_")[1]),r=Number(i.attr("data-count"));if(e.find(`.${s}:checked`).length!=r)return this._showInputValidation(i,e,app),!1}return!0}_showInputValidation(e,t,a){ui.notifications.error(game.i18n.localize("dsk.DSKError.MissingChoices"));let s=e.closest(".tab").attr("data-tab");a.activateTab(s),J.flashElem(t.find(`.tabs a[data-tab='${s}']`)),J.flashElem(e.closest("div"))}async alreadyAdded(e,t){if(e=="")return!1;let a=!1;return a=await new Promise((s,i)=>{new Dialog({title:game.i18n.localize("dsk.DIALOG.warning"),content:game.i18n.format("dsk.DIALOG.alreadyAddedCharacterpart",{category:h.categoryLocalization(t)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("dsk.ok"),default:!0,callback:()=>{s(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("dsk.cancel"),default:!0,callback:()=>{s(!0)}}}}).render(!0)}),a}async addSelections(e){let t=[];for(let a of e){if($(a).val()=="")continue;let i=await fromUuid($(a).val()),r=h.parseAbilityString(i.name);switch(i.name=$(a).attr("name"),i.type){case"advantage":case"disadvantage":i.system.level=Number($(a).attr("data-step")),i=B.reverseAdoptionCalculation(this.actor,r,i),this.mergeLevels(t,i)||E.vantageAdded(this.actor,i);break;case"specialability":i.system.level=Number($(a).attr("data-step")),$(a).attr("data-free")&&(i.system.ap=0),i=B.reverseAdoptionCalculation(this.actor,r,i),this.mergeLevels(t,i)||x.abilityAdded(this.actor,i);break}}await this.actor.createEmbeddedDocuments("Item",t)}mergeLevels(e,t){let a=!1,s=e.find(i=>i.name==t.name&&i.type==t.type);if(s){a=!0;let i=Number(getProperty(t,"system.level"));i&&(s.system.level+=i)}else e.push(t);return a}static flashElem(e,t="emphasize"){e.addClass(t),setTimeout(function(){e.removeClass(t)},600)}finalizeUpdate(){this.errors.length==0?this.close():$(this._element).find(".dialog-buttons").html(`<div class="error"><p>${game.i18n.localize("dsk.DSKError.notUnderstood")}</p><ul><li>${this.errors.join("</li><li>")}</li></ul></div>`)}};m(J,"WizardDSK");var Oe=class extends J{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")}`}),e.template="systems/dsk/templates/wizard/add-species-wizard.html",e}async _parseBonus(e){let t=[],a=[],s=!1,i=Object.keys(w.characteristics),r=new RegExp(game.i18n.localize("dsk.WIZARDPARSER.speciesAdvantage"),"i");for(let n of e.split(","))if(r.test(n)){s=!0;let l=i.filter(c=>n.includes(c.toUpperCase()));t.push({choices:l,allowedCount:1});break}else a.push(n.trim());return a=await this.parseToItem(a.join(", "),["advantage","disadvantage"]),{anyAttributeRequirements:s,attributeRequirements:t,optionals:a}}async getData(e){let t=await super.getData(e),{anyAttributeRequirements:a,attributeRequirements:s,optionals:i}=await this._parseBonus(this.species.system.advantages),r=a;return mergeObject(t,{speciesDescription:game.i18n.has(`dsk.Racedescr.${this.species.name}`)?game.i18n.localize(`dsk.Racedescr.${this.species.name}`):this.species.system.description.value,species:this.species,description:game.i18n.format("dsk.WIZARD.speciesdescr",{species:this.species.name}),title:game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")} ${this.species.name}`}),generalToChose:r,anyAttributeRequirements:a,optionals:i,attributeRequirements:s}),t}async addSpecies(e,t){this.actor=e,this.species=duplicate(t)}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.species,"species")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let a={"system.details.species":this.species.name,"system.stats.gs.initial":this.species.system.gs,"system.stats.sk.initial":this.species.system.sk,"system.stats.zk.initial":this.species.system.zk,"system.stats.LeP.initial":this.species.system.LeP,"system.stats.LeP.value":this.species.system.LeP+this.actor.system.characteristics.ko.value*2};for(let s of e.find(".exclusive:checked"))a[`system.characteristics.${$(s).val()}.species`]=1;await this.actor._updateAPs(t,{},{render:!1}),await this.addSelections(e.find(".optional:checked")),await this.actor.update(a),await this.actor.removeCondition("incapacitated"),this.finalizeUpdate()}};m(Oe,"SpeciesWizard");var xe=class extends J{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")}`}),e.template="systems/dsk/templates/wizard/add-culture-wizard.html",e}async getData(e){let t=await super.getData(e),a=0;return mergeObject(t,{title:game.i18n.format("dsk.WIZARD.addItem",{item:`${h.categoryLocalization("culture")} ${this.culture.name}`}),culture:this.culture,description:game.i18n.format("dsk.WIZARD.culturedescr",{culture:this.culture.name,cost:a})}),t}async addCulture(e,t){this.actor=e,this.culture=duplicate(t)}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.culture,"culture")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let a={"system.details.culture":this.culture.name};await this.actor._updateAPs(t,{},{render:!1}),await this.updateSkill(this.culture.system.skills.split(","),"skill"),await this.actor.update(a),this.finalizeUpdate()}};m(xe,"CultureWizard");var ze=class extends J{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.profession")}`}),e.template="systems/dsk/templates/wizard/add-career-wizard.html",e}async getData(e){let t=await super.getData(e),a=[...await this.parseToItem(this.career.system.requirements.advantage,["disadvantage","advantage"]),...await this.parseToItem(this.career.system.requirements.specialability,["specialability"])],s=a.filter(l=>["advantage","disadvantage"].includes(l.type)&&!l.disabled),i=0,r=a.reduce(function(l,c){return l+(c.disabled?0:Number(c.system.ap)||0)},0),n=a.filter(l=>l.type=="specialability"&&!l.disabled);return mergeObject(t,{title:game.i18n.format("dsk.WIZARD.addItem",{item:`${h.categoryLocalization("profession")} ${this.career.name}`}),career:this.career,description:game.i18n.format("dsk.WIZARD.careerdescr",{career:this.career.name,cost:i+r}),baseCost:i,missingVantagesToChose:s.length>0,missingSpecialabiltiesToChose:n.length>0}),t}async addCareer(e,t){this.actor=e,this.career=duplicate(t)}async setAbility(e,t){if(e.trim()=="")return;let a=[],s=[];for(let i of e.split(",")){if(["","-"].includes(i.trim()))continue;let r=h.parseAbilityString(i.trim()),n=this.actor.items.find(l=>t.includes(l.type)&&l.name==r.original);if(n)n=duplicate(n),n.system.level!=null&&(n.system.level=r.step),n=B.reverseAdoptionCalculation(this.actor,r,n),s.push(n);else if(n=await this.findCompendiumItem(r.original,t),n||(n=await this.findCompendiumItem(r.name,t)),n)n=duplicate(n),n.name=r.original,n.system.level!=null&&(n.system.level=r.step),n=B.reverseAdoptionCalculation(this.actor,r,n),a.push(n);else{let l=t.map(c=>h.categoryLocalization(c)).join("/");this.errors.push(`${l}: ${i}`),ui.notifications.error(game.i18n.format("dsk.DSKError.notFound",{category:l,name:i}))}}await this.actor.updateEmbeddedDocuments("Item",s,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",a,{},{render:!1})}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.profession,"profession")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let a={"system.details.profession":this.career.name};this.career.system.isAncestor&&(await this.setAbility(this.career.system.ahnengabe,["ahnengabe"]),await this.setAbility(this.career.system.ahnengeschenk,["ahnengeschenk"])),await this.setAbility(this.career.system.requirements.specialability,["specialability"]),await this.setAbility(this.career.system.requirements.advantage,["advantage","disadvantage"]),await this.actor._updateAPs(t,{},{render:!1});let s=[...this.career.system.skills.body.split(","),...this.career.system.skills.social.split(","),...this.career.system.skills.mental.split(","),...this.career.system.skills.trade.split(",")];await this.updateSkill(s,"skill"),await this.updateSkill(this.career.system.skills.combat.split(","),"combatskill"),await this.actor.update(a),this.finalizeUpdate()}};m(ze,"CareerWizard");var te=class extends ie{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","actor","character-sheet"]),width:795}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/npc-limited.html":"systems/dsk/templates/actors/actor-sheet.html"}async _manageDragItems(e,t){switch(t){case"aggregatedTest":await this.actor.createEmbeddedDocuments("Item",[e]);break;case"species":let a=new Oe;await a.addSpecies(this.actor,e),a.render(!0);break;case"culture":let s=new xe;await s.addCulture(this.actor,e),s.render(!0);break;case"profession":let i=new ze;await i.addCareer(this.actor,e),i.render(!0);break;default:return super._manageDragItems(e,t)}}};m(te,"ActorSheetCharacter");var re=class extends ie{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","actor","creature-sheet","character-sheet"])}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/creature-limited.html":"systems/dsk/templates/actors/creature-sheet.html"}async getData(e){let t=await super.getData(e);return t.enrichedBehaviour=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.fight"),{secrets:this.object.isOwner,async:!0}),t.enrichedSpecialrules=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.specialRules"),{secrets:this.object.isOwner,async:!0}),t}async _cleverDeleteItem(e){let t=this.actor.items.find(a=>a.id==e);switch(t.type){case"trait":await this._updateAPs(t.system.ap*-1,{},{render:!1});break}await super._cleverDeleteItem(e)}async _addTrait(e){this.actor.items.find(a=>a.type=="trait"&&a.name==e.name)||(await this._updateAPs(e.system.ap,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}async _onDropItemCreate(e){return e.type=="trait"?this._addTrait(e):super._onDropItemCreate(e)}};m(re,"ActorSheetCreature");var ne=class extends te{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","actor","npc-sheet"])}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/npc-limited.html":"systems/dsk/templates/actors/npc-sheet.html"}};m(ne,"ActorSheetNPC");var Ne=class extends JournalSheet{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","dskjournal"])}),e}};m(Ne,"DSKJournalSheet");var cs={"":"dsk.Modifier",defenseMalus:"dsk.MODS.defenseMalus",FW:"dsk.MODS.FW",AeP:"dsk.AeP",FP:"dsk.MODS.FP",QL:"dsk.MODS.QS",dmg:"dsk.MODS.damage",damageBonus:"dsk.MODS.damage",armorPen:"dsk.MODS.armorPen",TPM:"dsk.MODS.partChecks"};function Pa(){Handlebars.registerHelper({roman:(o,e)=>e!=null&&Number(e)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][o-1],itemCategory:o=>h.categoryLocalization(o),isWEBM:o=>/.webm$/.test(o),getAttr:(o,e,t)=>o.system.characteristics[e][t],diceThingsUp:(o,e)=>h.replaceDies(o,!1),replaceConditions:h.replaceConditions,attrLoc:(o,e)=>game.i18n.localize(`dsk.characteristics.${o}.${e}`),floor:o=>Math.floor(Number(o)),situationalTooltip:o=>{let e=game.i18n.localize(`${cs[o.type]||"dsk.Modifier"}`),t=`${o.name}<br/>${e}: ${o.value}`;return o.source&&(t+=`<br/>${game.i18n.localize("dsk.source")}: ${o.source}`),t}})}m(Pa,"setupHandlebars");function _a(){Hooks.on("getJournalSheetHeaderButtons",(o,e)=>{!o.document.sceneNote||e.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:async()=>o.document.panToNote()})}),Hooks.on("renderJournalSheet",(o,e,t)=>{e.find(".close").attr("data-tooltip",game.i18n.localize("dsk.SHEET.Close")),e.find(".entry-image").attr("data-tooltip",game.i18n.localize("dsk.SHEET.imageView")),e.find(".entry-text").attr("data-tooltip",game.i18n.localize("dsk.SHEET.textView")),e.find(".share-image").attr("data-tooltip",game.i18n.localize("dsk.SHEET.showToPlayers")),e.find(".import").attr("data-tooltip",game.i18n.localize("dsk.SHEET.import")),e.find(".panMapNote").attr("data-tooltip",game.i18n.localize("dsk.SHEET.panMapNote"))}),Hooks.on("renderJournalPageSheet",(o,e,t)=>{G.bindRollCommands(e),O.bindButtons(e),e.find("img").mousedown(a=>{a.button==2&&game.dsk.apps.DSKUtility.showArtwork({name:o.name,uuid:"",img:$(a.currentTarget).attr("src")})}),Se(e)})}m(_a,"setupJournal");function La(){Hooks.on("hotbarDrop",(o,e,t)=>{if(e.type=="Item"){let a=fromUuidSync(e.uuid);if(!["ahnengabe","meleeweapon","rangeweapon","skill","combatskill","char","trait"].includes(a.type)||(a.type=="meleeweapon"||a.type=="combatskill")&&!["attack","parry"].includes(e.mod))return;if((a.type=="rangeweapon"||a.type=="trait")&&!["attack"].includes(e.mod))return;let i=`{mod: "${e.mod}"}`,r;game.user.isGM||e.actorId==null?r=`game.dsk.macro.itemMacro("${a.name}", "${a.type}", ${i});`:r=`game.dsk.macro.itemMacroById("${e.actorId}", "${a.name}", "${a.type}", ${i})`;let n=e.mod==null?a.name:`${a.name} - ${game.i18n.localize("dsk.characteristics."+e.mod+".name")}`;return Ra(r,n,a.img,t)}else if(e.type=="Actor"||e.type=="JournalEntry"){let a=fromUuidSync(e.uuid),s=`(await fromUuid('${e.uuid}')).sheet.render(true)`;return Ra(s,a.name,a.img,t)}})}m(La,"setupMacros");function Ra(o,e,t,a){let s=game.macros.contents.find(i=>i.name===e&&i.command===o);return s?game.user.assignHotbarMacro(s,a):Macro.create({name:e,type:"script",img:t,command:o},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,a)),!1}m(Ra,"createHotBarMacro");var Pe=class{static async stopFade(e){e.stopPropagation(),e.preventDefault(),this.fadeOut?(this.fadeOut=!1,$(e.currentTarget).find("i").removeClass("fa-stop").addClass("fa-angle-right"),$(".didYouKnow").off("click"),$(".didYouKnow .closeDidYou").click(()=>$(".didYouKnow").remove())):fetch(`systems/dsk/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let a=t.data[Math.floor(Math.random()*t.data.length)],s=await renderTemplate("systems/dsk/templates/system/didyouknow.html",{msg:a,fadeOut:Pe.fadeOut});$("body").find(".didYouKnow").replaceWith(s),Pe.activateListeners()})}static activateListeners(){$(".didYouKnow .stopFade").click(async e=>await this.stopFade(e)),$(".didYouKnow").click(()=>$(".didYouKnow").remove()),$(".didYouKnow").fadeIn()}static async showOneMessage(e=8e3){game.settings.get("dsk","disableDidYouKnow")||fetch(`systems/dsk/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let a=t.data[Math.floor(Math.random()*t.data.length)],s=await renderTemplate("systems/dsk/templates/system/didyouknow.html",{msg:a,fadeOut:Pe.fadeOut});$("body").append(s),this.activateListeners(),setTimeout(function(){Pe.fadeOut&&$(".didYouKnow").fadeOut(1e3,()=>$(".didYouKnow").remove())},e)})}},Ce=Pe;m(Ce,"DidYouKnow"),z(Ce,"fadeOut",!0);var oe=class{static async firstTimeMessage(){if(!await game.settings.get("dsk","firstTimeStart")){await oe.setupDefaultOptions();let e=game.i18n.localize("dsk.WELCOME");ChatMessage.create(h.chatDataSetup(e)),oe.firstTimeLanguage(),await game.settings.set("dsk","firstTimeStart",!0)}}static firstTimeLanguage(){let e=["de"],t={title:game.i18n.localize("dsk.DIALOG.firstTime"),content:game.i18n.localize("dsk.DIALOG.firstTimeWarning"),default:"de",buttons:{}};for(let a of e)t.buttons[a]={label:game.i18n.localize(a),callback:()=>oe.setLanguage(a)};new Dialog(t).render(!0)}static async setLanguage(e){await game.settings.set("dsk","firstTimeStart",!0),await game.settings.set("dsk","forceLanguage",e),await game.settings.set("core","language",e),foundry.utils.debouncedReload()}static async setupDefaultOptions(){let e=game.settings.get("core",Combat.CONFIG_SETTING);e.skipDefeated=!0,await game.settings.set("core",Combat.CONFIG_SETTING,e),await game.settings.set("core","leftClickRelease",!0)}};m(oe,"DSKTutorial");var Ca=m(async(o,e,t,a)=>{if(game.user.isGM){let s=await h.getFolderForType("Actor",null,"Dropped Items"),r=game.users.filter(d=>!d.isGM).map(d=>d.id).reduce((d,p)=>(d[p]=1,d),{default:0}),n=e.toObject();n.system.quantity=a,_.obfuscateDropData(n,t.tabsinvisible),getProperty(n,"system.worn.value")&&(n.system.worn.value=!1);let l={type:"npc",name:e.name,img:e.img,prototypeToken:{img:e.img,width:.4,height:.4},ownership:r,items:[n],flags:{core:{sheetClass:"dsk.MerchantSheetDSK"}},folder:s,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},stats:{LeP:{value:16}}}},u=await(await game.dsk.documents.ActorDSK.create(l)).getTokenDocument({x:t.x,y:t.y,hidden:!1});if(!canvas.dimensions.rect.contains(u.x,u.y))return!1;if(o){await canvas.scene.createEmbeddedDocuments("Token",[u],{noHook:!0});let d=e.system.quantity-a;d<1?await o.deleteEmbeddedDocuments("Item",[e.id]):await o.updateEmbeddedDocuments("Item",[{_id:e.id,"system.quantity":d}])}else await canvas.scene.createEmbeddedDocuments("Token",[u])}else{let s={itemId:e.uuid,sourceActorId:o?.id,data:t,amount:a};game.socket.emit("system.dsk",{type:"itemDrop",payload:s})}},"dropToGround"),ds=m(async(o,e)=>{let t=await Item.implementation.fromDropData(e),a=t.parent;if(!w.equipmentCategories.includes(t.type))return;let s=await renderTemplate("systems/dsk/templates/dialog/dropToGround.html",{name:t.name,count:t.system.quantity});new da({title:e.name,content:s,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:async i=>Ca(a,t,e,Number(i.find('[name="count"]').val()))},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)},"handleItemDrop"),ms=m(async(o,e)=>{let t=e.x,a=e.y,s=0,i=o.grid.size,r=Math.ceil(Math.sqrt(e.ids.length));for(let n of e.ids){let l=game.actors.get(n);if(!l)continue;let c=await l.getTokenDocument({x:t,y:a,hidden:!1});c.constructor.create(c,{parent:o.scene}),r%s==0&&s>0?(a+=i,t=e.x):t+=i,s++}},"handleGroupDrop"),Fa=m(()=>{Hooks.on("dropCanvasData",async(o,e)=>{if(!!(game.settings.get("dsk","enableItemDropToCanvas")||game.user.isGM||e.tokenId)){if(e.type=="Item")return ds(o,e),!1;if(e.type=="GroupDrop")return ms(o,e),!1}})},"connectHook"),da=class extends Dialog{activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change(t=>{$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())})}};m(da,"DropToGroundDialog");var ye=class extends Dialog{static async showDialog(e){let t=this.callbackResult;new ye({title:game.i18n.localize("dsk.Unopposed"),content:await this.getTemplate(e),default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:a=>{t(a.find('[name="entryselection"]').val(),e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}static getTargetActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.targetSpeaker,a=canvas.tokens.get(t.token).actor;return a?{actor:a,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("dsk.DSKError.noProperActor")),{})}static async getTemplate(e){return""}static callbackResult(e,t,a){}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}};m(ye,"DialogReactDSK");var Me=class extends Dialog{static async showDialog(e,t){let a=new Me({title:game.i18n.localize("dsk.attacktest"),content:await this.getTemplate(e),buttons:{}});a.actor=e,a.tokenId=t,a.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t.currentTarget.dataset.value,this.actor,this.tokenId),this.close()})}static async getTemplate(e){let t=e.items.filter(r=>r.type=="combatskill").map(r=>D._calculateCombatSkillValues(r.toObject(),e.system)),a=[],s=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"];for(let r of e.items)if(s.includes(r.type)&&r.system.worn.value==!0){let n=r.type=="meleeweapon"?D._prepareMeleeWeapon(r.toObject(),t,e):D._prepareRangeWeapon(r.toObject(),[],t,e);a.push({name:r.name,id:r.name,img:r.img,value:n.attack})}else r.type=="trait"&&i.includes(r.system.traitType)&&a.push({name:r.name,id:r.name,img:r.img,value:r.system.at});return await renderTemplate("systems/dsk/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:a,title:"dsk.DIALOG.selectAction"})}callbackResult(e,t,a){let s=["meleeweapon","trait","rangeweapon"],i=t.items.find(r=>s.includes(r.type)&&r.name==e);i&&t.setupWeapon(i,"attack",{},a).then(r=>{t.basicTest(r)})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:550}),e}};m(Me,"ActAttackDialog");var ae=class extends CombatTracker{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"/systems/dsk/templates/system/combattracker.html"})}activateListeners(e){super.activateListeners(e),e.find(".combatant.actor .aggroButton").click(t=>{t.preventDefault(),t.stopPropagation(),ae.runActAttackDialog()})}static runActAttackDialog(){if(!game.combat)return;let e=game.combat.combatant;(game.user.isGM||e.isOwner)&&Me.showDialog(e.actor,e.tokenId)}async getData(e){let t=await super.getData(e);for(let a of t.turns){let s=t.combat.turns.find(n=>n.id==a.id),i=game.user.isGM||s.actor&&s.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsk","hideEffects");a.defenseCount=s.getFlag("dsk","defenseCount")||0;let r=[];if(s.actor){for(let n of s.actor.items)if(n.type=="rangeweapon"&&n.system.worn.value&&n.system.reloadTimeprogress>0){let l={name:n.name,remaining:D.calcLZ(n,s.actor)-n.system.reloadTimeprogress};l.remaining>0&&r.push(l)}else if(["spell","liturgy"].includes(n.type)&&n.system.castingTime.modified>0){let l={name:n.name,remaining:n.system.castingTime.modified-n.system.castingTime.progress};l.remaining>0&&r.push(l)}}r=r.sort((n,l)=>n.remaining-l.remaining),r.length>0&&(a.ongoings=`${game.i18n.localize("dsk.COMBATTRACKER.ongoing")}
${r.map(n=>`${n.name} - ${n.remaining}`).join(`
`)}`,a.ongoing=r[0].remaining),a.effects=new Set,s.token&&(s.token.effects.forEach(n=>a.effects.add(n)),s.token.overlayEffect&&a.effects.add(s.token.overlayEffect)),s.actor&&s.actor.temporaryEffects.forEach(n=>{n.statuses.has(CONFIG.Combat.defeatedStatusId)?a.defeated=!0:n.icon&&i&&!n.notApplicable&&(game.user.isGM||!n.getFlag("dsk","hidePlayers"))&&!n.getFlag("dsk","hideOnToken")&&a.effects.add(n.icon)})}return t}};m(ae,"DSKCombatTracker");var at=class extends Combat{constructor(e,t){super(e,t)}async refreshTokenbars(){game.dsk.apps.tokenHotbar&&game.dsk.apps.tokenHotbar.updateDSKHotbar()}_onCreate(e,t,a){super._onCreate(e,t,a),this.refreshTokenbars()}_onDelete(e,t){super._onDelete(e,t),this.refreshTokenbars()}async nextRound(){if(game.user.isGM)for(let e of this.turns)await e.setFlag("dsk","defenseCount",0);else await game.socket.emit("system.dsk",{type:"clearCombat",payload:{}});return await super.nextRound()}async getDefenseCount(e){let t=this.getCombatantFromActor(e);return t&&t.getFlag("dsk","defenseCount")||0}getCombatantFromActor(e){let t;return e.token?t=Array.from(this.combatants).find(a=>a.tokenId==e.token):t=Array.from(this.combatants).find(a=>a.actorId==e.actor),t?this.combatants.get(t.id):void 0}async updateDefenseCount(e){if(game.user.isGM)for(let t of e){let a=this.getCombatantFromActor({token:t});a&&!getProperty(a.actor,"system.config.defense")&&await a.setFlag("dsk","defenseCount",(a.getFlag("dsk","defenseCount")||0)+1)}else await game.socket.emit("system.dsk",{type:"updateDefenseCount",payload:{speaker:e}})}};m(at,"DSKCombat");var st=class extends Combatant{constructor(e,t){e.flags==null&&(e.flags={}),mergeObject(e.flags,{dsk:{defenseCount:0}}),super(e,t)}async recalcInitiative(){if(this.initiative){let t={initiative:(await this.getFlag("dsk","baseRoll")||0)+this.actor.system.stats.ini.value};await this.update(t)}}};m(st,"DSKCombatant");Hooks.on("preCreateCombatant",(o,e,t)=>{let a=h.getSpeaker({actor:o.actorId,scene:o.sceneId,token:o.token_id});if(getProperty(a.system,"merchant.merchantType")=="loot")return!1});Hooks.on("updateCombatant",(o,e,t)=>{if(!!game.user.isGM)if(e.initiative){if(!o.getFlag("dsk","baseRoll")){let s=`${e.initiative}`.split("."),i=Number(s[0])-Math.round(o.actor.system.stats.ini.value);o.setFlag("dsk","baseRoll",i)}}else"initiative"in e&&e.initiative==null&&o.update({["flags.dsk.-=baseRoll"]:null})});var _e=class{static async updateCombatHook(e,t,a,s){!t.round&&!t.turn||e.round!=0&&e.turns&&e.active&&e.previous.round<e.current.round&&await _e.startOfRound(e)}static async startOfRound(e){let t=game.users.find(a=>a.active&&a.isGM);if(!!(t&&game.user.id==t.id)){for(let a of e.turns)if(!a.defeated){for(let s of a.actor.effects){let i=[...s.statuses][0];i=="bleeding"?await this.applyBleeding(a):i=="burning"&&await this.applyBurning(a,s)}await this.startOfRoundEffects(a)}}}static async startOfRoundEffects(e){let t=["LeP","AeP"];for(let a of t)for(let s of e.actor.system.repeatingEffects.startOfRound[a]){if(getProperty(e.actor.system.repeatingEffects,`disabled.${a}`))continue;let i=await new Roll(s.value).evaluate({async:!0}),r=await i.render(),n=game.i18n.localize(i.total>0?"dsk.CHATNOTIFICATION.regenerates":"dsk.CHATNOTIFICATION.getsHurt"),l=`${e.actor.name} ${n} ${game.i18n.localize(a)} ${r}`;await ChatMessage.create(h.chatDataSetup(l)),a=="LeP"?await e.actor.applyDamage(i.total*-1):await e.actor.applyMana(i.total*-1)}}static async applyBleeding(e){e.actor.system.stats.LeP.value<=0||(await ChatMessage.create(h.chatDataSetup(game.i18n.format("dsk.CHATNOTIFICATION.bleeding",{actor:e.actor.name}))),await e.actor.applyDamage(1))}static async applyBurning(e,t){if(e.actor.system.stats.LeP.value<=0)return;let a=Number(t.getFlag("dsk","value")),s=DSKStatusEffects.resistantToEffect(e.actor,t),i={0:"1",1:"1d3",2:"1d6",3:"2d6"}[a-s]||"1",r=await new Roll(i).evaluate({async:!0}),n=await r.render();await ChatMessage.create(h.chatDataSetup(game.i18n.format(`dsk.CHATNOTIFICATION.burning.${a}`,{actor:e.actor.name,damage:n}))),await e.actor.applyDamage(r.total)}};m(_e,"RepeatingEffectsHelper");Hooks.on("updateCombat",_e.updateCombatHook);var ke=class extends Application{static get defaultOptions(){let e=super.defaultOptions;mergeObject(e,{classes:e.classes.concat(["dsk","initTracker"]),template:"systems/dsk/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"dsk.DSKIniTracker"});let t=game.settings.get("dsk","iniTrackerPosition");return mergeObject(e,t),e}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){let r=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),n=this.element[0];if(!n.style.width||a){let l=a||n.offsetWidth,c=n.style.maxWidth||window.innerWidth;r.width=a=Math.clamped(l,0,c),n.style.width=a+"px",a+r.left>window.innerWidth&&(e=r.left)}return game.settings.set("dsk","iniTrackerPosition",{left:r.left,top:r.top}),r}static connectHooks(){Hooks.on("renderDSKCombatTracker",(e,t,a)=>{!game.settings.get("dsk","enableCombatFlow")||(game.combat?(game.dsk.apps.initTracker||(game.dsk.apps.initTracker=new ke),game.dsk.apps.initTracker.updateTracker(a)):game.dsk.apps.initTracker&&(game.dsk.apps.initTracker.close(),game.dsk.apps.initTracker=void 0))})}updateTracker(e){this.combatData=e,this.render(!0)}async getData(e){let t=this.combatData,a=game.settings.get("dsk","iniTrackerSize"),s=t.round,i=t.turns,r=[],n=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,l=t.turns.some(c=>c.owner&&!c.hasRolled&&(!game.user.isGM||t.combat.combatants.get(c.id).isNPC));if(i.length){let c=[],u=5,d=!1,p=-1,f=0,b=0,T;for(;!(u==0||b==5);){let g=duplicate(i[f]),y=t.combat.combatants.get(g.id);d&&f==p&&(g.css=g.css.replace("active","")),!s||g.active&&!d?(d=!0,p=f):y.getFlag("dsk","waitInit")==t.round+b&&!y.defeated&&(game.user.isGM||!y.hidden)&&r.push(g),d&&!(n&&y.defeated)&&(game.user.isGM||!y.hidden)&&(g.round=t.round+b,g.owner&&y.token?.actor&&(g.maxLP=y.token.actor.system.stats.LeP.max,g.currentLP=y.token.actor.system.stats.LeP.value),T&&T!=g.round&&(g.newRound="newRound"),T=g.round,c.push(g),u--),f++,f>=i.length&&(f=0,b++)}t.turns=c}return t.isLastRound=t.turns[1]?.newRound,this.position.width=a*5+95,this.position.height=a+10,mergeObject(t,{itemWidth:a,unRolled:l,waitingTurns:r}),this.conditionalPanToCurrentCombatant(t),t}hasChangedTurn(e){let t=e.turn!=this.lastTurnUpdate||e.round!=this.lastRoundUpdate;return this.lastTurnUpdate=e.turn,this.lastRoundUpdate=e.round,t}async conditionalPanToCurrentCombatant(e){if(!game.settings.get("dsk","enableCombatPan"))return;let t=e.turns[0];if(!t)return;let a=e.combat.combatants.get(t.id);!a||!this.hasChangedTurn(e)||setTimeout(()=>{let s=a.token;!s||!s.object||!s.object.isVisible||(canvas.animatePan({x:s.x,y:s.y}),!(!a.actor||!a.actor.isOwner)&&s.object.control({releaseOthers:!0}))},300)}async _onWheelResize(e){let t=game.settings.get("dsk","iniTrackerSize");e.originalEvent.deltaY>0?t=Math.min(140,t+5):t=Math.max(30,t-5),await game.settings.set("dsk","iniTrackerSize",t),await this.render(!0)}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async s=>(s.stopPropagation(),s.preventDefault(),await this._onWheelResize(s),!1)),e.find(".combat-control").click(s=>this._onCombatControl(s));let a=e.find(".iniItem");a.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),a.click(this._onCombatantMouseDown.bind(this)),e.find(".waitingTackerList .iniItem").mousedown(s=>this._onRightClick(s)),e.find(".combatant-control").click(s=>this._onCombatantControl(s)),e.find(".combatant .aggroButton").click(s=>{s.preventDefault(),s.stopPropagation(),ae.runActAttackDialog()}),e.find(".rollMine").click(s=>this.rollMyChars()),game.user.isGM&&e.find(".rolledInit").click(s=>this.editCombatant(s))}rollMyChars(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);t.isOwner&&t.unsetFlag("dsk","waitInit")}}editCombatant(e){this._getCombatApp()._onConfigureCombatant($(e.currentTarget))}_onCombatantControl(e){this._getCombatApp()._onCombatantControl(e)}_onCombatControl(e){e.currentTarget.dataset.control=="waitInit"?this.waitInit(e):this._getCombatApp()._onCombatControl(e)}async waitInit(e){await game.combat.combatants.get(game.combat.current.combatantId).setFlag("dsk","waitInit",game.combat.current.round),e.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(e)}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onCombatantMouseDown(e){this._getCombatApp()._onCombatantMouseDown(e)}_getCombatApp(){return game.combats.apps[0]}_canDragStart(e){return!1}_canDragDrop(e){return!1}_onDragStart(e){let t=$(e.currentTarget).closestData("combatant-id");e.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:t}))}_onDrop(e){JSON.parse(e.dataTransfer.getData("text/plain")).type=="IniChange"}};m(ke,"DSKIniTracker");var Q=class extends Application{static registerTokenHotbar(){game.dsk.apps.tokenHotbar||(game.dsk.apps.tokenHotbar=new Q)}constructor(e){super(e),this.combatSkills=["selfControl","featOfStrength","bodyControl","perception"].map(a=>game.i18n.localize(`dsk.LocalizedIDs.${a}`)),this.defaultSkills=[game.i18n.localize("dsk.LocalizedIDs.perception")];let t=m(a=>{let s=a.parent?a.parent.id:void 0;s&&Q.hookUpdate(s)},"parentUpdate");Hooks.on("controlToken",(a,s)=>{this.updateDSKHotbar()}),Hooks.on("updateActor",(a,s)=>{Q.hookUpdate(a.id)}),Hooks.on("updateToken",(a,s,i)=>{s._id==getProperty(game.dsk.apps.tokenHotbar,"actor.prototypeToken.id")&&this.updateDSKHotbar()}),Hooks.on("updateOwnedItem",(a,s)=>{Q.hookUpdate(a.data.id)}),Hooks.on("createOwnedItem",(a,s)=>{Q.hookUpdate(a.data.id)}),Hooks.on("deleteOwnedItem",(a,s)=>{Q.hookUpdate(a.data.id)}),Hooks.on("updateItem",(a,s)=>{t(a)}),Hooks.on("createItem",(a,s)=>{t(a)}),Hooks.on("deleteItem",(a,s)=>{t(a)})}static hookUpdate(e){e==getProperty(game.dsk.apps.tokenHotbar,"actor.id")&&game.dsk.apps.tokenHotbar.updateDSKHotbar()}resetPosition(){let e=$("#hotbar").first().position(),t=game.settings.get("dsk","tokenhotbarSize");this.position.left=e.left+8,this.position.top=e.top-t-25}static get defaultOptions(){let e=super.defaultOptions,t=$("#hotbar").first().position(),a=game.settings.get("dsk","tokenhotbarSize"),s=game.settings.get("dsk","tokenhotbarPosition");return mergeObject(e,{classes:e.classes.concat(["dsk","tokenQuickHot"]),itemWidth:a,resizable:!1,height:a+45,zIndex:61,left:t.left+8,top:t.top-a-25,template:"systems/dsk/templates/status/tokenHotbar.html",title:"TokenHotbar"}),mergeObject(e,s),e}async _onWheelResize(e){let t=game.settings.get("dsk","tokenhotbarSize");e.originalEvent.deltaY>0?t=Math.min(100,t+5):t=Math.max(15,t-5),await game.settings.set("dsk","tokenhotbarSize",t),await this.render(!0)}async _cycleLayout(e){if(e.button==2){let t=game.settings.get("dsk","tokenhotbarLayout")+1;t==4&&(t=0),await game.settings.set("dsk","tokenhotbarLayout",t),await this.render(!0)}}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async a=>(a.stopPropagation(),a.preventDefault(),await this._onWheelResize(a),!1)),t.on("mousedown",async a=>{await this._cycleLayout(a)}),e.on("mousedown","li",async a=>(a.stopPropagation(),await this.executeQuickButton(a),!1)),e.on("mouseenter","li.primary",a=>{let s=a.currentTarget.dataset.category;this.category=s,setTimeout(()=>{e.find(".secondary").removeClass("shown"),s==this.category&&e.find(`.secondary[data-category="${s}"]`).addClass("shown")},700)}),e.on("mouseleave","li.primary",a=>{let s=a.currentTarget.dataset.category;this.category=void 0,setTimeout(()=>{s!=this.category&&e.find(`.secondary[data-category="${s}"]`).removeClass("shown")},50)})}async executeQuickButton(e){let t=canvas.tokens.controlled[0].actor,a=canvas.tokens.controlled[0].id,s=e.currentTarget.dataset.id;switch(e.currentTarget.dataset.subfunction){case"addEffect":Re.showDialog();break;case"effect":let r=t.effects.get(s),n=[...r.statuses][0];e.button==0?n?await t.addCondition(n,1,!1,!1):r.sheet.render(!0):e.button==2&&(n?await t.removeCondition(n,1,!1):await t.sheet._deleteActiveEffect(s)),await this.render(!0);break;case"onUse":let l=t.items.get(s);new Y(l).executeOnUseEffect();break;default:let u=t.items.get(s);if(u){if(e.button==2)return u.sheet.render(!0);switch(u.type){case"meleeweapon":case"rangeweapon":case"trait":t.setupWeapon(u,"attack",{},a).then(d=>{t.basicTest(d)});break;case"ahnengabe":t.setupSpell(u,{},a).then(d=>{t.basicTest(d)});break;case"skill":t.setupSkill(u,{},a).then(d=>{t.basicTest(d)});break}}}}subWidth(e,t,a=7){return`style="width:${Math.ceil(e.length/a)*200}px"`}async getData(){let e=await super.getData(),t=this.actor,a={attacks:[],spells:[],default:[],skills:[]},s,i,r=[],n=[],l=[],c=game.settings.get("dsk","tokenhotbarLayout"),u=c%2,d=Q.defaultOptions.itemWidth,p=["ahnengabe"];if(t){let b=[],T=[];if(l=(await t.actorEffects()).map(g=>({name:g.name,id:g.id,icon:g.icon,cssClass:"effect",abbrev:`${g.name[0]} ${g.getFlag("dsk","value")||""}`,subfunction:"effect"})),game.combat){let g=t.items.filter(k=>k.type=="combatskill").map(k=>D._calculateCombatSkillValues(k.toObject(),t.system)),y=["meleeweapon","rangeweapon"],v=["meleeAttack","rangeAttack"];for(let k of t.items){if(k.type=="trait"&&v.includes(k.system.traitType)){let I=D._parseDmg(k.toObject());a.attacks.push({name:k.name,id:k.id,icon:k.img,cssClass:`weapon ${k.id}`,abbrev:k.name[0],attack:k.system.at,damage:I.damagedie,dadd:I.damageAdd})}else if(y.includes(k.type)&&k.system.worn.value==!0){let I=k.type=="meleeweapon"?D._prepareMeleeWeapon(k.toObject(),g,t):D._prepareRangeWeapon(k.toObject(),[],g,t);a.attacks.push({name:k.name,id:k.id,icon:k.img,cssClass:`weapon ${k.id}`,abbrev:k.name[0],attack:I.attack,damage:I.damagedie,dadd:I.damageAdd})}else if(p.includes(k.type))k.system.effectFormula?a.spells.push({name:k.name,id:k.id,icon:k.img,cssClass:"spell",abbrev:k.name[0]}):T.push({name:k.name,id:k.id,icon:k.img,cssClass:"spell",abbrev:k.name[0]});else if(["skill"].includes(k.type)&&this.combatSkills.includes(k.name))a.default.push({name:`${k.name} (${k.system.level})`,id:k.id,icon:k.img,cssClass:"skill",abbrev:k.name[0]});else if(["skill"].includes(k.type)){let I={name:`${k.name} (${k.system.level})`,id:k.id,icon:k.img,cssClass:"skill",addClass:k.system.group,abbrev:k.name[0],tw:k.system.level};b.push(I)}else k.type=="consumable"&&r.push({name:k.name,id:k.id,icon:k.img,cssClass:"consumable",abbrev:k.system.quantity});k.getFlag("dsk","onUseEffect")&&n.push({name:k.name,id:k.id,icon:k.img,cssClass:"onUse",abbrev:k.name[0],subfunction:"onUse"})}s=r.pop()}else{let g=[];for(let y of t.items){if(["skill"].includes(y.type)&&this.defaultSkills.includes(y.name))a.default.push({name:`${y.name} (${y.system.level})`,id:y.id,icon:y.img,cssClass:"skill",abbrev:y.name[0]});else if(["skill"].includes(y.type)){let v={name:`${y.name} (${y.system.level})`,id:y.id,icon:y.img,cssClass:"skill",addClass:y.system.group,abbrev:y.name[0],tw:y.system.level};y.system.level>0&&g.push(v),b.push(v)}else p.includes(y.type)&&(y.system.effectFormula?a.spells.push({name:y.name,id:y.id,icon:y.img,cssClass:"spell",abbrev:y.name[0]}):T.push({name:y.name,id:y.id,icon:y.img,cssClass:"spell",abbrev:y.name[0]}));y.getFlag("dsk","onUseEffect")&&n.push({name:y.name,id:y.id,icon:y.img,cssClass:"onUse",abbrev:y.name[0],subfunction:"onUse"})}a.skills.push(...g.sort((y,v)=>v.tw-y.tw).slice(0,5))}i=n.pop(),a.spells.length==0&&T.length>0&&a.spells.push(T.pop()),a.spells.length>0&&T.length>0&&(a.spells[0].more=T.sort((g,y)=>g.name.localeCompare(y.name)),a.spells[0].subwidth=this.subWidth(T,d)),a.default.length>0&&b.length>0&&(a.default[0].more=b.sort((g,y)=>g.addClass.localeCompare(y.addClass)||g.name.localeCompare(y.name)),a.default[0].subwidth=this.subWidth(b,d,20)),s&&(r.length>0&&(s.more=r,s.subwidth=this.subWidth(r,d)),a.consumables=[s]),i&&(n.length>0&&(i.more=n,i.subwidth=this.subWidth(n,d)),a.onUsages=[i])}if(this.showEffects){let b=game.i18n.localize("dsk.CONDITION.add"),T={name:b,id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:b[0],subfunction:"addEffect"};l.length>0&&(T.more=l,T.subwidth=this.subWidth(l,d)),a.effects=[T]}let f=Object.keys(a).reduce((b,T)=>b+a[T].length,0);return u?(this.position.width=d,this.position.height=d*f+14):(this.position.width=d*f+14,this.position.height=d),mergeObject(e,{items:a,itemWidth:d,direction:c,count:f}),e}async render(e,t={}){let a=await super.render(e,t);return this._element&&this._element.css({zIndex:61}),a}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){let r=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),n=this.element[0];if(!n.style.width||a){let l=a||n.offsetWidth,c=n.style.maxWidth||window.innerWidth;r.width=a=Math.clamped(l,0,c),n.style.width=a+"px",a+r.left>window.innerWidth&&(e=r.left)}return game.settings.set("dsk","tokenhotbarPosition",{left:r.left,top:r.top}),r}async updateDSKHotbar(){let e=canvas.tokens.controlled;if(this.actor=void 0,this.showEffects=!1,e.length===1){let t=e[0].actor;t&&t.isOwner&&(this.actor=t)}e.length>=1&&(this.showEffects=!0),await this.render(!0)}};m(Q,"TokenHotbar2");var Re=class extends Dialog{static async showDialog(){let e=duplicate(CONFIG.statusEffects).map(a=>({label:game.i18n.localize(a.name),icon:a.icon,description:game.i18n.localize(a.description),id:a.id})).sort((a,s)=>a.label.localeCompare(s.label)),t=new Re({title:game.i18n.localize("dsk.CONDITION.add"),content:await renderTemplate("systems/dsk/templates/dialog/addstatusdialog.html",{effects:e}),buttons:{}});t.position.height=Math.ceil(e.length/3)*36+170,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(s=>this.addEffect(s));let t=m(s=>this._filterConditions($(s.currentTarget),e),"filterConditions"),a=e.find(".conditionSearch");a.keyup(s=>this._filterConditions($(s.currentTarget),e)),a[0]&&a[0].addEventListener("search",t,!1)}_filterConditions(e,t){if(e.val()!=null){let a=e.val().toLowerCase().trim(),s=t.find(".filterable");t.find(".filterHide").removeClass("filterHide"),s.filter(function(){return $(this).find("span").text().toLowerCase().trim().indexOf(a)==-1}).addClass("filterHide")}}async addEffect(e){for(let t of canvas.tokens.controlled)await t.actor.addCondition(e.currentTarget.dataset.value,1,!1,!1);game.dsk.apps.tokenHotbar.render(!0),this.close()}static get defaultOptions(){let e=super.defaultOptions,t=Math.ceil(CONFIG.statusEffects.length/3)*32;return mergeObject(e,{classes:["dsk","tokenStatusEffects"],width:700,resizable:!0,height:t}),e}};m(Re,"AddEffectDialog");var P=class{static payMoney(e,t,a=!1){let s=P.canPay(e,t,a);return s.success&&P._updateMoney(e,s.actorsMoney.sum-s.money),!a&&s.msg!=""&&ChatMessage.create(h.chatDataSetup(`<p>${s.msg}</p>`,"roll")),s.success}static canPay(e,t,a){let s=this._getPaymoney(t),i={success:!1,msg:"",money:s};return s&&(i.actorsMoney=this._actorsMoney(e),i.actorsMoney.sum>=s?(i.msg=game.i18n.format("dsk.PAYMENT.pay",{actor:e.name,amount:P._moneyToString(s)}),i.success=!0):(i.msg=game.i18n.format("dsk.PAYMENT.cannotpay",{actor:e.name,amount:P._moneyToString(s)}),a&&ui.notifications.notify(i.msg))),i}static getMoney(e,t,a=!1){let s=this._getPaidmoney(t);if(s){let i=this._actorsMoney(e);P._updateMoney(e,i.sum+s);let r=`<p>${game.i18n.format("dsk.PAYMENT.getPaid",{actor:e.name,amount:P._moneyToString(s)})}</p>`;return a||ChatMessage.create(h.chatDataSetup(r,"roll")),!0}}static _updateMoney(e,t){let a=P._moneyToCoins(t);e.update({"system.money":a})}static createGetPaidChatMessage(e,t=void 0){let a=this._getPaidmoney(e);if(a){let s=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("dsk.PAYMENT.wage")}</b></p><p>${game.i18n.format("dsk.PAYMENT.getPaidSum",{amount:P._moneyToString(a)})}${s}</p><button class="payButton" data-pay="1" data-amount="${a}">${game.i18n.localize("dsk.PAYMENT.getPaidButton")}</button>`;ChatMessage.create(h.chatDataSetup(i,"roll"))}}static createPayChatMessage(e,t=void 0){let a=this._getPaymoney(e);if(a){let s=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("dsk.PAYMENT.bill")}</b></p>${game.i18n.format("dsk.PAYMENT.paySum",{amount:P._moneyToString(a)})}${s}</p><button class="payButton" data-pay="0" data-amount="${a}">${game.i18n.localize("dsk.PAYMENT.payButton")}</button>`;ChatMessage.create(h.chatDataSetup(i,"roll"))}}static _getPaidmoney(e){let t=this._parseMoneyString(e);if(!t){let a=`<p><b>${game.i18n.localize("dsk.PAYMENT.error")}</b></p><p><i>${game.i18n.localize("dsk.PAYMENT.getPaidexample")}</i></p>`;return ChatMessage.create(h.chatDataSetup(a,"roll")),!1}return t}static _getPaymoney(e){let t=this._parseMoneyString(e);if(!t){let a=`<p><b>${game.i18n.localize("dsk.PAYMENT.error")}</b></p><p><i>${game.i18n.localize("dsk.PAYMENT.payexample")}</i></p>`;return ChatMessage.create(h.chatDataSetup(a,"roll")),!1}return t}static _parseMoneyString(e){let t=e.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return t?Number(t[0]):!1}static _actorsMoney(e){return{sum:e.system.money}}static handlePayAction(e,t,a,s=void 0){if(game.user.isGM&&!s){ui.notifications.notify(game.i18n.localize("dsk.PAYMENT.onlyActors"));return}s?K.playMoneySound(!0):s=game.user.character;let i=!1;s&&t?i=P.payMoney(s,a):s&&!t?i=P.getMoney(s,a):ui.notifications.notify(game.i18n.localize("dsk.PAYMENT.onlyActors")),i&&e&&(e.fadeOut(),game.socket.emit("system.dsk",{type:"updateMsg",payload:{id:e.closest(".message").attr("data-message-id"),updateData:{[`flags.dsk.userHidden.${game.user.id}`]:!0}}}))}static _moneyToCoins(e){return e}static _moneyToString(e){return`<span class="nobr">${P._moneyToCoins(e)} <span data-tooltip="dsk.money" class="chatmoney" style="background-size:contain;background-image:url('systems/dsk/icons/categories/money.webp');"></span></span>`}static async chatListeners(e){e.on("click",".payButton",t=>{let a=$(t.currentTarget);P.handlePayAction(a,Number(a.attr("data-pay"))!=1,a.attr("data-amount")),K.playMoneySound()})}};m(P,"DSKPayment");var Fe=m(o=>class extends o{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["merchant-sheet"])}),e}static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/merchant-sheet.html"}get template(){if(this.merchantSheetActivated())switch(getProperty(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsk/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsk/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsk/templates/actors/merchant/merchant-epic.html";default:return super.template}return this.constructor.merchantTemplate}merchantSheetActivated(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(getProperty(this.actor.system,"merchant.merchantType"))}async allowMerchant(e,t){let a=duplicate(this.actor.ownership),s=t?1:0;for(let i of e)a[i]=s;await this.actor.update({ownership:a},{diff:!1,recursive:!1,noHook:!0})}activateListeners(e){super.activateListeners(e),e.find(".allowMerchant").click(async t=>{let a=$(t.currentTarget).attr("data-user-id"),s=$(t.currentTarget).find("i");await this.allowMerchant([a],!s.hasClass("fa-check-circle")),s.toggleClass("fa-circle fa-check-circle")}),e.find(".toggleAllAllowMerchant").click(async t=>{let a=game.users.filter(i=>!i.isGM).map(i=>i.id),s=t.currentTarget.dataset.lock=="true";await this.allowMerchant(a,s),this.render()}),e.find(".lockTradeSection").click(t=>this.lockTradeSection(t)),e.find(".item-tradeLock").click(t=>this.toggleTradeLock(t)),e.find(".randomGoods").click(t=>this.randomGoods(t)),e.find(".clearInventory").click(t=>this.clearInventory(t)),e.find(".removeOtherTradeFriend").click(()=>this.removeOtherTradeFriend()),e.find(".choseTradefriend").click(()=>this.choseTradefriend()),e.find(".setCustomPrice").click(t=>$(t.currentTarget).addClass("edit")),e.find(".customPriceTag").change(async t=>this.setCustomPrice(t)).blur(t=>$(t.currentTarget).closest(".setCustomPrice").removeClass("edit")),e.find(".buy-item").click(t=>{this.advanceWrapper(t,"buyItem",t),K.playMoneySound()}),e.find(".sell-item").click(t=>{this.advanceWrapper(t,"sellItem",t),K.playMoneySound()}),e.find(".item-external-edit").click(t=>{t.preventDefault();let a=this._getItemId(t);this.getTradeFriend().items.get(a).sheet.render(!0)}),e.find(".changeAmountAllItems").mousedown(t=>this.changeAmountAllItems(t)),e.find(".gearSearch").prop("disabled",!1)}_canDragStart(e){return!this.merchantSheetActivated()&&this.isEditable}async toggleTradeLock(e){let t=this._getItemId(e),a=this.actor.items.get(t);this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.tradeLocked":!a.system.tradeLocked}])}async setCustomPrice(e){e.stopPropagation(),e.preventDefault();let t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"flags.dsk.customPriceTag":Number(e.target.value)}])}removeOtherTradeFriend(){this.otherTradeFriend=void 0,this.render(!0)}async choseTradefriend(){(await Le.getDialog(this)).render(!0)}async lockTradeSection(e){let t=[],a=this.filterRule(e),s;for(let i of this.actor.items)if(a(i)){let r=i.toObject();s===void 0&&(s=!r.system.tradeLocked),r.system.tradeLocked=s,t.push(r)}this.actor.updateEmbeddedDocuments("Item",t)}filterRule(e){let t=e.currentTarget.dataset.type;return w.equipmentTypes[t]?a=>a.type=="equipment"&&a.system.category==t:a=>a.type==t&&w.equipmentCategories.includes(a.type)}async changeAmountAllItems(e){let t=[],a=this.filterRule(e);for(let s of this.actor.items)if(a(s)){let i=s.toObject();_.increment(e,i,"system.quantity",0),t.push(i)}this.actor.updateEmbeddedDocuments("Item",t)}playerViewEnabled(){return getProperty(this.actor.system,"merchant.playerView")}async buyItem(e){await this.transferItem(this.actor,this.getTradeFriend(),e,!0)}async sellItem(e){await this.transferItem(this.getTradeFriend(),this.actor,e,!1)}async transferItem(e,t,a,s=!0){let i=this._getItemId(a),r=$(a.currentTarget).attr("data-price"),n=a.ctrlKey?10:1;game.user.isGM?await this.constructor.finishTransaction(e,t,r,i,s,n):(this.constructor.noNeedToPay(t,e,r)||P.canPay(t,r,!0))&&game.socket.emit("system.dsk",{type:"trade",payload:{target:this.constructor.transferTokenData(t),source:this.constructor.transferTokenData(e),price:r,itemId:i,buy:s,amount:n}})}static transferTokenData(e){let t={actor:e.id};return e.token&&(t.token=e.token.id),t}static async finishTransaction(e,t,a,s,i,r){let n=e.items.get(s).toObject();if(r=Math.min(Number(n.system.quantity),r),Number(n.system.quantity)>0){let l=this.noNeedToPay(t,e,a);(l||P.payMoney(t,a,!0))&&(getProperty(n,"system.worn.value")&&(n.system.worn.value=!1),i?(await this.updateTargetTransaction(t,n,r,e,a),await this.updateSourceTransaction(e,t,n,a,s,r),await this.transferNotification(n,t,e,i,a,r,l),await this.selfDestruction(e)):(await this.updateSourceTransaction(e,t,n,a,s,r),await this.updateTargetTransaction(t,n,r,e,a),await this.transferNotification(n,e,t,i,a,r,l)))}}static isTemporaryToken(e){return getProperty(e.system,"merchant.merchantType")=="loot"&&getProperty(e.system,"merchant.temporary")}static async selfDestruction(e){if(this.isTemporaryToken(e)&&!e.items.some(a=>w.equipmentCategories.includes(a.type)||a.type=="money"&&a.system.quantity>0)){game.socket.emit("system.dsk",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(e)}});let a=e.getActiveTokens().map(s=>s.id);await canvas.scene.deleteEmbeddedDocuments("Token",a),await game.actors.get(e.id).delete(),this.hideDeletedSheet(e)}}static async hideDeletedSheet(e){e.sheet.close(!0)}static async transferNotification(e,t,a,s,i,r,n){let l=game.settings.get("dsk","merchantNotification");if(l==0||getProperty(e,"system.category")=="service")return;let c="dsk.MERCHANT."+(s?"buy":"sell")+(n?"Loot":"")+"Notification",u=game.i18n.format(c,{item:e.name,source:t.name,target:a.name,amount:r,price:i,buy:s}),d=h.chatDataSetup(u);l==2&&(d.whisper=ChatMessage.getWhisperRecipients("GM").map(p=>p.id)),await ChatMessage.create(d)}static noNeedToPay(e,t,a){return a==0||getProperty(e.system,"merchant.merchantType")=="loot"||getProperty(t.system,"merchant.merchantType")=="loot"}static async updateSourceTransaction(e,t,a,s,i,r){let n=duplicate(a);Number(n.system.quantity)>r||n.type=="money"?(n.system.quantity=Number(n.system.quantity)-r,await e.updateEmbeddedDocuments("Item",[n])):await e.deleteEmbeddedDocuments("Item",[i]),this.noNeedToPay(e,t,s)||await P.getMoney(e,s,!0)}static async updateTargetTransaction(e,t,a,s,i){let r=duplicate(t);if(getProperty(r,"system.category")=="service"){let l=game.i18n.format("dsk.MERCHANT.buyNotification",{item:r.name,amount:a,source:e.name,target:s.name,price:i});ChatMessage.create(h.chatDataSetup(l))}else{let l=e.items.find(c=>C.areEquals(r,c));r.system.quantity=a,l?await C.stackItems(l,r,e):await e.createEmbeddedDocuments("Item",[r])}}getTradeFriend(){return this.otherTradeFriend||game.user.character}async _manageDragItems(e,t){switch(t){case"creature":case"npc":case"character":this.setTradeFriend(e);break;default:return super._manageDragItems(e,t)}}setTradeFriend(e){let t=game.actors.get(e._id);t.isOwner&&(this.otherTradeFriend=t,this.render(!0))}async _render(e=!1,t={}){if(!game.user.isGM&&getProperty(this.actor.system,"merchant.merchantType")=="loot"&&getProperty(this.actor.system,"merchant.locked")){AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1);return}await super._render(e,t)}_getHeaderButtons(){let e=super._getHeaderButtons();return this.actor.isOwner&&e.unshift({class:"playerview",icon:"fas fa-toggle-on",onclick:async t=>this._togglePlayerview(t)}),e}_togglePlayerview(e){this.actor.update({"system.merchant.playerView":!getProperty(this.actor.system,"merchant.playerView")})}async randomGoods(e){let t=await renderTemplate("systems/dsk/templates/dialog/randomGoods-dialog.html",{categories:w.equipmentCategories});new Dialog({title:game.i18n.localize("dsk.MERCHANT.randomGoods"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:a=>this.addRandomGoods(this.actor,a,e)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async clearInventory(e){new Dialog({title:game.i18n.localize("dsk.MERCHANT.clearInventory"),content:game.i18n.localize("dsk.MERCHANT.deleteAllGoods"),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{this.removeAllGoods(this.actor,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async addRandomGoods(e,t,a){let s=$(a.currentTarget).text();$(a.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let i=[];t.find('input[type="checkbox"]:checked').each(function(){let c=$(this).val();i.push({name:c,count:Number(t.find(`input[name="each_${c}"]`).val()),number:Number(t.find(`input[name="number_${c}"]`).val())})});let r=game.dsk.itemLibrary;r.equipmentBuild||await r.buildEquipmentIndex();let n=[];for(let c of i){let u=(await r.getRandomItems(c.name,c.number)).map(d=>{let p=d.toObject();return p.system.quantity=c.count,p});n.push(...u)}let l={};n=n.filter(function(c){let u=getProperty(c,"system.effect");u=typeof u=="object"&&u!==null&&getProperty(u,"attributes")||"";let d=Number(getProperty(c,"system.price"))||0;if(u!=""||d>1e4)return!1;let p=`${c.type}_${c.name}`;return(l.hasOwnProperty(p)?!1:l[p]=!0)&&e.items.filter(function(f){return f.type==c.type&&f.name==c.name}).length==0}),await e.createEmbeddedDocuments("Item",n),$(a.currentTarget).text(s)}async removeAllGoods(e,t){let a=$(t.currentTarget).text();$(t.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let s=e.items.filter(i=>w.equipmentCategories.includes(i.type)&&!getProperty(i,"worn.value")).map(i=>i.id);await e.deleteEmbeddedDocuments("Item",s),$(t.currentTarget).text(a)}async getData(e){let t=await super.getData(e);return t.merchantType=getProperty(this.actor.system,"merchant.merchantType")||"none",t.merchantTypes={none:game.i18n.localize("dsk.MERCHANT.typeNone"),merchant:game.i18n.localize("dsk.MERCHANT.typeMerchant"),loot:game.i18n.localize("dsk.MERCHANT.typeLoot"),epic:game.i18n.localize("dsk.MERCHANT.typeEpic")},t.invName=t.merchantTypes[t.merchantType],t.players=game.users.filter(a=>!a.isGM).map(a=>(a.allowedMerchant=this.actor.testUserPermission(a,"LIMITED",!1),a.buyingFactor=getProperty(this.actor.system,`merchant.factors.buyingFactor.${a.id}`),a.sellingFactor=getProperty(this.actor.system,`merchant.factors.sellingFactor.${a.id}`),a)),t.merchantType!="epic"?(this.prepareStorage(t),this.merchantSheetActivated()&&(this.filterWornEquipment(t),this.prepareTradeFriend(t),t.prepare.inventory.misc.items.length==0&&(t.prepare.inventory.misc.show=!1))):this.prepareStorage(t),t.hasOtherTradeFriend=!!this.otherTradeFriend,t}filterWornEquipment(e){for(let[t,a]of Object.entries(e.prepare.inventory))a.items=a.items.filter(s=>!getProperty(s,"system.worn.value"))}prepareStorage(e){if(e.merchantType=="merchant")for(let[t,a]of Object.entries(e.prepare.inventory))for(let s of a.items)s.defaultPrice=this.getItemPrice(s),s.calculatedPrice=Number(parseFloat(`${s.defaultPrice*(getProperty(this.actor.system,"merchant.sellingFactor")||1)}`).toFixed(2))*(getProperty(this.actor.system,`merchant.factors.sellingFactor.${game.user.id}`)||1),s.priceTag=` / ${s.calculatedPrice}`;else if(e.merchantType=="loot")for(let[t,a]of Object.entries(e.prepare.inventory))for(let s of a.items)s.calculatedPrice=this.getItemPrice(s)}getItemPrice(e){return Number(getProperty(e,"flags.dsk.customPriceTag"))||(e.type=="consumable"?game.dsk.config.ItemSubClasses.consumable.consumablePrice(e):Number(e.system.price))}prepareTradeFriend(e){let t=this.getTradeFriend();if(t){let a=t.prepareItems({details:[]}),s=getProperty(this.actor.system,"merchant.merchantType")=="loot"?1:(getProperty(this.actor.system,"merchant.buyingFactor")||1)*(getProperty(this.actor.system,`merchant.factors.buyingFactor.${game.user.id}`)||1),i=this.prepareSellPrices(a.inventory,s);i.misc.items.length==0&&(i.misc.show=!1),mergeObject(e,{tradeFriend:{img:t.img,name:t.name,inventory:i,money:t.system.money}})}else mergeObject(e,{tradeFriend:{inventory:[],money:""}})}prepareSellPrices(e,t){for(let[a,s]of Object.entries(e))for(let i of s.items)i.calculatedPrice=Number(parseFloat(`${this.getItemPrice(i)*t}`).toFixed(2));return e}},"MerchantSheetMixin"),Le=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{}),e}static async getDialog(e){let t=await game.dsk.apps.gameMasterMenu?.getTrackedHeros();if(!t)return ui.notifications.warn("The required functionality is not yet available.");let a=new Le({title:game.i18n.localize("dsk.DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsk/templates/dialog/selectTradeFriend.html",{users:t}),default:"yes",buttons:{}});return a.actor=e,a}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){this.actor.setTradeFriend({_id:e.currentTarget.dataset.id}),this.close()}};m(Le,"SelectTradefriendDialog");var de=class extends Fe(ne){};m(de,"MerchantSheetDSK");function Ha(){Hooks.once("ready",async()=>{game.socket.on("system.dsk",o=>{switch(o.type){case"hideDeletedSheet":let e=o.payload.target.token?game.actors.tokens[o.payload.target.token]:game.actors.get(o.payload.target.actor);de.hideDeletedSheet(e);break}}),game.user.isGM&&game.socket.on("system.dsk",o=>{if(!!h.isActiveGM())switch(o.type){case"target":{let e=game.scenes.get(o.payload.scene);new Token(e.getEmbeddedDocument("Token",o.payload.target)).actor.update({"flags.oppose":o.payload.opposeFlag})}break;case"addEffect":W.applyEffect(o.payload.id,o.payload.mode,o.payload.actors);break;case"hideQueryButton":L.hideReactionButton(o.payload.id);break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(o.payload.speaker);break;case"updateMsg":game.messages.get(o.payload.id).update(o.payload.updateData);break;case"deleteMsg":game.messages.get(o.payload.id).delete();break;case"showDamage":L.showDamage(game.messages.get(o.payload.id),o.payload.hide);break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"trade":{let e=o.payload.source.token?game.actors.tokens[o.payload.source.token]:game.actors.get(o.payload.source.actor),t=o.payload.target.token?game.actors.tokens[o.payload.target.token]:game.actors.get(o.payload.target.actor);de.finishTransaction(e,t,o.payload.price,o.payload.itemId,o.payload.buy,o.payload.amount)}break;case"playWhisperSound":o.payload.whisper.includes(game.user.id)&&AudioHelper.play({src:o.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(o.payload.id).then(e=>{new Y(e).socketedConditionAddActor(o.payload.actors.map(a=>game.actors.get(a)),o.payload.data)});break;case"socketedConditionAdd":fromUuid(o.payload.id).then(e=>{new Y(e).socketedConditionAdd(o.payload.targets,o.payload.data)});break;case"socketedRemoveCondition":fromUuid(o.payload.id).then(e=>{new Y(e).socketedRemoveCondition(o.payload.targets,o.payload.coreId)});break;case"socketedActorTransformation":fromUuid(o.payload.id).then(e=>{new Y(e).socketedActorTransformation(o.payload.targets,o.payload.update)});break;case"itemDrop":{let e=o.payload.sourceActorId?game.actors.get(o.payload.sourceActorId):void 0;fromUuid(o.payload.itemId).then(t=>{Ca(e,t,o.payload.data,o.payload.amount)})}break;default:console.warn(`Unhandled socket data type ${o.type}`)}}),await oe.firstTimeMessage(),Ce.showOneMessage(),h.moduleEnabled("vtta-tokenizer")&&!await game.settings.get("dsk","tokenizerSetup")&&game.user.isGM&&(await game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsk/icons/backgrounds/token_green.webp"),await game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsk/icons/backgrounds/token_black.webp"),await game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsk/icons/backgrounds/token_blue.webp"),await game.settings.set("dsk","tokenizerSetup",!0)),h.moduleEnabled("dice-so-nice")&&!await game.settings.get("dsk","diceSetup")&&game.user.isGM&&(await game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0),await game.settings.set("dsk","diceSetup",!0)),C.setupSubClasses(),ke.connectHooks(),Fa(),Q.registerTokenHotbar(),Ia(),Na()})}m(Ha,"initReady");var He=class extends Application{constructor(e){super(e),this.adventures=[],this.books=[],this.rshs=[]}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsk","largeDialog","noscrollWizard","bookWizardsheet","dskjournalbrowser"]),width:800,height:880,template:"systems/dsk/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("dsk.Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),e}static initHook(){He.wizard=new He,game.dsk.apps.journalBrowser=He.wizard,Hooks.on("renderJournalDirectory",(e,t)=>{let a=$('<div class="header-actions action-buttons flexrow"></div>'),s=$(`<button id="openJournalBrowser"><i class="fa fa-book"></i>${game.i18n.localize("dsk.Book.Wizard")}</button>`);s.click(()=>{He.wizard.render(!0)}),a.append(s),t.find(".header-actions:first-child").after(a)})}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({label:"Library",class:"library",icon:"fas fa-book",onclick:async t=>this._showBooks()}),e}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".library").attr("data-tooltip",game.i18n.localize("dsk.Book.home"))}_showBooks(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!0,this.currentType=void 0,this.loadPage(this._element)}async toggleBookVisibility(e,t,a){let s=game.settings.get("dsk","expansionPermissions");s[e]=a,await game.settings.set("dsk","expansionPermissions",s);let i=this[t].find(l=>l.id==e),r=await(await fetch(i.path)).json(),n=["actors","journal","scenes"];for(let l of n){if(!r[l])continue;let c=game.packs.get(r[l]),u=a?"OBSERVER":"NONE",d={ownership:{PLAYER:u,TRUSTED:u}};await c.configure(d)}this.render()}activateListeners(e){super.activateListeners(e),e.on("click",".toggleVisibility",async t=>{let a=t.currentTarget.dataset.itemid,s=t.currentTarget.dataset.type,i=$(t.currentTarget).find("i").hasClass("fa-toggle-off");this.toggleBookVisibility(a,s,i)}),e.on("click",".showMapNote",t=>{game.journal.get(t.currentTarget.dataset.entryid).panToNote()}),e.on("search keyup",".filterJournals",t=>{this.filterToc($(t.currentTarget).val())}),e.on("click",".loadBook",t=>{this.selectedChapter=void 0,this.selectedType=void 0,this.content=void 0,this.loadBook($(t.currentTarget).text(),e,$(t.currentTarget).attr("data-type"))}),e.on("click",".getChapter",t=>{this.selectedType=$(t.currentTarget).closest(".toc").attr("data-type"),this.selectedChapter=$(t.currentTarget).attr("data-id"),this.content=void 0,this.loadPage(e)}),e.on("click",".subChapter",t=>{let a=$(t.currentTarget).text(),s=$(t.currentTarget).attr("data-jid");s?this.loadJournalById(s):($(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-id="${a}"]`).addClass("selected"),this.loadJournal(a))}),G.bindRollCommands(e),e.find(".tocCollapser").click(t=>{$(t.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),e.find(".tocCollapsing").toggleClass("expanded")}),e.on("mousedown",".openPin",async t=>{let a=t.currentTarget.dataset.uuid;t.button==0?this.showJournal(await fromUuid(a)):t.button==2&&this.unpinJournal(a)}),e.on("click",".showJournal",t=>{this.popJournal($(t.currentTarget).closest("h1").attr("data-uuid"))}),e.on("click",".pinJournal",t=>{let a=$(t.currentTarget).closest("h1"),s=a.attr("data-uuid"),i=a.text();this.pinJournal(s,i)}),e.on("click",".activateScene",t=>{this.showSzene($(t.currentTarget).attr("data-id"),$(t.currentTarget).attr("data-mode"))}),e.on("click",".fulltextsearch",t=>{this.fulltextsearch=!this.fulltextsearch,$(t.currentTarget).toggleClass("on"),this.filterToc(e.find(".filterJournals").val())}),e.on("mousedown",".chapter img",t=>{let a=this.book.id;t.button==2&&game.dsk.apps.DSKUtility.showArtwork({name:a,uuid:"",img:$(t.currentTarget).attr("src")})}),O.bindButtons(e),e.on("click",".importBook",async()=>this.importBook()),Se(e),xa(e,".breadcrumbs",this.resaveBreadCrumbs),this.heightFix()}heightFix(){let e=$(this._element).find(".breadcrumbs").height();$(this._element).find(".col.seventy.scrollable").css({"margin-bottom":`${e}px`})}async loadJournal(e){await this.showJournal(this.journals.find(t=>t.name==e&&t.flags.dsk.parent==this.selectedChapter))}async loadJournalById(e){await this.showJournal(this.journals.find(t=>t.id==e))}async resaveBreadCrumbs(e){let t={};for(let a of e.getElementsByTagName("div"))t[a.dataset.uuid]=a.innerText;await game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(t))}async filterToc(e){if(e!=null){e=e.toLowerCase().trim();let t;if(e!=""){let a=[];this.fulltextsearch?(this.journalIndex||(this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),await this.journalIndex.add(this.journals.map(s=>new ua(s)))),a=await this.journalIndex.search(e)):a=this.journals.filter(s=>s.name.toLowerCase().trim().indexOf(e)!=-1),a=a.map(s=>`<li class="fas fa-caret-right"><a data-jid="${s.id}" class="subChapter">${s.name}</a></li>`),$(this._element).find(".tocContent").html(`<ul>${a.join(`
`)}</ul>`)}else t=await this.getToc(),$(this._element).find(".adventureWizard > .row-section > .toc").html(t).find(".filterJournals").focus()}}async showJournal(e){let t="";for(let r of e.pages){let n=r.sheet,l=await n.getData(),c=(await n._renderInner(l)).get(),u=$(c[c.length-1]).html();r.type=="video"&&(u=`<div class="video-container">${u}</div>`),t+=u}let a=this.findSceneNote(e.getFlag("dsk","initId")),s=await TextEditor.enrichHTML(t,{secrets:game.user.isGM,async:!0});this.content=`<div><h1 class="journalHeader" data-uuid="${e.uuid}">${e.name}<div class="jrnIcons">${a}<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>${s}`;let i=$(this._element).find(".chapter");i.html(this.content),Se(i),i.find(".documentName-link, .entity-link, .content-link").click(r=>{let n=$(r.currentTarget);this.bookData&&n.attr("data-pack")==this.bookData.journal&&(r.stopPropagation(),this.loadJournalById(n.attr("data-id")))})}findSceneNote(e){if(e){let t=game.journal.find(a=>a.getFlag("dsk","initId")==e);if(t&&t.sceneNote)return`<a class="showMapNote" data-entryId="${t.id}"><i class="fas fa-map-pin"></i></a>`}return""}async importBook(){game.user.isGM&&new ma().render(this.bookData.moduleName)}async loadBook(e,t,a){a||(a=this.currentType),this.currentType=a,this.book=this[a].find(s=>s.id==e),await fetch(this.book.path).then(async s=>s.json()).then(async s=>{this.bookData=s;let i=game.packs.get(s.journal),r=await i.getIndex(),n=await i.getDocuments();this.journals=n,s.actors&&(i=game.packs.get(s.actors),n=await i.getIndex(),this.actors=n),s.scenes&&(i=game.packs.get(s.scenes),n=await i.getIndex(),this.scenes=n),this.loadPage(t)})}async prefillActors(e){if(!e.actors)return[];let t=[],a=await game.folders.contents.find(i=>i.name==game.i18n.localize(`${this.bookData.moduleName}.name`)&&i.type=="Actor"&&i.folder==null),s=a?await game.folders.contents.filter(i=>i.type=="Actor"&&i.folder?.id==a.id).map(i=>i.id):void 0;for(let i of e.actors){let r=s?.length?game.actors.contents.find(u=>u.name==i&&s.includes(u.folder?.id)):void 0,n,l=r?.id,c=r?.uuid;r||(r=this.actors.find(u=>u.name==i),n=this.bookData.actors,l=r?._id,c=r?`Compendium.${n}.${l}`:void 0),t.push({name:i,actor:r,pack:n,id:l,uuid:c})}return t}async popJournal(e){(await fromUuid(e)).sheet.render(!0)}async showSzene(e,t="activate"){let a=game.scenes.contents.find(s=>s.name==e);if(!a)return ui.notifications.error(game.i18n.localize("dsk.DSKError.sceneNotInitialized"));switch(t){case"activate":a.activate();break;case"view":a.view();break;case"toggle":a.update({navigation:!a.navigation});break}}async getChapter(){if(this.book){if(this.content)return this.content;if(this.selectedChapter){if(this.selectedChapter=="prep"){let a={initDescr:game.i18n.format(`${this.bookData.moduleName}.importContent`,{defaultText:game.i18n.localize("dsk.importDefault")})},s=this.bookData.modules;for(let i of s)i.enabled=this.moduleEnabled(i.id);return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_preparation.html",{modules:s,info:a})}else if(this.selectedChapter=="foundryUsage")return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_foundry.html");let e=this.bookData.chapters.find(a=>a.name==this.selectedType).content.find(a=>a.id==this.selectedChapter),t=this.getSubChapters();return e.scenes||e.actors||t.length==0?await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_chapter.html",{chapter:e,subChapters:this.getSubChapters(),actors:await this.prefillActors(e)}):await this.loadJournal(t[0].name)}return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData})}else return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),isGM:game.user.isGM})}filterBooks(e){let t=game.settings.get("dsk","expansionPermissions");for(let a of e)t[a.id]!=null&&(a.visible=t[a.id]);return game.user.isGM?e:e.filter(a=>a.visible==null||a.visible).sort((a,s)=>a.id.localeCompare(s.id))}getSubChapters(){return this.journals.filter(e=>e.flags.dsk.parent==this.selectedChapter).sort((e,t)=>e.flags.dsk.sort>t.flags.dsk.sort?1:-1).map(e=>({name:e.name,id:e.id}))}async getToc(){let e=[];if(this.book){if(e.push(...duplicate(this.bookData.chapters)),this.selectedChapter){let t;for(let a of e)if(t=a.content.find(s=>s.id==this.selectedChapter),t)break;t.cssClass="selected",t.subChapters=this.getSubChapters()}return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_toc.html",{chapters:e,book:this.book,fulltextsearch:this.fulltextsearch?"on":""})}else return'<div class="libraryImg"></div>'}async loadPage(e){let t=await this.getChapter(),a=await this.getToc();e.find(".toc").html(a),e.find(".chapter").html(t)}async getData(e){let t=await super.getData(e),a=await this.getChapter(),s=await this.getToc();return mergeObject(t,{adventure:this.bookData,currentChapter:a,breadcrumbs:this.renderBreadcrumbs(),toc:s}),t}async pinJournal(e,t=void 0){let a=this.readBreadCrumbs();t||(t=(await fromUuid(e))?.name||""),a[e]=t,game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(a)),this.render(!0)}unpinJournal(e){let t=this.readBreadCrumbs();delete t[e],game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(t)),this.render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain"))}catch{return!1}t.type=="JournalEntry"&&this.pinJournal(t.pack?`Compendium.${t.pack}.${t.id}`:`JournalEntry.${t.id}`)}readBreadCrumbs(){let e={};try{e=JSON.parse(game.settings.get("dsk",`breadcrumbs_${game.world.id}`))}catch{console.log("No Journalbrowser notes found")}return e}renderBreadcrumbs(){let e=this.readBreadCrumbs(),t=Object.entries(e).map(a=>`<div data-tooltip="${a[1]}" data-uuid="${a[0]}" class="openPin item">${a[1]}</div>`);return t.length>0?`<div id="breadcrumbs" class="breadcrumbs wrap row-section">${t.join("")}</div>`:""}moduleEnabled(e){return h.moduleEnabled(e)}},De=He;m(De,"BookWizard"),z(De,"wizard");var ma=class extends FormApplication{render(e){new game.dsk.apps.DSKInitializer("DSK Module Initialization",game.i18n.format(`${e}.importContent`,{defaultText:game.i18n.localize("dsk.importDefault")}),e,game.i18n.lang).render(!0)}};m(ma,"InitializerForm");var ua=class{constructor(e){let t=e.pages.find(a=>!0).text.content;this.document={name:e.name,data:$("<div>").html(t).text(),id:e.id}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}};m(ua,"JournalSearch");function ja(){game.settings.register("dsk","migrationVersion",{name:"migrationVersion",scope:"world",config:!1,default:25,type:Number}),game.settings.register("dsk","firstTimeStart",{name:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","informationDistribution",{name:"dsk.SETTINGS.informationDistribution",hint:"dsk.SETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.SETTINGS.information0"),1:game.i18n.localize("dsk.SETTINGS.information1"),2:game.i18n.localize("dsk.SETTINGS.information2")}}),game.settings.register("dsk","defaultConfigFinished",{name:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","limitCombatSpecAbs",{name:"dsk.SETTINGS.limitCombatSpecAbs",hint:"dsk.SETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","merchantNotification",{name:"dsk.SETTINGS.merchantNotification",hint:"dsk.SETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.no"),1:game.i18n.localize("dsk.yes"),2:game.i18n.localize("dsk.MERCHANT.onlyGM")}}),game.settings.register("dsk","expandChatModifierlist",{name:"dsk.SETTINGS.expandChatModifierlist",hint:"dsk.SETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","enableCombatFlow",{name:"dsk.SETTINGS.enableCombatFlow",hint:"dsk.SETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:o=>{game.dsk.apps.initTracker&&(game.dsk.apps.initTracker.close(),game.dsk.apps.initTracker=void 0)}}),game.settings.register("dsk","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","inventorySound",{name:"dsk.SETTINGS.inventorySound",hint:"dsk.SETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","scrollingFontsize",{name:"dsk.SETTINGS.scrollingFontsize",hint:"dsk.SETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsk","statusEffectCounterColor",{name:"dsk.SETTINGS.statusEffectCounterColor",hint:"dsk.SETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsk","playerCanEditSpellMacro",{name:"dsk.SETTINGS.playerCanEditSpellMacro",hint:"dsk.SETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsk",`breadcrumbs_${game.world.id}`,{name:"dsk.SETTINGS.breadcrumbs",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsk","soundConfig",{name:"dsk.SETTINGS.soundConfig",hint:"dsk.SETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:async()=>{K.loadSoundConfig()}}),game.settings.register("dsk","allowPhysicalDice",{name:"dsk.SETTINGS.allowPhysicalDice",hint:"dsk.SETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","enableItemDropToCanvas",{name:"dsk.SETTINGS.enableItemDropToCanvas",hint:"dsk.SETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","hideEffects",{name:"dsk.SETTINGS.hideEffects",hint:"dsk.SETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","hideOpposedDamage",{name:"dsk.SETTINGS.hideOpposedDamage",hint:"dsk.SETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","indexDescription",{name:"dsk.SETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsk","enableDPS",{name:"dsk.SETTINGS.enableDPS",hint:"dsk.SETTINGS.enableDPSHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","indexWorldItems",{name:"dsk.SETTINGS.indexWorldItems",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsk","tokenizerSetup",{name:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","forceLanguage",{name:"dsk.SETTINGS.forceLanguage",hint:"dsk.SETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German"}}),game.settings.register("dsk","enableCombatPan",{name:"dsk.SETTINGS.enableCombatPan",hint:"dsk.SETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","iniTrackerSize",{name:"dsk.SETTINGS.iniTrackerSize",hint:"dsk.SETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:async o=>{game.dsk.apps.tokenHotbar.constructor.defaultOptions.itemWidth=o}}),game.settings.register("dsk","iniTrackerPosition",{name:"iniTrackerPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsk","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.registerMenu("dsk","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("dsk.SETTINGS.changelog"),type:pa,restricted:!1}),game.settings.register("dsk","disableDidYouKnow",{name:"dsk.SETTINGS.disableDidYouKnow",hint:"dsk.SETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","tokenhotbarSize",{name:"dsk.SETTINGS.tokenhotbarSize",hint:"dsk.SETTINGS.tokenhotbarSizeHint",scope:"client",config:!0,default:35,type:Number,range:{min:15,max:100,step:5},onChange:async o=>{game.dsk.apps.tokenHotbar.constructor.defaultOptions.itemWidth=o}}),game.settings.register("dsk","obfuscateTokenNames",{name:"dsk.SETTINGS.obfuscateTokenNames",hint:"dsk.SETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.no"),1:game.i18n.localize("dsk.SETTINGS.yesNumbered"),2:game.i18n.localize("dsk.SETTINGS.renameNumbered"),3:game.i18n.localize("dsk.yes"),4:game.i18n.localize("dsk.SETTINGS.rename")}}),game.settings.register("dsk","tokenhotbarLayout",{name:"dsk.SETTINGS.tokenhotbarLayout",hint:"dsk.SETTINGS.tokenhotbarLayoutHint",scope:"client",config:!0,default:0,type:Number,choices:{0:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout3")}})}m(ja,"setupConfiguration");var pa=class extends FormApplication{render(){Ze()}};m(pa,"ChangelogForm");var Ma=class extends FormApplication{async render(){await game.settings.set("dsk","tokenhotbarPosition",{}),await game.settings.set("dsk","tokenhotbarLayout",0),await game.settings.set("dsk","tokenhotbarSize",35),game.dsk.apps.tokenHotbar.resetPosition(),game.dsk.apps.tokenHotbar.render(!0)}};m(Ma,"ResetTokenbar");function Ga(){game.keybindings.register("dsk","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:()=>Ba("nextTurn")}),game.keybindings.register("dsk","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:()=>Ba("previousTurn")}),game.keybindings.register("dsk","attacktest",{name:"attacktest",hint:game.i18n.localize("dsk.KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:()=>ae.runActAttackDialog()}),game.keybindings.register("dsk","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("dsk.KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:()=>h.renderToggle(game.dsk.apps.journalBrowser)}),game.keybindings.register("dsk","library",{name:"ItemLibrary",hint:game.i18n.localize("dsk.KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:()=>h.renderToggle(game.dsk.itemLibrary)})}m(Ga,"setupKeybindings");var Ba=m(o=>{game.combat?.combatant?.isOwner&&game.combat[o]()},"combatTurn");function qa(){Hooks.on("preCreateScene",function(o,e,t,a){e.grid?.units||o.updateSource({grid:{units:game.i18n.localize("dsk.gridUnits")}}),!t.dskInit&&e.notes?.some(s=>getProperty(s,"flags.dsk.initName"))&&ui.notifications.warn(game.i18n.localize("dsk.DSKError.mapsViaJournalbrowser"))}),Hooks.on("preCreateActiveEffect",function(o,e,t,a){if(o.parent.documentName!="Actor")return;let s={duration:{}};if(o.duration.startTime||(s.duration.startTime=game.time.worldTime),!game.combat){o.updateSource(s);return}s.duration.combat=game.combat.id,s.duration.startRound=game.combat.round,s.duration.startTurn=game.combat.turn,!o.duration.rounds&&o.duration.seconds&&(s.duration.rounds=o.duration.seconds/5),o.updateSource(s)})}m(qa,"setupScene");function Wa(){Hooks.once("setup",()=>{if(ja(),!["de"].includes(game.i18n.lang))console.warn(`DSK - ${game.i18n.lang} is not a supported language. Falling back to default language.`),ps();else{let o=game.settings.get("dsk","forceLanguage");["de"].includes(o)&&game.i18n.lang!=o&&us(o)}Ga(),qa(),De.initHook(),CONFIG.Canvas.lightAnimations.daylight={label:"dsk.LIGHT.daylight",illuminationShader:it},E.setupFunctions(),x.setupFunctions()})}m(Wa,"initSetup");var us=m(o=>{let e={title:game.i18n.localize("dsk.SETTINGS.forceLanguage"),content:game.i18n.format("dsk.DSKError.wrongLanguage",{lang:o}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async()=>{await game.settings.set("core","language",o),foundry.utils.debouncedReload()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}};new Dialog(e).render(!0)},"showWrongLanguageDialog"),fa=class extends Dialog{async close(e={}){if(!!["de"].includes(game.i18n.lang))return super.close(e)}};m(fa,"ForbiddenLanguageDialog");var ps=m(()=>{let o={title:game.i18n.localize("language"),content:"Your foundry language is not supported by this system. Due to technical reasons your foundry language setting has to be switched to german.",buttons:{de:{icon:'<i class="fa fa-check"></i>',label:"en",callback:async()=>{await game.settings.set("core","language","de"),foundry.utils.debouncedReload()}},logout:{icon:'<i class="fas fa-door-closed"></i>',label:game.i18n.localize("SETTINGS.Logout"),callback:async()=>{ui.menu.items.logout.onClick()}}}};new fa(o).render(!0)},"showForbiddenLanguageDialog"),je=class extends AdaptiveIlluminationShader{},it=je;m(it,"DaylightIlluminationShader"),z(it,"fragmentShader",`
    ${je.SHADER_HEADER}
    ${je.PERCEIVED_BRIGHTNESS}

    void main() {
        ${je.FRAGMENT_BEGIN}
        ${je.TRANSITION}
       
        // Darkness
        framebufferColor = max(framebufferColor, colorBackground);        
        // Elevation
        finalColor = mix(finalColor, max(finalColor, smoothstep( 0.1, 1.0, finalColor ) * 10.0), 1.0) * depth;        
        // Final
        gl_FragColor = vec4(finalColor, 1.0);
      }`);function Ka(){Hooks.on("renderSettings",(o,e,t)=>{let a=$(`<button id="reportADSKBug"><i class="fas fa-bug"></i> ${game.i18n.localize("dsk.DSKError.reportBug")}</button>`);a.click(()=>{window.open("https://github.com/Plushtoast/dsk-foundryVTT/issues","_blank")}),e.find("#settings-documentation").append(a),a=$('<button class="fshopButton"><div></div> F-Shop</button>'),a.click(()=>{window.open(game.i18n.localize("dsk.fshopLink"),"_blank")}),e.find("#settings-documentation").append(a);let s=game.system.title.split("/")[game.i18n.lang=="de"?0:1],i=e.find("#game-details .system .system-info").html();e.find("#game-details .system").html(`<span class="system-title">${s}</span><span class="system-info">${i}</span>`)}),Hooks.on("renderCompendiumDirectory",(o,e,t)=>{let a=$(`<button id="openLibrary"><i class="fas fa-university"></i>${game.i18n.localize("dsk.ItemLibrary")}</button>`);e.find(".header-actions").append(a),a.click(()=>{game.dsk.itemLibrary.render(!0)})}),Hooks.once("renderCompendiumDirectory",(o,e,t)=>{let a=game.i18n.lang=="de"?"en":"de",s=game.packs.filter(i=>getProperty(i.metadata,"flags.dsklang")==a);for(let i of s){let r=`${i.metadata.packageName}.${i.metadata.name}`;game.packs.delete(r),game.data.packs=game.data.packs.filter(n=>n.id!=r),e.find(`li[data-pack="${r}"]`).remove()}}),Hooks.on("renderActorDirectory",(o,e,t)=>{if(!game.user.isGM)for(let a of o.documents.filter(s=>s.isMerchant()&&getProperty(s,"system.merchant.hidePlayer")))e.find(`[data-document-id="${a.id}"]`).remove()})}m(Ka,"initSidebar");function Ua(){Hooks.on("deleteActiveEffect",(i,r)=>{if(!h.isActiveGM()||r.noHook)return;let n=i.parent;if(n&&n.documentName=="Actor"){let l=[...i.statuses][0];if(l=="bloodrush")return n.addCondition("stunned",4,!1,!1),!1;if(l=="dead"&&game.combat)return n.markDead(!1),!1;if(W.onEffectRemove(n,i),Hooks.call("deleteActorActiveEffect",n,i)===!1)return!1}}),Hooks.on("updateActor",(i,r)=>{!game.user.isGM&&i.limited&&hasProperty(r,"system.merchant.hidePlayer")&&ui.sidebar.render(!0)}),Hooks.on("dropActorSheetData",(i,r,n)=>{switch(n.data?.type){case"condition":return i.addCondition(n.data.payload.id,1,!1,!1),!1;case"lookup":return r._handleLookup(n.data),!1;case"fullpack":return r._addFullPack(n.data),!1}}),Hooks.on("createActiveEffect",(i,r,n)=>{!h.isActiveGM()||(o(i),e(i))}),Hooks.on("deleteActiveEffect",(i,r,n)=>{!h.isActiveGM()||o(i)}),Hooks.on("updateActiveEffect",(i,r,n)=>{!h.isActiveGM()||(o(i),t(i))});function o(i){if(!!game.user.isGM&&game.combat&&i.changes.some(r=>/(system\.stats\.ini|system\.characteristics.mu|system\.characteristics\.ge)/.test(r.key))){let r=i.parent.id,n=game.combat.combatants.find(l=>l.actor.id==r);n&&n.recalcInitiative()}}m(o,"checkIniChange");let e=m(async i=>{let r=i.parent;if(!r)return;await t(i,{},r);let n=[...i.statuses][0];n=="dead"&&game.combat?await r.markDead(!0):n=="unconscious"&&await r.addCondition("prone")},"createEffects"),t=m(async(i,r={},n)=>{if(n||(n=i.parent),!n||n.documentName!="Actor")return;let l=/^system\.condition\./;for(let c of i.changes||[])l.test(c.key)&&c.mode==2&&(r[c.key.split(".")[2]]=Number(c.value));for(let c of Object.keys(r))if(n.system.condition[c]>=8&&(c=="inpain"?await n.addCondition("incapacitated"):c=="stunned"?await n.addCondition("unconscious"):c=="feared"?await n.addCondition("panic"):c=="encumbered"&&await n.addCondition("fixated")),(Number(r.inpain)||0)>0&&!n.hasCondition("bloodrush")&&n.system.condition.inpain>0&&E.hasVantage(n,game.i18n.localize("dsk.LocalizedIDs.frenzy"))){await n.addCondition("bloodrush");let u=h.replaceConditions(`${game.i18n.format("dsk.CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+n.name+"</b>"})}`);ChatMessage.create(h.chatDataSetup(u))}},"countableDependentEffects"),a=m(async(i,r)=>{(game.dsk.apps.AskForNameDialog||ga).getDialog(i,r)},"askForName"),s=m(async(i,r)=>{if(!h.isActiveGM())return;let n=i.actor;if(n.hasPlayerOwner)return;let l=Number(game.settings.get("dsk","obfuscateTokenNames"));if(l==0||getProperty(n,"merchant.merchantType")=="loot")return;let c=canvas.scene.tokens.filter(d=>d.actor&&d.actor.id===n.id),u=game.i18n.localize("dsk.unknown");if([2,4].includes(l)){if(!(i.id||i._id))return;a(i,l);return}c.length>0&&l<3&&(u=`${c[0].name.replace(/ \d{1,}$/)} ${c.length+1}`),r.name=u},"obfuscateName");Hooks.on("preCreateToken",(i,r,n,l)=>{let c=i.actor;if(!c)return;let u={};getProperty(c,"system.merchant.merchantType")=="loot"?mergeObject(u,{displayBars:0}):getProperty(c,"system.config.autoBar")&&(mergeObject(u,{bar1:{attribute:"stats.LeP"}}),c.system.isMage?mergeObject(u,{bar2:{attribute:"stats.AeP"}}):mergeObject(u,{bar2:{attribute:"tbd"}})),getProperty(c,"system.config.autoSize")&&h.calcTokenSize(c,u),s(i,u),i.updateSource(u)}),Hooks.on("createToken",(i,r,n)=>{r.noHook||s(i,{})})}m(Ua,"initActorHooks");var ga=class extends Dialog{static async getDialog(e,t){new Dialog({title:game.i18n.localize("dsk.SETTINGS.obfuscateTokenNames"),content:`<label for="name">${game.i18n.localize("dsk.SETTINGS.rename")}</label> <input dtype="string" name="name" type="text" value="${e.actor.name}"/>`,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:async a=>{let s=e.id||e._id,i=a.find('[name="name"]').val();if(t==2){let n=canvas.scene.tokens.filter(l=>l.name===i);n.length>0&&(i=`${i.replace(/ \d{1,}$/)} ${n.length+1}`)}await canvas.scene.tokens.get(s).update({name:i})}},unknown:{icon:'<i class="fa fa-question"></i>',label:game.i18n.localize("dsk.unknown"),callback:async a=>{let s=e.id||e._id;await canvas.scene.tokens.get(s).update({name:game.i18n.localize("dsk.unknown")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}};m(ga,"AskForNameDialog");function Va(){Hooks.once("init",()=>{game.dsk.apps.DiceSoNiceCustomization=new me}),Hooks.once("diceSoNiceReady",(o,e,t,a)=>{o.addColorset({name:"mu",description:"DSK.mu",category:"DSK.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"kl",description:"DSK.kl",category:"DSK.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"in",description:"DSK.in",category:"DSK.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ch",description:"DSK.ch",category:"DSK.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ff",description:"DSK.ff",category:"DSK.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ge",description:"DSK.ge",category:"DSK.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ko",description:"DSK.ko",category:"DSK.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"kk",description:"DSK.kk",category:"DSK.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"attack",description:"DSK.attack",category:"DSK.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),game.dsk.apps.DiceSoNiceCustomization.initConfigs(),me.onConnect()})}m(Va,"initDSN");var be=class extends Application{initConfigs(){let e=game.dice3d.exports.Utils.prepareColorsetList();this.choices={};for(let[a,s]of Object.entries(e))mergeObject(this.choices,s);let t={damage:"black"};game.settings.registerMenu("dsk","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("dsk.SETTINGS.dicesonicesettings"),type:ha,restricted:!1});for(let a of be.attrs)game.settings.register("dsk",`dice3d_${a}`,{name:`CHAR.${a.toUpperCase()}`,scope:"client",config:!1,default:t[a]||a,type:String}),game.settings.register("dsk",`dice3d_system_${a}`,{name:`CHAR.${a.toUpperCase()}`,scope:"client",config:!1,default:"standard",type:String})}getAttributeConfiguration(e){return h.moduleEnabled("dice-so-nice")?{colorset:game.settings.get("dsk",`dice3d_${e}`),appearance:{colorset:game.settings.get("dsk",`dice3d_${e}`),system:game.settings.get("dsk",`dice3d_system_${e}`)}}:{colorset:e}}activateListeners(e){super.activateListeners(),e.find('[name="entryselection"]').change(async t=>{await game.settings.set("dsk",`dice3d_${t.currentTarget.dataset.attr}`,t.currentTarget.value)}),e.find('[name="systemselection"]').change(async t=>{await game.settings.set("dsk",`dice3d_system_${t.currentTarget.dataset.attr}`,t.currentTarget.value),be.preloadDiceAssets([t.currentTarget.value]),game.socket.emit("system.dsk",{type:"preloadDice3d",payload:{toPreload:[t.currentTarget.value]}})})}static onConnect(){game.socket.on("system.dsk",e=>{switch(e.type){case"preloadDice3d":console.warn("Preloading forced DSK dice assets"),be.preloadDiceAssets(e.payload);break;case"getPreloadDice3d":be.requestDicePreloads();break}}),this.collectPreloads(),game.socket.emit("system.dsk",{type:"getPreloadDice3d"})}static collectPreloads(e=!0){let t=new Set;for(let a of be.attrs)t.add(game.settings.get("dsk",`dice3d_system_${a}`));t=Array.from(t),e&&this.preloadDiceAssets(t),game.socket.emit("system.dsk",{type:"preloadDice3d",payload:t})}static requestDicePreloads(){this.collectPreloads(!1)}static async preloadDiceAssets(e,t=[]){console.warn("loading",e);for(let a of e){let s=game.dice3d.DiceFactory.systems[a];if(!s){this.unloadedModels.push(a);continue}let i=s.dice.filter(r=>t.length==0||t.includes(r.type));for(let r of i)try{r.modelFile?await r.loadModel(game.dice3d.DiceFactory.loaderGLTF):await r.loadTextures()}catch{console.warn("Unable to load dice model",a,r)}}this.unloadedModels.length&&this.retries<6&&!this.retrying&&(this.retrying=!0,setTimeout(()=>{this.retries+=1;let a=new Set(this.unloadedModels);this.unloadedModels=[],this.retrying=!1,this.preloadDiceAssets(a)},1e4))}async getData(e){let t=await super.getData(e);t.choices=this.choices,t.systems=game.dice3d.DiceFactory.systems,t.selections={};for(let a of be.attrs)t.selections[a]={color:game.settings.get("dsk",`dice3d_${a}`),system:game.settings.get("dsk",`dice3d_system_${a}`)};return t}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{template:"systems/dsk/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("dsk.SETTINGS.dicesonicesettings"),width:600}),e}},me=be;m(me,"DiceSoNiceCustomization"),z(me,"unloadedModels",[]),z(me,"retries",0),z(me,"retrying",!1),z(me,"attrs",["mu","kl","in","ch","ff","ge","ko","kk","attack","damage"]);var ha=class extends FormApplication{render(){game.dsk.apps.DiceSoNiceCustomization.render(!0)}};m(ha,"DiceSoNiceForm");function Ya(){Hooks.on("renderChatLog",(o,e,t)=>{_DiceDSK.chatListeners(e),P.chatListeners(e);let a=new G;Hooks.call("startDSKChatAutoCompletion",a),a.chatListeners(e),F.chatListeners(e)}),Hooks.on("renderChatMessage",(o,e,t)=>{if(game.user.isGM)e.find(".chat-button-player").remove();else{e.find(".chat-button-gm").remove();let a,s=e.find(".chat-button-target");s.length&&(a=ye.getTargetActor(t.message),a&&a.actor&&!a.actor.isOwner&&s.remove());let i=h.getSpeaker(t.message.speaker);i&&!i.isOwner&&(e.find(".selfButton").remove(),e.find(".d20").data("tooltip",""));let r=e.find(".onlyTarget");r.length&&(a=h.getSpeaker({token:r.attr("data-token"),actor:r.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}),a&&!a.isOwner&&r.remove()),e.find(".hideData").remove(),getProperty(t.message,`flags.dsk.userHidden.${game.user.id}`)&&e.find(".payButton").remove()}game.settings.get("dsk","expandChatModifierlist")&&(e.find(".expand-mods i").toggleClass("fa-minus fa-plus"),e.find(".expand-mods + ul").css({display:"block"})),O.bindButtons(e)}),Hooks.on("chatMessage",(o,e,t)=>{let a=e.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(a=a?a[0]:"",a){case"/pay":return game.user.isGM?P.createPayChatMessage(e):P.payMoney(h.getSpeaker(t.speaker),e),!1;case"/getPaid":return game.user.isGM?P.createGetPaidChatMessage(e):P.getMoney(h.getSpeaker(t.speaker),e),!1;case"/help":return F.getHelp(),!1;case"/conditions":return F.showConditions(),!1;case"/tables":return F.showTables(),!1}})}m(Ya,"initChatlogHooks");function Ja(){Token.prototype.drawEffects=async function(){this.effects.removeChildren().forEach(i=>i.destroy()),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.overlay=null;let t=this.document.effects,a=this.actor?await this.actor.actorEffects():[],s={src:this.document.overlayEffect,tint:null};if(t.length||a.length){let i=[];for(let r of a){if(!r.icon)continue;let n=Color.from(r.tint??null);if(r.getFlag("core","overlay")){s={src:r.icon,tint:n};continue}i.push(this._drawEffect(r.icon,n,getProperty(r,"flags.dsk.value")))}for(let r of t)i.push(this._drawEffect(r,null));await Promise.all(i)}this.effects.overlay=await this._drawOverlay(s.src,s.tint),this._refreshEffects()},Token.prototype._refreshEffects=function(){let t=0,a=Math.round(canvas.dimensions.size/2/5)*2,s=Math.floor(this.document.height*5),i=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0);for(let r of this.effects.children)if(r!==i&&!r.isCounter)if(r===this.effects.overlay){let n=Math.min(this.w*.6,this.h*.6);r.width=r.height=n,r.position.set((this.w-n)/2,(this.h-n)/2)}else{if(r.width=r.height=a,r.x=Math.floor(t/s)*a,r.y=t%s*a,i.drawRoundedRect(r.x+1,r.y+1,a-2,a-2,2),r.counter>1&&!r.counterDrawn){let n=game.dsk.config.effectTextStyle,l=game.settings.get("dsk","statusEffectCounterColor");n._fill=/^#[0-9A-F]+$/.test(l)?l:"#000000";let c=this.effects.addChild(new PreciseText(r.counter,n));c.x=r.x,c.y=r.y,c.isCounter=!0,r.counterDrawn=!0}t++}},Token.prototype._drawEffect=async function(t,a,s){if(!t)return;let i=await loadTexture(t,{fallback:"icons/svg/hazard.svg"}),r=new PIXI.Sprite(i);return a&&(r.tint=a),r.counter=s,this.effects.addChild(r)},TokenHUD.prototype._onToggleEffect=function(t,{overlay:a=!1}={}){t.preventDefault();let s=t.currentTarget,i=s.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find(r=>r.id===s.dataset.statusId):s.getAttribute("src");if(!!i.flags.dsk.editable){if(t.button==0)return this.object.incrementCondition(i);if(t.button==2)return this.object.decrementCondition(i)}},Token.prototype.incrementCondition=async function(t,{active:a,overlay:s=!1}={}){let i=this.actor.effects.find(r=>r.statuses.has(t.id));return!i||Number.isNumeric(getProperty(i,"flags.dsk.value"))?await this.actor.addCondition(t.id,1,!1,!1):i&&await this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),a},Token.prototype.decrementCondition=async function(t,{active:a,overlay:s=!1}={}){return this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),a};let o=Token.prototype._onClickLeft2,e=m(t=>t?["merchant","loot"].includes(getProperty(t.system,"merchant.merchantType")):!1,"isMerchant");Token.prototype._onClickLeft2=function(t){if(!(game.user.isGM||!game.settings.get("dsk","enableDPS")||!e(this.actor)||U.inDistance(this)))return ui.notifications.warn(game.i18n.localize("dsk.DSKError.notInRangeToLoot"));o.call(this,t)}}m(Ja,"initTokenHook");function Za(){Hooks.on("renderTokenHUD",(o,e,t)=>{let a=o.object.actor;a&&game.dsk.apps.LightDialog&&game.dsk.apps.LightDialog.lightHud(e,a,t),e.find('.control-icon[data-action="target"]').mousedown(s=>{s.button==2&&(game.user.updateTokenTargets([]),$(s.currentTarget).click(),s.preventDefault())}),e.find(".attribute input").off("change")})}m(Za,"initTokenHUD");function Xa(){Roll.prototype.editRollAtIndex=function(o){let e=[];for(let t of o){let{index:a,val:s}=t,i=0;for(let r of this.terms){let n=r instanceof DiceTerm||r.class=="DiceTerm"||r instanceof Die||r.class=="Die",l=r instanceof OperatorTerm;if(n||r.faces){if(r.results[a-i]){let c=r.results[a-i].result;r.results[a-i].result=s,e.push(c)}n||(r.total=r.results.reduce((c,u)=>c+u.result,0)),i+=r.results.length}else!l&&(r.class=="OperatorTerm"||r.operator)&&(r.total=r.operator)}e.push(0)}return this._total=this._evaluateTotal(),e}}m(Xa,"initRollsFunction");var Be=class extends Fe(re){static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/creature-merchant-sheet.html"}};m(Be,"CreatureMerchantSheetDSK");var Ge=class extends Fe(te){static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/character-merchant-sheet.html"}};m(Ge,"CharacterMerchantSheetDSK");function Qa(){let o=m((g,y)=>h.fateAvailable(g,y),"fateAvailable"),e=m(function(g){let y=game.messages.get(g.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&g.find(".opposed-card").length||g.find(".dice-roll").length)&&(getProperty(y,"damage.value")||0)>0},"canHurt"),t=m(function(g){let y=game.messages.get(g.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&g.find(".opposed-card").length||g.find(".dice-roll").length)&&(getProperty(y,"damage.sp")||0)>0},"canHurtSP"),a=m(function(g){let y=game.messages.get(g.attr("data-message-id"));return y.speaker.actor&&y.flags.data&&(game.actors.get(y.speaker.actor).isOwner||game.user.isGM)?["ahnengabe"].includes(y.flags.data.preData.source.type)||getProperty(y.flags.data.preData,"calculatedSpellModifiers.costsMana"):!1},"canCostMana"),s=m(function(g){if(game.user.isGM&&game.settings.get("dsk","hideOpposedDamage")){let y=game.messages.get(g.attr("data-message-id"));return"hideData"in y.flags&&y.flags.hideData}return!1},"canUnhideData"),i=m(function(g){if(game.user.isGM&&game.settings.get("dsk","hideOpposedDamage")){let y=game.messages.get(g.attr("data-message-id"));return"hideData"in y.flags&&!y.flags.hideData}return!1},"canHideData"),r=m(function(g){let y=game.messages.get(g.attr("data-message-id"));if(y.speaker.actor&&y.flags.data){let v=game.actors.get(y.speaker.actor);if(v.isOwner)return v.items.find(k=>k.name==`${game.i18n.localize("dsk.LocalizedIDs.aptitude")} (${y.flags.data.preData.source.name})`)!=null&&!y.flags.data.talentedRerollUsed}return!1},"isTalented"),n=m(function(g,y=!1){let v=game.messages.get(g.attr("data-message-id"));if(v.speaker.actor&&v.flags.data){let k=game.actors.get(v.speaker.actor);if(k.isOwner&&o(k,y))return v.flags.data.postData.damageRoll!=null&&!v.flags.data.fatePointDamageRerollUsed}return!1},"canRerollDamage"),l=m(function(g,y=!1){let v=game.messages.get(g.attr("data-message-id"));if(v.speaker.actor&&v.flags.data){let k=game.actors.get(v.speaker.actor);if(k.isOwner&&o(k,y))return!v.flags.data.fatePointRerollUsed&&v.flags.data.postData.rollType!="regenerate"}return!1},"canReroll"),c=m(function(g){let y=game.messages.get(g.attr("data-message-id"));return y.speaker.actor&&y.flags.data&&game.actors.get(y.speaker.actor).isOwner&&["LeP","AeP"].some(k=>getProperty(y.flags,`data.postData.${k}`)!=null)?!y.flags.data.healApplied:!1},"canHeal"),u=m(function(g){if(game.user.isGM){let y=game.messages.get(g.attr("data-message-id"));if("hideData"in y.flags){let v=!y.flags.hideData,k=$(y.content);k.find(".hideAnchor")[v?"addClass":"removeClass"]("hideData"),k=$("<div></div>").append(k),y.update({content:k.html(),"flags.hideData":v})}}},"showHideData"),d=m(g=>{let y=game.messages.get(g.data("messageId"));return!y||!canvas.tokens?!1:y.isRoll&&y.isContentVisible&&canvas.tokens.controlled.length&&g.find(".dice-roll").length},"canApplyDefaultRolls"),p=m((g,y,v=0)=>{let k=game.messages.get(g.attr("data-message-id"));game.actors.get(k.speaker.actor).useFateOnRoll(k,y,v)},"useFate"),f=m(async(g,y)=>{let v=game.messages.get(g.attr("data-message-id")),k=v.flags.opposeData,I=k.speakerDefend.speaker,H=h.getSpeaker(I);if(!H.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));await H.applyDamage(k.damage[y]),await v.update({"flags.data.damageApplied":!0,content:v.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${game.i18n.localize("damageApplied")}"></i>`)})},"applyDamage"),b=m((g,y)=>{let k=game.messages.get(g.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map(I=>{let H=I.actor,S=y!="sp"?k.total-D.armorValue(H).armor:k.total;return H.applyDamage(Math.max(0,S))}))},"applyChatCardDamage"),T=m(async g=>{let y=game.messages.get(g.attr("data-message-id")),v=y.flags.data,k=h.getSpeaker(y.speaker);if(!k.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));let I=["ritual","spell"].includes(v.preData.source.type)||getProperty(v.preData.calculatedSpellModifiers,"costsMana")?"AeP":"KaP",H=await k.applyMana(v.preData.calculatedSpellModifiers.finalcost,I);await y.update({"flags.data.manaApplied":!0,content:y.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')})},"payMana");Hooks.on("getChatLogEntryContext",(g,y)=>{y.push({name:game.i18n.localize("dsk.CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:i,callback:v=>{u(v)}},{name:game.i18n.localize("dsk.CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:s,callback:v=>{u(v)}},{name:game.i18n.localize("dsk.regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:c,callback:async v=>{let k=await game.messages.get(v.attr("data-message-id")),I=h.getSpeaker(k.speaker);if(!I.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));await k.update({"flags.data.healApplied":!0,content:k.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')}),await I.applyRegeneration(k.flags.data.postData.LeP,k.flags.data.postData.AeP,k.flags.data.postData.KaP)}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:a,callback:async v=>{T(v)}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:e,callback:v=>{f(v,"value")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:t,callback:v=>{f(v,"sp")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:d,callback:v=>{b(v,"value")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:d,callback:v=>{b(v,"sp")}},{name:game.i18n.localize("dsk.CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:l,callback:v=>{p(v,"reroll")}},{name:game.i18n.localize("dsk.CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:r,callback:v=>{p(v,"isTalented")}},{name:game.i18n.localize("dsk.CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:n,callback:v=>{p(v,"rerollDamage")}})})}m(Qa,"initChatContext");var ya=class extends ControlIcon{async draw(){return this.bg.clear(),await super.draw()}};m(ya,"TransparentControlIcon");var es=m(()=>{Note.prototype._drawControlIcon=function(){let o=this.document.getFlag("dsk","noBG"),e=Color.from(this.document.texture.tint||null),t={texture:this.document.texture.src,size:this.size,tint:e},a=o?new ya(t):new ControlIcon(t);return a.x-=this.size/2,a.y-=this.size/2,a}},"initHook");function ts(){_a(),Pa(),La(),Ka(),Ua(),Va(),Ya(),Ja(),Za(),Xa(),wa(),Qa(),Hooks.once("init",()=>{loadTemplates(["systems/dsk/templates/items/item-equipment.html","systems/dsk/templates/items/item-header.html","systems/dsk/templates/items/item-description.html","systems/dsk/templates/items/item-effects.html","systems/dsk/templates/items/item-stat.html","systems/dsk/templates/actors/parts/healthbar.html","systems/dsk/templates/actors/actor-talents.html","systems/dsk/templates/actors/actor-combat.html","systems/dsk/templates/actors/actor-equipment.html","systems/dsk/templates/actors/parts/gearSearch.html","systems/dsk/templates/actors/parts/purse.html","systems/dsk/templates/actors/parts/characteristics-small.html","systems/dsk/templates/actors/parts/status_effects.html","systems/dsk/templates/actors/parts/containerContent.html","systems/dsk/templates/actors/actor-notes.html","systems/dsk/templates/actors/creature/creature-combat.html","systems/dsk/templates/actors/creature/creature-main.html","systems/dsk/templates/actors/creature/creature-magic.html","systems/dsk/templates/status/advanced_functions.html","systems/dsk/templates/actors/creature/creature-loot.html","systems/dsk/templates/dialog/default-dialog.html","systems/dsk/templates/actors/character/actor-magic.html","systems/dsk/templates/actors/parts/characteristics-large.html","systems/dsk/templates/actors/npc/npc-main.html","systems/dsk/templates/actors/parts/rollhead.html","systems/dsk/templates/actors/actor-main.html","systems/dsk/templates/chat/roll/test-card.html","systems/dsk/templates/dialog/parts/targets.html","systems/dsk/templates/dialog/default-combat-dialog.html","systems/dsk/templates/actors/creature/creature-notes.html","systems/dsk/templates/dialog/enhanced-default-dialog.html","systems/dsk/templates/actors/parts/information.html","systems/dsk/templates/actors/merchant/merchant-commerce.html","systems/dsk/templates/actors/parts/normalhead.html"])}),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsk",te,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsk",re,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsk",ne,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsk",de,{types:["npc"]}),Actors.registerSheet("dsk",Be,{types:["creature"]}),Actors.registerSheet("dsk",Ge,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsk",W,{makeDefault:!0}),Journal.registerSheet("dsk",Ne,{makeDefault:!0}),R.setupSheets(),Ha(),Wa(),es(),U.initDoorMinDistance()}m(ts,"initHooks");var as={};Hooks.once("ready",()=>{Promise.all([h.allSkillsList()]).then(o=>{let e=o[0].skills.reduce((i,r)=>({...i,[r]:r}),{}),t=o[0].rangeSkills.reduce((i,r)=>({...i,[r]:r}),{}),a=o[0].meleeSkills.reduce((i,r)=>({...i,[r]:r}),{}),s=o[0].rangeSkills.concat(o[0].meleeSkills).reduce((i,r)=>({...i,[r]:r}),{});mergeObject(as,{ammunition:[{label:"dsk.ammunitionType",attr:"ammunitionType",type:"select",options:w.ammunitiongroups}],equipment:[{label:"dsk.category",attr:"category",type:"select",options:w.equipmentTypes}],rangeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill",type:"select",options:t},{label:"dsk.ammunitionType",attr:"ammunitionType",type:"select",options:w.ammunitiongroups}],meleeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill",type:"select",options:a},{label:"dsk.range",attr:"rw",type:"select",options:w.meleeRanges}],poison:[{label:"dsk.resistanceModifier",attr:"resist",type:"select",options:w.magicResistanceModifiers}],trait:[],profession:[],specialability:[{label:"dsk.category",attr:"category",type:"select",options:w.specialAbilityCategories},{label:"TYPES.Item.combatskill",attr:"subcategory",type:"select",options:s,notStrict:!0}],ahnengabe:[{label:"dsk.resistanceModifier",attr:"resist",type:"select",options:w.magicResistanceModifiers},{label:"dsk.targetCategory",attr:"targetCategory",type:"text"},{label:"dsk.distribution",attr:"distribution",type:"text"}],ahnengeschenk:[],npc:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"TYPES.Item.profession",attr:"details.profession",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture",type:"text"}],character:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"TYPES.Item.profession",attr:"details.profession",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture",type:"text"}],creature:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"dsk.sizeCategory",attr:"details.size",type:"select",options:w.sizeCategories}],armor:[{label:"dsk.protection",attr:"rs",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}}]})})});var ka=as;var qe=class{constructor(e,t={}){let a=e.documentName||e.type;switch(e.documentName){case"Actor":case"Item":a=e.type;break}let s="";if(game.settings.get("dsk","indexDescription"))switch(a){case"creature":case"npc":case"character":s=getProperty(e,"system.description.value");break;case"JournalEntry":s=getProperty(e,"system.content");break;default:s=getProperty(e,"description.value")}this.document={name:e.name,filterType:a,data:$("<div>").html(s).text(),id:e.id||e._id,visible:e.visible?e.visible:!0,compendium:e.compendium?e.compendium.metadata.packageName:t.packageName||"",pack:e.pack||(t.packageName?t.id:void 0),img:e.img}}get uuid(){if(this.document.compendium)return`Compendium.${this.document.pack}.${this.document.id}`;switch(this.itemType){case"character":case"creature":case"npc":return`Actor.${this.id}`;case"JournalEntry":return`JournalEntry.${this.id}`;default:return`Item.${this.id}`}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}get itemType(){return this.document.filterType}async getItem(){return await fromUuid(this.uuid)}hasPermission(){return this.document.visible}async render(){(await this.getItem()).sheet.render(!0)}get compendium(){return this.document.compendium}get img(){return this.itemType=="JournalEntry"?"systems/dsk/icons/categories/DSK-Auge.webp":this.document.img}};m(qe,"SearchDocument");var rt=class extends qe{constructor(e,t){super(e);let a=ka[t]||[];for(let s of a)this[s.attr]=s.attr.split(".").reduce((i,r)=>i[r]===void 0?{}:i[r],e.system)}};m(rt,"AdvancedSearchDocument");var We=class extends Application{constructor(e){super(e),this.advancedFiltering=!1,this.journalBuild=!1,this.journalWorldBuild=!1,this.equipmentBuild=!1,this.equipmentWorldBuild,this.zooBuild=!1,this.zooWorldBuild=!1,this.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),this.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.detailFilter={},this.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},this.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1},filterBy:{search:""}},character:{categories:{profession:!1,advantage:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1},filterBy:{search:""}},spell:{categories:{ahnengabe:!1,ahnengeschenk:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}}}async getData(e){let t=await super.getData(e);return t.categories=this.translateFilters(),t.isGM=game.user.isGM,t.items=this.items,t.advancedMode=this.advancedFiltering?"on":"",t.worldIndexed=game.settings.get("dsk","indexWorldItems")?"on":"",t.fullTextEnabled=game.settings.get("dsk","indexDescription")?"on":"",this.advancedFiltering&&(t.advancedFilter=await this.buildDetailFilter("tbd",this.subcategory)),t}translateFilters(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo),journal:this.buildFilter(this.filters.journal)}}purgeAdvancedFilters(){for(let e in this.filters)for(let t in this.filters[e].categories)this.filters[e].categories[t]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then(e=>{$(this._element).find(".advancedSearch .groupbox").html(e)})}buildFilter(e){let t=[];return Object.keys(e.categories).forEach(function(a){t.push({label:game.i18n.localize(`TYPES.Item.${a}`),selected:e.categories[a],key:a})}),t=t.sort(function(a,s){return a.label.localeCompare(s.label)}),t}static get defaultOptions(){let e=super.defaultOptions;return e.id="DSKItemLibrary",e.classes.push("dsk","itemlibrary"),e.height=800,e.width=800,e.resizable=!0,e.title=game.i18n.localize("dsk.ItemLibrary"),e.template="systems/dsk/templates/system/itemlibrary.html",e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],e}async getRandomItems(e,t){let a=[],s=this.equipmentIndex;return a.push(...await s.search(e,{field:["itemType"]})),(await Promise.all(this.shuffle(a.filter(i=>i.hasPermission)).slice(0,t+5).map(i=>i.getItem()))).filter(i=>{let r=i.getFlag("dsk","enchantments");return!r||!r.find(n=>n.talisman)}).slice(0,t)}shuffle(e){let t=e.length,a,s;for(;t!==0;)s=Math.floor(Math.random()*t),t-=1,a=e[t],e[t]=e[s],e[s]=a;return e}async findCompendiumItem(e,t,a=!0){this.equipmentBuild||await this.buildEquipmentIndex();let s={field:["name"],where:{itemType:t}},i=await this.equipmentIndex.search(e,s);return a&&(i=i.filter(r=>r.compendium!="")),await Promise.all(i.map(r=>r.getItem()))}async getCategoryItems(e,t=!1){return await this.buildEquipmentIndex(),t?(await Promise.all(this.equipmentIndex.search(e,{field:["itemType"]}).map(a=>a.getItem()))).map(a=>a.toObject()):this.equipmentIndex.search(e,{field:["itemType"]})}async executeAdvancedFilter(e,t,a,s,i,r=[]){let n=m(f=>{for(let b of a)if(b[2]?f[b[0]]!=b[1]:f[b[0]].indexOf(b[1])==-1)return!1;return!0},"selFnct"),l=m(f=>{for(let b of s)if(f[b[0]].toLowerCase().indexOf(b[1])==-1)return!1;return!0},"txtFnct"),c=m(f=>{for(let b of i)if(f[b[0]]!=b[1])return!1;return!0},"cbFnct"),u=m(f=>{for(let b of r)if(f[b[0]]<b[1]||f[b[0]]>b[2])return!1;return!0},"rangeFct"),p=t.where(f=>(e==""||f.name.toLowerCase().indexOf(e)!=-1)&&n(f)&&l(f)&&c(f)&&u(f));return p=p.filter(f=>f.hasPermission).sort((f,b)=>f.name.toLowerCase()>b.name.toLowerCase()?1:-1),p}async advancedFilterStuff(e,t){let a=$(this._element).find(".detailFilters"),s=a.attr("data-subc"),i=this.filters[e].filterBy.search.toLowerCase(),r=this.detailFilter[s],n=[],l=[],c=[];for(let d of a.find("select")){let p=$(d).val();p!=""&&n.push([$(d).attr("name"),p,d.dataset.notstrict!="true"])}for(let d of a.find('input[type="text"]:not(.manualFilter)')){let p=$(d).val();p!=""&&l.push([$(d).attr("name"),p.toLowerCase()])}for(let d of a.find('input[type="checkbox"]:checked:not(.manualFilter)')){let p=$(d).val();p!=""&&c.push([$(d).attr("name"),p.toLowerCase()])}let u=await this.executeAdvancedFilter(i,r,n,l,c);return this.setBGImage(u,e),u}async filterStuff(e,t,a){let s=this.filters[e].filterBy.search,i={field:["name","data"]},r=[],n=!1;for(let l in this.filters[e].categories){if(this.filters[e].categories[l]){let c,u=null;s==""?c=t.search(l,{field:["itemType"],sort:"name",where:{itemType:l}}):c=t.search(s,{...i,sort:"name",where:{itemType:l}});let d=Number(a)||0;c=c.slice(d,Math.min(d+60,c.length)),c.length==60&&(u=`${d+60}`),this.pages[e].next=u,r.push(...c)}n=this.filters[e].categories[l]||n}return n||(r=t.search(s,{...i,limit:60,page:a||!0,sort:"name"}),this.pages[e].next=r.next),r=r.result?r.result:r,r=r.filter(l=>l.hasPermission),this.setBGImage(r,e),r}setBGImage(e,t){$(this._element).find(`.${t} .libcontainer`)[`${e.length>0?"remove":"add"}Class`]("libraryImg")}renderResult(e,t,{index:a,itemType:s},i){let r=e.find(".searchResult .item-list");renderTemplate("systems/dsk/templates/system/libraryItem.html",{items:t}).then(n=>{i||r.empty(),n=$(n),n.each(function(){let l=$(this);l.attr("draggable",!0).on("dragstart",c=>{let u=a.find($(l).attr("data-item-id"));c.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:s,uuid:u.uuid}))})}),r.append(n)})}async filterItems(e,t,a){let s=this.selectIndex(t);if(this.advancedFiltering&&t!="journal"){let i=await this.advancedFilterStuff(t,a);return this.renderResult(e,i,s,a),i}else{let i=await this.filterStuff(t,s.index,a);return this.renderResult(e,i,s,a),i}}selectIndex(e){let t="Item",a=this.equipmentIndex;switch(e){case"zoo":t="Actor",a=this.zooIndex;break;case"journal":t="JournalEntry",a=this.journalIndex;break}return{index:a,itemType:t}}async _render(e=!1,t={}){await super._render(e,t),this.buildEquipmentIndex()}async buildEquipmentIndex(){await this._createIndex("equipment","Item",game.items)}async _createIndex(e,t,a){if(this[`${e}Build`])return;SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:""}),pct:0});let s=$(this._element).find(`*[data-tab="${e}"]`);this.showLoading(s,e);let i=game.packs.filter(p=>p.documentName==t&&(game.user.isGM||!p.visible)),r=100/(i.length+1),n=r,l=["name","system.type","system.description.value","img"],c;t=="Actor"?c=m(p=>p.getIndex({actorFields:l}),"func"):t=="JournalEntry"?c=m(p=>p.getDocuments(),"func"):c=m(p=>p.getDocuments({type__in:game.system.documentTypes.Item}),"func");let u=this.indexWorldItems(a,e);SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:"world items"}),pct:Math.round(r)});let d=i.map(async p=>{let f=await c(p);n+=r,SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:`${p.metadata.label} (${p.metadata.id})`}),pct:Math.round(n)}),u.push(...f.map(b=>new qe(b,p.metadata)))});return Promise.all(d).then(p=>{this[`${e}Index`].add(u),this[`${e}Build`]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:""}),pct:100}),this.hideLoading(s,e)})}subcategoryFields(e){let t=["name","itemType"],a=ka[e]||[];for(let s of a)t.push(s.attr);return t}indexWorldItems(e,t){let a=[];return game.settings.get("dsk","indexWorldItems")&&(a.push(...e.filter(s=>s.visible).map(s=>new qe(s))),this[`${t}WorldBuild`]=!0),a}async createDetailIndex(e,t){if(!this.detailFilter[t]){let a=this.subcategoryFields(t),s=$(this._element).find(`*[data-tab="${e}"]`);s.find(".searchResult ul").html(""),this.showLoading(s,e),this.detailFilter[t]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:a}});let{index:i,itemType:r}=this.selectIndex(e),l=(r=="Item"?game.items:game.actors).filter(f=>f.visible&&f.type==t).map(f=>new rt(f,t)),c=i.search(t,{field:["itemType"]}),u={};for(let f of c)!f.document.pack||(u[f.document.pack]||(u[f.document.pack]=[]),u[f.document.pack].push(f.document.id));let d=[];for(let f of Object.entries(u))d.push(game.packs.get(f[0]).getDocuments({_id__in:f[1],type:t}));let p=await Promise.all(d);for(let f of p)l.push(...f.map(b=>new rt(b,t)));this.detailFilter[t].add(l),this.hideLoading(s,e)}}async buildDetailFilter(e,t){let a=ka[t]||[];if(a){let s=this.createDetailIndex(e,t),i=await renderTemplate("systems/dsk/templates/system/detailFilter.html",{fields:a,subcategory:t});return await s,i}else return`<p>${game.i18n.localize("dsk.Library.selectAdvanced")}</p>`}checkWorldStuffIndex(){game.settings.get("dsk","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}activateListeners(e){super.activateListeners(e),e.on("click",".toggleAdvancedMode",()=>{this.advancedFiltering=!this.advancedFiltering,this.advancedFiltering?($(this._element).find(".toggleAdvancedMode").addClass("on"),$(this._element).find(".advancedSearch").fadeIn(),this.purgeAdvancedFilters()):($(this._element).find(".toggleAdvancedMode").removeClass("on"),$(this._element).find(".advancedSearch").fadeOut())}),e.on("change",".detailFilters input, .detailFilters select",()=>{let a=$(this._element).find(".tab.active"),s=a.attr("data-tab");this.filterItems(a,s)}),e.on("click",".filter",async a=>{let s=$(a.currentTarget).closest(".tab"),i=s.attr("data-tab"),r=$(a.currentTarget).attr("data-category"),n=$(a.currentTarget).is(":checked");this.advancedFiltering&&n&&(this.purgeAdvancedFilters(),this.subcategory=r,$(a.currentTarget).prop("checked",n),$(this._element).find(".advancedSearch .groupbox").html(await this.buildDetailFilter(i,r))),this.filters[i].categories[r]=n,this.filterItems(s,i)}),e.on("click",".item-name",a=>{this.getItemFromHTML(a).render()}),e.on("mousedown",".item-name",a=>{a.button==2&&h.showArtwork(this.getItemFromHTML(a))}),e.on("keyup",".filterBy-search",a=>{let s=$(a.currentTarget).closest(".tab"),i=s.attr("data-tab");this.filters[i].filterBy.search=$(a.currentTarget).val(),this.filterItems(s,i)}),e.find('*[data-tab="journal"]').click(a=>{this._createIndex("journal","JournalEntry",game.journal)}),e.find('*[data-tab="zoo"]').click(a=>{this._createIndex("zoo","Actor",game.actors)}),e.find(".showDetails").click(a=>{let s=$(a.currentTarget).attr("data-btn");$(a.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),e.find(`.${s} .detailBox`).toggleClass("dskhidden")}),e.find(".toggleWorldIndex").click(a=>{game.settings.set("dsk","indexWorldItems",!game.settings.get("dsk","indexWorldItems")),this.checkWorldStuffIndex(),$(a.currentTarget).toggleClass("on")}),e.find(".fulltextsearch").click(a=>{game.settings.set("dsk","indexDescription",!game.settings.get("dsk","indexDescription")),$(a.currentTarget).toggleClass("on")});let t=this;$(this._element).find(".window-content").on("scroll.infinit",debounce(function(a){if(t.advancedFiltering)return;let s=$(a.target),i=s.scrollTop()+s.innerHeight()>=s[0].scrollHeight-100,r=e.find(".tabs .item.active").attr("data-tab");if(i&&t.pages[r].next){let n=e.find(".tab.active");t.filterItems.call(t,n,r,t.pages[r].next)}},100))}getItemFromHTML(e){let t=$(e.currentTarget).parents(".browser-item").attr("data-item-id");switch($(e.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(t);case"journal":return this.journalIndex.find(t);default:return this.equipmentIndex.find(t)}}showLoading(e,t){this.setBGImage([1],t),$(`<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>${game.i18n.localize("dsk.Library.buildingIndex")}</div>`).appendTo(e.find(".searchResult"))}hideLoading(e,t){this.setBGImage([],t),e.find(".loader").remove()}};m(We,"DSKItemLibrary");var ba=class extends ActiveEffect{apply(e,t){if(ba.itemChangeRegex.test(t.key)){let a=this._getModifiedItems(e,t);for(let s of a.items){let i=foundry.utils.flattenObject(s.overrides||{});i[a.key]=Number.isNumeric(s.value)?Number(a.value):a.value;let r={...t,key:a.key,value:a.value};super.apply(s,r),s.overrides=foundry.utils.expandObject(i)}}else return super.apply(e,t)}_getModifiedItems(e,t){let a=t.key.split("."),s=a.shift();s=s.replace("@","").toLowerCase();let i=a.shift(),r=a.join("."),n=t.value;return{items:e?.items?.filter(c=>c.type==s&&(c.name==i||c.id==i))||[],key:r,value:n}}static async _onCreateDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await D.postUpdateConditions(a.parent);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await D.postUpdateConditions(a.parent);return super._onUpdateDocuments(e,t)}static async _onDeleteDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await D.postUpdateConditions(a.parent);return super._onDeleteDocuments(e,t)}async _preUpdate(e,t,a){super._preUpdate(e,t,a),this._clearModifiedItems()}_clearModifiedItems(){if(this.parent instanceof CONFIG.Actor.documentClass){for(let e of this.changes)if(ba.itemChangeRegex.test(e.key)){let t=this._getModifiedItems(this.parent,e);for(let a of t.items){let s=foundry.utils.flattenObject(a.overrides||{}),i=t.key;delete s[i];let r=getProperty(a._source,i);setProperty(a,i,r),a.overrides=foundry.utils.expandObject(s),a.sheet?.rendered&&a.sheet.render(!0)}}}}async _preDelete(e,t){super._preDelete(e,t),this._clearModifiedItems()}},we=ba;m(we,"DSKActiveEffect"),z(we,"itemChangeRegex",/^@/);var fs=m((o,e)=>{let t=getProperty(o,e.key)||null;t==null&&/^system\.(vulnerabilities|resistances)/.test(e.key)&&(t=[],setProperty(o,e.key,t));let a=getType(t),s=null;switch(a){case"Array":let i=[],r=e.effect.name;for(let n of`${e.value}`.split(/[;,]+/)){let l=n.split(" "),c=l.pop(),u=l.join(" ");i.push({source:r,value:c,target:u})}s=t.concat(i)}return s!==null&&setProperty(o,e.key,s),s},"applyCustomEffect");Hooks.on("applyActiveEffect",(o,e)=>fs(o,e));var Ke=class extends Hotbar{async collapse(){return this._collapsed?!0:($(this.element).addClass("collapsedHotbar"),super.collapse())}async expand(){return this._collapsed?($(this.element).removeClass("collapsedHotbar"),super.expand()):!0}};m(Ke,"DSKHotbar");var Ue=class extends Dialog{constructor(e,t,a,s=""){let i={title:e,content:t,buttons:{initialize:{label:game.i18n.localize("dsk.initialize"),callback:async()=>{this.lock||await this.initialize()}},cancel:{label:game.i18n.localize("dsk.cancel"),callback:async()=>{this.lock||await this.dontInitialize()}}}};super(i),this.module=a,this.lang=s,this.folders={},this.journals={},this.scenes={},this.actors={},this.lock=!1}async initialize(){this.lock=!0;let e=$(this._element).find(".initialize");e.prepend('<i class="fas fa-spinner fa-spin"></i>');let t={};try{game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0)}catch{}try{await fetch(`modules/${this.module}/adventure${this.lang}.json`).then(async a=>a.json()).then(async a=>{t=a})}catch{try{await fetch(`modules/${this.module}/adventure.json`).then(async a=>a.json()).then(async a=>{t=a})}catch{console.warn(`Could not find book data for ${this.module} import.`)}}await fetch(`modules/${this.module}/initialization${this.lang}.json`).then(async a=>a.json()).then(async a=>{let s=a.folders;if(s){let i=await this.getFolderForType("JournalEntry"),r=a.folders[0].name;i&&(this.folders[i.data.name]=i,a.folders.shift());let n=await Folder.create(s);Array.isArray(n)||(n=[n]);for(let c of n)this.folders[c.data.name]=c;let l=[];for(let c in this.folders){let u=this.folders[c].getFlag("dsk","parent"),d=u==r?game.i18n.localize(`${this.module}.name`):u;d&&l.push({_id:this.folders[c].id,parent:this.folders[d].id})}await Folder.updateDocuments(l)}if(a.items){let i=await this.getFolderForType("Item"),r=[],n=[];for(let l of a.items){l.folder=i.id;let c=game.items.find(u=>u.name==l.name&&u.folder?.id==i.id);c?(l._id=c.id,n.push(l)):r.push(l)}await C.create(r),await C.updateDocuments(n)}if(a.playlists){let i=await this.getFolderForType("Playlist"),r=[],n=[],c=(await game.packs.get(a.playlists).getDocuments()).map(u=>u.toObject());for(let u of c){u.folder=i.id;let d=game.playlists.find(p=>p.name==u.name&&p.folder?.id==i.id);d?(u._id=d._id,n.push(u)):r.push(u)}await Playlist.create(r,{keepId:!0}),await Playlist.updateDocuments(n)}if(a.scenes){let i=await this.getFolderForType("Scene"),n=(await game.packs.get(a.scenes).getDocuments()).map(g=>g.toObject()),c=(await game.packs.get(a.journal).getDocuments()).map(g=>g.toObject()),u=await this.getFolderForType("JournalEntry"),d=[],p=[],f=new Map,b=!1;for(let g of n){let y=b,v=game.scenes.find(k=>k.name==g.name&&k.folder?.id==i.id);if(!b&&v&&([y,b]=await new Promise((k,I)=>{new Dialog({title:game.i18n.localize("dsk.Book.sceneReset"),content:game.i18n.format("dsk.Book.sceneResetDescription",{name:g.name}),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{k([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.LocalizedIDs.all"),callback:()=>{k([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{k([!1,!1])}}},close:()=>{k([!1,!1])}}).render(!0)})),v&&!y){this.scenes[v.name]=v;continue}g.folder=i.id;for(let k of g.notes)try{let I=c.find(H=>H.flags.dsk.initId==k.entryId);if(!f.has(I._id)){let H=getProperty(I,"flags.dsk.parent"),S=u;this.folders[H]?S=this.folders[H]:H&&(S=await this.getFolderForType("JournalEntry",u.id,H,0,getProperty(I,"flags.dsk.foldercolor")||"")),I.folder=S.id;let j=game.journal.find(Je=>Je.name==I.name&&Je.folder?.id==S.id&&Je.flags.dsk.initId==k.entryId);if(j)await j.update(I),f.set(I._id,j.id);else{let Je=await JournalEntry.create(I);f.set(I._id,Je.id)}}k.entryId=f.get(I._id)}catch(I){console.warn(`Could not initialize Scene Notes for scene :${g.name}`+I)}v?(g._id=v.id,p.push(g)):d.push(g)}let T=await Scene.create(d,{dskInit:!0});for(let g of T){this.scenes[g.name]=g;let y=await g.createThumbnail();await g.update({thumb:y.thumb},{diff:!1})}for(let g of p)await game.scenes.get(g._id).update(g),this.scenes[g.name]=game.scenes.get(g._id);if(a.initialScene){let g=this.scenes[a.initialScene];await game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0),await g.activate(),await g.update({navigation:!0})}}if(a.actors){let i=await this.getFolderForType("Actor"),n=(await game.packs.get(a.actors).getDocuments()).map(f=>f.toObject()),l=[],c=[],u=new Map,d=0;if(getProperty(t,"chapters")){for(let f of t.chapters)for(let b of f.content)if(b.actors){let T=!1;for(let g of b.actors)u.has(g)||(u.set(g,b.name),T=!0);T&&(await this.getFolderForType("Actor",i.id,b.name,d),d+=1)}}for(let f of n){let b=u.has(f.name)?await this.getFolderForType("Actor",i.id,u.get(f.name)):i;f.folder=b.id,f._id&&delete f._id;let T=game.actors.find(g=>g.name==f.name&&[i.id,b.id].includes(g.folder?.id));T?(f._id=T.id,await T.deleteEmbeddedDocuments("Item",T.items.map(g=>g.id)),c.push(f)):l.push(f)}let p=await Actor.create(l);await Actor.updateDocuments(c);for(let f of p)this.actors[f.name]=f}}),this.lock=!1,e.find("i").remove(),ui.notifications.notify(game.i18n.localize("dsk.initComplete")),await this.close()}async dontInitialize(){game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0),ui.notifications.notify(game.i18n.localize("dsk.initSkipped")),await this.close()}submit(e){try{e.callback&&e.callback(this.options.jQuery?this.element:this.element[0])}catch(t){throw ui.notifications.error(t),new Error(t)}}async getFolderForType(e,t=null,a=null,s=0,i=""){return a||(a=game.i18n.localize(`${this.module}.name`)),h.getFolderForType(e,t,a,s,i)}};m(Ue,"DSKInitializer");var ue=class{constructor(){this.tokens={},this.actors={}}static get wantedKeys(){let e=[];return game.settings.get("dsk","enableDPS")||e.push("distance"),e}getPath(e,t,a){let s=a||"",i=t._id||t.type;return e.token?`tokens.${e.token||e.actor}.${i}${s}`:`actors.${e.actor}.${i}${s}`}remember(e,t,a,s){let i=this.formDataSerialize(s);Object.entries(i).length>0&&setProperty(this,this.getPath(e,t,a),i)}recall(e,t,a){return getProperty(this,this.getPath(e,t,a))}formDataSerialize(e){let t=e.find("form"),a={};return t.find("select").each(function(){let s=$(this).attr("name");ue.wantedKeys.includes(s)&&(a[s]=$(this).val())}),t.find('input[type="checkbox"]').each(function(){let s=$(this).attr("name");ue.wantedKeys.includes(s)&&(a[s]=this.checked)}),t.find(".specAbs.active").each(function(){a.specAbs||(a.specAbs=[]),a.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})}),e.find('[name="situationalModifiers"] option').each(function(){a.situationalModifiers||(a.situationalModifiers=[]),a.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})}),a}};m(ue,"RollMemory");var Ve=class{static requestRoll(e,t=0){X.showRQMessage(e,t)}static rollCh(e,t={}){F.check3D20(void 0,e,t)}static itemMacroById(e,t,a,s){let i=game.actors.get(e),r=i?i.items.find(n=>n.name===t&&n.type==a):null;this.runItem(i,r,t,s)}static itemMacro(e,t,a){let s=ChatMessage.getSpeaker(),i;s.token&&(i=game.actors.tokens[s.token]),i||(i=game.actors.get(s.actor));let r=i?i.items.find(n=>n.name===e&&n.type==t):null;this.runItem(i,r,e,a,s.token)}static runItem(e,t,a,s,i){if(!e)return ui.notifications.error(game.i18n.format("dsk.DSKError.MacroItemMissing",{item:a}));switch(t.type){case"combatskill":case"trait":case"meleeweapon":return e.setupWeapon(t,s.mod,s,i).then(r=>{e.basicTest(r)});case"rangeweapon":return e.setupWeapon(t,"attack",s,i).then(r=>{e.basicTest(r)});case"skill":return e.setupSkill(t,s,i).then(r=>{e.basicTest(r)});case"ahnengabe":return e.setupSpell(t,s,i).then(r=>{e.basicTest(r)})}}};m(Ve,"MacroDSK");var Ye=class extends Pause{static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsk/templates/system/pause.html",e}};m(Ye,"DSKPause");Hooks.once("init",()=>{console.log("Initializing DSK system"),CONFIG.statusEffects=w.statusEffects,game.dsk={apps:{DSKUtility:h,DSKInitializer:Ue,DSKChatListeners:F,SpecialabilityRulesDSK:x,AdvantageRulesDSK:E,Migrakel:fe,DPS:U,DiceDSK:_DiceDSK,DSKStatusEffects:O},documents:{ActorDSK:D,ItemDSK:C},sheets:{ActorSheetDSK:ie,ItemSheetDSK:R,ActorSheetCreature:re,ActorSheetCharacter:te,ActorSheetNPC:ne},config:w,macro:Ve,memory:new ue,itemLibrary:new We},CONFIG.Actor.documentClass=D,CONFIG.Item.documentClass=C,CONFIG.ActiveEffect.documentClass=we,CONFIG.ui.combat=ae,CONFIG.ui.hotbar=Ke,CONFIG.ui.pause=Ye,CONFIG.Combat.documentClass=at,CONFIG.Combatant.documentClass=st,CONFIG.ActiveEffect.documentClass=we,CONFIG.ChatMessage.template="systems/dsk/templates/chat/chat-message.html",CONFIG.ActiveEffect.legacyTransferral=!1});ts();
