var Ss=Object.defineProperty;var ea=(o,e,t)=>e in o?Ss(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var m=(o,e)=>Ss(o,"name",{value:e,configurable:!0});var z=(o,e,t)=>(ea(o,typeof e!="symbol"?e+"":e,t),t);function Cs(){Hooks.on("getImagePopoutHeaderButtons",(o,e)=>{e.unshift({class:"posttochat",icon:"fas fa-comment",onclick:async()=>ta(o)})})}m(Cs,"initImagePopoutTochat");async function ta(o){let e=o.object,t=await renderTemplate("systems/dsk/templates/chat/imagetochat.html",{image:e});ChatMessage.create(g.chatDataSetup(t))}m(ta,"postImage");function Ms(o){let e=o.currentTarget.dataset;g.showArtwork(e,!1)}m(Ms,"showPopout");var A={};A.statusEffects=[{icon:"icons/svg/skull.svg",id:"dead",name:"dsk.CONDITION.defeated",label:"dsk.CONDITION.defeated",description:"dsk.CONDITIONDESCRIPTION.defeated",flags:{dsk:{value:null,editable:!0}}},{id:"inpain",name:"dsk.CONDITION.inpain",icon:"icons/svg/blood.svg",description:"dsk.CONDITIONDESCRIPTION.inpain",changes:[{key:"system.status.inpain",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"encumbered",name:"dsk.CONDITION.encumbered",icon:"icons/svg/anchor.svg",description:"dsk.CONDITIONDESCRIPTION.encumbered",changes:[{key:"system.status.encumbered",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"stunned",name:"dsk.CONDITION.stunned",icon:"icons/svg/daze.svg",description:"dsk.CONDITIONDESCRIPTION.stunned",changes:[{key:"system.status.stunned",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"feared",name:"dsk.CONDITION.feared",icon:"icons/svg/terror.svg",description:"dsk.CONDITIONDESCRIPTION.feared",changes:[{key:"system.status.feared",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"selfconfidence",name:"dsk.CONDITION.selfconfidence",icon:"icons/svg/up.svg",description:"dsk.CONDITIONDESCRIPTION.selfconfidence",changes:[{key:"system.status.selfconfidence",mode:2,value:1}],flags:{dsk:{value:1,editable:!0,max:8}}},{id:"prone",name:"dsk.CONDITION.prone",icon:"icons/svg/falling.svg",description:"dsk.CONDITIONDESCRIPTION.prone",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500},{key:"system.meleeStats.attack",mode:2,value:-4},{key:"system.rangeStats.attack",mode:2,value:-4},{key:"system.meleeStats.parry",mode:2,value:-2}],flags:{dsk:{value:null,editable:!0}}},{id:"rooted",name:"dsk.CONDITION.rooted",icon:"icons/svg/net.svg",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500}],description:"dsk.CONDITIONDESCRIPTION.rooted",flags:{dsk:{value:null,editable:!0}}},{id:"unconscious",name:"dsk.CONDITION.unconscious",icon:"icons/svg/unconscious.svg",description:"dsk.CONDITIONDESCRIPTION.unconscious",flags:{dsk:{value:null,editable:!0}}},{id:"blind",name:"dsk.CONDITION.blind",icon:"icons/svg/blind.svg",description:"dsk.CONDITIONDESCRIPTION.blind",changes:[{key:"system.meleeStats.attack",mode:2,value:-8},{key:"system.rangeStats.attack",mode:2,value:-100},{key:"system.meleeStats.parry",mode:2,value:-100}],flags:{dsk:{value:null,editable:!0}}},{id:"constricted",name:"dsk.CONDITION.constricted",icon:"icons/svg/cave.svg",description:"dsk.CONDITIONDESCRIPTION.constricted",flags:{dsk:{value:null,editable:!0}}},{id:"fixated",name:"dsk.CONDITION.fixated",icon:"icons/svg/padlock.svg",description:"dsk.CONDITIONDESCRIPTION.fixated",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500},{key:"system.meleeStats.parry",mode:2,value:-2}],flags:{dsk:{value:null,editable:!0}}},{id:"hallucinating",name:"dsk.CONDITION.hallucinating",icon:"icons/svg/padlock.svg",description:"dsk.CONDITIONDESCRIPTION.hallucinating",flags:{dsk:{value:null,editable:!0}}},{id:"incapacitated",name:"dsk.CONDITION.incapacitated",icon:"icons/svg/sleep.svg",description:"dsk.CONDITIONDESCRIPTION.incapacitated",changes:[{key:"system.stats.gs.gearmodifier",mode:2,value:-500}],flags:{dsk:{value:null,editable:!0}}},{id:"panic",name:"dsk.CONDITION.panic",icon:"icons/svg/terror.svg",description:"dsk.CONDITIONDESCRIPTION.panic",flags:{dsk:{value:null,editable:!0}}},{id:"bloodrush",name:"dsk.CONDITION.rage",icon:"icons/svg/bones.svg",description:"dsk.CONDITIONDESCRIPTION.rage",changes:[{key:"system.meleeStats.attack",mode:2,value:4},{key:"system.meleeStats.parry",mode:2,value:-100},{key:"system.rangeStats.attack",mode:2,value:-100}],flags:{dsk:{value:null,editable:!0}}},{id:"mute",name:"dsk.CONDITION.mute",icon:"icons/svg/silenced.svg",description:"dsk.CONDITIONDESCRIPTION.mute",flags:{dsk:{value:null,editable:!0}}},{id:"deaf",name:"dsk.CONDITION.deaf",icon:"icons/svg/deaf.svg",description:"dsk.CONDITIONDESCRIPTION.deaf",changes:[{key:"system.skillModifiers.step",mode:0,value:"Sinnessch\xE4rfe -4;Perception -4"}],flags:{dsk:{value:null,editable:!0}}},{id:"surprised",name:"dsk.CONDITION.surprised",icon:"icons/svg/hazard.svg",description:"dsk.CONDITIONDESCRIPTION.surprised",changes:[{key:"system.meleeStats.parry",mode:2,value:-100}],flags:{dsk:{value:null,editable:!0}}},{id:"invisible",name:"dsk.CONDITION.invisible",icon:"icons/svg/circle.svg",description:"dsk.CONDITIONDESCRIPTION.invisible",flags:{dsk:{value:null,editable:!0}}},{id:"poisoned",name:"dsk.CONDITION.poisoned",icon:"icons/svg/poison.svg",description:"dsk.CONDITIONDESCRIPTION.poisoned",flags:{dsk:{value:null,editable:!0}}}];A.StFs={A:"A",B:"B",C:"C",D:"D",E:"E"};A.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /ah [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk sinnessch\xE4rfe"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq bet\xF6ren"},{name:"twoD20Check",command:"/ch",example:"/ch"}];A.meleeRangeVision=()=>({"+0":"dsk.meleeVisionDisruption.0","-1":"dsk.meleeVisionDisruption.1","-2":"dsk.meleeVisionDisruption.2","-3":"dsk.meleeVisionDisruption.3","-5000":"dsk.meleeVisionDisruption.4"});A.addvantageRules={};A.removevantageRules={};A.vantagesNeedingAdaption={};A.addAbilityRules={};A.removeAbilityRules={};A.AbilitiesNeedingAdaption={};A.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[5,5,5,5,5,5,5,5,5,5,5,5,5,10,15,20,25,30,35,40,45,50,55,60,65,70],Eig:[20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,40,60,80,100,120,140,160,180,200,220,240]};A.specialAbilityCategories={general:"dsk.SPECIALABILITYCATEGORIES.general",Combat:"dsk.SPECIALABILITYCATEGORIES.combat",ahnen:"dsk.SPECIALABILITYCATEGORIES.ahnen",language:"dsk.SPECIALABILITYCATEGORIES.language"};A.shieldSizes={short:"dsk.SIZE.small",medium:"dsk.SIZE.average",long:"dsk.SIZE.big"};A.combatSkillSubCategories={0:"dsk.COMBATSKILLCATEGORY.0",1:"dsk.COMBATSKILLCATEGORY.1",2:"dsk.COMBATSKILLCATEGORY.2",3:"dsk.COMBATSKILLCATEGORY.3",4:"dsk.COMBATSKILLCATEGORY.4"};A.gearModifyableCalculatedAttributes=["schips","ini","gs","AeP","LeP","sk","zk"];A.rangeWeaponModifiers={short:"dsk.RangeMod.short",medium:"dsk.RangeMod.medium",long:"dsk.RangeMod.long",rangesense:"dsk.RangeMod.rangesense",extreme:"dsk.RangeMod.extreme"};A.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}};A.regnerationCampLocations={0:"dsk.regnerationCampLocations.normal","-1":"dsk.regnerationCampLocations.bad",1:"dsk.regnerationCampLocations.good"};A.regenerationInterruptOptions={0:"dsk.regenerationInterruptOptions.none","-1":"dsk.regenerationInterruptOptions.small","-2":"dsk.regenerationInterruptOptions.big"};A.equipmentCategories=["meleeweapon","rangeweapon","equipment","ammunition","armor","poison"];A.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8};A.aimOptions={0:"dsk.aimOptions.0",2:"dsk.aimOptions.1",4:"dsk.aimOptions.2"};A.rangeVision={0:"dsk.VisionDisruption.step0","-2":"dsk.VisionDisruption.step1","-4":"dsk.VisionDisruption.step2","-6":"dsk.VisionDisruption.step3","-5000":"dsk.VisionDisruption.step4"};A.targetMomevementOptions={0:"dsk.rangeMovementOptions.SLOW","-2":"dsk.rangeMovementOptions.FAST",2:"dsk.rangeMovementOptions.STATIONARY"};A.shooterMovementOptions={0:"dsk.rangeMovementOptions.SHOOTERSTATIONARY","-2":"dsk.rangeMovementOptions.SHOOTERMOVING","-4":"dsk.rangeMovementOptions.SHOOTERRUNNING"};A.mountedRangeOptions={0:"dsk.mountedRangeOptions.STATIONARY","-4":"dsk.mountedRangeOptions.SCHRITT","-8":"dsk.mountedRangeOptions.GALOPP"};A.rangeSizeCategories={tiny:"dsk.RANGESIZE.tiny",small:"dsk.RANGESIZE.small",average:"dsk.RANGESIZE.average",big:"dsk.RANGESIZE.big",giant:"dsk.RANGESIZE.giant"},A.meleeSizeCategories={tiny:"dsk.MELEESIZE.tiny",small:"dsk.MELEESIZE.small",average:"dsk.MELEESIZE.average",big:"dsk.MELEESIZE.big",giant:"dsk.MELEESIZE.giant"};A.narrowSpaceModifiers={weaponshort:{attack:2,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:0,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-2,parry:0,label:"dsk.NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:0,parry:2,label:"dsk.NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:0,parry:0,label:"dsk.NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-2,parry:-2,label:"dsk.NarrowSpaceModifiers.shield.long"}};A.meleeSizeModifier={tiny:-4,small:0,average:0,big:0,giant:0};A.sizeCategories={tiny:"dsk.SIZE.tiny",small:"dsk.SIZE.small",average:"dsk.SIZE.average",big:"dsk.SIZE.big",giant:"dsk.SIZE.giant"};A.equipmentTypes={misc:"dsk.Equipment.misc",clothes:"dsk.Equipment.clothes",tools:"dsk.Equipment.tools",light:"dsk.Equipment.light",healing:"dsk.Equipment.healing",bags:"dsk.Equipment.bags",wealth:"dsk.Equipment.wealth",writing:"dsk.Equipment.writing",alchemy:"dsk.Equipment.alchemy",service:"dsk.Equipment.service",luxus:"dsk.Equipment.luxus",blessed:"dsk.Equipment.blessed",food:"dsk.Equipment.food",animals:"dsk.Equipment.animals"};A.systemTables=[{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}},{name:"Ahnen",attrs:"",roll:"botch-roll",pack:{de:"dsk.patzer",en:"dsk.botch"},setting:{module:"",key:""}}];A.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4};A.effectTextStyle=CONFIG.canvasTextStyle.clone();A.effectTextStyle.fontSize="30";A.effectTextStyle.fontFamily="GentiumBasic";A.ammunitiongroups={"-":"-",arrow:"dsk.ammunition.arrow",bolt:"dsk.ammunition.bolt",bullet:"dsk.ammunition.bullet",stone:"dsk.ammunition.stone",dart:"dsk.ammunition.dart",mag:"dsk.ammunition.mag",infinite:"dsk.ammunition.infinite"};A.traitCategories={meleeAttack:"dsk.closeCombatAttacks",rangeAttack:"dsk.rangeCombatAttacks",armor:"TYPES.Item.armor",force:"dsk.force",specialty:"dsk.specialty"};A.meleeRanges={short:"dsk.Range.short",medium:"dsk.Range.medium",long:"dsk.Range.long"};A.magicResistanceModifiers={"-":"-",sk:"dsk.soulpower",zk:"dsk.toughness"};A.weapontypes={melee:"TYPES.Item.meleeweapon",range:"TYPES.Item.rangeweapon"};A.characteristics={mu:"dsk.characteristics.mu.name",kl:"dsk.characteristics.kl.name",in:"dsk.characteristics.in.name",ch:"dsk.characteristics.ch.name",ff:"dsk.characteristics.ff.name",ge:"dsk.characteristics.ge.name",ko:"dsk.characteristics.ko.name",kk:"dsk.characteristics.kk.name"};A.skillBurdens={yes:"dsk.yes",no:"dsk.no",maybe:"dsk.maybe"};A.skillDifficultyLabels={eeasy:"dsk.Skill-eeasy",veasy:"dsk.Skill-veasy",easy:"dsk.Skill-easy",challenging:"dsk.Skill-challenging",difficult:"dsk.Skill-difficult",hard:"dsk.Skill-hard",vhard:"dsk.Skill-vhard"};A.skillDifficultyModifiers={eeasy:16,veasy:8,easy:4,challenging:0,difficult:-4,hard:-8,vhard:-16};A.skillGroups={body:"dsk.SKILL.body",social:"dsk.SKILL.social",knowledge:"dsk.SKILL.knowledge",trade:"dsk.SKILL.trade"};CONFIG.time.roundTime=2;CONFIG.time.turnTime=0;var v=A;async function sa(){if(!game.settings.get("dsk","defaultConfigFinished")){console.log("Configuring default token settings");let o=game.settings.get("core","defaultToken");o.displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,o.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,o.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,o.bar1={attribute:"status.wounds"},await game.settings.set("core","defaultToken",o),await game.settings.set("core","leftClickRelease",!0),await game.settings.set("dsk","defaultConfigFinished",!0)}}m(sa,"setupDefaulTokenConfig");async function aa(o,e){await Je(),await game.settings.set("dsk","migrationVersion",e)}m(aa,"migrateDSK");async function Je(){let e=await(await fetch("systems/dsk/lazy/updatenotes.json")).json();new rt(e).render(!0)}m(Je,"showPatchViewer");function ys(){Hooks.once("ready",async function(){if(!game.user.isGM)return;await sa();let o=await game.settings.get("dsk","migrationVersion"),e=25;o<e&&aa(o,e)})}m(ys,"migrateWorld");var rt=class extends Application{constructor(e,t){super(t),this.json=e}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],mergeObject(e,{classes:e.classes.concat(["dsk","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),e.template="systems/dsk/templates/system/patchviewer.html",e.resizable=!0,e}async getData(){let e=this.json.notes[this.json.notes.length-1],t=this.json.default.replace(/VERSION/g,e.version),s=`<h1>CHANGELOG</h1><p>${t}. </br><b>Important updates</b>: ${e.text}</p><p>For details or proposals visit our github page at <a href="https://github.com/Plushtoast/dsk-foundryVT" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>`;await ChatMessage.create(g.chatDataSetup(s,"roll"));let a=game.i18n.lang,i=await renderTemplate(`systems/dsk/lazy/patchhtml/changelog_${a}_${e.version}.html`),r=await renderTemplate(`systems/dsk/lazy/patchhtml/news_${a}_${e.version}.html`),n=[this.json.notes[this.json.notes.length-2]].filter(p=>p!=null),l=n.length>0,c=l?await Promise.all(n.map(async p=>await renderTemplate(`systems/dsk/lazy/patchhtml/changelog_${a}_${p.version}.html`))):[],u=l?await Promise.all(n.map(async p=>await renderTemplate(`systems/dsk/lazy/patchhtml/news_${a}_${p.version}.html`))):[],d=await renderTemplate(`systems/dsk/lazy/patchhtml/modules_${a}.html`);return{patchName:t,changelog:i,news:r,prevVersions:n,prevChangeLogs:c,prevNews:u,modules:d}}};m(rt,"PatchViewer");var ks=class{static simpleAdoption(e,t,s,a){if(a[s].activeEffect){let i=duplicate(a[s].activeEffect);i.value=`${t.name} ${i.value}`;let r={changes:[i],duration:{},icon:"icons/svg/aura.svg",label:`${s} (${t.name})`,transfer:!0,flags:{dsk:{value:null,editable:!0,description:`${s} (${t.name})`,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}},tint:""};e.effects.push(r)}}static reverseAdoptionCalculation(e,t,s){let a=[v.vantagesNeedingAdaption,v.AbilitiesNeedingAdaption];for(let i of a)if(i[t.name]){let r=e.items.find(n=>i[t.name].items.includes(n.type)&&n.name==t.special);r&&(s.system.ap=s.system.ap.split("/")[r.system.StF.charCodeAt(0)-65],ks.simpleAdoption(s,r,t.name,i));break}return s}static hasItem(e,t,s){return e.items.find(a=>s.includes(a.type)&&a.name==t)!=null}static itemStep(e,t,s){let a=e.items.find(i=>s.includes(i.type)&&i.name==t);return a?Number(a.system.level):0}static itemAsModifier(e,t,s,a,i=!1,r=!1){let n=[],l=i?new RegExp(`^${g.escapeRegex(`${t} (`)}`):new RegExp(`^${g.escapeRegex(t)}$`),c=e.items.find(u=>a.includes(u.type)&&l.test(u.name));return c&&n.push({name:c.name,value:Number(c.system.level)*s,selected:r,source:c.name}),n}},j=ks;m(j,"ItemRulesDSK"),z(j,"children",{});var x=class extends j{static setupFunctions(){}static async abilityAdded(e,t){v.addAbilityRules[t.name]&&v.addAbilityRules[t.name](e,t)}static async abilityRemoved(e,t){v.removeAbilityRules[t.name]&&v.removeAbilityRules[t.name](e,t);let s=t.system.ap*t.system.level;if(/;/.test(t.system.ap)){let a=t.system.ap.split(";").map(i=>Number(i.trim()));s=0;for(let i=0;i<t.system.level;i++)s+=a[i]}await e._updateAPs(-1*s)}static async _specialabilityReturnFunction(e,t,s,a){if(t==null)return;if(t=duplicate(t),a!=null){if(/,/.test(t.system.ap)){let r=`${t.name.replace(" ()","")} (${a.name}`;t.system.ap=t.system.ap.split(",")[e.items.filter(n=>n.type==t.type&&n.name.includes(r)).length].trim()}x.simpleAdoption(t,a,t.name,v.AbilitiesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${a.name}${a.customEntry?", "+a.customEntry:""})`,a.data&&a.system.StF&&/\//.test(t.system.ap)&&(t.system.ap=t.system.ap.split("/")[a.system.StF.charCodeAt(0)-65].trim())}let i=e.items.find(r=>r.type==s&&r.name==t.name);if(i){let r=duplicate(i),n=/;/.test(r.system.ap)?r.system.ap.split(";").map(l=>Number(l.trim()))[r.system.level]:r.system.ap;r.system.level+1<=r.system.max&&await e.checkEnoughXP(n)&&(r.system.level+=1,await e._updateAPs(n,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[r]),await x.abilityAdded(e,r))}else{let r=t.system.ap.split(";").map(n=>n.trim())[0];await e.checkEnoughXP(r)&&(await x.abilityAdded(e,t),await e._updateAPs(r,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}}static async needsAdoption(e,t,s){let a=v.AbilitiesNeedingAdaption[t.name];if(a){let i,r;if(a.items=="text")i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-string-dialog.html",{original:t}),r=m(function(n){let l={name:n.find('[name="entryselection"]').val()};x._specialabilityReturnFunction(e,t,s,l)},"callback");else if(a.items=="array"){let n=a.elems.map(l=>({name:l}));i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:a.area}),r=m(function(l){let c=n.find(u=>u.name==l.find('[name="entryselection"]').val());x._specialabilityReturnFunction(e,t,s,c)},"callback")}else{let n=e.items.filter(l=>a.items.includes(l.type)).sort((l,c)=>l.name.localeCompare(c.name));i=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:a.area}),r=m(function(l){let c=n.find(u=>u.name==l.find('[name="entryselection"]').val());c.customEntry=l.find('[name="custom"]').val(),x._specialabilityReturnFunction(e,t,s,c)},"callback")}await new Dialog({title:game.i18n.localize("dsk.DIALOG.ItemRequiresAdoption"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:r},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}else x._specialabilityReturnFunction(e,t,s,null)}static hasAbility(e,t){return super.hasItem(e,t,["specialability"])}static abilityStep(e,t){return super.itemStep(e,t,["specialability"])}static abilityAsModifier(e,t,s=1,a=!1){return super.itemAsModifier(e,t,s,["specialability"],a)}};m(x,"SpecialabilityRulesDSK");j.children.SpecialabilityRulesDSK=x;var _=class{static _getFunctionData(e){return{data:e.currentTarget.dataset,actor:g.getSpeaker({token:e.currentTarget.dataset.token,actor:e.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}static multipleDefenseValue(e,t){let s=-2;return getProperty(t,"system.combatskill")==game.i18n.localize("dsk.LocalizedIDs.wrestle")&&x.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.masterfulDodge"))?s=-2:x.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.mightyMasterfulParry"))?s=-1:x.hasAbility(e,game.i18n.localize("dsk.LocalizedIDs.masterfulParry"))&&(s=-2),Math.min(0,s)}static isYieldedTwohanded(e){let t=this.regex2h.test(e.name),s=e.system.worn.wrongGrip;return t&&!s||!t&&s}static obfuscateDropData(e,t){if(t)for(let s of t)mergeObject(e,{system:{obfuscation:{[s]:!0}}})}static _buildDuration(e){let t={duration:{startTime:game.time.worldTime,rounds:e,seconds:e*5}};return game.combat&&mergeObject(t,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),t}static increment(e,t,s,a=void 0){let i=e.ctrlKey?10:1,r=e.button==2?-1:1,n=getProperty(t,s)+i*r;a!=null&&(n=Math.max(a,n)),setProperty(t,s,n)}};m(_,"RuleChaos"),z(_,"regex2h",/\(2H/);var F=class{static chatListeners(e){e.on("click",".openJournalBrowser",()=>game.dsk.apps.journalBrowser.render(!0));let t=$('<a class="button showHelp" data-tooltip="dsk.HELP.showHelp"><i class="fas fa-question"></i></a>');t.click(()=>{F.getHelp()}),$(e.find(".control-buttons")).prepend(t),e.on("click",".showPatchViewer",()=>Je()),e.on("click",".functionswitch",s=>_[s.currentTarget.dataset.function](s)),e.on("click",".panToToken",s=>F.panToToken(s)),e.on("click",".popoutImage",s=>Ms(s))}static async panToToken(e){let t=await fromUuid(e.currentTarget.dataset.uuid);!t||(canvas.animatePan({x:t.x,y:t.y}),t.isOwner&&t.object.control({releaseOthers:!0}))}static postStatus(e){let t=CONFIG.statusEffects.find(a=>a.id==e),s=`<h2><a class="chat-condition chatButton" data-id="${e}"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="${t.icon}"/>${game.i18n.localize(t.name)}</h2></a><p>${game.i18n.localize(t.description)}</p>`;ChatMessage.create(g.chatDataSetup(s,"roll"))}static getHelp(){let e=v.helpContent.map(t=>`<h2>${game.i18n.localize(`dsk.HELP.${t.name}`)}</h2>
            <p><b>${game.i18n.localize("dsk.HELP.command")}</b>: ${t.command}</p>
            <p><b>${game.i18n.localize("dsk.HELP.example")}</b>: ${t.example}</p>
            <p><b>${game.i18n.localize("dsk.description")}</b>: ${game.i18n.localize(`dsk.HELP.descr${t.name}`)}`).join("")+`<br>
            <p>${game.i18n.localize("dsk.HELP.default")}</p>`;ChatMessage.create(g.chatDataSetup(e,"roll"))}static showConditions(){let t=duplicate(CONFIG.statusEffects).map(s=>(s.name=game.i18n.localize(s.name),s)).sort((s,a)=>s.name.localeCompare(a.name)).map(s=>`<a class="chat-condition chatButton" data-id="${s.id}"><img src="${s.icon}"/>${s.name}</a>`).join(" ");ChatMessage.create(g.chatDataSetup(t,"roll"))}static async check3D20(e,t,s={}){let a=12;e?(e=e.get(0),t=await g.skillByName(e.textContent),e.dataset.attrs&&(a=e.dataset.attrs.split("|"))):t&&(t=await g.skillByName(t)),t&&(t=t.toObject()),t||(t={name:"2d20",type:"skill",system:{level:0,characteristic1:"mu",characteristic2:"kl",encumbers:"no"}});let i=await g.emptyActor(a);i.setupSkill(t,s,"emptyActor").then(r=>{i.basicTest(r)})}static async showTables(){let e=await renderTemplate("systems/dsk/templates/tables/systemtables.html",{tables:v.systemTables});ChatMessage.create(g.chatDataSetup(e,"roll"))}};m(F,"DSKChatListeners");var O=class{static bindButtons(e){e.find(".chat-condition").each(function(t,s){s.setAttribute("draggable",!0),s.addEventListener("dragstart",a=>{let i={data:{type:"condition",payload:{id:$(a.currentTarget).attr("data-id")}}};a.dataTransfer.setData("text/plain",JSON.stringify(i))})}),e.on("click",".chat-condition",t=>F.postStatus($(t.currentTarget).attr("data-id")))}static createCustomEffect(e,t="",s){s=s||game.i18n.localize("dsk.CONDITION.custom"),t==""&&(t=s),e.addCondition({label:s,icon:"icons/svg/aura.svg",origin:e.uuid,flags:{dsk:{value:null,editable:!0,description:t,custom:!0}}})}static async addCondition(e,t,s=1,a=!1,i=!0){if(!e.isOwner)return"Not owned";if(e.compendium)return"Can not add in compendium";if(a&&s<1)return this.removeCondition(e,t,s,i,a);if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(n=>n.id==t))),!t)return"No Effect Found";let r=this.hasCondition(e,t.id);return r&&r.flags.dsk.value==null?r:r?await O.updateEffect(e,r,s,a,i,t):await O.createEffect(e,t,s,i)}static async createEffect(e,t,s,a){let i=this.immuneToEffect(e,t);if(i)return i;t.name=game.i18n.localize(t.name),a?(t.flags.dsk.auto=Math.min(t.flags.dsk.max,s),t.flags.dsk.manual=0):(t.flags.dsk.manual=Math.min(t.flags.dsk.max,s),t.flags.dsk.auto=0),t.flags.dsk.value=Math.min(4,t.flags.dsk.manual+t.flags.dsk.auto),t.id&&(t.statuses=[t.id]),t.id=="dead"&&(t["flags.core.overlay"]=!0);let r=await e.createEmbeddedDocuments("ActiveEffect",[duplicate(t)]);return delete t.id,r}static async removeCondition(e,t,s=1,a=!0,i=!1){if(!e.isOwner)return"Not owned";if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(n=>n.id==t))),!t)return"No Effect Found";let r=this.hasCondition(e,t.id);if(r&&r.flags.dsk.value==null)return e.token&&(e=e.token.actor),await e.deleteEmbeddedDocuments("ActiveEffect",[r.id]);if(r)return await O.removeEffect(e,r,s,i,a)}static async removeEffect(e,t,s,a,i){let r=i?a?s:Math.max(0,t.flags.dsk.auto-s):t.flags.dsk.auto,n=i?t.flags.dsk.manual:a?s:t.flags.dsk.manual-s,l={flags:{dsk:{auto:r,manual:n,value:Math.max(0,Math.min(t.flags.dsk.max,n+r))}}};return l.flags.dsk.auto<1&&l.flags.dsk.manual==0?await e.deleteEmbeddedDocuments("ActiveEffect",[t.id]):await t.update(l)}static async updateEffect(e,t,s,a,i,r=void 0){let n=this.immuneToEffect(e,t,!0);if(n)return n;let l,c,u;return i?(c=Math.min(t.flags.dsk.max,a?s:t.flags.dsk.auto+s),l=c-t.flags.dsk.auto,u={flags:{dsk:{auto:c,manual:t.flags.dsk.manual}}}):(c=a?s:t.flags.dsk.manual+s,l=c-t.flags.dsk.manual,u={flags:{dsk:{manual:c,auto:t.flags.dsk.auto}}}),l==0||(u.flags.dsk.value=Math.max(0,Math.min(t.flags.dsk.max,u.flags.dsk.manual+u.flags.dsk.auto)),r.duration&&(u.duration=r.duration,u.duration.startTime=game.time.worldTime),await t.update(u)),t}static immuneToEffect(e,t,s=!0){if((getProperty(e,"system.immunities")||[]).includes(t.id)){let i=game.i18n.format("dsk.DSKError.immuneTo",{name:e.name,condition:game.i18n.localize(`dsk.CONDITION.${t.id}`)});return ui.notifications&&!s&&ui.notifications.warn(i),i}return!1}static resistantToEffect(e,t){let s=[...t.statuses][0];return s?(getProperty(e,"system.resistances.effects")||[]).reduce((i,r)=>(r.target==s&&(i+=Number(r.value)),i),0):0}static hasCondition(e,t){return e!=null&&t&&e.effects?e.effects.find(s=>s.statuses.has(t)):!1}static prepareActiveEffects(e,t){let s=duplicate(CONFIG.statusEffects),a=[];t.conditions=[],t.transferedConditions=[];let i;e.documentName=="Item"?i=e.effects:(i=Array.from(e.allApplicableEffects()),game.user.isGM||(i=i.filter(n=>!n.getFlag("dsk","hidePlayers"))));for(let n of i){let l=n.toObject();l.boolean=n.getFlag("dsk","value")==null;let c=[...n.statuses][0];c&&(l.value=n.getFlag("dsk","value"),l.editable=n.getFlag("dsk","editable"),l.descriptor=c,l.manual=n.getFlag("dsk","manual"),a.push(c)),e.documentName=="Item"||n.parent?.documentName!="Item"&&!n.notApplicable?t.conditions.push(l):n.notApplicable||(l.uuid=n.uuid,t.transferedConditions.push(l))}t.manualConditions=s.filter(n=>!a.includes(n.id));let r=[];for(let n of Object.keys(e.system?.status||{}))if(e.system.status[n]){let l=v.statusEffects.find(c=>c.id==n);r.push({icon:l.icon,id:n,name:game.i18n.localize(l.name),value:e.system.status[n]})}t.cumulativeConditions=r}static calculateRollModifier(e,t,s,a={}){return s.type=="regenerate"?0:-1*(t.system.status[e]||0)}static ModifierIsSelected(e,t={},s){return t.mode!="damage"}static getRollModifiers(e,t,s={}){let a=game.i18n.localize("dsk.status")+"/"+game.i18n.localize("dsk.condition"),i=[];for(let r of Object.keys(e.system.status))if(e.system.status[r]){let n=game.dsk.config.statusEffectClasses[r]||O;i.push({name:game.i18n.localize(`dsk.CONDITION.${r}`),value:n.calculateRollModifier(r,e,t,s),selected:n.ModifierIsSelected(t,s,e),source:a})}return i}};m(O,"DSKStatusEffects");var nt=class extends O{static ModifierIsSelected(e,t={},s){let a=e.type=="skill"&&e.system.encumbers=="yes",i=!["skill","ahnengabe","rangeweapon"].includes(e.type)&&t.mode!="damage";return a||i}static calculateRollModifier(e,t,s,a={}){return s.type=="regenerate"||s.type=="skill"&&s.system.encumbers=="no"?0:super.calculateRollModifier(e,t,s,a)}};m(nt,"EncumberedEffect");var ot=class extends O{static ModifierIsSelected(e,t={},s){return s.effects.find(a=>Array.from(a.statuses).includes("bloodrush"))==null}};m(ot,"PainEffect");var lt=class extends O{static calculateRollModifier(e,t,s,a={}){return s.type=="regenerate"?0:t.system.status.selfconfidence||0}};m(lt,"SelfconfidenceEffect");v.statusEffectClasses={encumbered:nt,inpain:ot,selfconfidence:lt};var E=class extends j{static setupFunctions(){}static async vantageAdded(e,t){game.dsk.config.addvantageRules[t.name]&&game.dsk.config.addvantageRules[t.name](e,t)}static async vantageRemoved(e,t){game.dsk.config.removevantageRules[t.name]&&game.dsk.config.removevantageRules[t.name](e,t)}static async _vantageReturnFunction(e,t,s,a){if(t==null)return;if(t=duplicate(t),/,/.test(t.system.ap)){let r=t.name.replace(" ()","");t.system.ap=t.system.ap.split(",")[e.items.filter(n=>n.type==t.type&&n.name.includes(r)).length].trim()}a!=null&&(E.simpleAdoption(t,a,t.name,v.vantagesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${a.name})`,a.data&&(t.system.ap=t.system.ap.split("/")[a.system.StF.charCodeAt(0)-65].trim()));let i=e.items.find(r=>r.type==s&&r.name==t.name);if(i){let r=duplicate(i),n=/;/.test(r.system.ap)?r.system.ap.split(";").map(l=>Number(l.trim()))[r.system.level]:r.system.ap;r.system.level+1<=r.system.max&&await e.checkEnoughXP(n)&&(r.system.level+=1,await e._updateAPs(n,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[r]),await E.vantageAdded(e,r))}else await e.checkEnoughXP(t.system.ap.split(";").map(r=>r.trim())[0])&&(await E.vantageAdded(e,t),await e._updateAPs(t.system.ap.split(";").map(r=>r.trim())[0],{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}static async needsAdoption(e,t,s){if(v.vantagesNeedingAdaption[t.name]){let a,i;if(v.vantagesNeedingAdaption[t.name].items=="text")a=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-string-dialog.html",{original:t}),i=m(function(r){let n={name:r.find('[name="entryselection"]').val()};E._vantageReturnFunction(e,t,s,n)},"callback");else{let r=e.items.filter(n=>v.vantagesNeedingAdaption[t.name].items.includes(n.type));a=await renderTemplate("systems/dsk/templates/dialog/requires-adoption-dialog.html",{items:r,original:t}),i=m(function(n){let l=r.find(c=>c.name==n.find('[name="entryselection"]').val());E._vantageReturnFunction(e,t,s,l)},"callback")}await new Dialog({title:game.i18n.localize("dsk.DIALOG.ItemRequiresAdoption"),content:a,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:i},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}else E._vantageReturnFunction(e,t,s,null)}static hasVantage(e,t){return super.hasItem(e,t,["advantage","disadvantage"])}static vantageStep(e,t){return super.itemStep(e,t,["advantage","disadvantage"])}static getVantageAsModifier(e,t,s=1,a=!1,i=!1){return super.itemAsModifier(e,t,s,["advantage","disadvantage"],a,i)}};m(E,"AdvantageRulesDSK");j.children.AdvantageRulesDSK=E;var W=class{static rangeFinder(e,t){let s=canvas.scene.grid.size,i=new Ray(e,t).distance/s,r=i*canvas.scene.grid.distance,n=Math.abs((getProperty(e,"system.elevation")||0)-(getProperty(t,"system.elevation")||0)),l=Math.hypot(r,n);return{elevation:n,distance:r,distanceSum:l,tileDistance:i,unit:canvas.scene.grid.units}}static inDistance(e){for(let t of canvas.scene.tokens)if(t.isOwner&&this.rangeFinder(e,t.object).tileDistance<=2)return!0;return!1}static distanceModifier(e,t,s){if(!game.settings.get("dsk","enableDPS")||!e)return 1;let a={};for(let i of game.user.targets){let r=W.rangeFinder(e,i);(a.distanceSum||0)<r.distanceSum&&(a=r)}if(a.unit==game.i18n.localize("dsk.gridUnits")){let i=Number(getProperty(s,"system.rangeMultiplier"))||1,r=t.system.rw.split("/").map(l=>Number(l)*i),n=0;for(;n<2&&r[n]<a.distanceSum;)n++;return n}else return 1}static initDoorMinDistance(){let e=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(t){return!game.user.isGM&&game.settings.get("dsk","enableDPS")&&!W.inDistance(this)?ui.notifications.warn(game.i18n.localize("dsk.DSKError.notInRangeToLoot")):e.apply(this,arguments)}}};m(W,"DPS");var be=class extends Dialog{static async getDialog(e){let t=Array.from(game.user.targets).map(i=>i.id),s=[],a=canvas.scene?canvas.scene.tokens.get(e.token)?.object:void 0;return game.combat&&game.combat.combatants.forEach(i=>{if(!!i.visible){if(i.isSelected=t.includes(i.token.id),a&&i.token){let r=canvas.scene.tokens.get(i.token.id).object;i.distance=W.rangeFinder(a,r),i.distance.distanceSum=Number(i.distance.distanceSum.toFixed(1))}s.push(i)}}),new be({title:game.i18n.localize("dsk.DIALOG.addTarget"),content:await renderTemplate("systems/dsk/templates/dialog/addTarget-dialog.html",{selectables:s}),default:"yes",buttons:{}})}activateListeners(e){super.activateListeners(e);let t=e.find(".combatant");t.click(s=>this.setTargets(s)),t.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),t.mousedown(s=>this._onRightClick(s))}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);if(t.token)return canvas.animatePan({x:t.token.x,y:t.token.y})}}_getCombatApp(){return game.combats.apps[0]}async setTargets(e){let t=e.originalEvent.shiftKey;t||$(e.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(e.currentTarget).addClass("selectedTarget");let s=e.currentTarget.dataset.combatantId;game.combat.combatants.get(s).token.object.setTarget(!0,{user:game.user,releaseOthers:!t,groupSelection:!0})}};m(be,"AddTargetDialog");var De=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk5Decent"])}),e}static async getDialog(){let e=game.users.filter(t=>t.active&&!t.isGM);return new De({title:game.i18n.localize("dsk.DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsk/templates/dialog/selectForUserDialog.html",{users:e}),default:"yes",buttons:{}})}static registerButtons(){Hooks.on("getSceneControlButtons",e=>{if(!game.user.isGM)return;let t={name:"targetUser",title:game.i18n.localize("dsk.CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:async()=>{(await De.getDialog()).render(!0)}};e[0].tools.splice(2,0,t)})}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){let t=Array.from(game.user.targets).map(i=>i.id),s=e.currentTarget.dataset.userId;game.users.get(s).updateTokenTargets(t),game.socket.emit("userActivity",s,{targets:t}),this.close()}};m(De,"SelectUserDialog");var we=class extends Dialog{static async getDialog(e){let t=game.users.filter(s=>s.active&&!s.isGM);new we({title:game.i18n.localize("dsk.SHEET.PostItem"),content:await renderTemplate("systems/dsk/templates/dialog/usermultipickdialog.html",{users:t}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:s=>{this.postContent(s,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}static async postContent(e,t){let s=g.chatDataSetup(t);if(!e.find("#sel_all").is(":checked")){let a=[];e.find(".usersel:checked").each(function(){a.push($(this).val())}),s.whisper=a}ChatMessage.create(s)}activateListeners(e){super.activateListeners(e),e.find('[name="sel_all"]').change(t=>{e.find(".usersel").prop("disabled",t.currentTarget.checked).prop("checked",t.currentTarget.checked)})}};m(we,"UserMultipickDialog");var bs=class extends Dialog{recallSettings(e,t,s){return this.recallData=game.dsk.memory.recall(e,t,s),this.dialogData={mode:s,speaker:e,source:t},this}async _render(e,t){await super._render(e,t),this.prepareFormRecall($(this._element))}setRollButtonWarning(){return this.dialogData.mode=="attack"?`<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("dsk.DIALOG.noTarget")}</span>`:""}setMultipleTargetsWarning(){return this.dialogData.mode=="attack"?`<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("dsk.DIALOG.multipleTarget")}</span>`:""}renderRollValueDie(){if(this.dialogData.rollValue&&this.dialogData.mode!="damage"){let e=this.dialogData.mode=="attack"?"die-mu":"die-in",t=this.dialogData.modifier||0;return`<span class="rollValue ${e} d20">${this.dialogData.rollValue+t}</span>`}else return""}async updateRollButton(e){let t=this.renderRollValueDie()+game.i18n.localize("dsk.Roll");e.length>0?e.length>1&&(t+=this.setMultipleTargetsWarning()):t+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(t)}async updateTargets(e,t){let s=await renderTemplate("systems/dsk/templates/dialog/parts/targets.html",{targets:t});e.find(".targets").html(s),this.updateRollButton(t)}removeTarget(e){let t=e.currentTarget.dataset.id;$(e.currentTarget).remove();let s=[];game.user.targets.forEach(a=>{t!=a.id&&s.push(a.id)}),game.user.updateTokenTargets(s)}readTargets(){let e=[];return game.user.targets.forEach(t=>{t.actor&&e.push({name:t.actor.name,img:t.actor.img,id:t.id})}),e}compareTargets(e,t){let s=this.readTargets();return JSON.stringify(t)!=JSON.stringify(s)&&(t=s,this.updateTargets(e,t)),t}activateListeners(e){super.activateListeners(e),e.find(".quantity-click").mousedown(t=>{let s=t.currentTarget.dataset.quantityfocus,a=$(t.currentTarget);if(s&&!a.is(":focus")){setTimeout(function(){a.select()});return}let i={val:Number(a.val())};_.increment(t,i,"val"),a.val(i.val)}),e.find(".modifiers option").mousedown(t=>(t.preventDefault(),$(t.currentTarget).prop("selected",!$(t.currentTarget).prop("selected")),!1)),e.on("click",".rollTarget",t=>this.removeTarget(t)),e.on("click",".addTarget",t=>this.addTarget(t))}async addTarget(e){(await be.getDialog(this.dialogData.speaker)).render(!0)}prepareFormRecall(e){if(this.recallData)for(let t in this.recallData)if(t=="specAbs")for(let s of this.recallData[t]){let a=e.find(`.specAbs[data-id="${s.id}"]`);a.addClass("active").attr("data-step",s.step),a.find(".step").text(bs.roman[s.step])}else{let s=e.find(`[name="${t}"]`);if(Array.isArray(this.recallData[t])){let a=s.find("option");for(let i of a){let r=this.recallData[t].find(n=>n.name==$(i).text().trim());r&&(i.selected=r.selected)}}else s.attr("type")=="checkbox"?s[0].checked=this.recallData[t]:s.val(this.recallData[t])}}},U=bs;m(U,"DialogShared"),z(U,"roman",[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"]);var J=class extends U{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}activateListeners(e){super.activateListeners(e);let t=e.find(".specAbs");t.mouseenter(i=>{if(i.currentTarget.getElementsByClassName("hovermenu").length==0){let r=document.createElement("div");r.classList.add("hovermenu");let n=document.createElement("i");n.classList.add("fas","fa-comment"),n.title=game.i18n.localize("dsk.SHEET.PostItem"),n.addEventListener("mousedown",this._postItem,!1),r.appendChild(n),i.currentTarget.appendChild(r)}}),t.mouseleave(i=>{let r=i.toElement||i.relatedTarget;r.parentNode==this||r==this||i.currentTarget.querySelectorAll(".hovermenu").forEach(n=>n.remove())}),e.on("mousedown",".specAbs",i=>{if(e.find(".opportunityAttack").is(":checked")){ui.notifications.error(game.i18n.localize("dsk.DSKError.opposedAttackNoSpecAbs"));return}let r=$(i.currentTarget),n=Number(r.attr("data-step")),l=Number(r.attr("data-maxStep")),c=Number(r.attr("data-category"));if(i.button==0){if(n=Math.min(l,n+1),[0,1].includes(c)&&game.settings.get("dsk","limitCombatSpecAbs")){let u=r.siblings(`[data-category="${c}"]`);u.removeClass("active").attr("data-step",0),u.find(".step").text(U.roman[0])}}else i.button==2&&(n=Math.clamped(l,0,n-1));r.attr("data-step",n),n>0?r.addClass("active"):r.removeClass("active"),r.find(".step").text(U.roman[n]),this.calculateModifier()}),e.find(".opportunityAttack").change(i=>{if($(i.currentTarget).is(":checked"))for(let r of e.find(".specAbs"))$(r).removeClass("active").attr("data-step",0).find(".step").text("")}),e.on("change","input,select",i=>this.calculateModifier(i)),e.find(".modifiers option").mousedown(i=>{this.calculateModifier(i)}),e.find(".quantity-click").mousedown(i=>this.calculateModifier(i));let s=this.readTargets();this.calculateModifier();let a=this;this.checkTargets=setInterval(function(){s=a.compareTargets(e,s)},500)}async close(e={}){return clearInterval(this.checkTargets),await super.close(e)}_postItem(e){e.stopPropagation();let t=$(e.currentTarget).closest(".specAbs"),s=t.attr("data-actor"),a=t.attr("data-id");return game.actors.get(s).items.get(a).postItem(),!1}recallSettings(e,t,s){return super.recallSettings(e,t,s),this.prepareWeapon(),this}prepareWeapon(){let e,t=this.dialogData.source,s=g.getSpeaker(this.dialogData.speaker);if(s)if(["meleeweapon","rangeweapon"].includes(t.type)){let a=t.system.combatskill,i=D._calculateCombatSkillValues(s.items.find(r=>r.type=="combatskill"&&r.name==a).toObject(),s.system);switch(t.type){case"meleeweapon":e=D._prepareMeleeWeapon(t,[i],s);break;case"rangeweapon":e=D._prepareRangeWeapon(t,[],[i],s);break}this.dialogData.mode=="attack"&&(this.dialogData.rollValue=e.attack)}else this.dialogData.mode=="attack"&&(this.dialogData.rollValue=Number(t.system.at))}prepareFormRecall(e){if(super.prepareFormRecall(e),canvas.scene&&game.settings.get("dsk","sightAutomationEnabled")){let t=canvas.scene?canvas.scene.darkness:0,s=game.settings.get("dsk","sightOptions").split("|").map(n=>Number(n)),a=0;for(;s[a]<=t;)a+=1;let i=g.getSpeaker(this.dialogData.speaker);if(i){let n=E.vantageStep(i,game.i18n.localize("dsk.LocalizedIDs.darksight"))+x.abilityStep(i,game.i18n.localize("dsk.LocalizedIDs.sappeurStyle")),l=x.abilityStep(i,game.i18n.localize("dsk.LocalizedIDs.blindFighting"));a<4&&a>0&&(n>1?a=0:(a=Math.max(0,a-n),a=Math.min(4,a+E.vantageStep(i,game.i18n.localize("dsk.LocalizedIDs.nightBlind"))))),a=Math.max(0,a-l)}let r=e.find(`[name="vision"] option:nth-child(${a+1})`);r.length&&(r[0].selected=!0)}}calculateModifier(){if(this.dialogData.mode=="damage")return;let e=this.dialogData.source,t=e.type=="trait"&&getProperty(e,"system.traitType")=="meleeAttack"||e.type=="meleeweapon",s={source:this.dialogData.source,extra:{options:{}}},a=g.getSpeaker(this.dialogData.speaker);t?J.resolveMeleeDialog(s,{},this.element,a,{},-2,this.dialogData.mode):J.resolveRangeDialog(s,{},this.element,a,{},this.dialogData.mode,-2),this.dialogData.modifier=_DiceDSK._situationalModifiers(s),this.updateRollButton(this.readTargets())}static resolveMeleeDialog(e,t,s,a,i,r,n){this._resolveDefault(e,t,s,a,i);let l=new FormDataExtended(s.find("form")[0]).object;e.opposingWeaponSize=l.weaponsize,e.narrowSpace=l.narrowSpace,e.attackOfOpportunity=this.attackOfOpportunity(e.situationalModifiers,l),e.situationalModifiers.push(C.parseValueType(game.i18n.localize("dsk.sight"),l.vision||0),{name:game.i18n.localize("dsk.attackFromBehind"),value:l.attackFromBehind?-4:0},{name:game.i18n.localize("dsk.MODS.damage"),damageBonus:l.damageModifier,value:0,step:1},{name:game.i18n.format("dsk.defenseCount",{malus:-1*r}),dmmalus:(Number(l.defenseCount)||0)*r*-1,value:(Number(l.defenseCount)||0)*r*-1,type:"defenseMalus"},{name:game.i18n.localize("dsk.wrongHand"),value:l.wrongHand?-4:0},{name:game.i18n.localize("dsk.advantageousPosition"),value:l.advantageousPosition?2:0},{name:game.i18n.localize("dsk.sizeCategory"),value:v.meleeSizeModifier[l.size]},...C.getSpecAbModifiers(s,n)),n=="attack"&&e.situationalModifiers.push({name:game.i18n.localize("dsk.doubleAttack"),value:l.doubleAttack?-3+Math.floor(x.abilityStep(a,game.i18n.localize("dsk.LocalizedIDs.twoWeaponCombat"))*1.5):0})}static resolveRangeDialog(e,t,s,a,i,r){this._resolveDefault(e,t,s,a,i);let n=new FormDataExtended(s.find("form")[0]).object;e.rangeModifier=n.distance,e.situationalModifiers.push({name:game.i18n.localize("dsk.target")+" "+s.find('[name="targetMovement"] option:selected').text(),value:Number(n.targetMovement)||0},{name:game.i18n.localize("dsk.shooter")+" "+s.find('[name="shooterMovement"] option:selected').text(),value:Number(n.shooterMovement)||0},{name:game.i18n.localize("dsk.mount")+" "+s.find('[name="mountedOptions"] option:selected').text(),value:Number(n.mountedOptions)||0},{name:game.i18n.format("dsk.defenseCount",{malus:-1*r}),dmmalus:(Number(n.defenseCount)||0)*r*-1,value:(Number(n.defenseCount)||0)*r*-1,type:"defenseMalus"},{name:game.i18n.localize("dsk.rangeMovementOptions.QUICKCHANGE"),value:n.quickChange?-4:0},{name:game.i18n.localize("dsk.MODS.combatTurmoil"),value:n.combatTurmoil?-2:0},{name:game.i18n.localize("dsk.aim"),value:Number(n.aim)||0},{name:game.i18n.localize("dsk.MODS.damage"),damageBonus:n.damageModifier,value:0,step:1},{name:game.i18n.localize("dsk.sight"),value:Number(n.vision||0)},...C.getSpecAbModifiers(s,"attack"),{name:game.i18n.localize("dsk.sizeCategory"),value:v.rangeSizeModifier[n.size]})}static _resolveDefault(e,t,s,a,i){t.rollMode=s.find('[name="rollMode"]').val(),e.situationalModifiers=D._parseModifiers(s),D.schipsModifier(s,e.situationalModifiers),e.vw=s.find('[name="vw"]').val(),mergeObject(e.extra.options,i)}static attackOfOpportunity(e,t){let s=t.opportunityAttack?-8:0;if(s){e.push({name:game.i18n.localize("dsk.opportunityAttack"),value:s});let a=game.i18n.localize("dsk.LocalizedIDs.enemySense");game.user.targets.forEach(i=>{if(i.actor&&i.actor.items.find(r=>r.type=="specialability"&&r.name==a)){e.push({name:a,value:s});return}})}return s!=0}static getRollButtons(e,t,s,a){let i=G.getRollButtons(e,t,s,a);if(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType=="rangeAttack"){let r=e.source.type=="trait"?Number(e.source.system.lz):D.calcLZ(e.source,e.extra.actor),n=e.source.system.reloadTimeprogress;n<r&&mergeObject(i,{reloadButton:{label:`${game.i18n.localize("dsk.WEAPON.reload")} (${n}/${r})`,callback:async()=>{await(await g.getSpeaker(e.extra.speaker)).updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTimeprogress":n+1}]);let c=game.i18n.format("dsk.WEAPON.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${n+1}/${r}`});await ChatMessage.create(g.chatDataSetup(c))}}})}return i}};m(J,"DSKCombatDialog");var Ie=class extends U{static getRollButtons(e,t,s,a){let i=G.getRollButtons(e,t,s,a);i.rollButton.label=game.i18n.localize("dsk.Opposed");let r={nonOpposedButton:{label:game.i18n.localize("dsk.Roll"),callback:n=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,n),e.opposable=!1,s(t.callback(n))}}};return mergeObject(r,i),r}activateListeners(e){super.activateListeners(e),e.on("change","input,select",a=>this.rememberFormData(a));let t=this.readTargets(),s=this;this.checkTargets=setInterval(function(){t=s.compareTargets(e,t)},500),this.rememberFormData(),e.on("mousedown",".quantity-click",a=>this.rememberFormData(a)),e.find(".modifiers option").mousedown(a=>{this.rememberFormData(a)})}rememberFormData(e){let t=new FormDataExtended(this.element.find("form")[0]).object;t.situationalModifiers=D._parseModifiers(this._element)}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}};m(Ie,"SkillDialogDSK");var Ze=class extends U{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}prepareFormRecall(e){super.prepareFormRecall(e),e.find(".spellModifier").trigger("change")}static getRollButtons(e,t,s,a){let i=G.getRollButtons(e,t,s,a);if(["spell","liturgy"].includes(e.source.type)){let r=Number(e.source.system.castingTime.value),n=e.source.system.castingTime.progress,l=e.source.system.castingTime.modified;if(r&&e.extra.speaker.token!="emptyActor"){let c=l>0?` (${n}/${l})`:"";mergeObject(i,{reloadButton:{label:`${game.i18n.localize("dsk.SPELL.reload")}${c}`,callback:async u=>{let d=await g.getSpeaker(e.extra.speaker),p={_id:e.source._id,"system.castingTime.progress":n+1};l==0&&(l=Number(u.find(".castingTime").text())-1,p["system.castingTime.modified"]=l),await d.updateEmbeddedDocuments("Item",[p]);let f=game.i18n.format("dsk.SPELL.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${n+1}/${l}`});await ChatMessage.create(g.chatDataSetup(f))}}})}}return i}async recalcSpellModifiers(e,t){let s=e,a=duplicate(this.dialogData.source),i=s.find(".castingTime"),r=s.find(".aspcost"),n=s.find(".reach"),l=s.find(".maintainCost"),c=s.find(".ritual").length>0,u=s.find(".maxMods");if(s.find(".spellModifier:checked").length>Number(u.text())){t&&(t.currentTarget.checked=!1),u.addClass("emphasize"),setTimeout(function(){u.removeClass("emphasize")},600);return}let d=a.system.AeP,p=a.system.range,f=2,k=d;s.find(".variableBaseCost")[a.system.variableBaseCost=="true"?"show":"hide"]();let T=0;s.find(".spellModifier[data-cost]:checked").each(function(y,b){k=k*(b.value<0?.5:2),T+=Number(b.value)}),k<1?t&&(t.currentTarget.checked=!1):(r.text(k),r.attr("data-mod",T)),T=0,k=f,s.find(".spellModifier[data-castingTime]:checked").each(function(y,b){if(c){let w=Ze.bigTimes.indexOf(Number(k));if(w!=null){let I=w+(b.value>0?1:-1);I<Ze.bigTimes.length&&I>=0?k=Ze.bigTimes[I]:ui.notifications.error(game.i18n.localize("dsk.DSKError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("dsk.DSKError.TimeCannotBeParsed"))}else k=k*(b.value>0?2:.5);T+=Number(b.value)}),k<1?t&&(t.currentTarget.checked=!1):(i.text(k),i.attr("data-mod",T)),T=0;let h=game.i18n.localize("dsk.ReverseSpellRanges."+p);n.text(p),s.find(".spellModifier[data-reach]:checked").each(function(y,b){if(h=="self")b.checked=!1;else if(h=="touch")n.text("4 "+game.i18n.localize("dsk.step")),T+=Number(b.value);else{let w=p.split(" ");h=Number(w[0]),isNaN(h)?(t&&(t.currentTarget.checked=!1),ui.notifications.error(game.i18n.localize("dsk.DSKError.RangeCannotBeParsed"))):(n.text(h*2+" "+game.i18n.localize("dsk.step")),T+=Number(b.value))}}),n.attr("data-mod",T),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2)}activateListeners(e){super.activateListeners(e),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2),e.find(".specAbs").mousedown(a=>{$(a.currentTarget).toggleClass("active"),this.recalcSpellModifiers(e)}),e.find(".variableBaseCost").change(a=>{let i=$(a.currentTarget).parents(".skill-test"),r=i.find(".aspcost").attr("data-base"),n=$(a.currentTarget).val();i.find(".aspcost").attr("data-base",n),i.find(".aspcost").text(Number(i.find(".aspcost").text())*n/r)}),e.find(".spellModifier").change(a=>this.recalcSpellModifiers(e,a));let t=this.readTargets();t.length==0&&this.setRollButtonWarning();let s=this;this.checkTargets=setInterval(function(){t=s.compareTargets(e,t)},500)}},ue=Ze;m(ue,"DSKpellDialog"),z(ue,"rollChanges",["defenseMalus"]),z(ue,"bigTimes",[5,30,120,480,960,1920]);var G=class extends U{static getDialogForItem(e){switch(e){case"rangeweapon":case"meleeweapon":case"trait":return J;case"ahnengabe":return ue;case"skill":return Ie}return G}static getRollButtons(e,t,s,a){let i={rollButton:{label:game.i18n.localize("dsk.check"),callback:r=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,r),s(t.callback(r))}}};return game.user.isGM&&mergeObject(i,{cheat:{label:game.i18n.localize("dsk.DIALOG.cheat"),callback:r=>{game.dsk.memory.remember(e.extra.speaker,e.source,e.mode,r),s(t.callback(r,{cheat:!0}))}}}),i}activateListeners(e){super.activateListeners(e),e.find(".dieButton").click(t=>{let s=$(t.currentTarget);s.attr("data-single")=="true"&&s.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),s.toggleClass("dieSelected")})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}};m(G,"DSKDialog");function Ds(o,e={}){g.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}m(Ds,"automatedAnimation");async function bi(o,e,t,s,a,i={}){let r={};if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else{let l=await game.packs.get(o).getDocuments({name:e});if(!l.length){for(let c of game.packs.filter(u=>u.documentName=="Macro"&&/\(internal\)/.test(u.metadata.label)))if(l=await c.getDocuments({name:e}),l.length)break}if(l.length){let c=`(async () => {${l[0].command}})()`,u=Function("actor","item","qs","automatedAnimation","args",c);try{i.result=r;let d=mergeObject({automatedAnimation:Ds},this);await u.call(d,t,s,a,Ds,i)}catch(d){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(d),r.error=!0}}else ui.notifications.error(game.i18n.format("dsk.DSKError.macroNotFound",{name:e}))}return r}m(bi,"callMacro");var _DSKActiveEffectConfig=class extends ActiveEffectConfig{static get defaultOptions(){return mergeObject(super.defaultOptions,{resizable:!0})}static async onEffectRemove(o,e){let t=getProperty(e,"flags.dsa5.onRemove");if(t)if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let s=Object.getPrototypeOf(async function(){}).constructor;await new s("effect","actor",t).call(this,e,o)}catch(s){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(s),console.warn(s.stack)}}async checkTimesUpInstalled(){let o=g.moduleEnabled("times-up");return!o&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("dsk.DSKError.shouldTimesUp")),o}async _render(o=!1,e={}){await super._render(o,e);let t=-1,s=["none","systemEffect","macro","creature"].map(c=>({name:`dsk.ActiveEffects.advancedFunctions.${c}`,index:t+=1})),a=getProperty(this.object,"parent.type"),i={hasSpellEffects:["ahnengabe","consumable","poison","ammunition","meleeweapon","rangeweapon"].includes(a)||["specialability"].includes(a)&&getProperty(this.object,"parent.system.category")=="Combat"||a=="trait"&&["meleeAttack","rangeAttack"].includes(getProperty(this.object,"parent.system.traitType")),hasDamageTransformation:["ammunition"].includes(a)};i.hasDamageTransformation&&s.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5});let r={systemEffects:this.getStatusEffects(),canEditMacros:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")},n=$(this._element);n.find(".tabs").append(`<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>${game.i18n.localize("dsk.advanced")}</a>`);let l=await renderTemplate("systems/dsk/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:s,effectConfigs:i,config:r});n.find('.tab[data-tab="effects"]').after($(l)),n.find(".advancedSelector").change(c=>{let u=this.object;u.flags.dsk.advancedFunction=$(c.currentTarget).val(),renderTemplate("systems/dsk/templates/status/advanced_functions.html",{effect:u,config:r}).then(d=>{n.find(".advancedFunctions").html(d)})}),this.checkTimesUpInstalled()}async _onSubmit(o,{updateData:e=null,preventClose:t=!1,preventRender:s=!1}={}){return getProperty(this.object,"system.document.parent.documentName")!="Actor"&&getProperty(this.object,"system.document.parent.parent")&&ui.notifications.error(game.i18n.localize("dsk.DSKError.nestedEffectNotSupported")),await super._onSubmit(o,{updateData:e,preventClose:t,preventRender:s})}getStatusEffects(){return duplicate(CONFIG.statusEffects).map(o=>({id:o.id,label:game.i18n.localize(o.name)})).sort((o,e)=>o.name.localeCompare(e.name))}getData(o){return super.getData(o)}static applyRollTransformation(actor,options,functionID){let msg="",source=options.origin;for(let ef of source.effects)try{Number(getProperty(ef,"flags.dsk.advancedFunction"))==functionID&&eval(getProperty(ef,"flags.dsk.args3"))}catch(o){console.warn("Unable to apply advanced effect",o,ef)}return options.origin=source,{msg,options}}static async applyAdvancedFunction(actor,effects,source,testData,sourceActor,skipResistRolls=!0){let msg="",resistRolls=[],effectApplied=!1,effectsWithChanges=[],effectNames=new Set;for(let ef of effects){ef.origin&&delete ef.origin;let specStep=Number(getProperty(ef,"flags.dsk.specStep"))||0;try{let customEf=Number(getProperty(ef,"flags.dsk.advancedFunction")),qs=Math.min(testData.qualityStep||0,6),resistRoll=getProperty(ef,"flags.dsk.resistRoll");if(resistRoll&&!skipResistRolls){let o=resistRoll.split(" "),e=`${o.pop()}`;resistRolls.push({skill:o.join(" "),mod:Math.round(Roll.safeEval(`${e}`.replace(/q(l|s)/i,qs).replace("step",specStep)))||0,effect:ef,target:actor,token:actor.token?actor.token.id:void 0})}else if(effectApplied=!0,effectNames.has(ef.name)||effectNames.add(ef.name),ef.changes&&ef.changes.length>0&&effectsWithChanges.push(ef),customEf)switch(customEf){case 1:{let o=duplicate(CONFIG.statusEffects.find(t=>t.id==getProperty(ef,"flags.dsk.args0"))),e=`${getProperty(ef,"flags.dsk.args1")}`||"1";o.duration=ef.duration,/,/.test(e)?e=Number(e.split(",")[qs-1]):e=Number(e.replace(game.i18n.localize("dsk.CHARAbbrev.QS"),qs)),await actor.addCondition(o,e,!1,!1)}break;case 2:game.user.can("MACRO_SCRIPT")?await eval(`(async () => {${getProperty(ef,"flags.dsk.args3")}})()`):ui.notifications.warn("You are not allowed to use JavaScript macros.");break;case 3:let creatures=(getProperty(ef,"flags.dsk.args4")||"").split(",").map(o=>`@Compendium[${o.trim().replace(/(@Compendium\[|\])/)}]`).join(" ");msg+=`<p><b>${game.i18n.localize("dsk.ActiveEffects.advancedFunctions.creature")}</b>:</p><p>${creatures}</p>`;break}}catch(o){console.warn("Unable to apply advanced effect"),console.warn(o),console.warn(ef)}}return await actor.createEmbeddedDocuments("ActiveEffect",effectsWithChanges.map(o=>(o.origin=actor.uuid,o))),{msg,resistRolls,effectApplied,effectNames:Array.from(effectNames)}}static async resistEffect(o){let e=o.currentTarget.dataset,t={token:e.token,actor:e.actor,scene:canvas.id},s=g.getSpeaker(t);if(s){let a=s.items.find(i=>i.type=="skill"&&i.name==e.skill);s.setupSkill(a,{modifier:e.mod},e.token).then(async i=>{i.testData.opposable=!1,((await s.basicTest(i)).result.qualityStep||0)<1&&await this.applyEffect(e.message,e.mode,[t],{effectIds:[e.effect],skipResistRolls:!0})})}else console.warn("Actor not found for resist roll.")}static async applyEffect(o,e,t,s={}){let a=game.messages.get(o),i=a.flags.data.preData.source,r=a.flags.data.postData,n=a.speaker;["poison","disease"].includes(i.type)&&(r.qualityStep=r.successLevel>0?2:1);let l=g.getSpeaker(n)||g.getSpeaker(getProperty(a.flags,"data.preData.extra.speaker"))||game.actors.get(getProperty(a.flags,"data.preData.extra.actor.id")),c=l,u=await this._parseEffectDuration(i,r,a.flags.data.preData,l);s.effectIds&&(u=u.filter(p=>s.effectIds.includes(p._id)));let d=[];if(e=="self"?l&&d.push(l):t?d=t.map(p=>g.getSpeaker(p)):game.user.targets.size&&game.user.targets.forEach(p=>{p.actor&&d.push(p.actor)}),game.user.isGM)for(let p of d){let{msg:f,resistRolls:k,effectApplied:T,effectNames:h}=await _DSKActiveEffectConfig.applyAdvancedFunction(p,u,i,r,c,s.skipResistRolls||!1);if(T){let b=`${game.i18n.format("dsk.ActiveEffects.appliedEffect",{target:p.token?.name||p.name,source:h.join(", ")})}${f||""}`;await ChatMessage.create(g.chatDataSetup(b))}k.length&&await this.createResistRollMessage(k,o,e)}else game.socket.emit("system.dsk",{type:"addEffect",payload:{mode:e,id:o,actors:d.map(p=>({token:p.token?p.token.id:void 0,actor:p.id,scene:canvas.scene.id}))}})}static async createResistRollMessage(o,e,t){for(let s of o){let a=await renderTemplate("systems/dsk/templates/chat/roll/resist-roll.html",{resist:s,id:e,mode:t});await ChatMessage.create(g.chatDataSetup(a))}}static async _parseEffectDuration(o,e,t,s){let a={};for(let c of t.situationalModifiers.filter(u=>u.specAbId))a[c.specAbId]=c.step;let i=Object.keys(a),r=s?s.items.filter(c=>i.includes(c.id)):[],n=o.effects?duplicate(o.effects):[];for(let c of r){let u=duplicate(c).effects;for(let d of u)setProperty(d,"flags.dsk.specStep",a[c.id]);n.push(...u)}let l=getProperty(o,"system.duration")||"";l=l.replace(" x "," * ").replace(game.i18n.localize("dsk.CHARAbbrev.QS"),e.qualityStep);try{let c=[{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEX.days"),"gi"),seconds:86400},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.weeks"),"gi"),seconds:604800},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.months"),"gi"),seconds:2592e3},{regEx:new RegExp(game.i18n.localize("dsk.DSKREGEXmaintain.years"),"gi"),seconds:3024e4}];for(let u of c)if(u.regEx.test(l)){let d=l.replace(u.regEx,"").trim(),p=await _DiceDSK._stringToRoll(d);if(!isNaN(p))for(let f of n){let k=p*u.seconds,T=getProperty(f,"flags.dsk.customDuration");if(T){let h=T.split(",")[e.qualityStep-1];h&&h!="-"&&(k=Number(h))}f.duration.seconds=k,f.duration.rounds=f.duration.seconds/5}break}}catch{console.error(`Could not parse duration '${l}' of '${o.name}'`)}return n}dropDownMenu(){let o=game.i18n.localize("dsk.MODS.FW"),e=game.i18n.localize("TYPES.Item.skill"),t=game.i18n.localize("dsk.regenerate"),s=game.i18n.localize("dsk.MODS.FP"),a=game.i18n.localize("dsk.stepValue"),i=game.i18n.localize("dsk.MODS.QS"),r=game.i18n.localize("dsk.MODS.partChecks"),n=`${game.i18n.localize("dsk.LocalizedIDs.perception")} 1`,l=`${game.i18n.localize("dsk.LocalizedIDs.wrestle")} 1`,c=game.i18n.localize("dsk.closeCombatAttacks"),u=game.i18n.localize("dsk.rangeCombatAttacks"),d=`${t} (${game.i18n.localize("dsk.CHARAbbrev.CR")})`,p=game.i18n.localize("dsk.AePCost"),f=`${game.i18n.localize("dsk.description")} 1`,k=`${game.i18n.localize("Healing")} 1`,T=[{name:game.i18n.localize("dsk.protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:`${game.i18n.localize("dsk.resistanceModifier")} (${game.i18n.localize("dsk.condition")})`,val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("dsk.carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("dsk.CHARAbbrev.AW")}`,val:"system.meleeStats.attack",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("dsk.CHARAbbrev.VW")}`,val:"system.meleeStats.parry",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:`${c} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("dsk.MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:"Elementar 1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.AW")}`,val:"system.rangeStats.attack",mode:2,ph:"1"},{name:`${u} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:`${u} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:`${game.i18n.localize("TYPES.Item.ahnengabe")} - ${game.i18n.localize("dsk.CHARAbbrev.damage")}`,val:"system.spellStats.damage",mode:2,ph:"1"},{name:p,val:"system.aepModifier",mode:2,ph:"1"},{name:`${e} - ${o}`,val:"system.skillModifiers.FW",mode:0,ph:n},{name:`${e} - ${s}`,val:"system.skillModifiers.FP",mode:0,ph:n},{name:`${e} - ${a}`,val:"system.skillModifiers.step",mode:0,ph:n},{name:`${e} - ${i}`,val:"system.skillModifiers.QL",mode:0,ph:n},{name:`${e} - ${r}`,val:"system.skillModifiers.TPM",mode:0,ph:n},{name:`${game.i18n.localize("dsk.vulnerability")} - ${game.i18n.localize("TYPES.Item.combatskill")}`,val:"system.vulnerabilities.combatskill",mode:0,ph:l},{name:`${e} - ${game.i18n.localize("dsk.MODS.global")}`,val:"system.skillModifiers.global",mode:0,ph:"1"},{name:`${d} - ${game.i18n.localize("dsk.LeP")}`,val:"system.repeatingEffects.startOfRound.LeP",mode:0,ph:"1d6"},{name:`${d} - ${game.i18n.localize("dsk.AeP")}`,val:"system.repeatingEffects.startOfRound.AeP",mode:0,ph:"1d6"},{name:`${t} - ${game.i18n.localize("dsk.LeP")}`,val:"system.stats.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:`${t} - ${game.i18n.localize("dsk.AeP")}`,val:"system.stats.regeneration.AePgearmodifier",mode:2,ph:"1"},{name:`${game.i18n.localize("dsk.advanced")} - ${p}`,val:"system.skillModifiers.conditional.AePCost",mode:0,ph:f}],h=["ahnengabe","skill","feature"];for(let b of h){let w=b=="skill"?"skillglobal":b,I=g.categoryLocalization(w);T.push({name:`${I} - ${o}`,val:`system.skillModifiers.${b}.FW`,mode:0,ph:n},{name:`${I} - ${s}`,val:`system.skillModifiers.${b}.FP`,mode:0,ph:n},{name:`${I} - ${a}`,val:`system.skillModifiers.${b}.step`,mode:0,ph:n},{name:`${I} - ${i}`,val:`system.skillModifiers.${b}.QL`,mode:0,ph:n},{name:`${I} - ${r}`,val:`system.skillModifiers.${b}.TPM`,mode:0,ph:n})}let y=["inpain","selfconfidence","encumbered","stunned","feared"];for(let b of y)T.push({name:game.i18n.localize(`dsk.CONDITION.${b}`),val:`system.status.${b}`,mode:2,ph:1});for(let b of Object.keys(v.characteristics))T.push({name:game.i18n.localize(`dsk.characteristics.${b}.name`),val:`system.characteristics.${b}.gearmodifier`,mode:2,ph:"1"});for(let b of v.gearModifyableCalculatedAttributes)T.push({name:game.i18n.localize(`dsk.${b}`),val:`system.stats.${b}.gearmodifier`,mode:2,ph:"1"});T=T.sort((b,w)=>b.name.localeCompare(w.name));for(let b of T)(!b.ph||b.mode==null)&&console.warn(b);return T=T.map(b=>`<option value="${b.val}" data-mode="${b.mode}" data-ph="${b.ph}">${b.name}</option>`).join(`
`),`<select class="selMenu">${T}</select>`}activateListeners(o){super.activateListeners(o);let e=this.dropDownMenu();o.find(".changes-list .effect-change .key").append(e),o.find(".selMenu").change(t=>{let s=$(t.currentTarget);s.siblings("input").val(s.val());let a=s.closest(".effect-change"),i=s.find("option:selected");a.find(".mode select").val(i.attr("data-mode")),a.find(".value input").attr("placeholder",i.attr("data-ph")),s.blur()})}};m(_DSKActiveEffectConfig,"DSKActiveEffectConfig");var q=class{static async playEffect(e,t,s,a=void 0,i=!1){let r=await this.getSound(e,t,s);if(r)try{a?(game.socket.emit("system.dsk",{type:"playWhisperSound",payload:{whisper:a,soundPath:r}}),i||AudioHelper.play({src:r,volume:.8,loop:!1},!1)):AudioHelper.play({src:r,volume:.8,loop:!1},!0)}catch{console.warn(`Could not play item sound effect ${r}`)}}static async loadSoundConfig(){let e=await game.settings.get("dsk","soundConfig");if(e)try{let s=await(await fetch(e)).json();this.sounds=s,console.log("DSK | Sound Config Loaded")}catch(t){console.warn(t)}}static successLevelToString(e){switch(e){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}static async getSound(e,t,s){if(!this.sounds&&!this.triedInit&&(await this.loadSoundConfig(),this.triedInit=!0),!this.sounds)return;let a=this.successLevelToString(s),i=[],r;switch(t.type){case"meleeweapon":case"rangeweapon":i=[...a.map(n=>`${t.type}.manual.${t.name}.${e}_${n}`),`${t.type}.manual.${t.name}.${e}`,`${t.type}.manual.${t.name}.default.${e}`,`${t.type}.manual.${t.name}.default`,...a.map(n=>`${t.type}.${t.system.combatskill}.${e}_${n}`),`${t.type}.${t.system.combatskill}.${e}`,...a.map(n=>`${t.type}.${t.system.combatskill}.default_${n}`),`${t.type}.${t.system.combatskill}.default`];break;case"skill":i=[...a.map(n=>`${t.type}.${t.name}.${e}_${n}`),`${t.type}.${t.name}.${e}`,...a.map(n=>`${t.type}.${t.name}.default_${n}`),`${t.type}.${t.name}.default`];break;case"ahnengabe":i=[...a.map(n=>`${t.type}.${t.name}.${e}_${n}`),`${t.type}.${t.name}.${e}`,...a.map(n=>`${t.type}.${t.name}.default_${n}`),`${t.type}.${t.name}.default`];break}i.push(...a.map(n=>`${t.type}.default_${n}`),`${t.type}.default`);for(let n of i)if(!!hasProperty(this.sounds,n)&&(r=getProperty(this.sounds,n),r&&(typeof r=="string"||r instanceof String)))break;return r}static async playMoneySound(e=!1){if(!game.modules.get("gAudioBundle-3"))return;let t=["modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"],s=t[Math.floor(Math.random()*t.length)];await this.playSoundPath(s,e)}static async playEquipmentWearStatusChange(e,t=!1){let s=[],a=game.modules.get("gAudioBundle-2"),i=game.modules.get("gAudioBundle-3"),r=game.modules.get("gAudioBundle-4");switch(e.type){case"armor":a&&s.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg");break;case"meleeweapon":a&&s.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),i&&s.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg");break;case"rangeweapon":r&&s.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg");break}if(s.length==0&&a&&s.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg"),s.length>0){let n=s[Math.floor(Math.random()*s.length)];await this.playSoundPath(n,t,.5)}}static async playSoundPath(e,t=!1,s=.8){if(!!game.settings.get("dsk","inventorySound"))try{AudioHelper.play({src:e,volume:s,loop:!1},t)}catch{console.warn(`Could not play item sound effect ${e}`)}}};m(q,"DSKSoundEffect"),z(q,"sounds"),z(q,"triedInit",!1);var V=class{constructor(e){this.item=e}async callMacro(e,t,s={}){let i=await game.packs.get(e).getDocuments({name:t});if(!i.length){for(let n of game.packs.filter(l=>l.documentName=="Macro"&&/\(internal\)/.test(l.metadata.label)))if(i=await n.getDocuments({name:t}),i.length)break}let r={};if(i.length){let n=`(async () => {${i[0].command}})()`,l=Function("args","actor","item",n);try{s.result=r,await l.call(this,s,this.item.actor,this.item)}catch(c){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(c),r.error=!0}}else ui.notifications.error(game.i18n.format("dsk.DSKError.macroNotFound",{name:t}));return r}async executeOnUseEffect(){if(!game.user.can("MACRO_SCRIPT"))return ui.notifications.warn("You are not allowed to use JavaScript macros.");if(!this.item.actor)return;let t=`(async () => {${V.getOnUseEffect(this.item)}})()`,s=Function("item","actor",t);try{await s.call(this,this.item,this.item.actor)}catch(a){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(a),console.warn(a.stack)}}static getOnUseEffect(e){return e.getFlag("dsk","onUseEffect")}async automatedAnimation(e,t={}){g.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}effectDummy(e,t,s){return{label:e,icon:"icons/svg/aura.svg",changes:t,duration:s,flags:{dsk:{value:null,editable:!0,customizable:!0,description:e,custom:!0}}}}async socketedConditionAddActor(e,t){if(game.user.isGM){let s=typeof t=="string";s&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let a=[];for(let i of e)s?await i.addCondition(t,1,!1,!1):await i.addCondition(t),a.push(i.name);await this.createInfoMessage(t,a)}else{let s={id:this.item.uuid,data:t,actors:e.map(a=>a.id)};game.socket.emit("system.dsk",{type:"socketedConditionAddActor",payload:s})}}async createInfoMessage(e,t,s=!0){if(t.length){let a=s?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",i=game.i18n.format(a,{source:e.label,target:t.join(", ")});await ChatMessage.create(g.chatDataSetup(i))}}async socketedRemoveCondition(e,t,s=1){if(game.user.isGM){let a=[];for(let r of e){let n=canvas.tokens.get(r);n.actor&&(await n.actor.removeCondition(t,s,!1),a.push(n.name))}let i=CONFIG.statusEffects.find(r=>r.id==t);i.name=game.i18n.localize(i.name),await this.createInfoMessage(i,a,!1)}else{let a={id:this.item.uuid,coreId:t,targets:e};game.socket.emit("system.dsk",{type:"socketedRemoveCondition",payload:a})}}async socketedActorTransformation(e,t){if(game.user.isGM)for(let s of e){let a=canvas.tokens.get(s);a.actor&&await a.actor.update(t)}else{let s={id:this.item.uuid,targets:e,update:t};game.socket.emit("system.dsk",{type:"socketedActorTransformation",payload:s})}}async socketedConditionAdd(e,t){if(game.user.isGM){let s=typeof t=="string";s&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let a=[];for(let i of e){let r=canvas.tokens.get(i);r.actor&&(s?await r.actor.addCondition(t,1,!1,!1):await r.actor.addCondition(t),a.push(r.name))}await this.createInfoMessage(t,a)}else{let s={id:this.item.uuid,data:t,targets:e};game.socket.emit("system.dsk",{type:"socketedConditionAdd",payload:s})}}};m(V,"OnUseEffect");var Q=class{static async showBotchCard(e,t={}){t.speaker={token:e.token,actor:e.actor,scene:e.scene},t.source=e.source;let s=v.systemTables.find(u=>u.name==e.table),a=await Q.getRollTable(s.pack[game.i18n.lang],game.i18n.localize(`dsk.TABLENAMES.${e.table}`),e),i=t.speaker?await Q.hasEffect(a):!1,r=g.replaceDies(g.replaceConditions(a.results[0].text)),n=`${game.i18n.localize("dsk.TABLENAMES."+e.table)}`,l=await renderTemplate("systems/dsk/templates/tables/tableCard.html",{result:r,title:n,hasEffect:i}),c=await this.buildEffects(a,i);ChatMessage.create({user:game.user.id,content:l,whisper:t.whisper,blind:t.blind,flags:{data:{preData:{source:{effects:c},extra:{actor:{id:t.speaker.actor},speaker:t.speaker},situationalModifiers:[]},postData:{}},dsk:{hasEffect:i,options:t}}})}static async hasEffect(e){return getProperty(e.results[0],"flags.dsk")||!1}static async buildEffects(e,t){let s=[];if(t&&t.resistEffect){let a=new V().effectDummy(t.resistEffect.fail.description,t.resistEffect.changes||[],t.resistEffect.duration||{});t.resistEffect.fail.systemEffect&&mergeObject(a,{_id:"botchEffect",flags:{dsk:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:'await actor.addCondition("prone");'}}}),s.push(a)}return s}static async getRollTable(e,t,s={}){let i=(await game.packs.get(e).getDocuments({name__in:[t]}))[0],r=await i.draw({displayChat:!1});return s.weaponless=="true"&&r.roll.total<7&&(r.roll.editRollAtIndex([{index:0,val:r.roll.total+5}]),r=await i.draw({displayChat:!1,roll:r.roll})),r}static async tableEnabledFor(e){let t=v.systemTables.find(s=>s.name==e);return t?game.settings.get(t.setting.module,t.setting.key):!1}static rollCritBotchButton(e,t,s){let a=game.i18n.localize(`dsk.TABLENAMES.${e}`),i=s.extra.speaker,r=s.source._id;return`, <a class="roll-button botch-roll" data-table="${e}" data-weaponless="${t}" data-source="${r}" data-token="${i.token}" data-actor="${i.actor}" data-scene="${i.scene}"><i class="fas fa-dice"></i>${a}</a>`}static async defaultBotch(){return", "+game.i18n.localize("dsk.selfDamage")+(await new Roll("1d6+2").evaluate({async:!0})).total}static defaultAttackCrit(e){let t=", "+game.i18n.localize("dsk.halfDefense");return e&&(t+=", "+game.i18n.localize("dsk.doubleDamage")),t}static defaultParryCrit(){return", "+game.i18n.localize("dsk.attackOfOpportunity")}};m(Q,"DSKTables");var oe=class{constructor(){oe.skills.length==0&&g.allSkills(["skill"]).then(e=>{oe.skills=e.map(t=>({name:t.name,type:"skill"})).concat(Object.values(game.dsk.config.characteristics).map(t=>({name:game.i18n.localize(t),type:"attribute"})).concat({name:game.i18n.localize("dsk.regenerate"),type:"regeneration"}))}),this.regex,this.filtering=!1}get regex(){return new RegExp(`^/(${oe.cmds.join(" |")})`)}async chatListeners(e){let t=this;this.anchor=$("#chat-message").parent(),$("#chat-message").off("keydown",ui.chat._onChatKeyDownBinding),e.on("keyup","#chat-message",async function(s){t._parseInput(s)}),e.on("click",".quick-item",async function(s){t._quickSelect($(s.currentTarget))}),e.on("keydown","#chat-message",function(s){t._navigateQuickFind(s)})}_parseInput(e){let t=e.target.value;if(this.regex.test(t)){if([38,40,13,9].includes(e.which))return!1;if(e.which==27)return this._closeQuickfind(),!1;let s=this._getCmd(t),a=t.substring(1+s.length).toLowerCase().trim();this[`_filter${s}`](a),this.filtering=!0}else this._closeQuickfind()}_getCmd(e){return e.substring(1,3).toUpperCase().trim()}_completeCurrentEntry(e){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+e.text())+""}_closeQuickfind(){this.filtering=!1,this.anchor.find(".quickfind").remove()}_filterW(e){let t=game.users.contents.filter(s=>s.active&&s.name.toLowerCase().trim().indexOf(e)!=-1).map(s=>({name:s.name,type:"user"}));this._checkEmpty(t),this._setList(t,"W")}_filterAT(e){let{actor:t,tokenId:s}=oe._getActor();if(t){let a=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],r=t.items.filter(n=>(a.includes(n.type)&&n.system.worn.value==!0||n.type=="trait"&&i.includes(n.system.traitType))&&n.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(n=>({name:n.name,type:"item"}));this._checkEmpty(r),this._setList(r,"AT")}}_filterAH(e){let{actor:t,tokenId:s}=oe._getActor();if(t){let a=["ahnengabe"],i=t.items.filter(r=>a.includes(r.type)&&r.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(r=>({name:r.name,type:"item"}));this._checkEmpty(i),this._setList(i,"SP")}}_checkEmpty(e){e.length||e.push({name:game.i18n.localize("dsk.DSKError.noMatch"),type:"none"})}_getSkills(e,t=void 0){e=e.replace(/(-|\+)?\d+/g,"").trim();let s=oe.skills.filter(a=>a.name.toLowerCase().trim().indexOf(e)!=-1&&(t==null||t==a.type)).slice(0,5);return this._checkEmpty(s),s}_filterCH(e){this._setList(this._getSkills(e),"CH")}_filterSK(e){this._setList(this._getSkills(e),"SK")}_filterRQ(e){this._setList(this._getSkills(e),"RQ")}_setList(e,t){let s=$(`<div class="quickfind dsklist"><ul>${e.map(i=>`<li data-type="${i.type}" data-category="${t}" class="quick-item">${i.name}</li>`).join("")}</ul></div>`);s.find(".quick-item:first").addClass("focus");let a=this.anchor.find(".quickfind");a.length?a.replaceWith(s):this.anchor.append(s)}_navigateQuickFind(e){if(this.filtering){let t=this.anchor.find(".focus");switch(e.which){case 38:return t.prev(".quick-item").length&&t.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return t.next(".quick-item").length&&t.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if(t.attr("data-category")=="W")break;return e.stopPropagation(),e.preventDefault(),this._quickSelect(t),!1;case 9:return e.stopPropagation(),e.preventDefault(),this._completeCurrentEntry(t),!1}}ui.chat._onChatKeyDown(e)}static _getActor(){let e=ChatMessage.getSpeaker(),t;return e.token&&(t=game.actors.tokens[e.token]),t||(t=game.actors.get(e.actor)),t?{actor:t,tokenId:e.token}:(ui.notifications.error(game.i18n.localize("dsk.DSKError.noProperActor")),{})}_quickSelect(e){let t=e.attr("data-category");switch(t){case"NM":case"RQ":case"CH":this[`_quick${t}`](e);break;case"W":this._completeCurrentEntry(e);break;default:let{actor:s,tokenId:a}=oe._getActor();s&&(this._resetChatAutoCompletion(),this[`_quick${t}`](e,s,a))}}_quickW(e,t,s){}_quickCH(e){F.check3D20(e),this._resetChatAutoCompletion()}_quickSK(e,t,s){switch(e.attr("data-type")){case"skill":let a=t.items.find(r=>r.name==e.text()&&r.type=="skill");a&&t.setupSkill(a,{},s).then(r=>{t.basicTest(r)});break;case"attribute":let i=Object.keys(game.dsk.config.characteristics).find(r=>game.i18n.localize(game.dsk.config.characteristics[r])==e.text());t.setupCharacteristic(i,{},s).then(r=>{t.basicTest(r)});break;case"regeneration":t.setupRegeneration("regenerate",{},s).then(r=>{t.basicTest(r)});break}}_resetChatAutoCompletion(){$("#chat-message").val(""),this.anchor.find(".quickfind").remove()}_quickRQ(e){let t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(),Z.showRQMessage(e.text(),t)}_quickAT(e,t,s){let a=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],r=t.items.find(n=>a.includes(n.type)&&n.name==e.text());r||(r=t.items.find(n=>n.type=="trait"&&n.name==e.text()&&i.includes(n.system.traitType))),r&&t.setupWeapon(r,"attack",{},s).then(n=>{t.basicTest(n)})}_quickSP(e,t,s){let a=["ahnengabe"],i=t.items.find(r=>a.includes(r.type)&&r.name==e.text());i&&t.setupSpell(i,{},s).then(r=>{t.basicTest(r)})}static async infoItemAsync(e){(await fromUuid(e)).postItem()}static bindRollCommands(e){e.on("click",".request-roll",t=>(Z.showRQMessage(t.currentTarget.dataset.name,Number(t.currentTarget.dataset.modifier)||0),t.stopPropagation(),!1)),e.on("click",".postInfo",t=>{let s=fromUuidSync(t.currentTarget.dataset.uuid);return s&&(typeof s.postItem=="function"?s.postItem():this.infoItemAsync(t.currentTarget.dataset.uuid)),t.stopPropagation(),!1}),e.on("click",".postContentChat",async t=>{let s=$(t.currentTarget).closest(".postChatSection").find(".postChatContent").html();we.getDialog(s)}),e.on("click",".request-CH",t=>(F.check3D20(void 0,t.currentTarget.dataset.name,{modifier:Number(t.currentTarget.dataset.modifier)||0}),t.stopPropagation(),!1))}},B=oe;m(B,"DSKChatAutoCompletion"),z(B,"skills",[]),z(B,"cmds",["sk","at","ah","rq","w","ch"]);var Z=class{static async requestRoll(e,t,s=0){let{actor:a,tokenId:i}=B._getActor();if(a){game.user.updateTokenTargets([]);let r={modifier:s};switch(e){case"attribute":let n=Object.keys(game.dsk.config.characteristics).find(c=>game.i18n.localize(game.dsk.config.characteristics[c])==t);a.setupCharacteristic(n,r,i).then(c=>{a.basicTest(c)});break;case"regeneration":a.setupRegeneration("regenerate",r,i).then(c=>{a.basicTest(c)});break;default:let l=a.items.find(c=>c.name==t&&c.type==e);a.setupSkill(l,r,i).then(c=>{a.basicTest(c)})}}}static showRQMessage(e,t=0){let s=t<0?` ${t}`:t>0?` +${t}`:"",a=B.skills.find(r=>r.name==e).type,i=game.i18n.format("dsk.CHATNOTIFICATION.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${a}" data-modifier="${t}" data-name="${e}"><i class="fas fa-dice"></i> ${e}${s}</a>`});ChatMessage.create(g.chatDataSetup(i))}static async updateInformationRoll(e,t,s){let a=t.result.qualityStep||0;if(a>0){let i=await fromUuid(e.uuid),r=[`<p><b>${i.name}</b></p>`];for(let l=1;l<=a;l++){let c=`qs${l}`;i.system[c]&&r.push(`<p>${i.system[c]}</p>`)}let n=g.chatDataSetup(r.join(""));e.recipients.length&&(n.whisper=e.recipients),ChatMessage.create(n)}}static async informationRequestRoll(e){let t=e.currentTarget.dataset.mod,s=e.currentTarget.dataset.uuid,{actor:a,tokenId:i}=B._getActor();if(!a)return;let r=game.settings.get("dsk","informationDistribution"),n=[];r==1?(n=game.users.filter(u=>u.isGM).map(u=>u.id),n.push(game.user.id)):r==2&&(n=game.users.filter(u=>u.isGM).map(u=>u.id));let l={modifier:t,postFunction:{functionName:"game.dsk.apps.RequestRoll.updateInformationRoll",uuid:s,recipients:n}},c=a.items.find(u=>u.name==e.currentTarget.dataset.skill&&u.type=="skill");a.setupSkill(c,l,i).then(async u=>{u.testData.opposable=!1;let d=await a.basicTest(u);this.updateInformationRoll(l.postFunction,d)})}static chatListeners(e){e.on("click",".request-roll",t=>{let s=t.currentTarget.dataset;Z.requestRoll(s.type,s.name,Number(s.modifier)||0)}),e.on("click",".informationRequestRoll",t=>Z.informationRequestRoll(t))}};m(Z,"RequestRoll");var le=class extends j{static async traitAdded(e,t){v.addTraitRules[t.name]&&await v.addTraitRules[t.name](e,t)}static hasTrait(e,t){return super.hasItem(e,t,["trait"])}};m(le,"TraitRulesDSK");var _DiceDSK=class{static async rollTest(o){let e;switch(o.source.type){case"ahnengabe":e=await this.rollSpell(o);break;case"skill":e=await this.rollTalent(o);break;case"combatskill":e=await this.rollCombatskill(o);break;case"regenerate":e=await this.rollRegeneration(o);break;case"trait":e=o.mode=="damage"?await this.rollDamage(o):await this.rollCombatTrait(o),o.mode!="damage"&&await this.updateDefenseCount(e);break;case"meleeweapon":case"rangeweapon":e=o.mode=="damage"?await this.rollDamage(o):await this.rollWeapon(o),o.mode!="damage"&&await this.updateDefenseCount(e);break;case"poison":e=await this.rollItem(o);break;default:e=await this.rollAttribute(o)}return mergeObject(e,deepClone(o.extra)),e}static async updateDefenseCount(o){game.combat&&await game.combat.updateDefenseCount(Array.from(game.user.targets).map(e=>e.id))}static async setupDialog({dialogOptions:o,testData:e,cardOptions:t}){let s=await game.settings.get("core","rollMode"),a=0;typeof e.source.toObject=="function"&&(e.source=e.source.toObject(!1)),mergeObject(e,{testDifficulty:a}),mergeObject(o.data,{testDifficulty:a,testModifier:o.data.modifier||0});let i=o.data.situationalModifiers||(e.extra.actor?O.getRollModifiers(e.extra.actor,e.source):[]);e.extra.options.moreModifiers!=null&&i.push(...e.extra.options.moreModifiers);let r=[];if(game.user.targets.forEach(n=>{n.actor&&r.push({name:n.actor.name,id:n.id,img:n.actor.img})}),mergeObject(o.data,{hasSituationalModifiers:i.length>0,situationalModifiers:i,rollMode:o.data.rollMode||s,rollModes:CONFIG.Dice.rollModes,defenseCount:await this.getDefenseCount(e),targets:r}),mergeObject(t,{user:game.user.id}),e.extra.options.bypass)return t.rollMode=e.extra.options.rollMode||s,e.situationalModifiers||(e.situationalModifiers=[]),{testData:e,cardOptions:t};{let n=await renderTemplate(o.template,o.data);return new Promise((l,c)=>{let u=G.getDialogForItem(e.source.type);new u({title:o.title,content:n,buttons:u.getRollButtons(e,o,l,c),default:"rollButton"}).recallSettings(e.extra.speaker,e.source,e.mode).render(!0)})}}static _appendSituationalModifiers(o,e,t,s=""){let a=o.situationalModifiers.find(i=>i.name==e);a?a.value=t:o.situationalModifiers.push({name:e,value:t,type:s})}static _situationalPartCheckModifiers(o){return o.situationalModifiers.reduce(function(e,t){if(t.type=="TPM"){let s=t.value.split("|");return s.length!=2||(e[0]=e[0]+Number(s[0]),e[1]=e[1]+Number(s[1])),e}else return e},[0,0])}static _situationalModifiers(o,e=""){return o.situationalModifiers.reduce(function(t,s){return t+((s.type==e||e==""&&s.type==null)&&Number(s.value)||0)},0)}static async getDefenseCount(o){let e=Array.from(game.user.targets);return game.combat&&e[0]?await game.combat.getDefenseCount({token:e[0].id}):0}static async rollTalent(o){let e=await this._roll2D20(o);return e.rollType="talent",e}static async rollAttribute(o){let e=await this._roll2D20(o);return e.rollType="attribute",e}static get2D20SuccessLevel(o,e,t=20,s=1){let a=o.terms.filter(r=>r.results&&r.results[0].result<=s).length,i=o.terms.filter(r=>r.results&&r.results[0].result>=t).length;return a>=2?a:i>=2?i*-1:e>=0?1:-1}static async _addRollDiceSoNice(o,e,t){if(o.rollMode){for(let s=0;s<e.dice.length;s++)mergeObject(e.dice[s].options,t);await this.showDiceSoNice(e,o.rollMode)}}static async rollSpell(o){let e=await this._roll2D20(o);if(e.rollType=o.source.types,e.preData.calculatedSpellModifiers.finalcost=Number(e.preData.calculatedSpellModifiers.cost),e.successLevel>=2){let t=10;e.description=e.description+", "+game.i18n.localize("dsk.additionalQLs")+" "+t,e.qualityStep=Math.min(6,Math.ceil(e.result/5)+2),e.preData.calculatedSpellModifiers.finalcost=Math.round(e.preData.calculatedSpellModifiers.cost/2)}else e.successLevel<=-2&&(e.description+=Q.rollCritBotchButton("Ahnen",!1,o));if(e.successLevel>0&&o.source.system.effectFormula!=""){let t=o.source.system.effectFormula.replace(game.i18n.localize("dsk.CHARAbbrev.QS"),e.qualityStep).replace(/[Ww]/g,"d"),s=[];for(let n of o.situationalModifiers)n.armorPen&&s.push(n.armorPen);/(,|;)/.test(t)&&(t=t.split(/[,;]/)[e.qualityStep-1]);let a=o.damageRoll?Roll.fromData(o.damageRoll):await _DiceDSK.manualRolls(await new Roll(t).evaluate({async:!0}),"dsk.CHAR.DAMAGE",o.extra.options);this._addRollDiceSoNice(o,a,game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),e.calculatedEffectFormula=t;for(let n of a.terms)if(n instanceof Die||n.class=="Die")for(let l of n.results)e.characteristics.push({char:"effect",res:l.result,die:"d"+n.faces});let i=[],r=await _DiceDSK._stringToRoll(o.extra.actor.system.spellStats.damage,o);r!=0&&i.push(game.i18n.localize("dsk.statuseffects")+" "+r),e.armorPen=s,e.damageRoll=damageRoll.toJSON(),e.damage=a.total+r,e.damagedescription=i.join(`
`)}return this.calculateEnergyCost(e,o),e}static calculateEnergyCost(o,e){let t=[];if(o.successLevel<0){let n=["traditionWitch","traditionFjarning","braniborian"].map(c=>game.i18n.localize(`dsk.LocalizedIDs.${c}`)),l=e.extra.actor.items.some(c=>c.type=="specialability"&&n.includes(c.name))?3:2;o.preData.calculatedSpellModifiers.finalcost=Math.round(o.preData.calculatedSpellModifiers.finalcost/l)}let s="AePCost",a=game.i18n.localize("dsk.LocalizedIDs.weakAstralBody"),i=game.i18n.localize(`dsk.LocalizedIDs.${o.successLevel>0?"energyControl":"smallEnergyControl"}`),r={val:"aepModifier",name:"AeP"};t.push({name:a,value:E.vantageStep(e.extra.actor,a)},{name:i,value:x.abilityStep(e.extra.actor,i)*-1},{name:`${game.i18n.localize("dsk.statuseffects")} (${game.i18n.localize("dsk.CHARAbbrev."+r.name)})`,value:e.extra.actor.system[r.val]+this._situationalModifiers(e,s)}),t=t.filter(n=>n.value!=0),o.preData.calculatedSpellModifiers.description=t.map(n=>`${n.name} ${n.value}`).join(`
`),o.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(o.preData.calculatedSpellModifiers.finalcost)+t.reduce((n,l)=>n+l.value,0))}static async _stringToRoll(o,e){let t=[],s=/\d{1}[dDwW]\d/g,a=`${o}`;a.replace(s,function(n){t.push(new Roll(n.replace(/[Ww]/,"d")).evaluate({async:!0}))});let i=await Promise.all(t),r=a.replace(s,()=>{let n=i.shift();return e&&_DiceDSK._addRollDiceSoNice(e,n,game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),n.total});return await Roll.safeEval(r)}static async detailedWeaponResult(o,e,t){if(e.mode=="attack")switch(o.successLevel){case 2:o.description+=Q.defaultAttackCrit(!0),o.doubleDamage=!0;break;case-2:let s=t.type=="meleeweapon"||getProperty(t,"system.traitType")=="meleeAttack",a=getProperty(t,"system.combatskill")==game.i18n.localize("dsk.LocalizedIDs.wrestle")||t.type=="trait";s?o.description+=Q.rollCritBotchButton("Melee",a,e):o.description+=Q.rollCritBotchButton("Range",!1,e);break}}static async evaluateDamage(o,e,t,s,a){let i=t.system.tp.replace(/[Ww]/g,"d"),r=[],n=t.dmgMultipliers||[],l=n.map(h=>`${h.name} *${h.val}`),c=[],u=0;for(let h of o.situationalModifiers){let y=0;if(h.armorPen&&c.push(h.armorPen),h.damageBonus){if(/^\*/.test(h.damageBonus)){n.push({name:h.name,val:Number(h.damageBonus.replace("*",""))});continue}let b=/^=/.test(h.damageBonus),w=`${h.damageBonus}`.replace(/^=/,""),I=await _DiceDSK._stringToRoll(w,o);if(y=I*(h.step||1),b){i=w.replace(/[Ww]/,"d"),r.push({name:h.name,roll:I});continue}else h.damageBonus=I,u+=y}}let d=o.damageRoll?Roll.fromData(o.damageRoll):await _DiceDSK.manualRolls(await new Roll(i).evaluate({async:!0}),"dsk.damage",o.extra.options),p=d.total,f=0;for(let h of d.terms)if(h instanceof Die||h.class=="Die")for(let y of h.results)f+=Number(y.result),e.characteristics.push({char:"damage",res:y.result,die:"d"+h.faces});let k=p-f;if(r.length>0)l.push(r[0].name+" "+p);else{p+=u,l.push(game.i18n.localize("dsk.Roll")+" "+f),k!=0&&l.push(game.i18n.localize("dsk.weaponModifier")+" "+k),o.situationalModifiers.reduce((b,w)=>{if(w.damageBonus){let I=/^\*/.test(w.damageBonus)?w.damageBonus:Number(w.damageBonus)*(w.step||1);l.push(`${w.name} ${I}`)}},l),o.situationalModifiers.find(b=>b.name.indexOf(game.i18n.localize("dsk.CONDITION.bloodrush"))>-1)&&(p+=2,l.push(game.i18n.localize("dsk.CONDITION.bloodrush")+" "+2)),t.extraDamage&&(p=Number(t.extraDamage)+Number(p),l.push(game.i18n.localize("dsk.damageThreshold")+" "+t.extraDamage));let h;if(s){let b=v.rangeMods[o.rangeModifier||"medium"].damage;p+=b,b!=0&&l.push(game.i18n.localize("dsk.distance")+" "+b),h=o.extra.actor.system.rangeStats.damage}else h=o.extra.actor.system.meleeStats.damage;let y=await _DiceDSK._stringToRoll(h,o);y!=0&&(p+=y,l.push(game.i18n.localize("dsk.statuseffects")+" "+y))}let T=game.i18n.localize("dsk.LocalizedIDs.feint");e.qualityStep>0&&!o.situationalModifiers.find(h=>h.name==T)&&(p+=e.qualityStep,l.push(game.i18n.localize("dsk.qualityStep")+" "+e.qualityStep)),a&&(p=p*3,l.push(game.i18n.localize("dsk.doubleDamage")));for(let h of n)p=p*h.val;e.armorPen=c,e.damagedescription=l.join(", "),e.damage=Math.round(p),e.damageRoll=d.toJSON()}static parseEffect(o){let e=o.system.effect?o.system.effect:void 0,t=[];if(e){let a=/^[a-z]+\|[a-zA-z ]+$/;for(let i of e.split(";"))if(a.test(i.trim())){let r=i.split("|").map(n=>n.trim());if(r[0]=="condition"){let n=CONFIG.statusEffects.find(l=>l.id==r[1]);t.push(`<a class="chat-condition chatButton" data-id="${n.id}">
                            <img src="${n.icon}"/>${game.i18n.localize(n.name)}
                            </a>`)}else t.push(`<a class="roll-button roll-item" data-name="${r[1]}" data-type="${r[0]}"><i class="fas fa-dice"></i>${game.i18n.localize(r[0])}: ${r[1]}</a>`)}}let s=getProperty(o,"flags.dsk.poison");return s&&t.push(`<a class="roll-button roll-item" data-removecharge="${!s.permanent}" data-name="${s.name}" data-type="poison"><i class="fas fa-dice"></i>${game.i18n.localize("TYPES.Item.poison")}: ${s.name}</a>`),t.join(", ")}static async _roll2D20(o){let e=o.roll?Roll.fromData(o.roll):await new Roll("1d20+1d20").evaluate({async:!0}),t=[],s=0;if(o.testDifficulty&&this._appendSituationalModifiers(o,game.i18n.localize("dsk.Difficulty"),o.testDifficulty),o.vw){let f=o.situationalModifiers.reduce((T,h)=>T+(Number(h.dmmalus)||0),0),k=Math.max(0,Number(o.vw)-f);this._appendSituationalModifiers(o,game.i18n.localize("dsk.ABBR.VW"),-1*k)}let a=this._situationalModifiers(o),i=this._situationalPartCheckModifiers(o,"TPM"),r=o.source.attack||Number(o.source.system.at);r||(o.source.system.level==null?r=-5+o.extra.actor.system.characteristics[o.source.system.characteristic1].value+o.extra.actor.system.characteristics[o.source.system.characteristic2].value:r=o.source.system.level+5+Math.round((o.extra.actor.system.characteristics[o.source.system.characteristic1].value+o.extra.actor.system.characteristics[o.source.system.characteristic2].value)/2));let n=r+this._situationalModifiers(o,"FW")+i[0]+i[1]+a;o.advancedModifiers&&(n+=o.advancedModifiers.fws+o.advancedModifiers.chars[0]+o.advancedModifiers.chars[1]);let l=n-e.terms[0].results[0].result-e.terms[2].results[0].result,c=1,u=20;if(o.source.type=="skill"&&E.hasVantage(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.incompetent")} (${o.source.name})`)){let f=await new Roll("1d20").evaluate({async:!0}),k=res.reduce((h,y,b,w)=>y<w[h]?b:h,0),T=e.terms[k*2].total;l+=Math.max(res[k],0),l-=Math.max(0,f.total-tar[k]),e.editRollAtIndex([{index:k,val:f.total}]),this._addRollDiceSoNice(o,f,e.terms[k*2].options),t.push(game.i18n.format("dsk.CHATNOTIFICATION.unableReroll",{die:k+1,oldVal:T,newVal:f.total}))}let d=0;o.source.type=="skill"&&le.hasTrait(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.automaticSuccess")} (${o.source.name})`)?(t.push(game.i18n.localize("dsk.LocalizedIDs.automaticSuccess")),s=1,d=1):o.source.type=="skill"&&le.hasTrait(o.extra.actor,`${game.i18n.localize("dsk.LocalizedIDs.automaticFail")} (${o.source.name})`)?(t.push(game.i18n.localize("dsk.LocalizedIDs.automaticFail")),s=-1):(s=_DiceDSK.get2D20SuccessLevel(e,l,u,c),o.routine&&(s=1),t.push(_DiceDSK.getSuccessDescription(s))),t=t.join(", ");let p=0;return s>0&&(l+=this._situationalModifiers(o,"FP"),p=Math.max(1,(l==0?1:l>0?Math.ceil(l/5):0)+(o.qualityStep!=null?Number(o.qualityStep):0))+(o.advancedModifiers?.qls||0)+this._situationalModifiers(o,"QL")),p<d&&(p=d),{result:l,characteristics:[0,1].map(f=>({char:o.source.system[`characteristic${f+1}`]||o.source.type,res:e.terms[f*2].results[0].result,tar:o.extra.actor?.system.characteristics[o.source.system[`characteristic${f+1}`]]?.value})),qualityStep:p,pw:n,roll:e,description:t,preData:o,successLevel:s,modifiers:a,extra:{}}}static async renderRollCard(chatOptions,testData,rerenderMessage){let applyEffect=this.addApplyEffectData(testData),preData=deepClone(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:preData.mode=="attack";await Hooks.call("postProcessDSKRoll",chatOptions,testData,rerenderMessage,hideDamage),delete preData.extra.actor,delete testData.actor,delete testData.preData;let hasAreaTemplate=testData.successLevel>0&&preData.source.system.target&&preData.source.system.target.type in game.dsk.config.areaTargetTypes,chatData={title:chatOptions.title,testData,hideData:game.user.isGM,preData,hideDamage,modifierList:preData.situationalModifiers.filter(o=>o.value!=0),applyEffect,hasAreaTemplate};if(preData.advancedModifiers&&(preData.advancedModifiers.chars.some(o=>o!=0)&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.partChecks"),value:preData.advancedModifiers.chars}),preData.advancedModifiers.fws!=0&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.FW"),value:preData.advancedModifiers.fws}),preData.advancedModifiers.qls!=0&&chatData.modifierList.push({name:game.i18n.localize("dsk.MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter(o=>o.isGM).map(o=>o.id)),chatOptions.rollMode==="blindroll"?chatOptions.blind=!0:chatOptions.rollMode==="selfroll"&&(chatOptions.whisper=[game.user.id]),q.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSKRoll:!0},rerenderMessage){let html=await renderTemplate(chatOptions.template,chatData),actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.user).character,rollData=actor?actor.getRollData():{},enriched=await TextEditor.enrichHTML(html,{rollData,async:!0});chatOptions.content=enriched;let postFunction=getProperty(rerenderMessage,"flags.data.preData.extra.options.postFunction");postFunction&&(testData.messageId=rerenderMessage.id,eval(postFunction.functionName)(postFunction,{result:testData},preData.source));let newMsg=await rerenderMessage.update({content:chatOptions.content,["flags.data"]:chatOptions["flags.data"]});return ui.chat.updateMessage(newMsg),newMsg}else return chatOptions.content=await renderTemplate(chatOptions.template,chatData),await ChatMessage.create(chatOptions,!1)}static addApplyEffectData(o){let e=o.preData.source;if(["ahnengabe","meleeweapon","rangeweapon"].includes(e.type)){if(o.successLevel>0&&e.effects.length>0)return!0}else{if(["poison"].includes(e.type))return e.effects.length>0;if(e.type=="trait"&&e.effects.length>0&&o.successLevel>0)return!0}let t=o.preData.situationalModifiers.filter(s=>s.specAbId).map(s=>s.specAbId);if(t.length>0){let s=o.preData.extra.actor.items.filter(a=>t.includes(a._id));for(let a of s)if(a.effects.length>0)return!0}return!1}static getSuccessDescription(o){return game.i18n.localize(["dsk.CriticalFailure","dsk.Failure","","dsk.Success","dsk.CriticalSuccess"][o+2])}static async showDiceSoNice(o,e){if(g.moduleEnabled("dice-so-nice")){let t=null,s=!1;switch(e){case"blindroll":s=!0,t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"gmroll":t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"selfroll":t=[];break}let a=game.dice3d.showForRoll(o,game.user,!0,t,s);game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")||await a}}static async manualRolls(o,e="",t={}){if(t.cheat||game.settings.get("dsk","allowPhysicalDice"))if(t.predefinedResult)o.editRollAtIndex(t.predefinedResult);else{let s=!1,a,i=[];for(let n of o.terms)if(n instanceof Die||n.class=="Die")for(let l of n.results)i.push({faces:n.faces,val:l.result});let r=await renderTemplate("systems/dsk/templates/dialog/manualroll-dialog.html",{dice:i,description:e});if([s,a]=await new Promise((n,l)=>{new G({title:game.i18n.localize(t.cheat?"dsk.DIALOG.cheat":"dsk.SETTINGS.allowPhysicalDice"),content:r,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:c=>{n([!0,c])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{n([!1,0])}}}}).render(!0)}),s){let n=[];a.find(".dieInput").each(function(l){let c=Number($(this).val());c>0&&n.push({val:c,index:l}),l++}),o.editRollAtIndex(n)}}return o}static _getNarrowSpaceModifier(o,e){return e.narrowSpace?game.i18n.localize("dsk.LocalizedIDs.Shields")==o.system.combatskill?v.narrowSpaceModifiers["shield"+o.system.shieldsize][e.mode]:v.narrowSpaceModifiers["weapon"+o.system.rw][e.mode]:0}static async rollCombatTrait(o){let e=o.source,t=e.system.traitType=="meleeAttack",s=e;t?this._appendSituationalModifiers(o,game.i18n.localize("dsk.narrowSpace"),this._getNarrowSpaceModifier(s,o)):this._appendSituationalModifiers(o,game.i18n.localize("dsk.distance"),v.rangeMods[o.rangeModifier||"medium"].attack);let a=await this._roll2D20(o);await this.detailedWeaponResult(a,o,e),o.mode=="attack"&&a.successLevel>0&&await _DiceDSK.evaluateDamage(o,a,s,!t,a.doubleDamage),a.rollType="weapon";let i=_DiceDSK.parseEffect(s);return i&&(a.parsedEffect=i),a}static async rollWeapon(o){let e,t=o.source,s=o.extra.actor,a=t.system.combatskill,i=D._calculateCombatSkillValues(s.items.find(c=>c.type=="combatskill"&&c.name==a),s.system),r=t.type=="meleeweapon";r?(e=D._prepareMeleeWeapon(t,[i],o.extra.actor),this._appendSituationalModifiers(o,game.i18n.localize("dsk.narrowSpace"),this._getNarrowSpaceModifier(e,o))):(e=D._prepareRangeWeapon(t,[],[i],o.extra.actor),this._appendSituationalModifiers(o,game.i18n.localize("dsk.distance"),v.rangeMods[o.rangeModifier||"medium"].attack));let n=await this._roll2D20(o);await this.detailedWeaponResult(n,o,t),o.mode=="attack"&&n.successLevel>0&&await _DiceDSK.evaluateDamage(o,n,e,!r,n.doubleDamage),n.rollType="weapon";let l=_DiceDSK.parseEffect(e);return l&&(n.parsedEffect=l),n}static async rollRegeneration(o){let e=this._situationalModifiers(o),t=o.roll,s=[],a={rollType:"regenerate",preData:o,modifiers:e,extra:{}},i=[];o.regenerateLeP&&i.push("LeP"),o.extra.actor.system.isMage&&o.regenerateAeP&&i.push("AeP");let r=0;if(o.extra.actor.effects.some(l=>l.statuses.includes("sick"))){this._appendSituationalModifiers(o,game.i18n.localize("dsk.CONDITION.sick"),"*0");for(let l of i)s.push({char:l,res:0,die:"d6"}),a[l]=0,r+=2}else for(let l of i)this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.regeneration${l}`),E.vantageStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.regeneration${l}`)),l),this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.weakRegeneration${l}`),E.vantageStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.weakRegeneration${l}`))*-1,l),this._appendSituationalModifiers(o,game.i18n.localize(`dsk.LocalizedIDs.advancedRegeneration${l}`),x.abilityStep(o.extra.actor,game.i18n.localize(`dsk.LocalizedIDs.advancedRegeneration${l}`)),l),this._appendSituationalModifiers(o,`${game.i18n.localize(`CHARAbbrev.${l}`)} ${game.i18n.localize("dsk.Modifier")}`,o[`${l}Modifier`],l),this._appendSituationalModifiers(o,`${game.i18n.localize(`CHARAbbrev.${l}`)} ${game.i18n.localize("dsk.regenerate")}`,o[`regeneration${l}`],l),s.push({char:l,res:t.terms[r].results[0].result,die:"d6"}),a[l]=Math.round(Math.max(0,Number(t.terms[r].results[0].result)+Number(e)+this._situationalModifiers(o,l))*Number(o.regenerationFactor)),r+=2;return a.characteristics=s,a}static async rollDices(o,e){if(!o.roll){let t=game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration,s;switch(o.source.type){case"char":case"ahnengabe":case"skill":s=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,t(o.source.system.characteristic1)),mergeObject(s.dice[1].options,t(o.source.system.characteristic2));break;case"regenerate":let a=[];o.regenerateLeP&&a.push("1d6"),o.extra.actor.isMage&&o.regenerateAeP&&a.push("1d6"),s=await new Roll(a.join("+")).evaluate({async:!0}),o.regenerateLeP&&mergeObject(s.dice[0].options,t("mu")),o.extra.actor.isMage&&o.regenerateAeP&&mergeObject(s.dice[a.length-1].options,t("ge"));break;case"meleeweapon":case"rangeweapon":case"combatskill":if(o.mode=="damage"){let r=await this.damageFormula(o);s=await new Roll(r).evaluate({async:!0});for(let n=0;n<s.dice.length;n++)mergeObject(s.dice[n].options,t("damage"))}else s=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,t("attack")),mergeObject(s.dice[1].options,t("attack"));break;case"trait":if(o.mode=="damage"){let r=await this.damageFormula(o);s=await new Roll(r).evaluate({async:!0});for(let n=0;n<s.dice.length;n++)mergeObject(s.dice[n].options,t("damage"))}else s=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,t("attack")),mergeObject(s.dice[1].options,t("attack"));break;case"poison":case"disease":let i=t("in");s=await new Roll("1d20+1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,i),mergeObject(s.dice[1].options,i);break;default:console.error("Unexpected roll mode")}s=await _DiceDSK.manualRolls(s,o.source.type,o.extra.options),await this.showDiceSoNice(s,e.rollMode),o.roll=duplicate(s),o.rollMode=e.rollMode}return o}static async rollItem(o){o.source.attack=20+2*o.source.system.level;let e=await this._roll2D20(o);switch(o.source.type){case"poison":let t=o.source.system.duration.split(" / ").map(a=>a.trim()),s=o.source.system.effect.split(" / ").map(a=>a.trim());e.duration=t.length>1?e.successLevel>0?t[0]:t[1]:t[0],e.effect=s.length>1?e.successLevel>0?s[0]:s[1]:s[0];break;case"disease":break}return e}static async damageFormula(o){let e;if(o.source.type=="meleeweapon"){let t=D._calculateCombatSkillValues(o.extra.actor.items.find(s=>s.type=="combatskill"&&s.name==o.source.system.combatskill),o.extra.actor.system);e=D._prepareMeleeWeapon(o.source,[t],o.extra.actor)}else if(o.source.type=="rangeweapon"){let t=D._calculateCombatSkillValues(o.extra.actor.items.find(s=>s.type=="combatskill"&&s.name==o.source.system.combatskill),o.extra.actor.system);e=D._prepareRangeWeapon(o.source,[],[t],o.extra.actor)}else e=o.source.system;return o.source.system.tp.replace(/[Ww]/g,"d")+`+${e.extraDamage||0}`}static async rollDamage(o){let e=this._situationalModifiers(o),t=[],s=o.roll,a=s.total+e;for(let i of s.terms)if(i instanceof Die||i.class=="Die")for(let r of i.results)t.push({char:o.mode,res:r.result,die:"d"+i.faces});return{rollType:"damage",damage:a,characteristics:t,preData:o,modifiers:e,extra:{}}}static async _rollEdit(o){let e=$(o.currentTarget),t=e.parents(".message").attr("data-message-id"),s=game.messages.get(t),a=s.flags.data,i=a.preData;i.extra.actor=g.getSpeaker(i.extra.speaker).toObject(!1),i.extra.options.cheat&&delete i.extra.options.cheat;let r;switch(e.attr("data-edit-type")){case"roll":r=e.attr("data-edit-id");let l=Number(e.val());if(i.roll.terms.length>r*2){let u=Roll.fromData(i.roll);u.editRollAtIndex([{index:r,val:l}]),i.roll=u}else{let u=Roll.fromData(a.postData.damageRoll);r=r-i.roll.terms.filter(d=>d.results).length,u.editRollAtIndex([{index:r,val:l}]),i.damageRoll=u}break;case"mod":r=i.situationalModifiers.findIndex(u=>u.name==game.i18n.localize("dsk.chatEdit")),r>0&&i.situationalModifiers.splice(r,1);let c={name:game.i18n.localize("dsk.chatEdit"),value:Number(e.val())-this._situationalModifiers(i)};i.situationalModifiers.push(c);break}let n={template:a.template,rollMode:a.rollMode,title:a.title,speaker:s.speaker,user:s.user.id};["gmroll","blindroll"].includes(n.rollMode)&&(n.whisper=game.users.filter(l=>l.isGM).map(l=>l.id)),n.rollMode==="blindroll"&&(n.blind=!0),["poison","disease"].includes(i.source.type)?new C(i.source,{temporary:!0})[`${a.postData.postFunction}`]({testData:i,cardOptions:n},{rerenderMessage:s}):g.getSpeaker(s.speaker)[`${a.postData.postFunction}`]({testData:i,cardOptions:n},{rerenderMessage:s})}static async chatListeners(o){o.on("click",".expand-mods",e=>{e.preventDefault();let t=$(e.currentTarget);t.find("i").toggleClass("fa-minus fa-plus"),t.siblings("ul,div").fadeToggle()}),o.on("click",".edit-toggle",e=>{e.preventDefault(),$(e.currentTarget).parents(".chat-card").find(".display-toggle").toggle()}),o.on("click",".botch-roll",e=>Q.showBotchCard(e.currentTarget.dataset)),o.on("click",".roll-item",e=>_DiceDSK._itemRoll(e)),o.on("change",".roll-edit",e=>_DiceDSK._rollEdit(e)),o.on("click",".applyEffect",async e=>{_DiceDSK.wrapLock(e,async(t,s)=>{let a=s.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await _DSKActiveEffectConfig.applyEffect(a,i)})}),o.on("click",".applyTableEffect",async e=>{_DiceDSK.wrapLock(e,async(t,s)=>{let a=s.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await TableEffects.applyEffect(a,i)})}),o.on("click",".placeTemplate",async e=>MeasuredTemplateDSK.placeTemplateFromChat(e)),o.on("click",".resistEffect",e=>_DSKActiveEffectConfig.resistEffect(e)),o.on("click",".resistPain",e=>_DiceDSK.rollResistPain(e)),Z.chatListeners(o)}};m(_DiceDSK,"DiceDSK");Hooks.once("ready",async()=>{if(!M.creatureData){let o=await fetch(`systems/dsk/lazy/creaturetype/${game.i18n.lang}.json`);M.creatureData=await o.json(),M.magical=game.i18n.localize("dsk.WEAPON.magical"),M.clerical=game.i18n.localize("dsk.WEAPON.clerical"),M.silverPlated=game.i18n.localize("dsk.WEAPON.silverPlated"),game.dsk.apps.CreatureType=M}});var ia=m(o=>!(!o||o.length===0),"isNotEmpty"),se=class{constructor(e){this.creatureClass=e,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}static detectCreatureType(e){let t=e.system.details.species;return Object.keys(se.creatureData.types).filter(a=>t.indexOf(a)>=0).map(a=>this.getClass(se.creatureData.types[a],t))}static getClass(e,t){let s={DemonType:ut,ChimeraType:ct,DaimonidType:dt,DragonType:mt,ElementalType:pt,FairyType:ft,GhostType:gt,GolemType:ht,HomunculiType:yt,IntelligentCreatureType:kt,PlantType:bt,AnimalType:wt,UndeadType:vt,SupernaturalType:Tt,MagicalConstructType:St,WerCreatureType:Ct,VampireType:Mt}[e];return new s(t)}static creatureTypeName(e){if(e.type=="creature"){let t=e.system.species;return Object.keys(se.creatureData.types).filter(s=>t.indexOf(s)>=0)[0]}else return e.system.details.species}static addCreatureTypeModifiers(e,t,s,a){let i=se.detectCreatureType(e),r=["spell","ceremony","liturgy","ritual"].includes(t.type);for(let n of i){let l=n.damageModifier(t);if(r)for(let c of l)c.armorPen=n.spellResistanceModifier(e);s.push(...l)}s.push(...this.creatureBonusDamage(e,a)),se.addVulnerabilitiesToSource(e,t,s)}static addVulnerabilitiesToSource(e,t,s){let a=getProperty(e,"system.vulnerabilities");a&&["meleeweapon","rangeweapon"].includes(t.type)&&getProperty(a,"combatskill").reduce((r,n)=>{if(n.target==t.system.combatskill){let c=(/\*/.test(n.value)?Number(n.value.replace("*",""))>1:Number(n.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";s.push(...se.buildDamageMod(`${game.i18n.format(c,{name:t.system.combatskill})} (${n.source})`,n.value))}},s)}ignoredCondition(e){return!1}damageModifier(e){return[]}static creatureBonusDamage(e,t){let s=[],a=e.system.details.species,i=getProperty(t,"system.creatureBonus");for(let r of i)a.indexOf(r.target)>=0&&s.push(...this.buildDamageMod(r.source,r.value,!0));return s}spellImmunity(e){return this.spellImmunities.some(t=>e.includes(t))}spellArmorModifier(e){return 0}poisonImmunity(){return this.poisonImmunity}diseaseImmunity(){return this.diseaseImmunity}spellResistanceModifier(e){return 0}static buildDamageMod(e,t,s=!0){return[{name:e,value:t,selected:s,type:"dmg",source:game.i18n.localize("dsk.target")}]}weaponAttributes(e){return getProperty(e,"system.effect.attributes")||""}getTypeByClass(e){return Object.keys(se.creatureData.types).find(t=>se.creatureData.types[t]===e)}isAttackItem(e){return["meleeweapon","trait","rangeweapon"].includes(e.type)&&ia(this.weaponAttributes(e))}attributesRegex(e){let t=this.weaponAttributes(e);return new RegExp(`(${t.split(",").map(s=>g.escapeRegex(s.split("(")[0].trim())).join("|")})`,"i")}},M=se;m(M,"CreatureType"),z(M,"creatureData"),z(M,"magical"),z(M,"clerical");var Ae=class extends M{damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let s of M.creatureData.godOfLife){let a=`${M.clerical} (${s})`;if(t.test(a))return M.buildDamageMod(a,"*2")}}return super.damageModifier(e)}};m(Ae,"VulnerableToLifeGods");var ct=class extends Ae{};m(ct,"ChimeraType");var dt=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation"].map(t=>game.i18n.localize(`Features.${t}`))}damageModifier(e){return this.isAttackItem(e)&&this.attributesRegex(e).test(M.clerical)?M.buildDamageMod(M.clerical,"*2"):super.damageModifier(e)}};m(dt,"DaimonidType");var mt=class extends M{};m(mt,"DragonType");var ut=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);if(t.test(M.clerical))return M.buildDamageMod(`${M.clerical} (${M.creatureData.opposingGod})`,"*2",!1);if(t.test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("DemonType"),"*0.5")}spellArmorModifier(e){return Number(e.system.stats.soulpower.max)}spellResistanceModifier(e){return Number(e.system.stats.soulpower.max)}ignoredCondition(e){return!0}};m(ut,"DemonType");var pt=class extends M{constructor(e){super(e),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*1");return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*0.5")}spellArmorModifier(e){return Number(e.system.stats.soulpower.max)}spellResistanceModifier(e){return Number(e.system.stats.soulpower.max)}ignoredCondition(e){return!0}};m(pt,"ElementalType");var ft=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}};m(ft,"FairyType");var gt=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion","Healing","Telekinesis","Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let s of M.creatureData.godOfDeath){let a=`${M.clerical} (${s})`;if(t.test(a))return[]}if(t=this.attributesRegex(e),t.test(M.clerical))return M.buildDamageMod(M.clerical,"*0.5");if(t.test(M.magical))return M.buildDamageMod(M.magical,"*0.5")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(M.magical,"*0.5");return M.buildDamageMod(this.getTypeByClass("GhostType"),"*0")}ignoredCondition(e){return!["feared","inpain","confused"].includes(e)}};m(gt,"GhostType");var ht=class extends Ae{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["confused","paralysed"].includes(e)}};m(ht,"GolemType");var yt=class extends Ae{constructor(e){super(e),this.spellImmunities=["Healing"].map(t=>game.i18n.localize(`Features.${t}`))}ignoredCondition(e){return!["inpain","encumbered","stunned","feared","paralysed","confused"].includes(e)}};m(yt,"HomunculiType");var kt=class extends M{};m(kt,"IntelligentCreatureType");var bt=class extends M{};m(bt,"PlantType");var wt=class extends M{};m(wt,"AnimalType");var vt=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let s of M.creatureData.godOfDeath){let a=`${M.clerical} (${s})`;if(t.test(a))return M.buildDamageMod(a,"*2")}}return super.damageModifier(e)}ignoredCondition(e){return!["paralysed"].includes(e)}};m(vt,"UndeadType");var Tt=class extends M{};m(Tt,"SupernaturalType");var St=class extends M{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["stunned","feared","paralysed","confused"].includes(e)}};m(St,"MagicalConstructType");var Ct=class extends M{damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.silverPlated))return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*2")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*0.5")}};m(Ct,"WerCreatureType");var Mt=class extends M{damageModifier(e){return["spell","ceremony","liturgy","ritual"].includes(e.type)?super.damageModifier(e):M.buildDamageMod(this.getTypeByClass("VampireType"),"*0.5")}};m(Mt,"VampireType");var C=class extends Item{static defaultImages(e,t=""){let s=`${e}${t}`;return{effectwrapper:"icons/svg/aura.svg",information:"systems/dsk/icons/categories/DSK-Auge.webp",ammunition:"systems/dsk/icons/categories/arrow.webp",equipment:"systems/dsk/icons/categories/equipment.webp",advantage:"systems/dsk/icons/categories/advantage.webp",disadvantage:"systems/dsk/icons/categories/disadvantage.webp",specialability:"systems/dsk/icons/categories/specialability.webp",combatskill:"systems/dsk/icons/categories/combatskill.webp",ahnengabe:"systems/dsk/icons/categories/ahnengabe.webp",armor:"systems/dsk/icons/categories/armor.webp",rangeweapon:"systems/dsk/icons/categories/rangeweapon.webp",meleeweapon:"systems/dsk/icons/categories/meleeweapon.webp",ahnengeschenk:"systems/dsk/icons/categories/ahnengeschenk.webp",culture:"systems/dsk/icons/categories/culture.webp",profession:"systems/dsk/icons/categories/profession.webp",poison:"systems/dsk/icons/categories/poison.webp",trait:"systems/dsk/icons/categories/trait.webp"}[s]}static defaultIcon(e){(!e.img||e.img=="")&&(e.img=this.defaultImages(e.type)||"systems/dsk/icons/blank.webp")}setupEffect(e,t={},s){return C.getSubClass(this.type).setupDialog(e,t,this,s)}async itemTest({testData:e,cardOptions:t},s={}){e=await _DiceDSK.rollDices(e,t);let a=await _DiceDSK.rollTest(e);if(a.postFunction="itemTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("dsk.Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}return s.suppressMessage||_DiceDSK.renderRollCard(t,a,s.rerenderMessage),{result:a,cardOptions:t}}static attackStatEffect(e,t){t!=0&&e.push({name:game.i18n.localize("dsk.statuseffects"),value:t,selected:!0})}static prepareRangeAttack(e,t,s,a,i,r,n=void 0){e.push(...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.restrictedSenseSight"),-2)),this.getCombatSkillModifier(t,a,e);let l=this.getTargetSizeAndModifier(t,a,e,s),c=Number(t.system.rangeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("dsk.statuseffects")} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0});let u={...v.rangeWeaponModifiers};delete u[E.hasVantage(t,game.i18n.localize("dsk.LocalizedIDs.senseOfRange"))?"long":"rangesense"],x.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.extremeShot"))||delete u.extreme;let p=x.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.drivingArcher"))?duplicate(v.drivingArcherOptions):duplicate(v.mountedRangeOptions);mergeObject(s,{rangeOptions:u,rangeDistance:Object.keys(u)[W.distanceModifier(game.canvas.tokens.get(i),a,n)],sizeOptions:v.rangeSizeCategories,visionOptions:v.rangeVision,mountedOptions:p,shooterMovementOptions:v.shooterMovementOptions,targetMovementOptions:v.targetMomevementOptions,targetSize:l,combatSpecAbs:r,aimOptions:v.aimOptions})}async addCondition(e,t=1,s=!1,a=!0){return await O.addCondition(this,e,t,s,a)}async removeCondition(e,t=1,s=!0,a=!1){return O.removeCondition(this,e,t,s,a)}hasCondition(e){return O.hasCondition(this,e)}static prepareMeleeAttack(e,t,s,a,i,r){let n="short";game.user.targets.forEach(u=>{if(u.actor){let d=u.actor.items.filter(p=>p.type=="meleeweapon"&&p.system.worn.value||p.type=="trait"&&p.system.traitType=="meleeAttack"&&p.system.pa);d.length>0&&(n=d[0].system.rw)}});let l=this.getTargetSizeAndModifier(t,a,e,s);this.getCombatSkillModifier(t,a,e);let c=Number(t.system.meleeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("dsk.statuseffects")} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0}),mergeObject(s,{visionOptions:v.meleeRangeVision(),weaponSizes:v.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:n,combatSpecAbs:i,meleeSizeOptions:v.meleeSizeCategories,targetSize:l,constricted:t.hasCondition("constricted"),wrongHandDisabled:r,offHand:!r&&getProperty(a,"system.worn.offHand")})}static parseValueType(e,t){let s="";return/^\*/.test(t)&&(s="*",t=t.substring(1).replace(",",".")),{name:e,value:Number(t),type:s}}static getSpecAbModifiers(e,t){let s=[];for(let a of e.find(".specAbs")){let i=Number($(a).attr("data-step"));if(i>0){let r=t=="attack"?$(a).attr("data-atbonus"):$(a).attr("data-pabonus"),n=r.split(",").reduce((l,c)=>l+Number(c),0);s.push({name:$(a).find("a").text(),value:isNaN(n)?Number(r.replace("*","")):Number(n)*i,damageBonus:$(a).attr("data-tpbonus"),dmmalus:$(a).attr("data-dmmalus")*i,step:i,specAbId:$(a).attr("data-id"),type:/^\*/.test(r)?"*":void 0})}}return s}static getTargetSizeAndModifier(e,t,s,a){let i="average",r=0;return game.user.targets.forEach(n=>{if(n.actor){let l=getProperty(n.actor,"system.details.size");l&&(i=l),M.addCreatureTypeModifiers(n.actor,t,s,e),r=Math.max(r,n.actor.system.maxDefense.parry)}}),a.vw=r,i}static getCombatSkillModifier(e,t,s){if(t.type=="trait")return;let a=e.items.find(i=>i.type=="combatskill"&&i.name==t.system.combatskill);for(let i of a.effects)for(let r of i.changes)switch(r.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":s.push({name:`${a.name} - ${game.i18n.localize("dsk.MODS.defenseMalus")}`,value:r.value*-1,type:"defenseMalus",selected:!0});break}}static buildCombatSpecAbs(e,t,s,a){let i;s?(s.push(game.i18n.localize("dsk.LocalizedIDs.all")),s=s.map(p=>p.toLowerCase()),i=m((p,f)=>p.system.combatskills.split(/;|,/).map(k=>k.trim().toLowerCase()).filter(k=>f.includes(k.replace(/ \([a-zA-Z ]*\)/,""))).length>0,"searchFilter")):i=m(()=>!0,"searchFilter");let r=e.items.filter(p=>p.type=="specialability"&&t.includes(p.system.category)&&p.system.effect!=""&&i(p,s)),n=[],l=game.i18n.localize("dsk.LocalizedAbilityModifiers.at"),c=game.i18n.localize("dsk.LocalizedAbilityModifiers.tp"),u=game.i18n.localize("dsk.LocalizedAbilityModifiers.pa"),d=game.i18n.localize("dsk.LocalizedAbilityModifiers.dm");if(a=="attack")for(let p of r){let f=C.parseEffect(p.system.effect,e),k=f[l]||0,T=f[c]||0,h=f[d]||0;if(k!=0||T!=0||h!=0||p.effects.size>0){let y=game.i18n.localize(v.combatSkillSubCategories[p.system.subcategory]);n.push({name:p.name,atbonus:k,tpbonus:T,dmmalus:h,label:`${l}: ${k}, ${c}: ${T}, ${d}: ${h}`,steps:p.system.level,category:{id:p.system.subcategory,css:`ab_${p.system.subcategory}`,name:y},id:p.id,actor:e.id})}}else for(let p of r){let k=C.parseEffect(p.system.effect,e)[u]||0;if(k!=0){let T=game.i18n.localize(v.combatSkillSubCategories[p.system.subcategory]);n.push({name:p.name,pabonus:k,tpbonus:0,dmmalus:0,label:`${u}: ${k}`,steps:p.system.level,category:{id:p.system.category.sub,css:`ab_${p.system.subcategory}`,name:T},id:p.id,actor:e.id})}}return n}_setupCardOptions(e,t,s){let a=ChatMessage.getSpeaker();return{speaker:{alias:a.alias,scene:a.scene},flags:{img:a.token?canvas.tokens.get(a.token).document.img:this.img},title:t,template:e}}static getSkZkModifier(e,t){let s=[],a=[],i=["ahnengabe"].includes(t.type)&&t.system.effectFormula.trim()=="";game.user.targets.size&&game.user.targets.forEach(r=>{if(r.actor){let n=0;i&&(n=M.detectCreatureType(r.actor).reduce((c,u)=>c+u.spellResistanceModifier(r.actor),0)),s.push(r.actor.system.stats.sk.max*-1-n),a.push(r.actor.system.stats.zk.max*-1-n)}}),mergeObject(e,{SKModifier:s.length>0?Math.min(...s):0,ZKModifier:a.length>0?Math.min(...a):0})}static async create(e,t){return this.defaultIcon(e),await super.create(e,t)}static changeChars(e,t,s){e.system.characteristic1=t,e.system.characteristic2=s}static getSubClass(e){return game.dsk.config.ItemSubClasses[e]||C}static areEquals(e,t){return e.type!=t.type?!1:C.getSubClass(e.type).checkEquality(e,t)}static checkEquality(e,t){return t.type==e.type&&e.name==t.name&&e.system.description.value==t.system.description.value}static setupDialog(e,t,s,a,i){return null}static buildSpeaker(e,t){return{token:t,actor:e?e.id:void 0,scene:canvas.scene?canvas.scene.id:null}}static async stackItems(e,t,s){return await C.getSubClass(e.type).combineItem(e,t,s)}static async combineItem(e,t,s){return e=duplicate(e),e.system.quantity+=t.system.quantity,await s.updateEmbeddedDocuments("Item",[e])}static _chatLineHelper(e,t){return`<b>${game.i18n.localize(e)}</b>: ${t||"-"}`}static setupSubClasses(){game.dsk.config.ItemSubClasses={meleeweapon:$t,rangeweapon:Et,armor:Ot,ammunition:xt,equipment:zt,species:Nt,culture:Pt,profession:_t,advantage:Xe,disadvantage:Rt,specialability:Lt,ahnengeschenk:Ft,ahnengabe:$e,poison:Ht,skill:jt,combatskill:Bt,effectwrapper:It,information:Dt,trait:At}}static hasSchips(e){return getProperty(e.system,"stats.schips.value")>0}async postItem(){C.getSubClass(this.type)._postItem(this)}static parseEffect(e,t){let s={},a=new RegExp(game.i18n.localize("dsk.CHARAbbrev.GS"),"gi");for(let i of e.split(/,|;/).map(r=>r.trim())){let r=i.replace(/(\s+)/g," ").trim().split(" ");r[0]=r[0].replace(a,t.system.stats.gs.max),r.length==2&&(!isNaN(r[0])||/(=)?[+-]\d([+-]\d)?/.test(r[0])||/(=)?\d[dDwW]\d/.test(r[0])||/=\d+/.test(r[0])||/\*\d(\.\d)*/.test(r[0]))&&(s[r[1].toLowerCase()]==null?s[r[1].toLowerCase()]=[r[0]]:s[r[1].toLowerCase()].push(r[0]))}return s}static chatData(e,t){return[]}static async _postItem(e){let t=duplicate(e),s=getProperty(t,"system.obfuscation.details"),a=getProperty(t,"system.obfuscation.description");mergeObject(t,{properties:s?[]:C.getSubClass(e.type).chatData(duplicate(t.system),e.name),descriptionObfuscated:a}),t.hasPrice="price"in t.system&&!s,t.hasPrice&&t.properties.push(`<b>${game.i18n.localize("dsk.price")}</b>: ${t.system.price}`),e.pack&&(t.itemLink=e.link),t.img.includes("/blank.webp")&&(t.img=null);let i=await renderTemplate("systems/dsk/templates/chat/post-item.html",t),r=g.chatDataSetup(i);ChatMessage.create(r)}};m(C,"ItemDSK");var Dt=class extends C{static async _postItem(e){let t=await renderTemplate("systems/dsk/templates/chat/informationRequestRoll.html",{item:e}),s=g.chatDataSetup(t);ChatMessage.create(s)}};m(Dt,"ItemInformation");var It=class extends C{};m(It,"ItemEffectwrapper");var At=class extends C{static chatData(e,t){let s=[];switch(e.traitType){case"meleeAttack":s=[this._chatLineHelper("dsk.ABBR.AW",e.at),this._chatLineHelper("dsk.damage",e.damage),this._chatLineHelper("dsk.range",e.rw)];break;case"rangeAttack":s=[this._chatLineHelper("dsk.ABBR.AW",e.at),this._chatLineHelper("dsk.damage",e.damage),this._chatLineHelper("dsk.range",e.rw),this._chatLineHelper("dsk.reloadTime",e.lz)];break;case"armor":s=[this._chatLineHelper("dsk.protection",e.damage)];break}return s}static getSituationalModifiers(e,t,s,a,i){a=g.toObjectIfPossible(a);let r=a.system.traitType,n=C.buildCombatSpecAbs(t,["Combat","animal"],void 0,s.mode);s.mode=="attack"&&r=="meleeAttack"?this.prepareMeleeAttack(e,t,s,a,n,!1):s.mode=="attack"&&r=="rangeAttack"&&this.prepareRangeAttack(e,t,s,a,i,n),this.attackStatEffect(e,Number(t.system[r=="meleeAttack"?"meleeStats":"rangeStats"][s.mode]))}static setupDialog(e,t,s,a,i){let r=t.mode,n=s.name+" "+game.i18n.localize("dsk."+r+"test");mergeObject(s.system,{characteristic1:"attack",characteristic2:"attack"});let l={opposable:!0,source:s,mode:r,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}},c=_.multipleDefenseValue(a,s.toObject()),u={rollMode:t.rollMode,mode:r,hasSchips:this.hasSchips(a),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*c})},d=getProperty(s,"system.traitType"),p=a?O.getRollModifiers(a,s,{mode:r}):[];this.getSituationalModifiers(p,a,u,s,i),u.situationalModifiers=p;let f={title:n,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:u,callback:(T,h={})=>(d=="meleeAttack"?J.resolveMeleeDialog(l,k,T,a,h,c,r):J.resolveRangeDialog(l,k,T,a,h,c),l.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),l.isRangeDefense=u.isRangeDefense,Hooks.call("callbackDialogCombatDSK",l,a,T,s,i),{testData:l,cardOptions:k})},k=a._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:f,testData:l,cardOptions:k})}};m(At,"ItemTrait");var $t=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.damage",e.tp),this._chatLineHelper("dsk.ABBR.awvw",`${e.aw} / ${e.vw}`),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill),this._chatLineHelper("dsk.range",game.i18n.localize(`dsk.Range.${e.rw}`))]}static getSituationalModifiers(e,t,s,a){let i=E.hasVantage(t,game.i18n.localize("dsk.LocalizedIDs.ambidextrous"));a=g.toObjectIfPossible(a);let r=[a.system.combatskill],n=C.buildCombatSpecAbs(t,["Combat"],r,s.mode);s.mode=="attack"&&this.prepareMeleeAttack(e,t,s,a,n,i),this.attackStatEffect(e,Number(t.system.meleeStats[s.mode]))}static setupDialog(e,t,s,a,i){let r=t.mode,n=s.name+" "+game.i18n.localize("dsk."+r+"test"),l=a.items.find(T=>T.type=="combatskill"&&T.name==s.system.combatskill);mergeObject(s.system,{characteristic1:l.system.characteristic1,characteristic2:l.system.characteristic2});let c={opposable:!0,source:s,mode:r,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}},u=_.multipleDefenseValue(a,c.source),d={rollMode:t.rollMode,mode:r,hasSchips:this.hasSchips(a),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*u})},p=a?O.getRollModifiers(a,s,{mode:r}):[];this.getSituationalModifiers(p,a,d,s),d.situationalModifiers=p;let f={title:n,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:d,callback:(T,h={})=>(J.resolveMeleeDialog(c,k,T,a,h,u,r),c.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),Hooks.call("callbackDialogCombatDSK",c,a,T,s,i),c.isRangeDefense=d.isRangeDefense,{testData:c,cardOptions:k})},k=a._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:f,testData:c,cardOptions:k})}};m($t,"ItemMeleeweapon");var Et=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.damage",e.tp),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill),this._chatLineHelper("dsk.range",e.rw)]}static getSituationalModifiers(e,t,s,a,i){if(s.mode=="attack"){let r=g.toObjectIfPossible(a),n=[r.system.combatskill],l=C.buildCombatSpecAbs(t,["Combat"],n,s.mode),c=t.items.get(r.system.currentAmmo);if(c){c=c.toObject(!1);let u=getProperty(c.flags,"dsk.poison");u&&mergeObject(a.flags,{dsk:{poison:u}})}if(this.prepareRangeAttack(e,t,s,r,i,l,c),c){if(c.system.atmod&&e.push({name:`${c.name} - ${game.i18n.localize("dsk.atmod")}`,value:c.system.atmod,selected:!0,specAbId:r.system.currentAmmo}),c.system.damageMod||c.system.armorMod){let u={name:`${c.name} - ${game.i18n.localize("dsk.MODS.damage")}`,value:c.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:r.system.currentAmmo};c.system.armorMod&&(u.armorPen=c.system.armorMod),e.push(u)}c.effects.length&&e.push({name:`${c.name} - ${game.i18n.localize("dsk.effect")}`,value:1,type:game.i18n.localize("dsk.effect"),selected:!0,specAbId:r.system.currentAmmo})}}this.attackStatEffect(e,Number(t.system.rangeStats[s.mode]))}static async checkAmmunitionState(e,t,s,a){let i=!0;if(a!="damage"){let r=e.system;if(r.ammunitionType!="infinite")if(r.ammunitionType=="-")t.extra.ammo=duplicate(e),i=t.extra.ammo.system.quantity>0;else{let n=s.items.get(r.currentAmmo);n?(t.extra.ammo=n.toObject(),r.ammunitionType=="mag"?i=t.extra.ammo.system.quantity>1||t.extra.ammo.system.mag.value>0&&t.extra.ammo.system.quantity>0:i=t.extra.ammo.system.quantity>0):i=!1}!i&&s.type=="creature"&&(i=!0)}return i||ui.notifications.error(game.i18n.localize("dsk.DSKError.NoAmmo")),i}static async setupDialog(e,t,s,a,i){let r=t.mode,n=s.name+" "+game.i18n.localize("dsk."+r+"test"),l=a.items.find(T=>T.type=="combatskill"&&T.name==s.system.combatskill);mergeObject(s.system,{characteristic1:l.system.characteristic1,characteristic2:l.system.characteristic2});let c={opposable:!0,source:s,mode:r,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}};if(!await this.checkAmmunitionState(s,c,a,r))return;let u=_.multipleDefenseValue(a,c.source),d={rollMode:t.rollMode,mode:r,hasSchips:this.hasSchips(a),defenseCountString:game.i18n.format("dsk.defenseCount",{malus:-1*u})},p=a?O.getRollModifiers(a,s,{mode:r}):[];this.getSituationalModifiers(p,a,d,s,i),d.situationalModifiers=p;let f={title:n,template:"/systems/dsk/templates/dialog/combatskill-enhanced-dialog.html",data:d,callback:(T,h={})=>(J.resolveRangeDialog(c,k,T,a,h,u),c.situationalModifiers.some(y=>y.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),Hooks.call("callbackDialogCombatDSK",c,a,T,s,i),{testData:c,cardOptions:k})},k=a._setupCardOptions("systems/dsk/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:f,testData:c,cardOptions:k})}};m(Et,"ItemRangeweapon");var Ot=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.protection",e.rs)]}};m(Ot,"ItemArmor");var xt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.ammunitionType",game.i18n.localize(`dsk.ammunition.${e.ammunitionType}`))]}};m(xt,"ItemAmmunition");var zt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.equipmentType",game.i18n.localize(`dsk.Equipment.${e.category}`))]}};m(zt,"ItemEquipment");var Nt=class extends C{};m(Nt,"ItemSpecies");var Pt=class extends C{};m(Pt,"ItemCulture");var _t=class extends C{};m(_t,"ItemProfession");var Xe=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.rule",e.rule)]}};m(Xe,"ItemAdvantage");var Rt=class extends Xe{};m(Rt,"ItemDisadvantage");var Lt=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.rule",e.rule)]}};m(Lt,"ItemSpecialability");var Ft=class extends C{};m(Ft,"ItemAhnengeschenk");var $e=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.AeP",e.AeP),this._chatLineHelper("dsk.distribution",e.distribution),this._chatLineHelper("dsk.duration",e.duration),this._chatLineHelper("dsk.range",e.range),this._chatLineHelper("dsk.targetCategory",e.targetCategory)]}static async getCallbackData(e,t,s){e.testDifficulty=0,e.situationalModifiers=D._parseModifiers(t),D.schipsModifier(t,e.situationalModifiers),e.situationalModifiers.some(i=>i.name==game.i18n.localize("dsk.schips"))&&s.reduceSchips(0);let a=new FormDataExtended(t.find("form")[0]).object;e.calculatedSpellModifiers={castingTime:t.find(".castingTime").text(),cost:t.find(".aspcost").text(),reach:t.find(".reach").text()},e.situationalModifiers.push({name:game.i18n.localize("dsk.removeGesture"),value:Number(a.removeGesture)||0},{name:game.i18n.localize("dsk.removeFormula"),value:Number(a.removeFormula)||0},{name:game.i18n.localize("dsk.zkModifier"),value:a.zkModifier||0},{name:game.i18n.localize("dsk.skModifier"),value:a.skModifier||0}),e.extensions=$e.getSpecAbModifiers(t),e.advancedModifiers={chars:[0,1].map(i=>a[`ch${i}`]),fws:a.fw,qls:a.qs},C.changeChars(e.source,...[0,1].map(i=>a[`characteristics${i}`]))}static getSpecAbModifiers(e){let t=[];for(let s of e.find(".specAbs.active"))t.push({name:s.dataset.name,title:s.getAttribute("title"),uuid:s.dataset.uuid});return t}static getSituationalModifiers(e,t,s,a){e.push(...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.magicalAttunement"),1,!0),...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.magicalRestriction"),-1,!0),...E.getVantageAsModifier(t,game.i18n.localize("dsk.LocalizedIDs.boundToArtifact"),-1,!0)),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&M.addCreatureTypeModifiers(i.actor,a,e,t)}),e.push(...t.getSkillModifier(a.name,a.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value});this.getSkZkModifier(s,a)}static setupDialog(e,t,s,a,i){let r="ahnen",n=s.name+" "+game.i18n.localize("dsk.probe")+(t.subtitle||""),l={opposable:!!s.system.effectFormula,source:s,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)},advancedModifiers:{chars:[0,0],fws:0,qls:0}},c={rollMode:t.rollMode,hasSKModifier:s.system.resist=="sk",hasZKModifier:s.system.resist=="zk",spellReach:s.system.range,hasSchips:this.hasSchips(a),characteristics:[1,2].map(f=>s.system[`characteristic${f}`])},u=a?O.getRollModifiers(a,s):[];this.getSituationalModifiers(u,a,c,s),c.situationalModifiers=u;let d={title:n,template:`/systems/dsk/templates/dialog/${r}-enhanced-dialog.html`,data:c,callback:async(f,k={})=>(p.rollMode=f.find('[name="rollMode"]').val(),await this.getCallbackData(l,f,a),mergeObject(l.extra.options,k),{testData:l,cardOptions:p})},p=a._setupCardOptions("systems/dsk/templates/chat/roll/spell-card.html",n,i);return _DiceDSK.setupDialog({dialogOptions:d,testData:l,cardOptions:p})}};m($e,"ItemAhnengabe");var Ht=class extends C{static chatData(e,t){return[this._chatLineHelper("dsk.stepValue",e.level),this._chatLineHelper("dsk.poisonType",e.category),this._chatLineHelper("dsk.start",e.start),this._chatLineHelper("dsk.duration",e.duration),this._chatLineHelper("dsk.resistanceModifier",e.resist),this._chatLineHelper("dsk.effect",g.replaceConditions(g.replaceDies(e.effect)))]}static getSituationalModifiers(e,t,s,a){a=g.toObjectIfPossible(a),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&e.push(...E.getVantageAsModifier(i.actor,game.i18n.localize("dsk.LocalizedIDs.poisonResistance"),-1,!1,!0))}),this.getSkZkModifier(s,a),mergeObject(s,{hasSKModifier:a.system.resist=="SK",hasZKModifier:a.system.resist=="ZK"})}static setupDialog(e,t,s,a,i){let r=s.name+" "+game.i18n.localize("TYPES.Item."+s.type)+" "+game.i18n.localize("dsk.check"),n={opposable:!1,source:s,extra:{options:t,speaker:C.buildSpeaker(a,i)}},l={rollMode:t.rollMode},c=[];this.getSituationalModifiers(c,a,l,s),l.situationalModifiers=c;let u={title:r,template:"/systems/dsk/templates/dialog/poison-dialog.html",data:l,callback:(p,f={})=>(d.rollMode=p.find('[name="rollMode"]').val(),n.situationalModifiers=D._parseModifiers(p),n.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:p.find('[name="zkModifier"]').val()||0}),n.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:p.find('[name="skModifier"]').val()||0}),mergeObject(n.extra.options,f),{testData:n,cardOptions:d})},d=s._setupCardOptions(`systems/dsk/templates/chat/roll/${s.type}-card.html`,r,i);return _DiceDSK.setupDialog({dialogOptions:u,testData:n,cardOptions:d})}};m(Ht,"ItemPoison");var jt=class extends C{static getSituationalModifiers(e,t,s,a){e.push(...t.getSkillModifier(a.name,a.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value})}static setupDialog(e,t,s,a,i){let r=s.name+" "+game.i18n.localize("dsk.probe")+(t.subtitle||""),n={opposable:!0,source:s,extra:{actor:a.toObject(!1),options:t,speaker:C.buildSpeaker(a,i)}},l={rollMode:t.rollMode,modifier:t.modifier||0,difficultyLabels:v.skillDifficultyLabels,hasSchips:this.hasSchips(a),characteristics:[1,2].map(d=>s.system[`characteristic${d}`]),situationalModifiers:a?O.getRollModifiers(a,s):[]};t.situationalModifiers&&l.situationalModifiers.push(...t.situationalModifiers),this.getSituationalModifiers(l.situationalModifiers,a,l,s);let c={title:r,template:"/systems/dsk/templates/dialog/skill-dialog.html",data:l,callback:(d,p={})=>(u.rollMode=d.find('[name="rollMode"]').val(),n.situationalModifiers=D._parseModifiers(d),D.schipsModifier(d,n.situationalModifiers),n.situationalModifiers.some(f=>f.name==game.i18n.localize("dsk.schips"))&&a.reduceSchips(0),n.testDifficulty=v.skillDifficultyModifiers[d.find('[name="testDifficulty"]').val()],n.advancedModifiers={chars:[0,1].map(f=>Number(d.find(`[name="ch${f}"]`).val())),fws:Number(d.find('[name="fw"]').val()),qls:Number(d.find('[name="qs"]').val())},C.changeChars(n.source,...[0,1].map(f=>d.find(`[name="characteristics${f}"]`).val())),mergeObject(n.extra.options,p),{testData:n,cardOptions:u})},u=a._setupCardOptions("systems/dsk/templates/chat/roll/skill-card.html",r,i);return _DiceDSK.setupDialog({dialogOptions:c,testData:n,cardOptions:u})}};m(jt,"ItemSkill");var Bt=class extends C{};m(Bt,"ItemCombatskill");function Is(o,e=320,t=40){o.attr({width:e*.8,viewBox:`0 0 ${e} ${t}`});let s=o.find("text"),a=s.get(0).getBBox(),i=e/a.width,r=t/a.height,n=i<r,l=n?i:r;isFinite(l)&&s.attr({transform:"matrix("+l+", 0, 0, "+l+", 0,0)",x:Math.max(0,(e-a.width)/2),y:t*.75/(n?1:l)})}m(Is,"svgAutoFit");function As(o,e,t,s="div"){if(e=o.find(e)[0],!e)return;e.classList.add("slist");let a=e.querySelectorAll(s),i=null;for(let r of a)r.draggable=!0,r.addEventListener("dragstart",function(n){i=this}),r.addEventListener("dragover",function(n){n.preventDefault()}),r.addEventListener("drop",async function(n){if(n.preventDefault(),this!=i){let l=0,c=0;for(let u=0;u<a.length;u++)i==a[u]&&(l=u),this==a[u]&&(c=u);l<c?this.parentNode.insertBefore(i,this.nextSibling):this.parentNode.insertBefore(i,this),await t(e)}})}m(As,"slist");function $s(o){let e=$(".tinyNotifications");e.length||($("body").append('<ul class="tinyNotifications"></ul>'),e=$(".tinyNotifications"));let t=$(`<li>${o}</li>`);e.prepend(t),setTimeout(function(){t.remove()},1500)}m($s,"tinyNotification");async function Gt(o,e,t=!0){let s,a;o.type=="Actor"?(s=await Actor.implementation.fromDropData(o),a=e===s.id):(s=await Item.implementation.fromDropData(o),a=e===s.parent?.uuid);let i=s?.type;return t&&(s=s.toObject()),o.amount&&(s.system.quantity.value=Number(o.amount)),{item:s,typeClass:i,selfTarget:a}}m(Gt,"itemFromDrop");var L=class{static async handleOpposedTarget(e){if(!e)return;let t=g.getSpeaker(e.speaker);if(!t)return;let s=e.flags.data.postData,a=e.flags.data.preData;game.user.targets.size&&e.flags.data.isOpposedTest&&!e.flags.data.defenderMessage&&!e.flags.data.attackerMessage&&(console.log("start opposed"),L.createOpposedTest(t,e,s,a)),await this.showDamage(e),await this.showSpellWithoutTarget(e)}static async createOpposedTest(e,t,s,a){let i;t.speaker.token?i=canvas.tokens.get(t.speaker.token).document:i=e.prototypeToken,s.successLevel>0?game.user.targets.forEach(async r=>{if(r.actor)switch(s.rollType){case"weapon":await L.evaluateAttack(e,t,s,a,i,r);break;default:let n=L.opposeMessage(i,r,!1);await ChatMessage.create({user:game.user.id,content:n,speaker:t.speaker,["flags.unopposeData"]:{attackMessageId:t.id,targetSpeaker:{scene:r.scene.id,token:r.id,alias:r.document.name}}})}}):game.user.targets.forEach(async r=>{r.actor&&await ChatMessage.create({user:game.user.id,content:L.opposeMessage(i,r,!0),speaker:t.speaker})})}static async evaluateAttack(e,t,s,a,i,r){if(s.qualityStep>0){s.source=a.source;let n=L._calculateOpposedDamage(s,r),l=[n.armorMod!=0?`${n.armorMod+" "+game.i18n.localize("dsk.Modifier")}`:"",n.armorMultiplier!=1?"*"+n.armorMultiplier+" "+game.i18n.localize("dsk.Modifier"):"",n.spellArmor!=0?`${n.spellArmor} ${game.i18n.localize("dsk.spellArmor")}`:""].join(""),c=`<b>${game.i18n.localize("dsk.damage")}</b>: ${n.damage}<i class="lighticon fa attackWeaponless" data-tooltip="Roll"></i> - <span data-tooltip="${l}">${n.armor}</span><i class="lighticon fa fa-shield-alt" data-tooltip="protection"></i> = ${n.sum}`,u={winner:"attacker",damage:{description:c,value:n.sum,sp:n.damage}};u=L.formatOpposedResult(u,i,r,s),await L.renderOpposedResult(u,{}),await L.playAutomatedJBA2(u.speakerAttack,u.speakerDefend,u)}}static _calculateOpposedDamage(e,t,s={}){let a=t.actor;s.origin=e.source,s.damage=e.damage;let i=_DSKActiveEffectConfig.applyRollTransformation(a,s,5).options.damage,{wornArmor:r,armor:n}=D.armorValue(a,s),l=[],c=0,u=e.armorPen||[];for(let f of u)/^\*/.test(f)?l.push(Number(f.replace("*",""))):c+=Number(f);let d=0;["ahnengabe"].includes(e.source.type)&&(d+=a.system.spellArmor||0),n+=c;let p=l.reduce((f,k)=>f*k,1);return n=Math.max(Math.round(n*p),0),n+=d,{damage:i,armor:n,armorMod:c,spellArmor:d,armorMultiplier:p,sum:i-n}}static formatOpposedResult(e,t,s,a){let i=e.differenceSL?"winsFP":"wins";return e.winner=="attacker"?(e.result=game.i18n.format("dsk.OPPOSED."+i,{winner:t.name,loser:s.name,SL:e.differenceSL}),e.img=t.img):e.winner=="defender"&&(e.result=game.i18n.format("dsk.OPPOSED."+i,{winner:s.name,loser:t.name,SL:e.differenceSL}),e.img=s.img),e.speakerAttack=L.tokenDude(t,a),e.speakerDefend=L.tokenDude(s,{}),e}static tokenDude(e,t){return{speaker:{token:e.id,actor:e.actor?.id,scene:canvas.scene?.id},img:L.videoOrImgTag(e.document?.texture.src||e.texture.src),testResult:t}}static async renderOpposedResult(e,t={}){e.hideData=await game.settings.get("dsk","hideOpposedDamage");let s=await renderTemplate("systems/dsk/templates/chat/roll/opposed-result.html",e),a={user:game.user.id,content:s,"flags.opposeData":e,"flags.hideData":e.hideData,whisper:t.whisper,blind:t.blind};await ChatMessage.create(a)}static opposeMessage(e,t,s){return`<div class="opposed-message">
            <b>${e.name}</b> ${game.i18n.localize("dsk.ROLL.Targeting")} <b>${t.document.name}</b> ${s?game.i18n.localize("dsk.ROLL.failed"):""}
            </div>
            <div class="opposed-tokens row-section">
                <div class="col two attacker">${L.videoOrImgTag(e.texture.src)}</div>
                <div class="col two defender">${L.videoOrImgTag(t.document.texture.src)}</div>
            </div>
             `}static async playAutomatedJBA2(e,t,s){if(g.moduleEnabled("autoanimations")){let a=g.getSpeaker(e.speaker).getActiveTokens()[0],i=g.getSpeaker(t.speaker).getActiveTokens()[0];if(!a||!a.actor||!i||!i.actor)return;let r=a.actor.items.get(e.testResult.source._id);if(r||(r=new C(e.testResult.source,{temporary:!0})),!r)return;let n=[i],l=s.winner=="attacker"?n:[];AutomatedAnimations.playAnimation(a,r,{targets:n,hitTargets:l,playOnMiss:!0})}}static videoOrImgTag(e){return/\.webm$/.test(e)?`<video loop autoplay src="${e}" width="50" height="50"></video>`:`<img src="${e}" width="50" height="50"/>`}static async showDamage(e,t=!1){game.user.isGM?(!t||!e.flags.data.hideDamage)&&e.flags.data.postData.damageRoll&&(await e.update({content:e.content.replace(`data-hide-damage="${!t}"`,`data-hide-damage="${t}"`),"flags.data.hideDamage":t}),t||_DiceDSK._addRollDiceSoNice(e.flags.data.preData,Roll.fromData(e.flags.data.postData.damageRoll),game.dsk.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"))):game.socket.emit("system.dsk",{type:"showDamage",payload:{id:e.id,hide:t}})}static async showSpellWithoutTarget(e){if(g.moduleEnabled("autoanimations")){let t=getProperty(e,"flags.data");if(!t||t.isOpposedTest)return;if((getProperty(t,"postData.result")||-1)>0){let a=g.getSpeaker(t.postData.speaker).getActiveTokens()[0];if(!a||!a.actor)return;let i=Array.from(game.user.targets),r=a.actor.items.get(t.preData.source._id);i.length||(i=[a]),AutomatedAnimations.playAnimation(a,r,{targets:i})}}}};m(L,"OpposedDSK");var N=class extends Actor{static async create(e,t){if(e instanceof Array||e.items)return await super.create(e,t);(!e.img||e.img=="icons/svg/mystery-man.svg")&&(e.img="icons/svg/mystery-man-black.svg");let s=["skill","combatskill"];["character","npc"].includes(e.type)&&s.push("meleeweapon","specialability"),e.items=await g.allSkills(s);let a={character:3,npc:1,creature:0},i=getProperty(e,"system.stats.schips.current")||a[e.type]||0;return e.system={stats:{schips:{current:i,value:i}}},e.type!="creature"&&[void 0,0].includes(getProperty(e,"system.stats.LeP.value"))&&mergeObject(e,{system:{stats:{LeP:{value:16}}}}),await super.create(e,t)}prepareDerivedData(){let e=this.system;try{e.canAdvance=this.isOwner&&this.type=="character";for(let n of Object.values(e.characteristics))n.value=n.initial+n.advances+(n.modifier||0)+n.gearmodifier;e.totalWeight=0;let t=[],s=new Map,a=this.items.filter(n=>n.type=="equipment"&&n.system.category=="bags");for(let n of a)s.set(n.id,[]);for(let n of this.items)if(N._baseCarryItems.has(n.type)){let l=getProperty(n,"system.parent_id");if(l&&l!=n._id&&s.has(l)){s.get(l).push(n);continue}n.type=="armor"?(n.system.preparedWeight=parseFloat((n.system.weight*n.system.quantity).toFixed(3)),e.totalWeight+=parseFloat((n.system.weight*(n.system.worn.value?Math.max(0,n.system.quantity-1):n.system.quantity)).toFixed(3)),n.system.worn.value&&t.push(n)):(n.system.preparedWeight=parseFloat((n.system.weight*n.system.quantity).toFixed(3)),e.totalWeight+=Number(n.system.preparedWeight))}else switch(n.type){case"ahnengabe":case"ahnengeschenk":e.isMage=!0;break;case"specialability":N._mageSpecs.has(n.system.category)&&(e.isMage=!0);break}for(let n of a){let l=getProperty(n,"system.parent_id");(!l||!s.has(l))&&(e.totalWeight+=this._calcBagweight(n,s,!0))}e.carrycapacity=e.characteristics.kk.value*2+e.carryModifier,e.canAdvance&&(e.details.experience.current=e.details.experience.total-e.details.experience.spent),(this.type=="character"||this.type=="npc")&&(e.stats.LeP.current=e.stats.LeP.initial+e.characteristics.ko.value*2,e.stats.AeP.current=!e.guidevalue||e.guidevalue=="-"?0:N._attrFromCharacteristic(e.guidevalue,e),e.stats.sk.value=(e.stats.sk.initial||0)+Math.round((e.characteristics.mu.value+e.characteristics.kl.value+e.characteristics.in.value)/3)-10,e.stats.zk.value=(e.stats.zk.initial||0)+Math.round((e.characteristics.ko.value+e.characteristics.ko.value+e.characteristics.kk.value)/3)-10,e.stats.ini.value=Math.round((e.characteristics.mu.value+e.characteristics.ge.value)/2)+(e.stats.ini.modifier||0),e.stats.LeP.min=-1*e.characteristics.ko.value),this.type=="creature"&&(e.stats.LeP.current=e.stats.LeP.initial,e.stats.AeP.current=e.stats.AeP.initial,e.stats.ini.value=e.stats.ini.current+(e.stats.ini.modifier||0)),e.stats.schips.max=Number(e.stats.schips.current)+Number(e.stats.schips.modifier)+e.stats.schips.gearmodifier,e.stats.regeneration.LePmax=e.stats.regeneration.LePTemp+e.stats.regeneration.LePMod+e.stats.regeneration.LePgearmodifier,e.stats.regeneration.AePmax=e.stats.regeneration.AePTemp+e.stats.regeneration.AePMod+e.stats.regeneration.AePgearmodifier,e.stats.LeP.max=Math.round((e.stats.LeP.current+e.stats.LeP.modifier+e.stats.LeP.advances)*e.stats.LeP.multiplier+e.stats.LeP.gearmodifier),e.stats.AeP.max=e.stats.AeP.current+e.stats.AeP.modifier+e.stats.AeP.advances+e.stats.AeP.gearmodifier,e.stats.gs.max=Math.max(0,e.stats.gs.initial+(e.stats.gs.modifier||0)+e.stats.gs.gearmodifier),e.stats.sk.max=e.stats.sk.value+e.stats.sk.modifier+e.stats.sk.gearmodifier,e.stats.zk.max=e.stats.zk.value+e.stats.zk.modifier+e.stats.zk.gearmodifier;let i=0;e.stats.ini.value+=e.stats.ini.gearmodifier-Math.min(4,i);let r=Number((.01*e.stats.ini.value).toFixed(2));e.stats.ini.value*=e.stats.ini.multiplier||1,e.stats.ini.value=Math.round(e.stats.ini.value)+r;for(let n of Object.keys(e.status))e.status[n]=Math.clamped(e.status[n],0,8);e.armorEncumbrance=this.getArmorEncumbrance(this,t),this.effectivePain(e),e.maxDefense=this.maxDefenseValue()}catch(t){console.error("Something went wrong with preparing actor data: "+t+t.stack),ui.notifications.error(game.i18n.format("dsk.DSKError.PreparationError",{name:this.name})+t+t.stack)}}static async deferredEffectAddition(e,t,s){let i=(t.effects.find(n=>n.statuses.has(e))?.flags.dsk.auto||0)!=s,r=`changing${e}`;t[r]=i,i&&await t.addCondition(e,s,!0).then(()=>t[r]=void 0)}static async postUpdateConditions(e){let t=e.system,s=e.isMerchant();if(!le.hasTrait(e,game.i18n.localize("dsk.LocalizedIDs.painImmunity"))){let i=e.woundPain(t);await this.deferredEffectAddition("inpain",e,i*2)}let a=t.armorEncumbrance;(e.type!="creature"||e.canAdvance)&&!s&&(a+=Math.max(0,Math.ceil((t.totalWeight-t.carrycapacity-5)/5))*2),await this.deferredEffectAddition("encumbered",e,a),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.blind"))&&await e.addCondition("blind"),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.mute"))&&await e.addCondition("mute"),E.hasVantage(e,game.i18n.localize("dsk.LocalizedIDs.deaf"))&&await e.addCondition("deaf"),s&&e.prepareMerchant()}static async _onCreateDocuments(e,t){for(let s of e)await N.postUpdateConditions(s);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let s of e)await N.postUpdateConditions(s);return super._onUpdateDocuments(e,t)}_calcBagweight(e,t,s=!0){let a=0;if(t.has(e._id)){let i=0;!e.system.worn.value&&s&&(a-=e.system.preparedWeight);for(let r of t.get(e._id))r.system.preparedWeight=Number(parseFloat((r.system.weight*r.system.quantity).toFixed(3))),t.has(r._id)?i+=this._calcBagweight(r,t,!1):i+=r.system.preparedWeight;s?e.system.worn.value&&(a+=i):a+=i+e.system.preparedWeight,e.system.bagweight=`${i.toFixed(3)}/${e.system.capacity||0}`}return a}effectivePain(e){let t=e.status.inpain||0;t<8&&(t-=E.vantageStep(this,game.i18n.localize("dsk.LocalizedIDs.ruggedFighter"))),t>0&&(t+=E.vantageStep(this,game.i18n.localize("dsk.LocalizedIDs.sensitiveToPain"))),t=Math.clamped(t,0,8),e.status.inpain=t}woundPain(e){let t=0;return e.stats.LeP.max>0&&(this.type!="creature"||e.stats.LeP.max>=20?(t=Math.floor((1-e.stats.LeP.value/e.stats.LeP.max)*4),e.stats.LeP.value<=5&&(t=4)):t=Math.floor(5-5*e.stats.LeP.value/e.stats.LeP.max)),Math.clamped(t,0,4)}static _calculateCombatSkillValues(e,t){return e=N._calculatePW(e,t),e.system.attack=e.PW,e.system.weapontype=="melee"?e.system.parry=Math.round(e.PW*.25):e.system.parry=0,e.cost=game.i18n.format("dsk.advancementCost",{cost:g._calculateAdvCost(e.system.level,e.system.StF)}),e}async prepareMerchant(){if(getProperty(this,"system.merchant.merchantType")=="loot"){if(getProperty(this,"system.merchant.locked")&&!this.hasCondition("locked"))await this.addCondition(N.lockedCondition());else if(!getProperty(this,"system.merchant.locked")){let e=this.effects.find(t=>t.statuses.has("locked"));e&&await this.deleteEmbeddedDocuments("ActiveEffect",[e.id])}}}static lockedCondition(){return{id:"locked",name:game.i18n.localize("dsk.MERCHANT.locked"),icon:"icons/svg/padlock.svg",flags:{dsk:{value:null,editable:!0,noEffect:!0,hidePlayers:!0,description:game.i18n.localize("dsk.MERCHANT.locked"),custom:!0}}}}isMerchant(){return["merchant","loot"].includes(getProperty(this,"system.merchant.merchantType"))}applyActiveEffects(){let e={};this.statuses??(this.statuses=new Set);let t=new Map;for(let n of Object.values(CONFIG.specialStatusEffects))t.set(n,this.statuses.has(n));this.statuses.clear();let s=[],a=1;for(let n of this.effects){if(n.disabled)continue;a=1;let l=n.getFlag("dsk","value");l&&(a=Number(l));for(let c=0;c<a;c++)s.push(...n.changes.map(u=>(u=foundry.utils.duplicate(u),u.effect=n,u.priority=u.priority?u.priority:u.mode*10,u)));for(let c of n.statuses)this.statuses.add(c)}let i=!0;for(let n of this.items)for(let l of n.effects)if(!l.disabled){switch(i=!0,n.type){case"meleeweapon":case"rangeweapon":case"armor":i=n.system.worn.value;break;case"equipment":i=!n.system.worn.wearable||n.system.worn.wearable&&n.system.worn.value;break;case"trait":i=!["meleeAttack","rangeAttack"].includes(n.system.traitType);break;case"ammunition":case"combatskill":case"poison":case"ahnengabe":case"ahnengeschenk":i=!1;break;case"specialability":i=n.system.category!="Combat"||[2,3].includes(n.system.subcategory),a=Number(n.system.level)||1;break;case"advantage":case"disadvantage":a=Number(n.system.level)||1;break}if(l.notApplicable=!i,!!i){for(let c=0;c<a;c++)s.push(...l.changes.map(u=>(u=foundry.utils.duplicate(u),u.effect=l,u.priority=u.priority?u.priority:u.mode*10,u)));for(let c of l.statuses)this.statuses.add(c)}}s.sort((n,l)=>n.priority-l.priority);for(let n of s){if(!n.key)continue;let l=n.effect.apply(this,n);Object.assign(e,l)}this.overrides=foundry.utils.expandObject(e);let r;for(let[n,l]of t){let c=this.statuses.has(n);if(c!==l){r??(r=this.getActiveTokens());for(let u of r)u._onApplyStatusEffect(n,c)}}}maxDefenseValue(){let e={parry:0,name:game.i18n.localize("dsk.noDefense")},t=[],s=[];for(let a of this.items)if(a.type=="combatskill")t.push(N._calculateCombatSkillValues(a,this.system));else if(a.type=="meleeweapon")getProperty(a,"system.worn.value")&&s.push(a);else if(a.type=="trait"&&a.system.traitType=="meleeAttack"){let i=N._prepareMeleetrait(a,this);i.parry>e.parry&&(e=i)}for(let a of s){let i=N._prepareMeleeWeapon(a,t,this,s.filter(r=>r._id!=a._id&&!_.isYieldedTwohanded(r)));i.parry>=e.parry&&(e=i)}return e}preparePostRollAction(e){let t=e.flags.data,s={flags:{img:e.flags.img},rollMode:t.rollMode,speaker:e.speaker,template:t.template,title:t.title,user:e.user};return t.attackerMessage&&(s.attackerMessage=t.attackerMessage),t.defenderMessage&&(s.defenderMessage=t.defenderMessage),t.unopposedStartMessage&&(s.unopposedStartMessage=t.unopposedStartMessage),s}async useFateOnRoll(e,t,s){if(t=="isTalented"||g.fateAvailable(this,s==1)){let a=e.flags.data,i=this.preparePostRollAction(e),r,n;s==0?(r=this.system.stats.schips.value-1,n="PointsRemaining"):(r=game.settings.get("dsk","groupschips").split("/")[0],n="GroupPointsRemaining");let l=`<h3 class="center"><b>${game.i18n.localize("dsk.CHATFATE.fatepointUsed")}</b></h3>
                  ${game.i18n.format("dsk.CHATFATE."+t,{character:"<b>"+this.name+"</b>"})}<br>
                  <b>${game.i18n.localize(`dsk.CHATFATE.${n}`)}</b>: ${r}`,c=a.preData;c.extra.actor=g.getSpeaker(c.extra.speaker).toObject(!1),this[`fate${t}`](l,i,c,e,a,s)}}resetTargetAndMessage(e,t){e.originalTargets?.size&&(game.user.targets=e.originalTargets,game.user.targets.user=game.user),!e.defenderMessage&&e.startMessagesList&&(t.startMessagesList=e.startMessagesList)}async fatererollDamage(e,t,s,a,i,r){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let n=await renderTemplate("systems/dsk/templates/dialog/fateReroll-dialogDamage.html",{testData:s,postData:i.postData,singleDie:i.postData.characteristics.filter(l=>l.char=="damage").length==1});new G({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async l=>{let c=l.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let u=Roll.fromData(i.postData.damageRoll),d=await _DiceDSK.manualRolls(await new Roll(u.formula||u._formula).evaluate({async:!0}),"dsk.CHATCONTEXT.rerollDamage");await _DiceDSK.showDiceSoNice(d,s.rollMode);for(let T=0;T<d.dice.length;T++)d.dice[T].options.colorset="black";let p=0,f=[],k=[];for(let T of c)f.push(`${u.terms[(T-2)*2].results[0].result}/${d.terms[p*2].results[0].result}`),k.push({index:(T-2)*2,val:d.terms[p*2].results[0].result}),p+=1;u.editRollAtIndex(k),s.damageRoll=u,e+=`<br><b>${game.i18n.localize("dsk.Roll")}</b>: ${f.join(", ")}`,ChatMessage.create(g.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:s,cardOptions:t},{rerenderMessage:a}),await a.update({"flags.data.fatePointDamageRerollUsed":!0}),await this.reduceSchips(r)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async fatereroll(e,t,s,a,i,r){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let n=await renderTemplate("systems/dsk/templates/dialog/fateReroll-dialog.html",{testData:s,postData:i.postData,singleDie:i.postData.characteristics.filter(l=>l.char!="damage").length==1});new G({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async l=>{let c=l.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let u=[];for(let h of c){let y=s.roll.terms[h*2];u.push(y.number+"d"+y.faces+"["+y.options.colorset+"]")}u=await _DiceDSK.manualRolls(await new Roll(u.join("+")).evaluate({async:!0}),"dsk.CHATCONTEXT.Reroll"),await _DiceDSK.showDiceSoNice(u,s.rollMode);let d=0,p=[],f=g.getSpeaker(s.extra.speaker),k=game.i18n.localize("dsk.LocalizedIDs.traditionPhex"),T=f.items.some(h=>h.type=="specialability"&&h.name==k);for(let h of c){let y=s.source.system[`characteristic${h+1}`],b=y?`${game.i18n.localize(`dsk.characteristics.${y}.abbr`)} - `:"";p.push(`${b}${s.roll.terms[h*2].results[0].result}/${u.terms[d*2].results[0].result}`),T?s.roll.terms[h*2].results[0].result=Math.min(u.terms[d*2].results[0].result,s.roll.terms[h*2].results[0].result):s.roll.terms[h*2].results[0].result=u.terms[d*2].results[0].result,d+=1}e+=`<br><b>${game.i18n.localize("dsk.Roll")}</b>: ${p.join(", ")}`,ChatMessage.create(g.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:s,cardOptions:t},{rerenderMessage:a}),await a.update({"flags.data.fatePointRerollUsed":!0}),await this.reduceSchips(r)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async fateisTalented(e,t,s,a,i){t.talentedRerollUsed=!0,this.resetTargetAndMessage(i,t),e=`<h3 class="center"><b>${game.i18n.localize("dsk.CHATFATE.fatepointUsed")}</b></h3>
              ${game.i18n.format("dsk.CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"})}<br>`;let r=await renderTemplate("systems/dsk/templates/dialog/isTalentedReroll-dialog.html",{testData:s,postData:i.postData});new G({title:game.i18n.localize("dsk.CHATFATE.selectDice"),content:r,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async n=>{let l=n.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(l.length>0){let c=[];for(let p of l){let f=s.roll.terms[p*2];c.push(f.number+"d"+f.faces+"["+f.options.colorset+"]")}c=await _DiceDSK.manualRolls(await new Roll(c.join("+")).evaluate({async:!0}),"dsk.CHATCONTEXT.talentedReroll"),await _DiceDSK.showDiceSoNice(c,s.rollMode);let u=0,d=[];for(let p of l){let f=s.source.system[`characteristic${p+1}`],k=f?`${game.i18n.localize(`dsk.characteristics.${f}.abbr`)} - `:"";d.push(`${k}${s.roll.terms[p*2].results[0].result}/${c.terms[u*2].results[0].result}`),s.roll.terms[p*2].results[0].result=c.terms[u*2].results[0].result,u+=1}e+=`<b>${game.i18n.localize("dsk.Roll")}</b>: ${d.join(", ")}`,ChatMessage.create(g.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:s,cardOptions:t},{rerenderMessage:a}),await a.update({"flags.data.talentedRerollUsed":!0})}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)}async reduceSchips(e){e==0?await this.update({"system.stats.schips.value":this.system.stats.schips.value-1}):await N.reduceGroupSchip()}async modifyTokenAttribute(e,t,s=!1,a=!0){let i=foundry.utils.getProperty(this.system,e),r;return a?(s&&(t=Math.clamped(i.min||0,Number(i.value)+t,i.max)),r={[`system.${e}.value`]:t}):(s&&(t=Number(i)+t),r={[`system.${e}`]:t}),Hooks.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:s,isBar:a},r)!==!1?this.update(r):this}static armorValue(e,t={}){let s=e.items.filter(r=>r.type=="armor"&&r.system.worn.value==!0);t.origin&&(s=s.map(r=>{let n=mergeObject(duplicate(t),{armor:r});return _DSKActiveEffectConfig.applyRollTransformation(e,n,4).options.armor}));let a=s.reduce((r,n)=>r+n.system.rs,0),i=e.items.filter(r=>r.type=="trait"&&r.system.traitType=="armor").reduce((r,n)=>r+Number(n.system.at),0);return{wornArmor:s,armor:a+i+(e.system.totalArmor||0)}}prepareBaseData(){let e=this.system;mergeObject(e,{skillModifiers:{FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AePCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],AePCost:[]},...["ahnengabe","skill"].reduce((t,s)=>(t[s]={FP:[],step:[],QL:[],TPM:[],FW:[]},t),{})},repeatingEffects:{startOfRound:{LeP:[],AeP:[]}},aepModifier:0,creatureBonus:[],stats:{initiative:{multiplier:1},LeP:{multiplier:1},regeneration:{LePgearmodifier:0,AePgearmodifier:0}},status:{encumbered:0,stunned:0,feared:0,inpain:0,selfconfidence:0},spellStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},totalArmor:0,carryModifier:0});for(let t of Object.values(e.stats))t.gearmodifier=0;for(let t of Object.values(e.characteristics))t.gearmodifier=0}prepareSheet(e){let t=duplicate(this),s={system:{characteristics:{}}};if(mergeObject(s,this.prepareItems(e)),s.canAdvance){let a=["LeP","AeP"];for(let i of a)mergeObject(s.system,{stats:{[i]:{cost:game.i18n.format("dsk.advancementCost",{cost:g._calculateAdvCost(t.system.stats[i].advances,"D")}),refund:game.i18n.format("dsk.refundCost",{cost:g._calculateAdvCost(t.system.stats[i].advances,"D",0)})}}});for(let[i,r]of Object.entries(this.system.characteristics))s.system.characteristics[i]={cost:game.i18n.format("dsk.advancementCost",{cost:g._calculateAdvCost(r.initial+r.advances,"Eig")}),refund:game.i18n.format("dsk.refundCost",{cost:g._calculateAdvCost(r.initial+r.advances,"Eig",0)})}}return s}_perpareItemAdvancementCost(e){return e.cost=game.i18n.format("dsk.advancementCost",{cost:g._calculateAdvCost(e.system.level,e.system.StF)}),e.refund=game.i18n.format("dsk.refundCost",{cost:g._calculateAdvCost(e.system.level,e.system.StF,0)}),e.canAdvance=this.system.canAdvance,e}static _prepareRangeTrait(e,t){return e.attack=Number(e.system.at)+Number(t.system.rangeStats.attack),e.LZ=Number(e.system.lz),e.LZ>0&&N.buildReloadProgress(e),this._parseDmg(e)}static _prepareRangeWeapon(e,t,s,a){let i=s.find(n=>n.name==e.system.combatskill);e.calculatedRange=e.system.rw;let r;if(i){if(e.attack=Number(i.system.attack)+Number(a.system.rangeStats.attack),e.system.ammunitionType!="-"&&(e.ammo=t.filter(n=>n.system.ammunitionType==e.system.ammunitionType),r=t.find(n=>n._id==e.system.currentAmmo),r)){let n=Number(r.system.rangeMultiplier)||1;e.calculatedRange=e.calculatedRange.split("/").map(l=>Math.round(Number(l)*n)).join("/"),e.attack+=Number(r.system.atmod)||0,r.system.ammunitionType=="mag"&&(e.ammoMax=r.system.mag.max,e.ammoCurrent=r.system.mag.value)}e.LZ=N.calcLZ(e,a),e.LZ>0&&N.buildReloadProgress(e)}else ui.notifications.error(game.i18n.format("dsk.DSKError.unknownCombatSkill",{skill:e.system.combatskill,item:e.name}));return this._parseDmg(e,r)}static _prepareMeleetrait(e,t){return e.attack=Number(e.system.at),e.parry=Math.max(0,(Number(e.system.pa)||Math.round(e.attack/4))+Number(t.system.meleeStats.parry)),this._parseDmg(e)}static _prepareMeleeWeapon(e,t,s,a=null){let i=t.find(r=>r.name==e.system.combatskill);if(i){e.attack=Number(i.system.attack)+Number(e.system.aw),e.parry=Math.max(0,i.system.parry+Number(e.system.vw)+Number(s.system.meleeStats.parry)+(e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Shields")?Number(e.system.vw):0)),e.yieldedTwoHand=_.isYieldedTwohanded(e),e.yieldedTwoHand||(a||(a=duplicate(s.items).filter(n=>n.type=="meleeweapon"&&n.system.worn.value&&n._id!=e._id&&!_.isYieldedTwohanded(n))),a.length>0&&(e.parry+=Math.max(...a.map(n=>n.system.vwoffhand)),e.attack+=Math.max(...a.map(n=>n.system.awoffhand))));let r=0;e.system.worn.wrongGrip&&e.yieldedTwoHand&&(e.parry-=1,r+=1),e=this._parseDmg(e),r>0&&(e.extraDamage=r,e.damageAdd=Roll.safeEval(e.damageAdd+" + "+Number(r)),e.damageAdd=(e.damageAdd>0?"+":"")+e.damageAdd)}else ui.notifications.error(game.i18n.format("dsk.DSKError.unknownCombatSkill",{skill:e.system.combatskill,item:e.name}));return e}static _parseDmg(e,t=void 0){let s=new Roll(e.system.tp.replace(/[Ww]/g,"d"),{async:!1}),a="",i="",r="+";for(let n of s.terms)n.faces?a=n.number+"d"+n.faces:n.operator?r=n.operator:n.number&&(i+=Number(`${r}${n.number}`));if(t){let n=getProperty(t,"system.damageMod");Number(n)?i+=`+${Number(n)}`:n&&(e.damageBonusDescription=`, ${n} ${game.i18n.localize("dsk.CHARAbbrev.damage")} ${t.name}`)}return i&&(i=Roll.safeEval(i)),e.damagedie=a||"0d6",e.damageAdd=i!=""?(Number(i)>=0?"+":"")+i:"",e}static calcLZ(e,t){let s=1,a=0;e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Throwing Weapons")?a=x.abilityStep(t,game.i18n.localize("dsk.LocalizedIDs.quickdraw"))*-1:e.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Crossbows")&&x.hasAbility(t,game.i18n.localize("dsk.LocalizedIDs.quickload"))?s=.5:a=x.abilityStep(t,game.i18n.localize("dsk.LocalizedIDs.quickload"))*-1;let i=`${e.system.lz}`.split("/");if(e.system.ammunitionType=="mag"){let r=t.items.find(l=>l.id==e.system.currentAmmo||l._id==e.system.currentAmmo),n=0;r&&(r=g.toObjectIfPossible(r),r.system.mag.value<=0&&(n=1)),i=i[n]||i[0]}else i=i[0];return Math.max(0,Math.round(Number(i)*s)+a)}_setOnUseEffect(e){getProperty(e,"flags.dsk.onUseEffect")&&(e.OnUseEffect=!0)}static _attrFromCharacteristic(e,t){return t.characteristics[e].value}static _calculatePW(e,t){return e.PW=Math.round((N._attrFromCharacteristic(e.system.characteristic1,t)+N._attrFromCharacteristic(e.system.characteristic2,t))/2)+5+(e.system.level||0),e}static buildReloadProgress(e){let t=e.system.reloadTimeprogress/e.LZ;e.title=game.i18n.format("dsk.WEAPON.loading",{status:`${e.system.reloadTimeprogress}/${e.LZ}`}),e.progress=`${e.system.reloadTimeprogress}/${e.LZ}`,t>=1&&(e.title=game.i18n.localize("dsk.WEAPON.loaded")),this.progressTransformation(e,t)}static progressTransformation(e,t){t>=.5?(e.transformRight="181deg",e.transformLeft=`${Math.round(t*360-179)}deg`):(e.transformRight=`${Math.round(t*360+1)}deg`,e.transformLeft=0)}getArmorEncumbrance(e,t){let s=t.reduce((a,i)=>(i.system.calculatedEncumbrance=Number(i.system.encumbrance),a+=i.system.calculatedEncumbrance),0);return Math.max(0,s-x.abilityStep(e,game.i18n.localize("dsk.LocalizedIDs.inuredToEncumbrance")))}prepareItems(e){let t=this.toObject(!1),s=[],a=[],i=[],r=[],n=[],l=[],c=[],u=[],d=[],p=[],f=Object.fromEntries(Object.keys(v.specialAbilityCategories).map(S=>[S,[]])),k=Object.fromEntries(Object.keys(v.traitCategories).map(S=>[S,[]])),T={hasSpells:this.system.isMage,ahnengabe:[],ahnengeschenk:[]},h={body:[],social:[],knowledge:[],trade:[]},y={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},poison:{items:[],show:!1,dataType:"poison"}};for(let S in v.equipmentTypes)y[S]={items:[],show:!1,dataType:S};y.misc.show=!0;for(let S=1;S<=Number(t.system.stats.schips.max);S++)p.push({value:S,cssClass:S<=Number(t.system.stats.schips.value)?"fullSchip":"emptySchip"});let b=new Map;for(let S of t.items.filter(H=>H.type=="equipment"&&H.system.category=="bags"))b.set(S._id,[]);t.items=t.items.sort((S,H)=>S.name.localeCompare(H.name));let w=t.system.totalArmor||0,I=!1;for(let S of t.items)try{let H=getProperty(S,"system.parent_id");if(S.type=="ammunition"&&d.push(N._prepareitemStructure(S)),H&&H!=S._id&&b.has(H)){b.get(H).push(S);continue}switch(e.details&&e.details.includes(S._id)&&(S.detailed="shown"),S.type){case"skill":h[S.system.group].push(N._calculatePW(this._perpareItemAdvancementCost(S,t.system),t.system));break;case"information":r.push(S);break;case"ahnengabe":T[S.type].push(N._calculatePW(this._perpareItemAdvancementCost(S),t.system));break;case"ahnengeschenk":T[S.type].push(S);break;case"combatskill":s.push(N._calculateCombatSkillValues(this._perpareItemAdvancementCost(S,t.system),t.system));break;case"ammunition":y.ammunition.items.push(N.prepareMag(S)),y.ammunition.show=!0;break;case"meleeweapon":S.toggleValue=getProperty(S.system,"worn.value")||!1,S.toggle=!0,this._setOnUseEffect(S),S.system.notInInventory||(y.meleeweapons.items.push(N._prepareitemStructure(S)),y.meleeweapons.show=!0),S.toggleValue&&u.push(S);break;case"rangeweapon":S.toggleValue=getProperty(S.system,"worn.value")||!1,S.toggle=!0,this._setOnUseEffect(S),y.rangeweapons.items.push(N._prepareitemStructure(S)),y.rangeweapons.show=!0;break;case"armor":S.toggleValue=getProperty(S.system,"worn.value")||!1,y.armor.items.push(N._prepareitemStructure(S)),y.armor.show=!0,S.toggle=!0,this._setOnUseEffect(S),S.system.worn.value&&(w+=Number(S.system.rs),n.push(S));break;case"trait":switch(S.system.traitType){case"rangeAttack":S=N._prepareRangeTrait(S,t);break;case"meleeAttack":S=N._prepareMeleetrait(S,t);break;case"armor":w+=Number(S.system.at);break}k[S.system.traitType].push(S),I=!0;break;case"poison":y.poison.items.push(S),y.poison.show=!0;break;case"equipment":S.toggle=getProperty(S,"system.worn.wearable")||!1,S.toggle&&(S.toggleValue=getProperty(S.system,"worn.value")||!1),this._setOnUseEffect(S),y[S.system.category].items.push(N._prepareitemStructure(S)),y[S.system.category].show=!0;break;case"advantage":this._setOnUseEffect(S),a.push(S);break;case"disadvantage":this._setOnUseEffect(S),i.push(S);break;case"specialability":this._setOnUseEffect(S),f[S.system.category].push(S);break}}catch(H){this._itemPreparationError(S,H)}for(let S of y.bags.items)this._setBagContent(S,b);for(let S of y.rangeweapons.items)try{S.system.worn.value&&l.push(N._prepareRangeWeapon(S,d,s,this))}catch(H){this._itemPreparationError(S,H)}for(let S of u)try{c.push(N._prepareMeleeWeapon(S,s,t,u.filter(H=>H._id!=S._id&&!_.isYieldedTwohanded(H))))}catch(H){this._itemPreparationError(S,H)}let K=duplicate(v.characteristics);return K["-"]="-",{totalWeight:parseFloat(this.system.totalWeight.toFixed(3)),armorSum:w,encumbrance:this.system.condition?.encumbered||0,carrycapacity:this.system.carrycapacity,wornRangedWeapons:l,guidevalues:K,wornMeleeWeapons:c,advantages:a,disadvantages:i,specAbs:f,information:r,combatskills:s,hasTrait:I,traits:k,wornArmor:n,inventory:y,canAdvance:this.system.canAdvance,sheetLocked:t.system.sheetLocked,magic:T,allSkillsLeft:{body:h.body,social:h.social},allSkillsRight:{knowledge:h.knowledge,trade:h.trade},schips:p}}setupWeapon(e,t,s,a){return s.mode=t,C.getSubClass(e.type).setupDialog(null,s,e,this,a)}setupSpell(e,t={},s){return C.getSubClass(e.type).setupDialog(null,t,e,this,s)}static _prepareitemStructure(e){let t=getProperty(e,"flags.dsk.enchantments");return t&&t.length>0?e.enchantClass="rar":e.effects.length>0&&(e.enchantClass="common"),e}async checkEnoughXP(e){if(!this.system.canAdvance||isNaN(e)||e==null||Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=e)return!0;if(Number(this.system.details.experience.total==0)){let t=`<p>${game.i18n.localize("dsk.DSKError.zeroXP")}</p><label>${game.i18n.localize("dsk.APValue")}: </label><input type="number" name="APsel" value="150"/>`,s=0,a=!1;if([a,s]=await new Promise((i,r)=>{new Dialog({title:game.i18n.localize("dsk.DSKError.NotEnoughXP"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:n=>{i([!0,n.find('[name="APsel"]')[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{i([!1,0])}}}}).render(!0)}),a)return await this.update({"system.details.experience.total":Number(s)}),!0}return ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughXP")),!1}getSkillModifier(e,t){let s=[],a=["FP","step","QL","TPM","FW"];for(let i of a){let r=i=="step"?"":i;s.push(...this.system.skillModifiers[i].filter(n=>n.target==e).map(n=>({name:n.source,value:n.value,type:r}))),this.system.skillModifiers[t]&&s.push(...this.system.skillModifiers[t][i].map(n=>({name:n.source,value:n.value,type:r})))}return s}setupSkill(e,t={},s){return C.getSubClass(e.type).setupDialog(null,t,e,this,s)}static prepareMag(e){return e.system.ammunitiongroup=="mag"&&(e.structureMax=e.system.mag.max,e.structureCurrent=e.system.mag.value),e}async _updateAPs(e,t={},s={}){if(this.system.canAdvance)if(!isNaN(e)&&e!=null){let a=Number(e);t["system.details.experience.spent"]=Number(this.system.details.experience.spent)+a,await this.update(t,s);let i=game.i18n.format(a>0?"dsk.advancementCost":"dsk.refundCost",{cost:Math.abs(a)});$s(i)}else ui.notifications.error(game.i18n.localize("dsk.DSKError.APUpdateError"))}setupRegeneration(e,t={},s){let a=game.i18n.localize("dsk.regenerationTest"),i={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this.actor,s)}};i.extra.actor.isMage=this.system.isMage;let r=O.getRollModifiers(i.extra.actor,i.source),n={title:a,template:"/systems/dsk/templates/dialog/regeneration-dialog.html",data:{rollMode:t.rollMode,regenerationInterruptOptions:v.regenerationInterruptOptions,regnerationCampLocations:v.regnerationCampLocations,showAepModifier:this.system.isMage,situationalModifiers:r,modifier:t.modifier||0},callback:(c,u={})=>{i.situationalModifiers=N._parseModifiers(c),l.rollMode=c.find('[name="rollMode"]').val(),i.situationalModifiers.push({name:game.i18n.localize("dsk.camplocation")+" - "+c.find('[name="regnerationCampLocations"] option:selected').text(),value:c.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("dsk.interruption")+" - "+c.find('[name="regenerationInterruptOptions"] option:selected').text(),value:c.find('[name="regenerationInterruptOptions"]').val()}),i.regenerationFactor=c.find('[name="badEnvironment"]').is(":checked")?.5:1;let d=["LeP","AeP"],p={};for(let f of d){i[`${f}Modifier`]=Number(c.find(`[name="${f}Modifier"]`).val()||0),i[`regeneration${f}`]=Number(this.system.stats.regeneration[`${f}max`]);let k=c.find(`[name="regenerate${f}"]`).is(":checked")?1:0;i[`regenerate${f}`]=k,k&&(p[`system.stats.regeneration.${f}Temp`]=0)}return mergeObject(i.extra.options,u),this.update(p),{testData:i,cardOptions:l}}},l=this._setupCardOptions("systems/dsk/templates/chat/roll/regeneration-card.html",a,s);return _DiceDSK.setupDialog({dialogOptions:n,testData:i,cardOptions:l})}setupCharacteristic(e,t={},s){let a=this.system.characteristics[e],i=game.i18n.localize(`dsk.characteristics.${e}.name`)+" "+game.i18n.localize("dsk.probe"),r={opposable:!1,source:{type:"char",system:{characteristic1:e,characteristic2:e}},extra:{characteristicId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this,s)}},n={title:i,template:"/systems/dsk/templates/dialog/characteristic-dialog.html",data:{rollMode:t.rollMode,modifier:t.modifier||0,characteristics:[1,2].map(c=>e),hasSchips:C.hasSchips(this)},callback:(c,u={})=>(l.rollMode=c.find('[name="rollMode"]').val(),r.situationalModifiers=N._parseModifiers(c),N.schipsModifier(c,r.situationalModifiers),r.situationalModifiers.some(d=>d.name==game.i18n.localize("dsk.schips"))&&this.reduceSchips(0),C.changeChars(r.source,...[0,1].map(d=>c.find(`[name="characteristics${d}"]`).val())),mergeObject(r.extra.options,u),{testData:r,cardOptions:l})},l=this._setupCardOptions("systems/dsk/templates/chat/roll/characteristic-card.html",i,s);return _DiceDSK.setupDialog({dialogOptions:n,testData:r,cardOptions:l})}_setupCardOptions(e,t,s){let a=game.canvas.tokens.get(s),i={speaker:{alias:a?a.name:this.prototypeToken.name,actor:this.id},title:t,template:e,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)i.speaker.alias=this.token.name,i.speaker.token=this.token.id,i.speaker.scene=canvas.scene.id,i.flags.img=this.token.img;else{let r=ChatMessage.getSpeaker();r.actor==this.id&&(i.speaker.alias=r.alias,i.speaker.token=r.token,i.speaker.scene=r.scene,i.flags.img=r.token?canvas.tokens.get(r.token).img:i.flags.img)}return i}static _parseModifiers(e,t){let s=[];return e.find('[name="situationalModifiers"] option:selected').each(function(){let a=$(this).val(),i={name:$(this).text().trim().split("[")[0],value:isNaN(a)?a:Number(a),type:$(this).attr("data-type")};i.type=="dmg"&&(i.damageBonus=i.value,i.value=0),$(this).attr("data-specAbId")&&(i.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(i.armorPen=$(this).attr("data-armorPen")),s.push(i)}),s.push({name:game.i18n.localize("dsk.manual"),value:Number(e.find('[name="testModifier"]').val()),type:""}),s}static async schipsModifier(e,t){e.find('[name="schips"]').is(":checked")&&t.push({name:game.i18n.localize("dsk.schips"),value:5,type:""})}async consumeAmmunition(e){if(e.extra.ammo&&!e.extra.ammoDecreased){if(e.extra.ammoDecreased=!0,e.extra.ammo._id){let t={_id:e.extra.ammo._id};e.extra.ammo.system.ammunitionType=="mag"?e.extra.ammo.system.mag.value<=0?(e.extra.ammo.system.quantity--,t["system.quantity"]=e.extra.ammo.system.quantity,t["system.mag.value"]=e.extra.ammo.system.mag.max-1):t["system.mag.value"]=e.extra.ammo.system.mag.value-1:(e.extra.ammo.system.quantity--,t["system.quantity"]=e.extra.ammo.system.quantity),await this.updateEmbeddedDocuments("Item",[t,{_id:e.source._id,"system.reloadTimeprogress":0}])}}else(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType=="rangeAttack")&&!e.extra.ammoDecreased?(e.extra.ammoDecreased=!0,await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTimeprogress":0}])):["ahnengabe"].includes(e.source.type)&&e.extra.speaker.token!="emptyActor"&&await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}])}async basicTest({testData:e,cardOptions:t},s={}){e=await _DiceDSK.rollDices(e,t);let a=await _DiceDSK.rollTest(e);if(e.extra.options.other&&(a.other||(a.other=[]),a.other.push(...e.extra.options.other)),a.postFunction="basicTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("dsk.Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}if(await this.consumeAmmunition(e),!s.suppressMessage){let i=await _DiceDSK.renderRollCard(t,a,s.rerenderMessage);await L.handleOpposedTarget(i),a.messageId=i.id}return{result:a,cardOptions:t,options:s}}tokenScrollingText(e){let t=this.isToken?[this.token?.object]:this.getActiveTokens(!0);for(let s of t){if(!s)continue;let a=0;for(let i of e)canvas.interface.createScrollingText(s.center,i.value,{anchor:a,direction:i.value>0?2:1,fontSize:game.settings.get("dsk","scrollingFontsize"),stroke:i.stroke,strokeThickness:1,jitter:.25,duration:1e3}),a+=1}}async _preUpdate(e,t,s){await super._preUpdate(e,t,s);let a={LeP:9109504,AeP:723929},i=[];for(let r of Object.keys(a)){let n=getProperty(e,`system.stats.${r}.value`);n&&i.push({value:n-this.system.stats[r].value,stroke:a[r]})}i.length&&this.tokenScrollingText(i)}_itemPreparationError(e,t){console.error("Something went wrong with preparing item "+e.name+": "+t),console.warn(t),console.warn(e),ui.notifications.error("Something went wrong with preparing item "+e.name+": "+t)}_setBagContent(e,t){if(t.has(e._id)){e.children=[];for(let s of t.get(e._id))e.children.push(N._prepareitemStructure(s)),t.has(s._id)&&this._setBagContent(s,t)}}async applyDamage(e){let t=Math.min(this.system.stats.LeP.max,this.system.stats.LeP.value-e);await this.update({"system.stats.LeP.value":t})}async applyRegeneration(e,t){let s={"system.stats.LeP.value":Math.min(this.system.stats.LeP.max,this.system.stats.LeP.value+(e||0)),"system.stats.AeP.value":Math.min(this.system.stats.AeP.max,this.system.stats.AeP.value+(t||0))};await this.update(s)}async applyMana(e){let t=Math.min(this.system.stats.AeP.max,this.system.stats.AeP.value-e);return t>=0?(await this.update({["data.stats.AeP.value"]:t}),!0):(ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughAeP")),!1)}async actorEffects(){let e=["dead"];return game.user.isGM||this.testUserPermission(game.user,"OBSERVER")||!await game.settings.get("dsk","hideEffects")?this.effects.filter(s=>!s.disabled&&!s.notApplicable&&(game.user.isGM||!s.getFlag("dsk","hidePlayers"))&&!s.getFlag("dsk","hideOnToken")&&(s.origin==this.uuid||!s.origin)):this.effects.filter(s=>e.some(a=>s.statuses.has(a)))}async _preCreate(e,t,s){await super._preCreate(e,t,s);let a={};e.img||(a.img="icons/svg/mystery-man-black.svg"),e.type=="character"&&mergeObject(a,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(a)}async markDead(e){let t=this.getActiveTokens();for(let s of t)s.combatant&&await s.combatant.update({defeated:e})}async addCondition(e,t=1,s=!1,a=!0){if(e=="bleeding")return await _.bleedingMessage(this);if(this.isToken&&!this.token?.object){console.warn("Actor token object is null for",this.name);return}return await O.addCondition(this,e,t,s,a)}async removeCondition(e,t=1,s=!0,a=!1){return await O.removeCondition(this,e,t,s,a)}hasCondition(e){return O.hasCondition(this,e)}},D=N;m(D,"ActorDSK"),z(D,"_baseCarryItems",new Set(["armor","meleeweapon","ammunition","rangeweapon","plant","poison","money","consumable","equipment"])),z(D,"_mageSpecs",new Set(["ahnen"]));function Es(){let o={Rq:"roll"},e={Rq:"dice"},t={Rq:""},s=/(-|\+)?\d+/,a=/\[[a-zA-z&; -]+/,i=/[\[\]]/g;if(!v.statusRegex){let r=v.statusEffects.map(l=>game.i18n.localize(l.name).toLowerCase()),n=["dsk.status","dsk.condition","dsk.level","dsk.levels"].map(l=>game.i18n.localize(l)).join("|");v.statusRegex={effects:r,regex:new RegExp(`(${n}) (${r.join("|")})`,"gi")}}CONFIG.TextEditor.enrichers.push({pattern:/@(Rq|Ch)\[[a-zA-z&; -]+ (-|\+)?\d+\]/g,enricher:(r,n)=>{let l=r[0],c=r[1],u=Number(l.match(s)[0]),d=l.replace(u,"").match(a)[0].replace(i,"").trim();return $(`<a class="roll-button request-${o[c]}" data-type="skill" data-modifier="${u}" data-name="${d}"><em class="fas fa-${e[c]}"></em>${t[c]}${d} ${u}</a>`)[0]}},{pattern:v.statusRegex.regex,enricher:(r,n)=>$(ws(r))[0]},{pattern:/@Info\[[a-zA-z&; -\.0-9]+\]/g,enricher:async(r,n)=>{let l=r[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1),c=await fromUuid(l);if(!c||c.type!="information")return $('<a class="content-link broken"><i class="fas fa-unlink"></i>info</a>')[0];if(!game.user.isGM)return $(`<a class="content-link"><i class="fas fa-mask"></i>${game.i18n.localize("dsk.GM notes")}</a>`)[0];let u=await renderTemplate("systems/dsk/templates/items/infopreview.html",{item:c});return $(u)[0]}},{pattern:/@PostChat\[(.*?)\]/g,enricher:async(r,n)=>{let l=r[1];return $(`<div class="row-section wrap maskfield postChatSection"><div class="col ninety"></div><div class="col ten center postContentChat" data-tooltip="dsk.SHEET.PostItem"><em class="far fa-comment-dots"></em></div><div class="col postChatContent">${l}</div></div>`)[0]}})}m(Es,"setEnrichers");function ws(o){let t=o[0].split(" "),s=t.shift();t=t.join(" ");let a=v.statusEffects[v.statusRegex.effects.indexOf(t.toLowerCase())];return`<span>${s} <a class="chatButton chat-condition" data-id="${a.id}"><img src="${a.icon}"/>${t}</a></span>`}m(ws,"conditionsMatcher");var g=class{static chatDataSetup(e,t,s){let a={user:game.user.id,rollMode:t||game.settings.get("core","rollMode"),content:e};return["gmroll","blindroll"].includes(a.rollMode)&&(a.whisper=ChatMessage.getWhisperRecipients("GM").map(i=>i.id)),a.rollMode==="blindroll"?a.blind=!0:a.rollMode==="selfroll"&&(a.whisper=[game.user]),s&&(a.speaker=ChatMessage.getSpeaker(),a.whisper=ChatMessage.getWhisperRecipients(s)),a}static categoryLocalization(e){return game.i18n.localize(`TYPES.Item.${e}`)}static fateAvailable(e,t){return e.system.stats.schips.value>0}static isActiveGM(){let e=game.users.find(t=>t.active&&t.isGM);return e&&game.user.id==e.id}static parseAbilityString(e){return{original:e.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:e.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((e.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(e.match(/\(([^()]+)\)/)||["",""])[1],type:e.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":e.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:e.match(/[-+]\d{1,2}$/)!=null}}static async allSkills(e=["skill","combatskill","specialability"]){let t=game.i18n.lang=="de"?"dsk.default":"dsk.defaulten";return await this.getCompendiumEntries(t,e)}static escapeRegex(e){return(typeof e=="string"||e instanceof String?e:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}static replaceDies(e,t=!1){let s=/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,a=t?"":"/roll ";return e.replace(s,function(i){return` [[${a}${i.replace(/[DwW]/,"d")}]]`})}static toObjectIfPossible(e){return typeof e.toObject=="function"?e.toObject(!1):duplicate(e)}static async allSkillsList(e=["skill","combatskill","specialability"]){let t=await this.allSkills(e),s=[],a=[],i=[];for(let r of t)r.type=="skill"?s.push(r.name):r.type=="combatskill"&&(r.system.weapontype=="melee"?i.push(r.name):a.push(r.name));return{skills:s.sort((r,n)=>r.localeCompare(n)),rangeSkills:a.sort((r,n)=>r.localeCompare(n)),meleeSkills:i.sort((r,n)=>r.localeCompare(n))}}static replaceConditions(e){return e&&e.replace(v.statusRegex.regex,t=>ws([t]))}static moduleEnabled(e){return game.modules.get(e)&&game.modules.get(e).active}static getSpeaker(e){let t=ChatMessage.getSpeakerActor(e);if(!t&&canvas.tokens){let s=canvas.tokens.get(e.token);s&&(t=s.actor)}if(!t){let s=game.scenes.get(e.scene);try{s&&(t=new Token(s.getEmbeddedDocument("Token",e.token))?.actor)}catch{}}return t}static async showArtwork({img:e,name:t,uuid:s,isOwner:a},i=!1){new ImagePopout(e,{title:i?a?t:"-":t,shareable:!0,uuid:s}).render(!0)}static renderToggle(e){e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}static async skillByName(e){let t=game.packs.get(game.i18n.lang=="de"?"dsk.default":"dsk.defaulten");await t.getIndex();let s=t.index.find(a=>a.name===e);return await t.getDocument(s._id)}static async emptyActor(e=12){Array.isArray(e)||(e=[e,e,e,e,e,e,e,e]);let t=await D.create({name:"Alricat",type:"npc",items:[],system:{stats:{LeP:{value:50},schips:{}},characteristics:{mu:{initial:e[0]},kl:{initial:e[1]},in:{initial:e[2]},ch:{initial:e[3]},ff:{initial:e[4]},ge:{initial:e[5]},ko:{initial:e[6]},kk:{initial:e[7]}}}},{temporary:!0,noHook:!0});return t.prepareData(),t}static calcTokenSize(e,t){let s=game.dsk.config.tokenSizeCategories[e.system.details.size];if(s)if(s<1)mergeObject(t,{texture:{scaleX:s,scaleY:s},width:1,height:1});else{let a=Math.floor(s),i=Math.max(s/a,.25);mergeObject(t,{width:a,height:a,texture:{scaleX:i,scaleY:i}})}}static _calculateAdvCost(e,t,s=1){return v.advancementCosts[t][Number(e)+s]}static async getCompendiumEntries(e,t){let s=await game.packs.get(e);if(!s)return ui.notifications.error("No content found"),[];let a=Array.isArray(t)?t:[t];return(await s.getDocuments()).filter(r=>a.includes(r.type)).map(r=>r.toObject())}static async getFolderForType(e,t=null,s=null,a=0,i="",r=void 0){let n=await game.folders.contents.find(l=>l.name==s&&l.type==e&&l.folder?.id==t);return n||(n=await Folder.create({name:s,type:e,sorting:r||(e=="JournalEntry"?"a":"m"),color:i,sort:a,parent:t})),n}};m(g,"DSKUtility");var pe=class{static async showDialog(e){let[t]=await new Promise((s,a)=>{new Dialog({title:game.i18n.localize("dsk.Migrakel.Migration"),content:e,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{s([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{s([!1])}}},close:()=>{s([!1])}}).render(!0)});return t}static async refreshStatusEffects(e){let t=[];for(let s of e.effects)if(s.origin){let a;try{a=await fromUuid(s.origin)}catch{}a||t.push(s.id)}await e.deleteEmbeddedDocuments("ActiveEffect",t)}static async updateVals(e,t,s){let a=game.dsk.itemLibrary,i=[],r=[],n=new Map;if(await this.refreshStatusEffects(e),t({type:"equipment"})){let l=[],c=[];for(let d of e.items.filter(p=>p.type=="equipment"&&p.system.category=="bags")){let p=await a.findCompendiumItem(d.name,d.type);if(p.length>0){if(p=p.find(k=>k.name==d.name&&k.type==d.type),!p)continue;console.log(`MIGRATION - Updated ${d.name}`);let f=mergeObject(d.toObject(),s(p));c.push(f),l.push(d.id)}}let u=await e.createEmbeddedDocuments("Item",c);for(let d=0;d<u.length;d++)n.set(l[d],u[d].id);await e.deleteEmbeddedDocuments("Item",l)}for(let l of e.items.filter(c=>t(c)&&!(c.type=="equipment"&&c.system.category=="bags"))){let c=await a.findCompendiumItem(l.name,l.type);if(c.length>0){if(c=c.find(d=>d.name==l.name&&d.type==l.type),!c)continue;console.log(`MIGRATION - Updated ${l.name}`);let u=mergeObject(l.toObject(),s(c));u.system.parent_id&&n.has(u.system.parent_id)&&(u.system.parent_id=n.get(u.system.parent_id)),r.push(u),i.push(l.id)}}await e.createEmbeddedDocuments("Item",r),await e.deleteEmbeddedDocuments("Item",i),ui.notifications.notify(game.i18n.localize("dsk.Migrakel.migrationDone"))}static async updateSpellsAndLiturgies(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.spells"))){let t=m(a=>["spell","liturgy","ritual","ceremony","spellextension"].includes(a.type),"condition"),s=m(a=>{let i={effects:a.effects.toObject()};return a.type!="spellextension"&&(i.system={effectFormula:a.system.effectFormula}),i},"updator");await this.updateVals(e,t,s)}}static async updateSpecialAbilities(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.abilities"))){let t=m(a=>{let i={system:{effect:{value:a.system.effect}},effects:a.effects.toObject()};return a.type=="specialability"&&(mergeObject(i,{system:{category:{sub:a.system.category.sub||0},list:{value:a.system.list.value}}}),a.system.category=="staff"&&mergeObject(i,{system:{feature:getProperty(a,"system.feature")||"",AsPCost:getProperty(a,"system.AsPCost")||"",volume:Number(getProperty(a,"system.volume"))||0,artifact:getProperty(a,"system.artifact")||""}})),this.updateMacro(i,a),i},"updator"),s=m(a=>["specialability","advantage","disadvantage","trait"].includes(a.type),"condition");await this.updateVals(e,s,t)}}static async updateCombatskills(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.cskills"))){let t=m(a=>({effects:a.effects.toObject()}),"updator"),s=m(a=>["combatskill"].includes(a.type),"condition");await this.updateVals(e,s,t)}}static async updateSkills(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.skills"))){let t=m(a=>["skill"].includes(a.type),"condition"),s=m(a=>({img:a.img}),"updator");await this.updateVals(e,t,s)}}static updateMacro(e,t){let s=t.getFlag("dsk","onUseEffect");s&&mergeObject(e,{flags:{dsk:{onUseEffect:s}}})}static async updateGear(e){if(await this.showDialog(game.i18n.localize("dsk.Migrakel.gear"))){let t=m(a=>["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(a.type),"condition"),s=m(a=>{let i={img:a.img,effects:a.effects.toObject()};return["poison","consumable"].includes(a.type)||mergeObject(i,{system:{effect:{value:a.system.effect}}}),["armor"].includes(a.type)&&mergeObject(i,{system:{subcategory:a.system.subcategory}}),this.updateMacro(i,a),i},"updator");await this.updateVals(e,t,s)}}};m(pe,"Migrakel");var fe=class extends Dialog{constructor(e,t){super(t),this.actor=e,this.lock=!1}static async buildDialog(e){let t=await renderTemplate("systems/dsk/templates/actors/parts/actorConfig.html",{actor:e});new fe(e,{title:game.i18n.localize("dsk.SHEET.actorConfig"),content:t,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.save"),callback:s=>{e.update({"system.config.autoBar":s.find('[name="autoBar"]').is(":checked"),"system.config.autoSize":s.find('[name="autoSize"]').is(":checked")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async updateWrapper(e,t){return ui.notifications.warn("There is nothing to migrate yet.")}activateListeners(e){super.activateListeners(e),e.find(".updateSpells").click(async t=>this.updateWrapper("updateSpellsAndLiturgies",t)),e.find(".updateAbilities").click(async t=>this.updateWrapper("updateSpecialAbilities",t)),e.find(".updatecSkills").click(async t=>this.updateWrapper("updateCombatskills",t)),e.find(".updateSkills").click(async t=>this.updateWrapper("updateSkills",t)),e.find(".updateGear").click(async t=>this.updateWrapper("updateGear",t))}};m(fe,"DialogActorConfig");function ve(o,e="img"){!game.user.isGM||o.find(e).each(function(t,s){s.setAttribute("draggable",!0),s.addEventListener("dragstart",a=>ra(a))})}m(ve,"bindImgToCanvasDragStart");var ra=m(o=>{canvas.tiles.activate();let e=o.currentTarget.src,t=o.currentTarget,s=canvas.dimensions.sceneHeight/t.naturalHeight,a=canvas.dimensions.sceneWidth/t.naturalWidth,i=Math.min(1,a,s),r=Math.round(canvas.dimensions.size/i),n={type:"Tile",texture:{src:e},tileSize:r};o.dataTransfer.setData("text/plain",JSON.stringify(n));let l=t.naturalWidth*i*canvas.stage.scale.x,c=t.naturalHeight*i*canvas.stage.scale.y,u=DragDrop.createDragImage(t,l,c);o.dataTransfer.setDragImage(u,l/2,c/2)},"dragTileImg");var ae=class extends ActorSheet{async _render(e=!1,t={}){this._saveSearchFields(),this._saveCollapsed(),await super._render(e,t),this._setCollapsed(),this._restoreSeachFields();let s=$(this._element),a={".close":"dsk.SHEET.Close",".configure-sheet":"dsk.SHEET.Configure",".configure-token":"dsk.SHEET.Token",".import":"dsk.SHEET.Import",".locksheet":"dsk.SHEET.Lock",".library":"dsk.SHEET.Library",".playerview":"dsk.SHEET.switchLimited",".actorConfig":"dsk.SHEET.actorConfig"};for(let i of Object.keys(a))s.find(i).attr("data-tooltip",game.i18n.localize(a[i]));this.currentFocus&&(s.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null)}async swapWeaponHand(e){let t=this._getItemId(e),s=this.actor.items.get(t);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.wrongGrip":!s.system.worn.wrongGrip}])}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],mergeObject(e,{width:770,height:740,scrollY:[".save-scroll"],dragDrop:[{dragSelector:".content .item",dropSelector:null},{dragSelector:".mainEffects .statusEffect",dropSelector:null}]}),e}_saveSearchFields(){if(this.form===null)return;let e=$(this.form).parent();this.searchFields={talentFiltered:$(e.find(".filterTalents")).hasClass("filtered"),searchText:$(e.find(".talentSearch")).val(),gearSearch:$(e.find(".gearSearch")).val()}}_restoreSeachFields(){if(this.searchFields!=null){let e=$(this.form).parent();this.searchFields.talentFiltered&&($(e.find(".filterTalents")).addClass("filtered"),$(e.find(".allTalents")).removeClass("showAll"));let t=$(e.find(".talentSearch"));t.val(this.searchFields.searchText),this.searchFields.searchText!=""&&this._filterTalents(t);let s=$(e.find(".gearSearch"));s.val(this.searchFields.gearSearch),this.searchFields.searchText!=""&&this._filterGear(s)}}_saveCollapsed(){if(this.form===null)return;let e=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];let t=e.find(".ch-collapse i");for(let s of t)this.collapsedBoxes.push($(s).attr("class"));for(let s of $(e.find(".expandDetails.shown")))this.openDetails.push($(s).closest(".item").attr("data-item-id"))}_setCollapsed(){let e=$(this.form).parent();if(this.collapsedBoxes){let t=e.find(".ch-collapse i");for(let s=0;s<t.length;s++)$(t[s]).attr("class",this.collapsedBoxes[s]),this.collapsedBoxes[s]&&this.collapsedBoxes[s].indexOf("fa-angle-down")!=-1&&$(t[s]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}}async getData(e){let t=await super.getData(e),s={actor:t.actor,editable:t.editable,limited:t.limited,owner:t.owner};return s.prepare=this.actor.prepareSheet({details:this.openDetails}),s.sizeCategories=v.sizeCategories,s.isGM=game.user.isGM,s.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},O.prepareActiveEffects(this.actor,s),s.enrichedOwnerdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.owner"),{secrets:this.object.isOwner,async:!0}),s.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.gm"),{secrets:this.object.isOwner,async:!0}),s.enrichedNotes=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.description"),{secrets:this.object.isOwner,async:!0}),s.enrichedBiography=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.biography"),{secrets:this.object.isOwner,async:!0}),s}async _openLibrary(){game.dsk.itemLibrary.render(!0)}async _configActor(){fe.buildDialog(this.actor)}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"library",icon:"fas fa-university",onclick:async()=>this._openLibrary()}),this.actor.isOwner&&e.unshift({class:"actorConfig",icon:"fas fa-link",onclick:async()=>this._configActor()}),this.actor.system.canAdvance&&e.unshift({class:"locksheet",icon:`fas fa-${this.actor.system.sheetLocked?"":"un"}lock`,onclick:async t=>this._changeAdvanceLock(t)}),e}async _changeAdvanceLock(e){await this.actor.update({"system.sheetLocked":!this.actor.system.sheetLocked}),$(e.currentTarget).find("i").toggleClass("fa-unlock fa-lock")}showLimited(){return!game.user.isGM&&this.actor.limited}getTokenId(){return this.token?this.token.id:void 0}activateListeners(e){super.activateListeners(e);let t=m(d=>{this.actor.items.get(this._getItemId(d)).postItem()},"posthand");e.find(".schip").click(d=>{d.preventDefault();let p=Number(d.currentTarget.getAttribute("data-val"));p==1&&$(this.form).find(".fullSchip").length==1&&(p=0),this.actor.update({"system.stats.schips.value":p})}),e.find(".swapWeaponHand").click(d=>this.swapWeaponHand(d)),e.find(".loadWeapon").mousedown(async d=>{let p=this._getItemId(d),f=this.actor.items.get(p).toObject();if(getProperty(f,"system.currentAmmo")==="")return;let k={_id:p};if(d.button==0){let T=f.type=="trait"?f.system.lz:D.calcLZ(f,this.actor);k["system.reloadTimeprogress"]=Math.min(f.system.reloadTimeprogress+1,T)}else d.button==2&&(k["system.reloadTimeprogress"]=0);await this.actor.updateEmbeddedDocuments("Item",[k])}),e.find(".item-swapMag").click(async d=>{await this.actor.swapMag(this._getItemId(d))}),e.find(".ammo-selector").change(async d=>{d.preventDefault();let p=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.currentAmmo":$(d.currentTarget).val()}])}),e.find(".condition-edit").click(async d=>{(d.currentTarget.dataset.uuid?await fromUuid(d.currentTarget.dataset.uuid):this.actor.effects.get(d.currentTarget.dataset.id)).sheet.render(!0)}),e.find(".ch-collapse").click(d=>{$(d.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(d.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()}),e.find(".item-toggle").click(d=>{let p=this._getItemId(d),f=this.actor.items.get(p).toObject();switch(f.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.worn.value":!f.system.worn.value}]),q.playEquipmentWearStatusChange(f);break}}),e.find(".status-create").click(d=>{let p=$(d.currentTarget).closest(".statusEffectMenu").find("ul");p.fadeIn("fast",()=>{p.find("input").focus()})}),e.find(".statusEffectMenu ul").mouseleave(d=>$(d.currentTarget).fadeOut()),e.find(".status-add").click(async d=>{let p=$(d.currentTarget).attr("data-id");p=="custom"?O.createCustomEffect(this.actor):await this.actor.addCondition(p,1,!1,!1)}),e.find(".skill-select").mousedown(d=>{let p=this._getItemId(d),f=this.actor.items.get(p);d.button==0?this.actor.setupSkill(f,{},this.getTokenId()).then(k=>{this.actor.basicTest(k)}):d.button==2&&f.sheet.render(!0)}),e.find(".advance-attribute").mousedown(d=>this.advanceWrapper(d,"_advanceAttribute",$(d.currentTarget).attr("data-attr"))),e.find(".refund-attribute").mousedown(d=>this.advanceWrapper(d,"_refundAttributeAdvance",$(d.currentTarget).attr("data-attr"))),e.find(".advance-item").mousedown(d=>this.advanceWrapper(d,"_advanceItem",this._getItemId(d))),e.find(".refund-item").mousedown(d=>this.advanceWrapper(d,"_refundItemAdvance",this._getItemId(d))),e.find(".advance-points").mousedown(d=>this.advanceWrapper(d,"_advancePoints",$(d.currentTarget).attr("data-attr"))),e.find(".refund-points").mousedown(d=>this.advanceWrapper(d,"_refundPointsAdvance",$(d.currentTarget).attr("data-attr"))),e.find(".spell-select").mousedown(d=>{let p=this._getItemId(d),f=this.actor.items.get(p);d.button==0?this.actor.setupSpell(f,{},this.getTokenId()).then(k=>this.actor.basicTest(k)):d.button==2&&f.sheet.render(!0)}),e.find(".quantity-click").mousedown(d=>{let p=this._getItemId(d),f=this.actor.items.get(p).toObject();_.increment(d,f,"system.quantity",0),this.actor.updateEmbeddedDocuments("Item",[f])}),e.find(".item-post").click(d=>t(d)),e.find(".item-dropdown").click(d=>{d.preventDefault(),$(d.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")}),e.find(".condition-show").mousedown(d=>{d.preventDefault();let p=d.currentTarget.dataset.id,f=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");if(d.button==0){let k=$(d.currentTarget).parents(".statusEffect").attr("data-origin");if(k)fromUuid(k).then(T=>T.sheet.render(!0));else{let T,h;f?(T=CONFIG.statusEffects.find(b=>b.id==f),h=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${T.id}"><img src="${T.icon}"/>${game.i18n.localize(T.name)}</a></b>: ${game.i18n.localize(T.description)}</div>`)):(T=this.actor.effects.find(b=>b.id==p),T&&(h=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${T.id}"><img src="${T.icon}"/>${game.i18n.localize(T.name)}</a></b>: ${game.i18n.localize(T.flags.dsk.description)}</div>`)));let y=$(d.currentTarget).closest(".groupbox").find(".effectDescription");y.fadeOut("fast",function(){y.html(h).fadeIn("fast")})}}else d.button==2&&!d.currentTarget.dataset.locked&&this._deleteActiveEffect(p)}),e.on("click",".chat-condition",d=>F.postStatus($(d.currentTarget).attr("data-id"))),e.find(".skill-advances").change(async d=>{let p=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.level":Number(d.target.value)}])}),e.find(".item-edit").click(d=>{d.preventDefault();let p=this._getItemId(d);this.actor.items.get(p).sheet.render(!0)}),e.find(".disableRegeneration").click(d=>{let f=`system.repeatingEffects.disabled.${d.currentTarget.dataset.type}`;this.actor.update({[f]:!getProperty(this.actor,f)})}),e.find(".consume-item").mousedown(d=>{if(d.button==2){let p=this._getItemId(d),f=this.actor.items.get(p);this.consumeItem(f)}}),e.find(".ch-value").click(d=>{d.preventDefault();let p=d.currentTarget.attributes["data-char"].value;this.actor.setupCharacteristic(p,{},this.getTokenId()).then(f=>this.actor.basicTest(f))}),e.find(".ch-regenerate").click(d=>{d.preventDefault(),this.actor.setupRegeneration("regenerate",{},this.getTokenId()).then(p=>this.actor.basicTest(p))}),e.find(".item-create").click(d=>this._onItemCreate(d)),e.find(".ch-rollCombat").click(d=>{d.preventDefault();let p=this._getItemId(d),f=$(d.currentTarget).attr("data-mode"),k=this.actor.items.get(p);this.actor.setupWeapon(k,f,{},this.getTokenId()).then(T=>this.actor.basicTest(T))});let s=m(d=>this._deleteItem(d),"deletehand");e.find(".onUseItem").click(d=>this._onMacroUseItem(d)),e.find(".cards .item").mouseenter(d=>{if(d.currentTarget.getElementsByClassName("hovermenu").length==0){let p=document.createElement("div");p.classList.add("hovermenu");let f=document.createElement("i");f.classList.add("fas","fa-times"),f.title=game.i18n.localize("dsk.SHEET.DeleteItem"),f.addEventListener("click",s,!1);let k=document.createElement("i");k.classList.add("fas","fa-comment"),k.title=game.i18n.localize("dsk.SHEET.PostItem"),k.addEventListener("click",t,!1),p.appendChild(k),p.appendChild(f),d.currentTarget.appendChild(p)}}),e.find(".cards .item").mouseleave(d=>{let p=d.toElement||d.relatedTarget;!p||p.parentNode==this||p==this||d.currentTarget.querySelectorAll(".hovermenu").forEach(f=>f.remove())});let a=this.actor.uuid;e.find(".actorDrag").each(function(d,p){p.setAttribute("draggable",!0),p.addEventListener("dragstart",f=>{let k={type:"Actor",uuid:a};f.dataTransfer.setData("text/plain",JSON.stringify(k))})}),e.find(".item-delete").click(d=>this._deleteItem(d)),e.find(".filterTalents").click(d=>{$(d.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(d.currentTarget).toggleClass("filtered")}),e.find(".condition-value").mousedown(async d=>{let p=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");d.button==0?await this.actor.addCondition(p,1,!1,!1):d.button==2&&await this.actor.removeCondition(p,1,!1)}),e.find(".condition-toggle").mousedown(async d=>{if(!this.isEditable)return;let p=$(d.currentTarget).parents(".statusEffect").attr("data-id"),f=this.actor.effects.get(p);await f.update({disabled:!f.disabled})}),e.find(".charimg").mousedown(d=>{d.button==2&&g.showArtwork(this.actor,!0)}),B.bindRollCommands(e);let i=m(d=>this._filterTalents($(d.currentTarget)),"filterTalents"),r=e.find(".talentSearch");r.keyup(d=>this._filterTalents($(d.currentTarget))),r[0]&&r[0].addEventListener("search",i,!1);let n=m(d=>this._filterConditions($(d.currentTarget)),"filterConditions"),l=e.find(".conditionSearch");l.keyup(d=>this._filterConditions($(d.currentTarget))),l[0]&&l[0].addEventListener("search",n,!1);let c=m(d=>this._filterGear($(d.currentTarget)),"filterGear"),u=e.find(".gearSearch");u.keyup(d=>this._filterGear($(d.currentTarget))),u[0]&&u[0].addEventListener("search",c,!1),ve(e,"img.charimg")}async advanceWrapper(e,t,s){let a=$(e.currentTarget).find("i");a.hasClass("fa-spin")||(a.addClass("fa-spin fa-spinner"),await this[t](s),a.removeClass("fa-spin fa-spinner"))}async _advanceAttribute(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial),s=g._calculateAdvCost(t,"Eig");await this._checkEnoughXP(s)&&await this._updateAPs(s,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)+1})}async _refundAttributeAdvance(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial);if(Number(this.actor.system.characteristics[e].advances)>0){let s=g._calculateAdvCost(t,"Eig",0)*-1;await this._updateAPs(s,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)-1})}}async _advancePoints(e){let t=Number(this.actor.system.stats[e].advances),s=g._calculateAdvCost(t,"D");await this._checkEnoughXP(s)&&this._checkMaximumPointAdvancement(e,t+1)&&await this._updateAPs(s,{[`system.stats.${e}.advances`]:Number(this.actor.system.stats[e].advances)+1})}async _refundPointsAdvance(e){let t=Number(this.actor.system.stats[e].advances);if(t>0){let s=g._calculateAdvCost(t,"D",0)*-1;await this._updateAPs(s,{[`system.stats.${e}.advances`]:Number(this.actor.system.stats[e].advances)-1})}}async _advanceItem(e){let t=this.actor.items.get(e).toObject(),s=g._calculateAdvCost(Number(t.system.level),t.system.StF);await this._checkEnoughXP(s)&&this._checkMaximumItemAdvancement(t,Number(t.system.level)+1)&&(await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.level":t.system.level+1}]),await this._updateAPs(s))}async _refundItemAdvance(e){let t=this.actor.items.get(e).toObject();if(t.system.level>0){let s=g._calculateAdvCost(Number(t.system.level),t.system.StF,0)*-1;await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.level":t.system.level-1}]),await this._updateAPs(s)}}_checkMaximumItemAdvancement(e,t){let s=!1;switch(e.type){case"combatskill":s=t<=this.maxByAttr(e,"dsk.LocalizedIDs.exceptionalCombatTechnique");break;case"ahnengabe":case"skill":s=t<=this.maxByAttr(e,"dsk.LocalizedIDs.exceptionalSkill");break}return s||ui.notifications.error(game.i18n.localize("dsk.DSKError.AdvanceMaximumReached")),s}maxByAttr(e,t){return Math.max(this.actor.system.characteristics[e.system.characteristic1].value,this.actor.system.characteristics[e.system.characteristic2].value)+2+E.vantageStep(this.actor,`${game.i18n.localize(t)} (${e.name})`)}async _checkEnoughXP(e){return await this.actor.checkEnoughXP(e)}_checkMaximumPointAdvancement(e,t){let s=!1;switch(e){case"LeP":s=t<=this.actor.system.characteristics.ko.value;break;case"AeP":s=t<=(this.actor.system.characteristics[this.actor.system.guidevalue]==null?0:this.actor.system.characteristics[this.actor.system.guidevalue].value);break}return s||ui.notifications.error(game.i18n.localize("dsk.DSKError.AdvanceMaximumReached")),s}_onItemCreate(e){e.preventDefault();let t=e.currentTarget,s=duplicate(t.dataset);v.equipmentTypes[s.type]&&(s.type="equipment",s=mergeObject(s,{"system.category":e.currentTarget.attributes["item-section"].value,"system.effect":""})),["aggregatedTest","ahnengabe"].includes(s.type)||(s["system.weight"]=0,s["system.quantity"]=0),C.defaultIcon(s),s.name=g.categoryLocalization(s.type),this.actor.createEmbeddedDocuments("Item",[s])}_onMacroUseItem(e){let t=this.actor.items.get(this._getItemId(e));new OnUseEffect(t).executeOnUseEffect()}_filterGear(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),s=$(this.element).find(".inventory .item");s.removeClass("filterHide"),s.filter(function(){return $(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}_filterTalents(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),s=$(this.form).parent().find(".allTalents");s.find(".item, .table-header, .table-title").removeClass("filterHide"),s.addClass("showAll").find(".item").filter(function(){return $(this).find(".talentName").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide"),t.length>0?(s.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),s.addClass("filterfull")):s.removeClass("filterfull")}}_filterConditions(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),s=$(this.form).find(".statusEffectMenu li:not(.search)");s.removeClass("filterHide"),s.filter(function(){return game.i18n.localize($(this).find("a").attr("data-tooltip")).toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async _deleteActiveEffect(e){if(!this.isEditable)return;let t=this.actor.effects.find(s=>s.id==e);t&&(this.token?this.token.actor:this.actor)&&await this.actor.deleteEmbeddedDocuments("ActiveEffect",[t.id])}_deleteItem(e){if(!this.isEditable)return;let t=this._getItemId(e),s=this.actor.items.get(t),a=game.i18n.format("dsk.DIALOG.DeleteItemDetail",{item:s.name});renderTemplate("systems/dsk/templates/dialog/delete-item-dialog.html",{message:a}).then(i=>{new Dialog({title:game.i18n.localize("dsk.DIALOG.deleteConfirmation"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>this._cleverDeleteItem(t)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}},default:"Yes"}).render(!0)})}async _addVantage(e,t){E.needsAdoption(this.actor,e,t)}async _addSpecialAbility(e,t){x.needsAdoption(this.actor,e,t)}async _cleverDeleteItem(e){let t=this.actor.items.get(e),s=[e];switch(t.type){case"advantage":case"disadvantage":{await E.vantageRemoved(this.actor,t);let a=t.system.ap*(t.system.level||1);if(/;/.test(t.system.ap)){let i=t.system.ap.split(";").map(r=>Number(r.trim()));a=0;for(let r=0;r<t.system.level;r++)a+=i[r]}await this._updateAPs(-1*a,{},{render:!1})}break;case"specialability":await x.abilityRemoved(this.actor,t);break;case"ahnengeschenk":await this._updateAPs(-1);break;case"ahnengabe":{let a=0;for(let i=0;i<=t.system.level;i++)a+=g._calculateAdvCost(i,t.system.StF,0);await this._updateAPs(a*-1,{},{render:!1})}break}await this.actor.deleteEmbeddedDocuments("Item",s)}_getItemId(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}_onDragStart(e){let t=e.currentTarget;if(e.target.classList.contains("content-link"))return;let s;t.dataset.itemId&&(s=this.actor.items.get(t.dataset.itemId).toDragData(),t.dataset.mod&&(s.mod=t.dataset.mod)),t.dataset.id&&(s=this.actor.effects.get(t.dataset.id).toDragData()),s&&e.dataTransfer.setData("text/plain",JSON.stringify(s))}async _addUniqueItem(e){if(e=duplicate(e),!this.actor.items.some(t=>C.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async handleItemCopy(e,t){if(v.equipmentCategories.includes(t))return e.name+=" (Copy)",await this._addLoot(e)}async _addLoot(e){e=duplicate(e);let t=this.actor.items.find(s=>C.areEquals(e,s));return t?(await C.stackItems(t,e,this.actor))[0]:(this._tabs[0].active=="combat"&&e.system.worn&&(e.system.worn.value=!0),(await this.actor.createEmbeddedDocuments("Item",[e]))[0])}async _manageDragItems(e,t){switch(t){case"meleeweapon":case"rangeweapon":case"equipment":case"ammunition":case"armor":case"poison":return await this._addLoot(e);case"disadvantage":case"advantage":await this._addVantage(e,t);break;case"specialability":await this._addSpecialAbility(e,t);break;case"information":case"skill":await this._addUniqueItem(e);break;case"ahnengabe":case"ahnengeschenk":await this._addSpellOrLiturgy(e);break;case"effectwrapper":await this._handleEffectWrapper(e);break;default:ui.notifications.error(game.i18n.format("dsk.DSKError.canNotBeAdded",{item:e.name,category:game.i18n.localize(e.type)}))}}async _updateAPs(e,t={},s={}){await this.actor._updateAPs(e,t,s)}async _addSpellOrLiturgy(e){let t=this.actor.items.find(a=>a.type==e.type&&a.name==e.name),s;if(e=duplicate(e),!t){switch(e.type){case"ahnengabe":s=g._calculateAdvCost(0,e.system.StF,0);break;case"ahnengeschenk":s=1;break;default:return}await this.actor.checkEnoughXP(s)&&(await this._updateAPs(s,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}}async _addUniqueItem(e){if(e=duplicate(e),!this.actor.items.some(t=>C.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async _handleEffectWrapper(e){this.actor.createEmbeddedDocuments("ActiveEffect",e.effects.map(t=>(t.origin=null,t)))}async _onDropItemCreate(e){return e instanceof Array?this.actor.createEmbeddedDocuments("Item",e):await this._manageDragItems(e,e.type)}async _onDropActor(e,t){if(!this.actor.isOwner)return!1;let{item:s,typeClass:a,selfTarget:i}=await Gt(t,this.id,!1);if(!i)return await this._manageDragItems(s,a)}async _onDropActiveEffect(e,t){let s=await ActiveEffect.implementation.fromDropData(t);if(!this.actor.isOwner||!s||this.actor.uuid===s.parent?.uuid)return!1;let a=s.toObject();return a.origin=this.actor.uuid,ActiveEffect.create(a,{parent:this.actor})}async _onDropItem(e,t){if(!this.actor.isOwner)return!1;let s=await Item.implementation.fromDropData(t),a=s.toObject();_.obfuscateDropData(a,t.tabsinvisible);let i,r=$(e.target).parents(".item");r&&r.attr("data-category")=="bags"&&v.equipmentCategories.includes(s.type)&&r.attr("data-item-id")!=s.id&&(i=r.attr("data-item-id"));let n=this.actor.uuid===s.parent?.uuid;if(n)if(e.ctrlKey)await this.handleItemCopy(a,s.type);else if(i){let l={_id:s.id,"system.parent_id":i};s.system.worn&&s.system.worn.value&&(l["system.worn.value"]=!1),await this.actor.updateEmbeddedDocuments("Item",[l])}else v.equipmentCategories.includes(s.type)&&await this.actor.updateEmbeddedDocuments("Item",[{_id:s.id,system:{parent_id:0}}]);else await this._onDropItemCreate(a);e.altKey&&!n&&v.equipmentCategories.includes(s.type)&&await this._handleRemoveSourceOnDrop(s)}};m(ae,"ActorSheetDSK");var Te=m(o=>class extends o{async obfuscateItem(e){e.stopPropagation(),e.preventDefault();let t=e.currentTarget.dataset.obfuscate;await this.item.update({[`system.obfuscation.${t}`]:!this.isObfuscated(t)})}isObfuscated(e){return getProperty(this.item,`system.obfuscation.${e}`)}activateListeners(e){super.activateListeners(e),e.on("click",".obfuscateSection",t=>this.obfuscateItem(t))}obfuscationCss(e){return this.isObfuscated(e)?"":" pale"}async _render(e=!1,t={}){await super._render(e,t);let s=["details","effects","description","enchantment"],a=!1;for(let i of s){let r=$(this._element).find(`nav [data-tab="${i}"]`);if(!r.length)continue;let n=t.tabsinvisible||this.isObfuscated(i),l=game.i18n.localize(`dsk.SHEET.${n?"deobfuscateItem":"obfuscateItem"}`);if(game.user.isGM){let c=`obfuscateSection${this.obfuscationCss(i)}`,u=r.find(`.${c}`),d=`<a data-tooltip="${l}" class="obfuscationBtn ${c}" data-obfuscate="${i}"><i class="fas fa-mask"></i></a>`;u.length?u.replaceWith(d):r.append(` ${d}`)}else n&&(r.hasClass("active")&&(a=!0),r.remove(),i=="details"&&$(this._element).find('[name="system.price"]').replaceWith("<label>?</label>"))}if(a){let i=$(this._element).find("nav .item:first-child");if(i.length)this.activateTab(i.attr("data-tab"));else{let r=await renderTemplate("systems/dsk/templates/items/obfuscatedItem.html",{item:this.item});$(this._element).find(".content").html(r)}}}},"ItemSheetObfuscation");var R=class extends ItemSheet{static setupSheets(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsk",Ut,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsk",Vt,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsk",Yt,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsk",Jt,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsk",Zt,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsk",Xt,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsk",Qt,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsk",es,{makeDefault:!0,types:["profession"]}),Items.registerSheet("dsk",Qe,{makeDefault:!0,types:["advantage"]}),Items.registerSheet("dsk",ts,{makeDefault:!0,types:["disadvantage"]}),Items.registerSheet("dsk",ss,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsk",as,{makeDefault:!0,types:["ahnengeschenk"]}),Items.registerSheet("dsk",is,{makeDefault:!0,types:["ahnengabe"]}),Items.registerSheet("dsk",rs,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsk",et,{makeDefault:!0,types:["skill"]}),Items.registerSheet("dsk",ns,{makeDefault:!0,types:["combatskill"]}),Items.registerSheet("dsk",Kt,{makeDefault:!0,types:["information"]}),Items.registerSheet("dsk",qt,{makeDefault:!0,types:["effectwrapper"]}),Items.registerSheet("dsk",Wt,{makeDefault:!0,types:["trait"]})}setupEffect(e){this.item.setupEffect().then(t=>this.item.itemTest(t))}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:async()=>this.item.postItem()}),e}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content"}],mergeObject(e,{classes:e.classes.concat(["dsk","item"]),width:450,height:500}),e}get template(){return`systems/dsk/templates/items/item-${this.item.type}-sheet.html`}async getData(e){let t=super.getData(e).data;return mergeObject(t,{isOwned:this.item.actor,editable:this.isEditable,item:this.item,isGM:game.user.isGM,enrichedDescription:await TextEditor.enrichHTML(getProperty(this.item.system,"description.value"),{secrets:this.object.isOwner,async:!0}),enrichedGmdescription:await TextEditor.enrichHTML(getProperty(this.item.system,"description.gminfo"),{secrets:this.object.isOwner,async:!0})}),O.prepareActiveEffects(this.item,t),t}async advanceWrapper(e,t){let a=$(e.currentTarget).find("i");a.hasClass("fa-spin")||(a.addClass("fa-spin fa-spinner"),await this[t](),a.removeClass("fa-spin fa-spinner"))}activateListeners(e){super.activateListeners(e),e.find(".advance-step").mousedown(s=>this.advanceWrapper(s,"_advanceStep")),e.find(".refund-step").mousedown(s=>this.advanceWrapper(s,"_refundStep")),e.find('[data-edit="img"]').mousedown(s=>{s.button==2&&g.showArtwork(this.item)}),e.find(".status-add").click(()=>{this.item.actor?ui.notifications.error(game.i18n.localize("dsk.DSKError.nestedEffectNotSupported")):O.createCustomEffect(this.item,"",this.item.name)}),e.find(".condition-show").mousedown(s=>{s.preventDefault();let a=$(s.currentTarget).attr("data-id");s.button==0?this.item.effects.get(a).sheet.render(!0):s.button==2&&this.item.deleteEmbeddedDocuments("ActiveEffect",[a])}),e.find(".condition-toggle").mousedown(s=>{let a=$(s.currentTarget).parents(".statusEffect").attr("data-id"),i=this.item.effects.get(a);i.update({disabled:!i.system.disabled})}),e.find(".condition-edit").click(s=>{this.item.effects.get($(s.currentTarget).attr("data-id")).sheet.render(!0)}),B.bindRollCommands(e),O.bindButtons(e);let t=e.find(".item-header");if(t.length){let s=t.find("svg");if(s){new ResizeObserver(function(r){let n=r[0];Is(s,n.contentRect.width)}).observe(t.get(0));let i=t.find("input");i.get(0).disabled||(s.click(()=>{s.hide(),i.show(),i.focus()}),i.blur(function(){s.show(),i.hide()}))}}}};m(R,"ItemSheetDSK");var qt=class extends R{};m(qt,"ItemSheetEffectwrapper");var Wt=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{traitCategories:v.traitCategories,ranges:v.meleeRanges}),t}};m(Wt,"ItemSheetTrait");var Kt=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{allSkills:(await g.allSkillsList(["skill"])).skills}),t}};m(Kt,"ItemSheetInformation");var Ut=class extends Te(R){async getData(e){let t=await super.getData(e),s=!1,a="";if(!s)a="wrongGrip.yieldTwo";else switch(game.i18n.localize(`dsk.LocalizedCTs.${this.item.system.combatskill}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":new RegExp(game.i18n.localize("dsk.wrongGrip.wrongGripBastardRegex")).test(this.item.name)?a="wrongGrip.yieldOneBastard":a="wrongGrip.yieldOneSwordBlunt";break;default:a="wrongGrip.yieldOnePolearms"}if(mergeObject(t,{twoHanded:s,wrongGripLabel:s?"wrongGrip.oneHanded":"wrongGrip.twoHanded",wrongGripHint:a,isShield:this.item.system.combatskill==game.i18n.localize("dsk.LocalizedIDs.Shields"),combatskills:(await g.allSkillsList(["combatskill"])).meleeSkills,ranges:v.meleeRanges,shieldSizes:v.shieldSizes}),this.item.actor){let i=this.item.actor.items.find(r=>r.type=="combatskill"&&r.name==this.item.system.combatskill);t.canBeOffHand=i&&!i.system.weapontype.twoHanded&&this.item.system.worn.value,t.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize(`dsk.LocalizedCTs.${this.item.system.combatskill}`))}return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),t}};m(Ut,"ItemSheetMeleeweapon");var Vt=class extends Te(R){async getData(e){let t=await super.getData(e);return mergeObject(t,{canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),ammunitiongroups:v.ammunitiongroups,combatskills:(await g.allSkillsList(["combatskill"])).rangeSkills}),t}};m(Vt,"ItemSheetRangeweapon");var Yt=class extends Te(R){};m(Yt,"ItemSheetArmor");var Jt=class extends Te(R){async getData(e){let t=await super.getData(e);return mergeObject(t,{ammunitiongroups:v.ammunitiongroups}),t}};m(Jt,"ItemSheetAmmunition");var Zt=class extends Te(R){async getData(e){let t=await super.getData(e);if(mergeObject(t,{equipmentTypes:v.equipmentTypes,canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")}),this.isBagWithContents()){let s=0;mergeObject(t,{containerContent:this.item.actor.items.filter(a=>v.equipmentCategories.includes(a.type)&&a.system.parent_id==this.item.id).map(a=>(a.weight=parseFloat((a.system.weight*a.system.quantity).toFixed(3)),s+=Number(a.weight),a)),weightSum:parseFloat(s.toFixed(3)),weightWidth:`style="width: ${Math.min(this.item.system.capacity?s/this.item.system.capacity*100:0,100)}%"`,weightExceeded:s>Number(this.item.system.capacity)?"exceeded":""})}return t}async breakOverflow(e,t){let s=$(await renderTemplate("systems/dsk/templates/items/baghover.html",e)),a=t.offset().top+52,i=t.offset().left-75;return s.appendTo($("body")),s.css({position:"absolute",left:i+"px",top:a+"px",bottom:"auto",right:"auto","z-index":1e4}),s}activateListeners(e){super.activateListeners(e);let t=e.find(".slot");t.mouseenter(async s=>{let a=$(s.currentTarget),i=await this.breakOverflow({name:a.attr("data-name"),weight:a.attr("data-weight"),quantity:a.attr("data-quantity")},a);i.fadeIn(),a.mouseleave(()=>{i.remove(),a.off("mouseleave")})}),t.mousedown(async s=>{let a=$(s.currentTarget).attr("data-item-id"),i=this.actor.items.get(a);s.button==0?i.sheet.render(!0):s.button==2&&($(".itemInfo").remove(),await i.update({"system.parent_id":0}),this.render(!0))})}isBagWithContents(){return this.item.actor&&getProperty(this.item,"system.category")=="bags"}async _onDrop(e){if(this.isBagWithContents()){let t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:s,typeClass:a,selfTarget:i}=await Gt(t,void 0),r=this.item.id==s.id,n=this.item.parent.id==t.actorId;if(v.equipmentCategories.includes(a)&&!r){s.system.parent_id=this.item.id,s.system.worn&&s.system.worn.value&&(s.system.worn.value=!1),n?await this.item.actor.updateEmbeddedDocuments("Item",[s]):await this.item.actor.sheet._addLoot(s),this.render(!0);return}}await super._onDrop(e)}};m(Zt,"ItemSheetEquipment");var Xt=class extends R{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:530,height:570}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{hasLocalization:game.i18n.has(`dsk.Racedescr.${this.item.name}`)}),t}};m(Xt,"ItemSheetSpecies");var Qt=class extends R{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}};m(Qt,"ItemSheetCulture");var es=class extends R{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{enrichedClothing:await TextEditor.enrichHTML(getProperty(this.item.system,"description.gear"),{secrets:this.object.isOwner,async:!0})}),t}};m(es,"ItemSheetProfession");var Qe=class extends R{async getData(e){let t=await super.getData(e);return t.enrichedRule=await TextEditor.enrichHTML(getProperty(this.item.system,"rule"),{secrets:this.object.isOwner,async:!0}),t}_advancable(){return this.item.system.max>0}async _refundStep(){let e,t;this.item.system.level>1&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level-1]),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.level":this.item.system.level-1}))}async _advanceStep(){let e,t;this.item.system.level<this.item.system.max&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level]),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.level":this.item.system.level+1})))}};m(Qe,"ItemSheetAdvantage");var ts=class extends Qe{};m(ts,"ItemSheetDisadvantage");var ss=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{categories:v.specialAbilityCategories,subCategories:v.combatSkillSubCategories,enrichedRule:await TextEditor.enrichHTML(getProperty(this.item.system,"rule"),{secrets:this.object.isOwner,async:!0}),canOnUseEffect:game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro")}),t}async _refundStep(){let e,t;this.item.system.level>1&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level-1]),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.level":this.item.system.level-1}))}async _advanceStep(){let e,t;this.item.system.level<this.item.system.max&&(e=this.item.system.ap,/;/.test(e)&&(t=e.split(";").map(s=>Number(s.trim())),e=t[this.item.system.level]),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.level":this.item.system.level+1})))}_advancable(){return this.item.system.max>0}};m(ss,"ItemSheetSpecialability");var as=class extends R{async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsk","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async setupEffect(e){if(this.item.actor.system.stats.AeP.value<1)return ui.notifications.error(game.i18n.localize("dsk.DSKError.NotEnoughAeP"));let t=game.dsk.config.ItemSubClasses.ahnengeschenk;await this.item.actor.update({"system.stats.AeP.value":this.item.actor.system.stats.AeP.value-=1});let s=`<p><b>${this.item.name} - ${game.i18n.localize("TYPES.Item.ahnengeschenk")} ${game.i18n.localize("dsk.probe")}</b></p><p>${this.item.system.description.value}</p><p>${t.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(g.chatDataSetup(s))}};m(as,"ItemSheetAhnengeschenk");var is=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{characteristics:v.characteristics,StFs:v.StFs,resistances:v.magicResistanceModifiers}),t}};m(is,"ItemSheetAhnengabe");var rs=class extends Te(R){async getData(e){let t=await super.getData(e);return mergeObject(t,{resistances:v.magicResistanceModifiers}),t}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}};m(rs,"ItemSheetPoison");var et=class extends R{async getData(e){let t=await super.getData(e);return mergeObject(t,{characteristics:v.characteristics,skillGroups:v.skillGroups,skillBurdens:v.skillBurdens,hasLocalization:game.i18n.has(`dsk.SKILLdescr.${this.item.name}`),StFs:v.StFs}),t}};m(et,"ItemSheetSkill");var ns=class extends et{async getData(e){let t=await super.getData(e);return mergeObject(t,{weapontypes:v.weapontypes,hasLocalization:game.i18n.has(`dsk.Combatskilldescr.${this.item.name}`)}),t}};m(ns,"ItemSheetCombatskill");var Y=class extends Application{constructor(e){super(e),this.items=[],this.errors=[],this.attributes=[],this.updating=!1}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsk","largeDialog"]),width:750,height:640}),e.resizable=!0,e}async updateSkill(e,t,s=1,a=!0){let i=[];for(let r of e){if(["","-"].includes(r.trim()))continue;let n=g.parseAbilityString(r.trim()),l=this.actor.items.find(c=>c.type==t&&c.name==n.name);if(l){let c=duplicate(l);c.system.level=Math.max(0,s*n.step+(a?Number(c.system.level):0)),i.push(c)}else console.warn(`Could not find ${t} ${r}`),this.errors.push(`${g.categoryLocalization(t)}: ${r}`)}await this.actor.updateEmbeddedDocuments("Item",i,{},{render:!1})}async findCompendiumItem(e,t){for(let s of t){let a=await game.dsk.itemLibrary.findCompendiumItem(e,s);if(a.length)return a.find(i=>i.name==e&&i.type==s&&i.system)}}async parseToItem(e,t){return e.trim()==""?[]:await Promise.all(e.split(", ").map(async s=>{let a=g.parseAbilityString(s.trim()),i=await this.findCompendiumItem(a.original,t);if(i||(i=await this.findCompendiumItem(a.name,t)),i){let n=i.uuid;i=duplicate(i),i.uuid=n,i.tooltip=game.i18n.localize("dsk.details"),i=j.reverseAdoptionCalculation(this.actor,a,i),i.system.ap&&(i.APunparseable=isNaN(i.system.ap),i.apCost=i.APunparseable?i.system.ap:a.step*Number(i.system.ap))}else{console.warn(`Not found <${s}>`);let n=t.map(l=>g.categoryLocalization(l)).join("/");this.errors.push(`${n}: ${s}`),i={name:s.trim(),notFound:!0,tooltip:game.i18n.localize("dsk.DSKError.itemNotFound"),apCost:"?"}}i.replaceName=a.original,i.step=a.step;let r=this.actor.items.find(n=>t.includes(n.type)&&n.name==a.original)!=null;return i.disabled=r||i.notFound||i.APunparseable,r&&(i.tooltip=game.i18n.localize("dsk.YouAlreadyHaveit")),i}))}activateListeners(e){super.activateListeners(e),e.find("button.ok").click(()=>{this.updating||(this.updating=!0,this.updateCharacter().then(()=>this.updating=!1))}),e.find("button.cancel").click(()=>{this.close()}),e.find(".show-item").click(t=>{let s=$(t.currentTarget).attr("data-id");this.items.find(i=>i.id==s).sheet.render(!0)}),e.find(".optional").change(t=>{let s=$(t.currentTarget).closest(".content"),a=Number(s.attr("data-cost"));s.find(".optional:checked").each(function(){a+=Number($(this).attr("data-cost"))});let i=s.find(".apCost");i.text(a),Y.flashElem(i,"emphasize2")}),e.find(".exclusive").change(t=>{let s=$(t.currentTarget).closest(".content"),a=$(t.currentTarget).attr("data-sel"),i=s.find(`.allowedCount_${a}`),r=Number(i.attr("data-count"));if(s.find(`.exclusive_${a}:checked`).length>r){t.currentTarget.checked=!1,Y.flashElem(i);return}})}_validateInput(e){let t=new Set,s=/^exclusive_/;for(let a of e.find(".exclusive"))t.add(a.className.split(/\s+/).filter(i=>s.test(i))[0]);for(let a of t){let i=e.find(".allowedCount_"+a.split("_")[1]),r=Number(i.attr("data-count"));if(e.find(`.${a}:checked`).length!=r)return this._showInputValidation(i,e,app),!1}return!0}_showInputValidation(e,t,s){ui.notifications.error(game.i18n.localize("dsk.DSKError.MissingChoices"));let a=e.closest(".tab").attr("data-tab");s.activateTab(a),Y.flashElem(t.find(`.tabs a[data-tab='${a}']`)),Y.flashElem(e.closest("div"))}async alreadyAdded(e,t){if(e=="")return!1;let s=!1;return s=await new Promise((a,i)=>{new Dialog({title:game.i18n.localize("dsk.DIALOG.warning"),content:game.i18n.format("dsk.DIALOG.alreadyAddedCharacterpart",{category:g.categoryLocalization(t)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("dsk.ok"),default:!0,callback:()=>{a(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("dsk.cancel"),default:!0,callback:()=>{a(!0)}}}}).render(!0)}),s}async addSelections(e){let t=[];for(let s of e){if($(s).val()=="")continue;let i=await fromUuid($(s).val()),r=g.parseAbilityString(i.name);switch(i.name=$(s).attr("name"),i.type){case"advantage":case"disadvantage":i.system.level=Number($(s).attr("data-step")),i=j.reverseAdoptionCalculation(this.actor,r,i),this.mergeLevels(t,i)||E.vantageAdded(this.actor,i);break;case"specialability":i.system.level=Number($(s).attr("data-step")),$(s).attr("data-free")&&(i.system.ap=0),i=j.reverseAdoptionCalculation(this.actor,r,i),this.mergeLevels(t,i)||x.abilityAdded(this.actor,i);break}}await this.actor.createEmbeddedDocuments("Item",t)}mergeLevels(e,t){let s=!1,a=e.find(i=>i.name==t.name&&i.type==t.type);if(a){s=!0;let i=Number(getProperty(t,"system.level"));i&&(a.system.level+=i)}else e.push(t);return s}static flashElem(e,t="emphasize"){e.addClass(t),setTimeout(function(){e.removeClass(t)},600)}finalizeUpdate(){this.errors.length==0?this.close():$(this._element).find(".dialog-buttons").html(`<div class="error"><p>${game.i18n.localize("dsk.DSKError.notUnderstood")}</p><ul><li>${this.errors.join("</li><li>")}</li></ul></div>`)}};m(Y,"WizardDSK");var Ee=class extends Y{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")}`}),e.template="systems/dsk/templates/wizard/add-species-wizard.html",e}async _parseBonus(e){let t=[],s=[],a=!1,i=Object.keys(v.characteristics),r=new RegExp(game.i18n.localize("dsk.WIZARDPARSER.speciesAdvantage"),"i");for(let n of e.split(","))if(r.test(n)){a=!0;let l=i.filter(c=>n.includes(c.toUpperCase()));t.push({choices:l,allowedCount:1});break}else s.push(n.trim());return s=await this.parseToItem(s.join(", "),["advantage","disadvantage"]),{anyAttributeRequirements:a,attributeRequirements:t,optionals:s}}async getData(e){let t=await super.getData(e),{anyAttributeRequirements:s,attributeRequirements:a,optionals:i}=await this._parseBonus(this.species.system.advantages),r=s;return mergeObject(t,{speciesDescription:game.i18n.has(`dsk.Racedescr.${this.species.name}`)?game.i18n.localize(`dsk.Racedescr.${this.species.name}`):this.species.system.description.value,species:this.species,description:game.i18n.format("dsk.WIZARD.speciesdescr",{species:this.species.name}),title:game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")} ${this.species.name}`}),generalToChose:r,anyAttributeRequirements:s,optionals:i,attributeRequirements:a}),t}async addSpecies(e,t){this.actor=e,this.species=duplicate(t)}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.species,"species")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.species":this.species.name,"system.stats.gs.initial":this.species.system.gs,"system.stats.sk.initial":this.species.system.sk,"system.stats.zk.initial":this.species.system.zk,"system.stats.LeP.initial":this.species.system.LeP,"system.stats.LeP.value":this.species.system.LeP+this.actor.system.characteristics.ko.value*2};for(let a of e.find(".exclusive:checked"))s[`system.characteristics.${$(a).val()}.species`]=1;await this.actor._updateAPs(t,{},{render:!1}),await this.addSelections(e.find(".optional:checked")),await this.actor.update(s),await this.actor.removeCondition("incapacitated"),this.finalizeUpdate()}};m(Ee,"SpeciesWizard");var Oe=class extends Y{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")}`}),e.template="systems/dsk/templates/wizard/add-culture-wizard.html",e}async getData(e){let t=await super.getData(e),s=0;return mergeObject(t,{title:game.i18n.format("dsk.WIZARD.addItem",{item:`${g.categoryLocalization("culture")} ${this.culture.name}`}),culture:this.culture,description:game.i18n.format("dsk.WIZARD.culturedescr",{culture:this.culture.name,cost:s})}),t}async addCulture(e,t){this.actor=e,this.culture=duplicate(t)}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.culture,"culture")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.culture":this.culture.name};await this.actor._updateAPs(t,{},{render:!1}),await this.updateSkill(this.culture.system.skills.split(","),"skill"),await this.actor.update(s),this.finalizeUpdate()}};m(Oe,"CultureWizard");var xe=class extends Y{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("dsk.WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.profession")}`}),e.template="systems/dsk/templates/wizard/add-career-wizard.html",e}async getData(e){let t=await super.getData(e),s=[...await this.parseToItem(this.career.system.requirements.advantage,["disadvantage","advantage"]),...await this.parseToItem(this.career.system.requirements.specialability,["specialability"])],a=s.filter(l=>["advantage","disadvantage"].includes(l.type)&&!l.disabled),i=0,r=s.reduce(function(l,c){return l+(c.disabled?0:Number(c.system.ap)||0)},0),n=s.filter(l=>l.type=="specialability"&&!l.disabled);return mergeObject(t,{title:game.i18n.format("dsk.WIZARD.addItem",{item:`${g.categoryLocalization("profession")} ${this.career.name}`}),career:this.career,description:game.i18n.format("dsk.WIZARD.careerdescr",{career:this.career.name,cost:i+r}),baseCost:i,missingVantagesToChose:a.length>0,missingSpecialabiltiesToChose:n.length>0}),t}async addCareer(e,t){this.actor=e,this.career=duplicate(t)}async setAbility(e,t){if(e.trim()=="")return;let s=[],a=[];for(let i of e.split(",")){if(["","-"].includes(i.trim()))continue;let r=g.parseAbilityString(i.trim()),n=this.actor.items.find(l=>t.includes(l.type)&&l.name==r.original);if(n)n=duplicate(n),n.system.level!=null&&(n.system.level=r.step),n=j.reverseAdoptionCalculation(this.actor,r,n),a.push(n);else if(n=await this.findCompendiumItem(r.original,t),n||(n=await this.findCompendiumItem(r.name,t)),n)n=duplicate(n),n.name=r.original,n.system.level!=null&&(n.system.level=r.step),n=j.reverseAdoptionCalculation(this.actor,r,n),s.push(n);else{let l=t.map(c=>g.categoryLocalization(c)).join("/");this.errors.push(`${l}: ${i}`),ui.notifications.error(game.i18n.format("dsk.DSKError.notFound",{category:l,name:i}))}}await this.actor.updateEmbeddedDocuments("Item",a,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",s,{},{render:!1})}async updateCharacter(){let e=$(this._element);e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let t=Number(e.find(".apCost").text());if(!this._validateInput($(this._element))||!await this.actor.checkEnoughXP(t)||await this.alreadyAdded(this.actor.system.details.profession,"profession")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.profession":this.career.name};this.career.system.isAncestor&&(await this.setAbility(this.career.system.ahnengabe,["ahnengabe"]),await this.setAbility(this.career.system.ahnengeschenk,["ahnengeschenk"])),await this.setAbility(this.career.system.requirements.specialability,["specialability"]),await this.setAbility(this.career.system.requirements.advantage,["advantage","disadvantage"]),await this.actor._updateAPs(t,{},{render:!1});let a=[...this.career.system.skills.body.split(","),...this.career.system.skills.social.split(","),...this.career.system.skills.mental.split(","),...this.career.system.skills.trade.split(",")];await this.updateSkill(a,"skill"),await this.updateSkill(this.career.system.skills.combat.split(","),"combatskill"),await this.actor.update(s),this.finalizeUpdate()}};m(xe,"CareerWizard");var ee=class extends ae{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","actor","character-sheet"]),width:795}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/npc-limited.html":"systems/dsk/templates/actors/actor-sheet.html"}async _manageDragItems(e,t){switch(t){case"aggregatedTest":await this.actor.createEmbeddedDocuments("Item",[e]);break;case"species":let s=new Ee;await s.addSpecies(this.actor,e),s.render(!0);break;case"culture":let a=new Oe;await a.addCulture(this.actor,e),a.render(!0);break;case"profession":let i=new xe;await i.addCareer(this.actor,e),i.render(!0);break;default:return super._manageDragItems(e,t)}}};m(ee,"ActorSheetCharacter");var ie=class extends ae{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","actor","creature-sheet","character-sheet"])}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/creature-limited.html":"systems/dsk/templates/actors/creature-sheet.html"}async getData(e){let t=await super.getData(e);return t.enrichedBehaviour=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.fight"),{secrets:this.object.isOwner,async:!0}),t.enrichedSpecialrules=await TextEditor.enrichHTML(getProperty(this.actor.system,"notes.specialRules"),{secrets:this.object.isOwner,async:!0}),t}async _cleverDeleteItem(e){let t=this.actor.items.find(s=>s.id==e);switch(t.type){case"trait":await this._updateAPs(t.system.ap*-1,{},{render:!1});break}await super._cleverDeleteItem(e)}async _addTrait(e){this.actor.items.find(s=>s.type=="trait"&&s.name==e.name)||(await this._updateAPs(e.system.ap,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}async _onDropItemCreate(e){return e.type=="trait"?this._addTrait(e):super._onDropItemCreate(e)}};m(ie,"ActorSheetCreature");var re=class extends ee{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","actor","npc-sheet"])}),e}get template(){return this.showLimited()?"systems/dsk/templates/actors/npc-limited.html":"systems/dsk/templates/actors/npc-sheet.html"}};m(re,"ActorSheetNPC");var ze=class extends JournalSheet{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsk","dskjournal"])}),e}};m(ze,"DSKJournalSheet");var na={"":"dsk.Modifier",defenseMalus:"dsk.MODS.defenseMalus",FW:"dsk.MODS.FW",AeP:"dsk.AeP",FP:"dsk.MODS.FP",QL:"dsk.MODS.QS",dmg:"dsk.MODS.damage",damageBonus:"dsk.MODS.damage",armorPen:"dsk.MODS.armorPen",TPM:"dsk.MODS.partChecks"};function Os(){Handlebars.registerHelper({roman:(o,e)=>e!=null&&Number(e)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][o-1],itemCategory:o=>g.categoryLocalization(o),isWEBM:o=>/.webm$/.test(o),getAttr:(o,e,t)=>o.system.characteristics[e][t],diceThingsUp:(o,e)=>g.replaceDies(o,!1),replaceConditions:g.replaceConditions,attrLoc:(o,e)=>game.i18n.localize(`dsk.characteristics.${o}.${e}`),floor:o=>Math.floor(Number(o)),situationalTooltip:o=>{let e=game.i18n.localize(`${na[o.type]||"dsk.Modifier"}`),t=`${o.name}<br/>${e}: ${o.value}`;return o.source&&(t+=`<br/>${game.i18n.localize("dsk.source")}: ${o.source}`),t}})}m(Os,"setupHandlebars");function xs(){Hooks.on("getJournalSheetHeaderButtons",(o,e)=>{!o.document.sceneNote||e.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:async()=>o.document.panToNote()})}),Hooks.on("renderJournalSheet",(o,e,t)=>{e.find(".close").attr("data-tooltip",game.i18n.localize("dsk.SHEET.Close")),e.find(".entry-image").attr("data-tooltip",game.i18n.localize("dsk.SHEET.imageView")),e.find(".entry-text").attr("data-tooltip",game.i18n.localize("dsk.SHEET.textView")),e.find(".share-image").attr("data-tooltip",game.i18n.localize("dsk.SHEET.showToPlayers")),e.find(".import").attr("data-tooltip",game.i18n.localize("dsk.SHEET.import")),e.find(".panMapNote").attr("data-tooltip",game.i18n.localize("dsk.SHEET.panMapNote"))}),Hooks.on("renderJournalPageSheet",(o,e,t)=>{B.bindRollCommands(e),O.bindButtons(e),e.find("img").mousedown(s=>{s.button==2&&game.dsk.apps.DSKUtility.showArtwork({name:o.name,uuid:"",img:$(s.currentTarget).attr("src")})}),ve(e)})}m(xs,"setupJournal");function Ns(){Hooks.on("hotbarDrop",(o,e,t)=>{if(e.type=="Item"){let s=fromUuidSync(e.uuid);if(!["ahnengabe","meleeweapon","rangeweapon","skill","combatskill","char","trait"].includes(s.type)||(s.type=="meleeweapon"||s.type=="combatskill")&&!["attack","parry"].includes(e.mod))return;if((s.type=="rangeweapon"||s.type=="trait")&&!["attack"].includes(e.mod))return;let i=`{mod: "${e.mod}"}`,r;game.user.isGM||e.actorId==null?r=`game.dsk.macro.itemMacro("${s.name}", "${s.type}", ${i});`:r=`game.dsk.macro.itemMacroById("${e.actorId}", "${s.name}", "${s.type}", ${i})`;let n=e.mod==null?s.name:`${s.name} - ${game.i18n.localize("dsk.characteristics."+e.mod+".name")}`;return zs(r,n,s.img,t)}else if(e.type=="Actor"||e.type=="JournalEntry"){let s=fromUuidSync(e.uuid),a=`(await fromUuid('${e.uuid}')).sheet.render(true)`;return zs(a,s.name,s.img,t)}})}m(Ns,"setupMacros");function zs(o,e,t,s){let a=game.macros.contents.find(i=>i.name===e&&i.command===o);return a?game.user.assignHotbarMacro(a,s):Macro.create({name:e,type:"script",img:t,command:o},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,s)),!1}m(zs,"createHotBarMacro");var Ne=class{static async stopFade(e){e.stopPropagation(),e.preventDefault(),this.fadeOut?(this.fadeOut=!1,$(e.currentTarget).find("i").removeClass("fa-stop").addClass("fa-angle-right"),$(".didYouKnow").off("click"),$(".didYouKnow .closeDidYou").click(()=>$(".didYouKnow").remove())):fetch(`systems/dsk/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let s=t.data[Math.floor(Math.random()*t.data.length)],a=await renderTemplate("systems/dsk/templates/system/didyouknow.html",{msg:s,fadeOut:Ne.fadeOut});$("body").find(".didYouKnow").replaceWith(a),Ne.activateListeners()})}static activateListeners(){$(".didYouKnow .stopFade").click(async e=>await this.stopFade(e)),$(".didYouKnow").click(()=>$(".didYouKnow").remove()),$(".didYouKnow").fadeIn()}static async showOneMessage(e=8e3){game.settings.get("dsk","disableDidYouKnow")||fetch(`systems/dsk/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let s=t.data[Math.floor(Math.random()*t.data.length)],a=await renderTemplate("systems/dsk/templates/system/didyouknow.html",{msg:s,fadeOut:Ne.fadeOut});$("body").append(a),this.activateListeners(),setTimeout(function(){Ne.fadeOut&&$(".didYouKnow").fadeOut(1e3,()=>$(".didYouKnow").remove())},e)})}},Se=Ne;m(Se,"DidYouKnow"),z(Se,"fadeOut",!0);var ne=class{static async firstTimeMessage(){if(!await game.settings.get("dsk","firstTimeStart")){await ne.setupDefaultOptions();let e=game.i18n.localize("dsk.WELCOME");ChatMessage.create(g.chatDataSetup(e)),ne.firstTimeLanguage(),await game.settings.set("dsk","firstTimeStart",!0)}}static firstTimeLanguage(){let e=["de"],t={title:game.i18n.localize("dsk.DIALOG.firstTime"),content:game.i18n.localize("dsk.DIALOG.firstTimeWarning"),default:"de",buttons:{}};for(let s of e)t.buttons[s]={label:game.i18n.localize(s),callback:()=>ne.setLanguage(s)};new Dialog(t).render(!0)}static async setLanguage(e){await game.settings.set("dsk","firstTimeStart",!0),await game.settings.set("dsk","forceLanguage",e),await game.settings.set("core","language",e),foundry.utils.debouncedReload()}static async setupDefaultOptions(){let e=game.settings.get("core",Combat.CONFIG_SETTING);e.skipDefeated=!0,await game.settings.set("core",Combat.CONFIG_SETTING,e),await game.settings.set("core","leftClickRelease",!0)}};m(ne,"DSKTutorial");var vs=m(async(o,e,t,s)=>{if(game.user.isGM){let a=await g.getFolderForType("Actor",null,"Dropped Items"),r=game.users.filter(d=>!d.isGM).map(d=>d.id).reduce((d,p)=>(d[p]=1,d),{default:0}),n=e.toObject();n.system.quantity=s,_.obfuscateDropData(n,t.tabsinvisible),getProperty(n,"system.worn.value")&&(n.system.worn.value=!1);let l={type:"npc",name:e.name,img:e.img,prototypeToken:{img:e.img,width:.4,height:.4},ownership:r,items:[n],flags:{core:{sheetClass:"dsk.MerchantSheetDSK"}},folder:a,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},stats:{LeP:{value:16}}}},u=await(await game.dsk.documents.ActorDSK.create(l)).getTokenDocument({x:t.x,y:t.y,hidden:!1});if(!canvas.dimensions.rect.contains(u.x,u.y))return!1;if(o){await canvas.scene.createEmbeddedDocuments("Token",[u],{noHook:!0});let d=e.system.quantity-s;d<1?await o.deleteEmbeddedDocuments("Item",[e.id]):await o.updateEmbeddedDocuments("Item",[{_id:e.id,"system.quantity":d}])}else await canvas.scene.createEmbeddedDocuments("Token",[u])}else{let a={itemId:e.uuid,sourceActorId:o?.id,data:t,amount:s};game.socket.emit("system.dsk",{type:"itemDrop",payload:a})}},"dropToGround"),oa=m(async(o,e)=>{let t=await Item.implementation.fromDropData(e),s=t.parent;if(!v.equipmentCategories.includes(t.type))return;let a=await renderTemplate("systems/dsk/templates/dialog/dropToGround.html",{name:t.name,count:t.system.quantity});new os({title:e.name,content:a,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:async i=>vs(s,t,e,Number(i.find('[name="count"]').val()))},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)},"handleItemDrop"),la=m(async(o,e)=>{let t=e.x,s=e.y,a=0,i=o.grid.size,r=Math.ceil(Math.sqrt(e.ids.length));for(let n of e.ids){let l=game.actors.get(n);if(!l)continue;let c=await l.getTokenDocument({x:t,y:s,hidden:!1});c.constructor.create(c,{parent:o.scene}),r%a==0&&a>0?(s+=i,t=e.x):t+=i,a++}},"handleGroupDrop"),Ps=m(()=>{Hooks.on("dropCanvasData",async(o,e)=>{if(!!(game.settings.get("dsk","enableItemDropToCanvas")||game.user.isGM||e.tokenId)){if(e.type=="Item")return oa(o,e),!1;if(e.type=="GroupDrop")return la(o,e),!1}})},"connectHook"),os=class extends Dialog{activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change(t=>{$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())})}};m(os,"DropToGroundDialog");var ge=class extends Dialog{static async showDialog(e){let t=this.callbackResult;new ge({title:game.i18n.localize("dsk.Unopposed"),content:await this.getTemplate(e),default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:s=>{t(s.find('[name="entryselection"]').val(),e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}static getTargetActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.targetSpeaker,s=canvas.tokens.get(t.token).actor;return s?{actor:s,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("dsk.DSKError.noProperActor")),{})}static async getTemplate(e){return""}static callbackResult(e,t,s){}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}};m(ge,"DialogReactDSK");var Ce=class extends Dialog{static async showDialog(e,t){let s=new Ce({title:game.i18n.localize("dsk.attacktest"),content:await this.getTemplate(e),buttons:{}});s.actor=e,s.tokenId=t,s.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t.currentTarget.dataset.value,this.actor,this.tokenId),this.close()})}static async getTemplate(e){let t=e.items.filter(r=>r.type=="combatskill").map(r=>D._calculateCombatSkillValues(r.toObject(),e.system)),s=[],a=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"];for(let r of e.items)if(a.includes(r.type)&&r.system.worn.value==!0){let n=r.type=="meleeweapon"?D._prepareMeleeWeapon(r.toObject(),t,e):D._prepareRangeWeapon(r.toObject(),[],t,e);s.push({name:r.name,id:r.name,img:r.img,value:n.attack})}else r.type=="trait"&&i.includes(r.system.traitType)&&s.push({name:r.name,id:r.name,img:r.img,value:r.system.at});return await renderTemplate("systems/dsk/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:s,title:"dsk.DIALOG.selectAction"})}callbackResult(e,t,s){let a=["meleeweapon","trait","rangeweapon"],i=t.items.find(r=>a.includes(r.type)&&r.name==e);i&&t.setupWeapon(i,"attack",{},s).then(r=>{t.basicTest(r)})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:550}),e}};m(Ce,"ActAttackDialog");var te=class extends CombatTracker{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"/systems/dsk/templates/system/combattracker.html"})}activateListeners(e){super.activateListeners(e),e.find(".combatant.actor .aggroButton").click(t=>{t.preventDefault(),t.stopPropagation(),te.runActAttackDialog()})}static runActAttackDialog(){if(!game.combat)return;let e=game.combat.combatant;(game.user.isGM||e.isOwner)&&Ce.showDialog(e.actor,e.tokenId)}async getData(e){let t=await super.getData(e);for(let s of t.turns){let a=t.combat.turns.find(n=>n.id==s.id),i=game.user.isGM||a.actor&&a.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsk","hideEffects");s.defenseCount=a.getFlag("dsk","defenseCount")||0;let r=[];if(a.actor){for(let n of a.actor.items)if(n.type=="rangeweapon"&&n.system.worn.value&&n.system.reloadTimeprogress>0){let l={name:n.name,remaining:D.calcLZ(n,a.actor)-n.system.reloadTimeprogress};l.remaining>0&&r.push(l)}else if(["spell","liturgy"].includes(n.type)&&n.system.castingTime.modified>0){let l={name:n.name,remaining:n.system.castingTime.modified-n.system.castingTime.progress};l.remaining>0&&r.push(l)}}r=r.sort((n,l)=>n.remaining-l.remaining),r.length>0&&(s.ongoings=`${game.i18n.localize("dsk.COMBATTRACKER.ongoing")}
${r.map(n=>`${n.name} - ${n.remaining}`).join(`
`)}`,s.ongoing=r[0].remaining),s.effects=new Set,a.token&&(a.token.effects.forEach(n=>s.effects.add(n)),a.token.overlayEffect&&s.effects.add(a.token.overlayEffect)),a.actor&&a.actor.temporaryEffects.forEach(n=>{n.statuses.has(CONFIG.Combat.defeatedStatusId)?s.defeated=!0:n.icon&&i&&!n.notApplicable&&(game.user.isGM||!n.getFlag("dsk","hidePlayers"))&&!n.getFlag("dsk","hideOnToken")&&s.effects.add(n.icon)})}return t}};m(te,"DSKCombatTracker");var tt=class extends Combat{constructor(e,t){super(e,t)}async refreshTokenbars(){game.dsk.apps.tokenHotbar&&game.dsk.apps.tokenHotbar.updateDSKHotbar()}_onCreate(e,t,s){super._onCreate(e,t,s),this.refreshTokenbars()}_onDelete(e,t){super._onDelete(e,t),this.refreshTokenbars()}async nextRound(){if(game.user.isGM)for(let e of this.turns)await e.setFlag("dsk","defenseCount",0);else await game.socket.emit("system.dsk",{type:"clearCombat",payload:{}});return await super.nextRound()}async getDefenseCount(e){let t=this.getCombatantFromActor(e);return t&&t.getFlag("dsk","defenseCount")||0}getCombatantFromActor(e){let t;return e.token?t=Array.from(this.combatants).find(s=>s.tokenId==e.token):t=Array.from(this.combatants).find(s=>s.actorId==e.actor),t?this.combatants.get(t.id):void 0}async updateDefenseCount(e){if(game.user.isGM)for(let t of e){let s=this.getCombatantFromActor({token:t});s&&!getProperty(s.actor,"system.config.defense")&&await s.setFlag("dsk","defenseCount",(s.getFlag("dsk","defenseCount")||0)+1)}else await game.socket.emit("system.dsk",{type:"updateDefenseCount",payload:{speaker:e}})}};m(tt,"DSKCombat");var st=class extends Combatant{constructor(e,t){e.flags==null&&(e.flags={}),mergeObject(e.flags,{dsk:{defenseCount:0}}),super(e,t)}async recalcInitiative(){if(this.initiative){let t={initiative:(await this.getFlag("dsk","baseRoll")||0)+this.actor.system.stats.ini.value};await this.update(t)}}};m(st,"DSKCombatant");Hooks.on("preCreateCombatant",(o,e,t)=>{let s=g.getSpeaker({actor:o.actorId,scene:o.sceneId,token:o.token_id});if(getProperty(s.system,"merchant.merchantType")=="loot")return!1});Hooks.on("updateCombatant",(o,e,t)=>{if(!!game.user.isGM)if(e.initiative){if(!o.getFlag("dsk","baseRoll")){let a=`${e.initiative}`.split("."),i=Number(a[0])-Math.round(o.actor.system.stats.ini.value);o.setFlag("dsk","baseRoll",i)}}else"initiative"in e&&e.initiative==null&&o.update({["flags.dsk.-=baseRoll"]:null})});var Pe=class{static async updateCombatHook(e,t,s,a){!t.round&&!t.turn||e.round!=0&&e.turns&&e.active&&e.previous.round<e.current.round&&await Pe.startOfRound(e)}static async startOfRound(e){let t=game.users.find(s=>s.active&&s.isGM);if(!!(t&&game.user.id==t.id)){for(let s of e.turns)if(!s.defeated){for(let a of s.actor.effects){let i=[...a.statuses][0];i=="bleeding"?await this.applyBleeding(s):i=="burning"&&await this.applyBurning(s,a)}await this.startOfRoundEffects(s)}}}static async startOfRoundEffects(e){let t=["LeP","AeP"];for(let s of t)for(let a of e.actor.system.repeatingEffects.startOfRound[s]){if(getProperty(e.actor.system.repeatingEffects,`disabled.${s}`))continue;let i=await new Roll(a.value).evaluate({async:!0}),r=await i.render(),n=game.i18n.localize(i.total>0?"dsk.CHATNOTIFICATION.regenerates":"dsk.CHATNOTIFICATION.getsHurt"),l=`${e.actor.name} ${n} ${game.i18n.localize(s)} ${r}`;await ChatMessage.create(g.chatDataSetup(l)),s=="LeP"?await e.actor.applyDamage(i.total*-1):await e.actor.applyMana(i.total*-1)}}static async applyBleeding(e){e.actor.system.stats.LeP.value<=0||(await ChatMessage.create(g.chatDataSetup(game.i18n.format("dsk.CHATNOTIFICATION.bleeding",{actor:e.actor.name}))),await e.actor.applyDamage(1))}static async applyBurning(e,t){if(e.actor.system.stats.LeP.value<=0)return;let s=Number(t.getFlag("dsk","value")),a=DSKStatusEffects.resistantToEffect(e.actor,t),i={0:"1",1:"1d3",2:"1d6",3:"2d6"}[s-a]||"1",r=await new Roll(i).evaluate({async:!0}),n=await r.render();await ChatMessage.create(g.chatDataSetup(game.i18n.format(`dsk.CHATNOTIFICATION.burning.${s}`,{actor:e.actor.name,damage:n}))),await e.actor.applyDamage(r.total)}};m(Pe,"RepeatingEffectsHelper");Hooks.on("updateCombat",Pe.updateCombatHook);var he=class extends Application{static get defaultOptions(){let e=super.defaultOptions;mergeObject(e,{classes:e.classes.concat(["dsk","initTracker"]),template:"systems/dsk/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"dsk.DSKIniTracker"});let t=game.settings.get("dsk","iniTrackerPosition");return mergeObject(e,t),e}setPosition({left:e,top:t,width:s,height:a,scale:i}={}){let r=super.setPosition({left:e,top:t,width:s,height:a,scale:i}),n=this.element[0];if(!n.style.width||s){let l=s||n.offsetWidth,c=n.style.maxWidth||window.innerWidth;r.width=s=Math.clamped(l,0,c),n.style.width=s+"px",s+r.left>window.innerWidth&&(e=r.left)}return game.settings.set("dsk","iniTrackerPosition",{left:r.left,top:r.top}),r}static connectHooks(){Hooks.on("renderDSKCombatTracker",(e,t,s)=>{!game.settings.get("dsk","enableCombatFlow")||(game.combat?(game.dsk.apps.initTracker||(game.dsk.apps.initTracker=new he),game.dsk.apps.initTracker.updateTracker(s)):game.dsk.apps.initTracker&&(game.dsk.apps.initTracker.close(),game.dsk.apps.initTracker=void 0))})}updateTracker(e){this.combatData=e,this.render(!0)}async getData(e){let t=this.combatData,s=game.settings.get("dsk","iniTrackerSize"),a=t.round,i=t.turns,r=[],n=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,l=t.turns.some(c=>c.owner&&!c.hasRolled&&(!game.user.isGM||t.combat.combatants.get(c.id).isNPC));if(i.length){let c=[],u=5,d=!1,p=-1,f=0,k=0,T;for(;!(u==0||k==5);){let h=duplicate(i[f]),y=t.combat.combatants.get(h.id);d&&f==p&&(h.css=h.css.replace("active","")),!a||h.active&&!d?(d=!0,p=f):y.getFlag("dsk","waitInit")==t.round+k&&!y.defeated&&(game.user.isGM||!y.hidden)&&r.push(h),d&&!(n&&y.defeated)&&(game.user.isGM||!y.hidden)&&(h.round=t.round+k,h.owner&&y.token?.actor&&(h.maxLP=y.token.actor.system.stats.LeP.max,h.currentLP=y.token.actor.system.stats.LeP.value),T&&T!=h.round&&(h.newRound="newRound"),T=h.round,c.push(h),u--),f++,f>=i.length&&(f=0,k++)}t.turns=c}return t.isLastRound=t.turns[1]?.newRound,this.position.width=s*5+95,this.position.height=s+10,mergeObject(t,{itemWidth:s,unRolled:l,waitingTurns:r}),this.conditionalPanToCurrentCombatant(t),t}hasChangedTurn(e){let t=e.turn!=this.lastTurnUpdate||e.round!=this.lastRoundUpdate;return this.lastTurnUpdate=e.turn,this.lastRoundUpdate=e.round,t}async conditionalPanToCurrentCombatant(e){if(!game.settings.get("dsk","enableCombatPan"))return;let t=e.turns[0];if(!t)return;let s=e.combat.combatants.get(t.id);!s||!this.hasChangedTurn(e)||setTimeout(()=>{let a=s.token;!a||!a.object||!a.object.isVisible||(canvas.animatePan({x:a.x,y:a.y}),!(!s.actor||!s.actor.isOwner)&&a.object.control({releaseOthers:!0}))},300)}async _onWheelResize(e){let t=game.settings.get("dsk","iniTrackerSize");e.originalEvent.deltaY>0?t=Math.min(140,t+5):t=Math.max(30,t-5),await game.settings.set("dsk","iniTrackerSize",t),await this.render(!0)}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async a=>(a.stopPropagation(),a.preventDefault(),await this._onWheelResize(a),!1)),e.find(".combat-control").click(a=>this._onCombatControl(a));let s=e.find(".iniItem");s.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),s.click(this._onCombatantMouseDown.bind(this)),e.find(".waitingTackerList .iniItem").mousedown(a=>this._onRightClick(a)),e.find(".combatant-control").click(a=>this._onCombatantControl(a)),e.find(".combatant .aggroButton").click(a=>{a.preventDefault(),a.stopPropagation(),te.runActAttackDialog()}),e.find(".rollMine").click(a=>this.rollMyChars()),game.user.isGM&&e.find(".rolledInit").click(a=>this.editCombatant(a))}rollMyChars(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);t.isOwner&&t.unsetFlag("dsk","waitInit")}}editCombatant(e){this._getCombatApp()._onConfigureCombatant($(e.currentTarget))}_onCombatantControl(e){this._getCombatApp()._onCombatantControl(e)}_onCombatControl(e){e.currentTarget.dataset.control=="waitInit"?this.waitInit(e):this._getCombatApp()._onCombatControl(e)}async waitInit(e){await game.combat.combatants.get(game.combat.current.combatantId).setFlag("dsk","waitInit",game.combat.current.round),e.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(e)}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onCombatantMouseDown(e){this._getCombatApp()._onCombatantMouseDown(e)}_getCombatApp(){return game.combats.apps[0]}_canDragStart(e){return!1}_canDragDrop(e){return!1}_onDragStart(e){let t=$(e.currentTarget).closestData("combatant-id");e.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:t}))}_onDrop(e){JSON.parse(e.dataTransfer.getData("text/plain")).type=="IniChange"}};m(he,"DSKIniTracker");var X=class extends Application{static registerTokenHotbar(){game.dsk.apps.tokenHotbar||(game.dsk.apps.tokenHotbar=new X)}constructor(e){super(e),this.combatSkills=["selfControl","featOfStrength","bodyControl","perception"].map(s=>game.i18n.localize(`dsk.LocalizedIDs.${s}`)),this.defaultSkills=[game.i18n.localize("dsk.LocalizedIDs.perception")];let t=m(s=>{let a=s.parent?s.parent.id:void 0;a&&X.hookUpdate(a)},"parentUpdate");Hooks.on("controlToken",(s,a)=>{this.updateDSKHotbar()}),Hooks.on("updateActor",(s,a)=>{X.hookUpdate(s.id)}),Hooks.on("updateToken",(s,a,i)=>{a._id==getProperty(game.dsk.apps.tokenHotbar,"actor.prototypeToken.id")&&this.updateDSKHotbar()}),Hooks.on("updateOwnedItem",(s,a)=>{X.hookUpdate(s.data.id)}),Hooks.on("createOwnedItem",(s,a)=>{X.hookUpdate(s.data.id)}),Hooks.on("deleteOwnedItem",(s,a)=>{X.hookUpdate(s.data.id)}),Hooks.on("updateItem",(s,a)=>{t(s)}),Hooks.on("createItem",(s,a)=>{t(s)}),Hooks.on("deleteItem",(s,a)=>{t(s)})}static hookUpdate(e){e==getProperty(game.dsk.apps.tokenHotbar,"actor.id")&&game.dsk.apps.tokenHotbar.updateDSKHotbar()}resetPosition(){let e=$("#hotbar").first().position(),t=game.settings.get("dsk","tokenhotbarSize");this.position.left=e.left+8,this.position.top=e.top-t-25}static get defaultOptions(){let e=super.defaultOptions,t=$("#hotbar").first().position(),s=game.settings.get("dsk","tokenhotbarSize"),a=game.settings.get("dsk","tokenhotbarPosition");return mergeObject(e,{classes:e.classes.concat(["dsk","tokenQuickHot"]),itemWidth:s,resizable:!1,height:s+45,zIndex:61,left:t.left+8,top:t.top-s-25,template:"systems/dsk/templates/status/tokenHotbar.html",title:"TokenHotbar"}),mergeObject(e,a),e}async _onWheelResize(e){let t=game.settings.get("dsk","tokenhotbarSize");e.originalEvent.deltaY>0?t=Math.min(100,t+5):t=Math.max(15,t-5),await game.settings.set("dsk","tokenhotbarSize",t),await this.render(!0)}async _cycleLayout(e){if(e.button==2){let t=game.settings.get("dsk","tokenhotbarLayout")+1;t==4&&(t=0),await game.settings.set("dsk","tokenhotbarLayout",t),await this.render(!0)}}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async s=>(s.stopPropagation(),s.preventDefault(),await this._onWheelResize(s),!1)),t.on("mousedown",async s=>{await this._cycleLayout(s)}),e.on("mousedown","li",async s=>(s.stopPropagation(),await this.executeQuickButton(s),!1)),e.on("mouseenter","li.primary",s=>{let a=s.currentTarget.dataset.category;this.category=a,setTimeout(()=>{e.find(".secondary").removeClass("shown"),a==this.category&&e.find(`.secondary[data-category="${a}"]`).addClass("shown")},700)}),e.on("mouseleave","li.primary",s=>{let a=s.currentTarget.dataset.category;this.category=void 0,setTimeout(()=>{a!=this.category&&e.find(`.secondary[data-category="${a}"]`).removeClass("shown")},50)})}async executeQuickButton(e){let t=canvas.tokens.controlled[0].actor,s=canvas.tokens.controlled[0].id,a=e.currentTarget.dataset.id;switch(e.currentTarget.dataset.subfunction){case"addEffect":_e.showDialog();break;case"effect":let r=t.effects.get(a),n=[...r.statuses][0];e.button==0?n?await t.addCondition(n,1,!1,!1):r.sheet.render(!0):e.button==2&&(n?await t.removeCondition(n,1,!1):await t.sheet._deleteActiveEffect(a)),await this.render(!0);break;case"onUse":let l=t.items.get(a);new V(l).executeOnUseEffect();break;default:let u=t.items.get(a);if(u){if(e.button==2)return u.sheet.render(!0);switch(u.type){case"meleeweapon":case"rangeweapon":case"trait":t.setupWeapon(u,"attack",{},s).then(d=>{t.basicTest(d)});break;case"ahnengabe":t.setupSpell(u,{},s).then(d=>{t.basicTest(d)});break;case"skill":t.setupSkill(u,{},s).then(d=>{t.basicTest(d)});break}}}}subWidth(e,t,s=7){return`style="width:${Math.ceil(e.length/s)*200}px"`}async getData(){let e=await super.getData(),t=this.actor,s={attacks:[],spells:[],default:[],skills:[]},a,i,r=[],n=[],l=[],c=game.settings.get("dsk","tokenhotbarLayout"),u=c%2,d=X.defaultOptions.itemWidth,p=["ahnengabe"];if(t){let k=[],T=[];if(l=(await t.actorEffects()).map(h=>({name:h.name,id:h.id,icon:h.icon,cssClass:"effect",abbrev:`${h.name[0]} ${h.getFlag("dsk","value")||""}`,subfunction:"effect"})),game.combat){let h=t.items.filter(w=>w.type=="combatskill").map(w=>D._calculateCombatSkillValues(w.toObject(),t.system)),y=["meleeweapon","rangeweapon"],b=["meleeAttack","rangeAttack"];for(let w of t.items){if(w.type=="trait"&&b.includes(w.system.traitType)){let I=D._parseDmg(w.toObject());s.attacks.push({name:w.name,id:w.id,icon:w.img,cssClass:`weapon ${w.id}`,abbrev:w.name[0],attack:w.system.at,damage:I.damagedie,dadd:I.damageAdd})}else if(y.includes(w.type)&&w.system.worn.value==!0){let I=w.type=="meleeweapon"?D._prepareMeleeWeapon(w.toObject(),h,t):D._prepareRangeWeapon(w.toObject(),[],h,t);s.attacks.push({name:w.name,id:w.id,icon:w.img,cssClass:`weapon ${w.id}`,abbrev:w.name[0],attack:I.attack,damage:I.damagedie,dadd:I.damageAdd})}else if(p.includes(w.type))w.system.effectFormula?s.spells.push({name:w.name,id:w.id,icon:w.img,cssClass:"spell",abbrev:w.name[0]}):T.push({name:w.name,id:w.id,icon:w.img,cssClass:"spell",abbrev:w.name[0]});else if(["skill"].includes(w.type)&&this.combatSkills.includes(w.name))s.default.push({name:`${w.name} (${w.system.level})`,id:w.id,icon:w.img,cssClass:"skill",abbrev:w.name[0]});else if(["skill"].includes(w.type)){let I={name:`${w.name} (${w.system.level})`,id:w.id,icon:w.img,cssClass:"skill",addClass:w.system.group,abbrev:w.name[0],tw:w.system.level};k.push(I)}else w.type=="consumable"&&r.push({name:w.name,id:w.id,icon:w.img,cssClass:"consumable",abbrev:w.system.quantity});w.getFlag("dsk","onUseEffect")&&n.push({name:w.name,id:w.id,icon:w.img,cssClass:"onUse",abbrev:w.name[0],subfunction:"onUse"})}a=r.pop()}else{let h=[];for(let y of t.items){if(["skill"].includes(y.type)&&this.defaultSkills.includes(y.name))s.default.push({name:`${y.name} (${y.system.level})`,id:y.id,icon:y.img,cssClass:"skill",abbrev:y.name[0]});else if(["skill"].includes(y.type)){let b={name:`${y.name} (${y.system.level})`,id:y.id,icon:y.img,cssClass:"skill",addClass:y.system.group,abbrev:y.name[0],tw:y.system.level};y.system.level>0&&h.push(b),k.push(b)}else p.includes(y.type)&&(y.system.effectFormula?s.spells.push({name:y.name,id:y.id,icon:y.img,cssClass:"spell",abbrev:y.name[0]}):T.push({name:y.name,id:y.id,icon:y.img,cssClass:"spell",abbrev:y.name[0]}));y.getFlag("dsk","onUseEffect")&&n.push({name:y.name,id:y.id,icon:y.img,cssClass:"onUse",abbrev:y.name[0],subfunction:"onUse"})}s.skills.push(...h.sort((y,b)=>b.tw-y.tw).slice(0,5))}i=n.pop(),s.spells.length==0&&T.length>0&&s.spells.push(T.pop()),s.spells.length>0&&T.length>0&&(s.spells[0].more=T.sort((h,y)=>h.name.localeCompare(y.name)),s.spells[0].subwidth=this.subWidth(T,d)),s.default.length>0&&k.length>0&&(s.default[0].more=k.sort((h,y)=>h.addClass.localeCompare(y.addClass)||h.name.localeCompare(y.name)),s.default[0].subwidth=this.subWidth(k,d,20)),a&&(r.length>0&&(a.more=r,a.subwidth=this.subWidth(r,d)),s.consumables=[a]),i&&(n.length>0&&(i.more=n,i.subwidth=this.subWidth(n,d)),s.onUsages=[i])}if(this.showEffects){let k=game.i18n.localize("dsk.CONDITION.add"),T={name:k,id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:k[0],subfunction:"addEffect"};l.length>0&&(T.more=l,T.subwidth=this.subWidth(l,d)),s.effects=[T]}let f=Object.keys(s).reduce((k,T)=>k+s[T].length,0);return u?(this.position.width=d,this.position.height=d*f+14):(this.position.width=d*f+14,this.position.height=d),mergeObject(e,{items:s,itemWidth:d,direction:c,count:f}),e}async render(e,t={}){let s=await super.render(e,t);return this._element&&this._element.css({zIndex:61}),s}setPosition({left:e,top:t,width:s,height:a,scale:i}={}){let r=super.setPosition({left:e,top:t,width:s,height:a,scale:i}),n=this.element[0];if(!n.style.width||s){let l=s||n.offsetWidth,c=n.style.maxWidth||window.innerWidth;r.width=s=Math.clamped(l,0,c),n.style.width=s+"px",s+r.left>window.innerWidth&&(e=r.left)}return game.settings.set("dsk","tokenhotbarPosition",{left:r.left,top:r.top}),r}async updateDSKHotbar(){let e=canvas.tokens.controlled;if(this.actor=void 0,this.showEffects=!1,e.length===1){let t=e[0].actor;t&&t.isOwner&&(this.actor=t)}e.length>=1&&(this.showEffects=!0),await this.render(!0)}};m(X,"TokenHotbar2");var _e=class extends Dialog{static async showDialog(){let e=duplicate(CONFIG.statusEffects).map(s=>({label:game.i18n.localize(s.name),icon:s.icon,description:game.i18n.localize(s.description),id:s.id})).sort((s,a)=>s.label.localeCompare(a.label)),t=new _e({title:game.i18n.localize("dsk.CONDITION.add"),content:await renderTemplate("systems/dsk/templates/dialog/addstatusdialog.html",{effects:e}),buttons:{}});t.position.height=Math.ceil(e.length/3)*36+170,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(a=>this.addEffect(a));let t=m(a=>this._filterConditions($(a.currentTarget),e),"filterConditions"),s=e.find(".conditionSearch");s.keyup(a=>this._filterConditions($(a.currentTarget),e)),s[0]&&s[0].addEventListener("search",t,!1)}_filterConditions(e,t){if(e.val()!=null){let s=e.val().toLowerCase().trim(),a=t.find(".filterable");t.find(".filterHide").removeClass("filterHide"),a.filter(function(){return $(this).find("span").text().toLowerCase().trim().indexOf(s)==-1}).addClass("filterHide")}}async addEffect(e){for(let t of canvas.tokens.controlled)await t.actor.addCondition(e.currentTarget.dataset.value,1,!1,!1);game.dsk.apps.tokenHotbar.render(!0),this.close()}static get defaultOptions(){let e=super.defaultOptions,t=Math.ceil(CONFIG.statusEffects.length/3)*32;return mergeObject(e,{classes:["dsk","tokenStatusEffects"],width:700,resizable:!0,height:t}),e}};m(_e,"AddEffectDialog");var P=class{static payMoney(e,t,s=!1){let a=P.canPay(e,t,s);return a.success&&P._updateMoney(e,a.actorsMoney.sum-a.money),!s&&a.msg!=""&&ChatMessage.create(g.chatDataSetup(`<p>${a.msg}</p>`,"roll")),a.success}static canPay(e,t,s){let a=this._getPaymoney(t),i={success:!1,msg:"",money:a};return a&&(i.actorsMoney=this._actorsMoney(e),i.actorsMoney.sum>=a?(i.msg=game.i18n.format("dsk.PAYMENT.pay",{actor:e.name,amount:P._moneyToString(a)}),i.success=!0):(i.msg=game.i18n.format("dsk.PAYMENT.cannotpay",{actor:e.name,amount:P._moneyToString(a)}),s&&ui.notifications.notify(i.msg))),i}static getMoney(e,t,s=!1){let a=this._getPaidmoney(t);if(a){let i=this._actorsMoney(e);P._updateMoney(e,i.sum+a);let r=`<p>${game.i18n.format("dsk.PAYMENT.getPaid",{actor:e.name,amount:P._moneyToString(a)})}</p>`;return s||ChatMessage.create(g.chatDataSetup(r,"roll")),!0}}static _updateMoney(e,t){let s=P._moneyToCoins(t);e.update({"system.money":s})}static createGetPaidChatMessage(e,t=void 0){let s=this._getPaidmoney(e);if(s){let a=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("dsk.PAYMENT.wage")}</b></p><p>${game.i18n.format("dsk.PAYMENT.getPaidSum",{amount:P._moneyToString(s)})}${a}</p><button class="payButton" data-pay="1" data-amount="${s}">${game.i18n.localize("dsk.PAYMENT.getPaidButton")}</button>`;ChatMessage.create(g.chatDataSetup(i,"roll"))}}static createPayChatMessage(e,t=void 0){let s=this._getPaymoney(e);if(s){let a=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("dsk.PAYMENT.bill")}</b></p>${game.i18n.format("dsk.PAYMENT.paySum",{amount:P._moneyToString(s)})}${a}</p><button class="payButton" data-pay="0" data-amount="${s}">${game.i18n.localize("dsk.PAYMENT.payButton")}</button>`;ChatMessage.create(g.chatDataSetup(i,"roll"))}}static _getPaidmoney(e){let t=this._parseMoneyString(e);if(!t){let s=`<p><b>${game.i18n.localize("dsk.PAYMENT.error")}</b></p><p><i>${game.i18n.localize("dsk.PAYMENT.getPaidexample")}</i></p>`;return ChatMessage.create(g.chatDataSetup(s,"roll")),!1}return t}static _getPaymoney(e){let t=this._parseMoneyString(e);if(!t){let s=`<p><b>${game.i18n.localize("dsk.PAYMENT.error")}</b></p><p><i>${game.i18n.localize("dsk.PAYMENT.payexample")}</i></p>`;return ChatMessage.create(g.chatDataSetup(s,"roll")),!1}return t}static _parseMoneyString(e){let t=e.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return t?Number(t[0]):!1}static _actorsMoney(e){return{sum:e.system.money}}static handlePayAction(e,t,s,a=void 0){if(game.user.isGM&&!a){ui.notifications.notify(game.i18n.localize("dsk.PAYMENT.onlyActors"));return}a?q.playMoneySound(!0):a=game.user.character;let i=!1;a&&t?i=P.payMoney(a,s):a&&!t?i=P.getMoney(a,s):ui.notifications.notify(game.i18n.localize("dsk.PAYMENT.onlyActors")),i&&e&&(e.fadeOut(),game.socket.emit("system.dsk",{type:"updateMsg",payload:{id:e.closest(".message").attr("data-message-id"),updateData:{[`flags.dsk.userHidden.${game.user.id}`]:!0}}}))}static _moneyToCoins(e){return e}static _moneyToString(e){return`<span class="nobr">${P._moneyToCoins(e)} <span data-tooltip="dsk.money" class="chatmoney" style="background-size:contain;background-image:url('systems/dsk/icons/categories/money.webp');"></span></span>`}static async chatListeners(e){e.on("click",".payButton",t=>{let s=$(t.currentTarget);P.handlePayAction(s,Number(s.attr("data-pay"))!=1,s.attr("data-amount")),q.playMoneySound()})}};m(P,"DSKPayment");var Le=m(o=>class extends o{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["merchant-sheet"])}),e}static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/merchant-sheet.html"}get template(){if(this.merchantSheetActivated())switch(getProperty(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsk/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsk/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsk/templates/actors/merchant/merchant-epic.html";default:return super.template}return this.constructor.merchantTemplate}merchantSheetActivated(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(getProperty(this.actor.system,"merchant.merchantType"))}async allowMerchant(e,t){let s=duplicate(this.actor.ownership),a=t?1:0;for(let i of e)s[i]=a;await this.actor.update({ownership:s},{diff:!1,recursive:!1,noHook:!0})}activateListeners(e){super.activateListeners(e),e.find(".allowMerchant").click(async t=>{let s=$(t.currentTarget).attr("data-user-id"),a=$(t.currentTarget).find("i");await this.allowMerchant([s],!a.hasClass("fa-check-circle")),a.toggleClass("fa-circle fa-check-circle")}),e.find(".toggleAllAllowMerchant").click(async t=>{let s=game.users.filter(i=>!i.isGM).map(i=>i.id),a=t.currentTarget.dataset.lock=="true";await this.allowMerchant(s,a),this.render()}),e.find(".lockTradeSection").click(t=>this.lockTradeSection(t)),e.find(".item-tradeLock").click(t=>this.toggleTradeLock(t)),e.find(".randomGoods").click(t=>this.randomGoods(t)),e.find(".clearInventory").click(t=>this.clearInventory(t)),e.find(".removeOtherTradeFriend").click(()=>this.removeOtherTradeFriend()),e.find(".choseTradefriend").click(()=>this.choseTradefriend()),e.find(".setCustomPrice").click(t=>$(t.currentTarget).addClass("edit")),e.find(".customPriceTag").change(async t=>this.setCustomPrice(t)).blur(t=>$(t.currentTarget).closest(".setCustomPrice").removeClass("edit")),e.find(".buy-item").click(t=>{this.advanceWrapper(t,"buyItem",t),q.playMoneySound()}),e.find(".sell-item").click(t=>{this.advanceWrapper(t,"sellItem",t),q.playMoneySound()}),e.find(".item-external-edit").click(t=>{t.preventDefault();let s=this._getItemId(t);this.getTradeFriend().items.get(s).sheet.render(!0)}),e.find(".changeAmountAllItems").mousedown(t=>this.changeAmountAllItems(t)),e.find(".gearSearch").prop("disabled",!1)}_canDragStart(e){return!this.merchantSheetActivated()&&this.isEditable}async toggleTradeLock(e){let t=this._getItemId(e),s=this.actor.items.get(t);this.actor.updateEmbeddedDocuments("Item",[{_id:s.id,"system.tradeLocked":!s.system.tradeLocked}])}async setCustomPrice(e){e.stopPropagation(),e.preventDefault();let t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"flags.dsk.customPriceTag":Number(e.target.value)}])}removeOtherTradeFriend(){this.otherTradeFriend=void 0,this.render(!0)}async choseTradefriend(){(await Re.getDialog(this)).render(!0)}async lockTradeSection(e){let t=[],s=this.filterRule(e),a;for(let i of this.actor.items)if(s(i)){let r=i.toObject();a===void 0&&(a=!r.system.tradeLocked),r.system.tradeLocked=a,t.push(r)}this.actor.updateEmbeddedDocuments("Item",t)}filterRule(e){let t=e.currentTarget.dataset.type;return v.equipmentTypes[t]?s=>s.type=="equipment"&&s.system.category==t:s=>s.type==t&&v.equipmentCategories.includes(s.type)}async changeAmountAllItems(e){let t=[],s=this.filterRule(e);for(let a of this.actor.items)if(s(a)){let i=a.toObject();_.increment(e,i,"system.quantity",0),t.push(i)}this.actor.updateEmbeddedDocuments("Item",t)}playerViewEnabled(){return getProperty(this.actor.system,"merchant.playerView")}async buyItem(e){await this.transferItem(this.actor,this.getTradeFriend(),e,!0)}async sellItem(e){await this.transferItem(this.getTradeFriend(),this.actor,e,!1)}async transferItem(e,t,s,a=!0){let i=this._getItemId(s),r=$(s.currentTarget).attr("data-price"),n=s.ctrlKey?10:1;game.user.isGM?await this.constructor.finishTransaction(e,t,r,i,a,n):(this.constructor.noNeedToPay(t,e,r)||P.canPay(t,r,!0))&&game.socket.emit("system.dsk",{type:"trade",payload:{target:this.constructor.transferTokenData(t),source:this.constructor.transferTokenData(e),price:r,itemId:i,buy:a,amount:n}})}static transferTokenData(e){let t={actor:e.id};return e.token&&(t.token=e.token.id),t}static async finishTransaction(e,t,s,a,i,r){let n=e.items.get(a).toObject();if(r=Math.min(Number(n.system.quantity),r),Number(n.system.quantity)>0){let l=this.noNeedToPay(t,e,s);(l||P.payMoney(t,s,!0))&&(getProperty(n,"system.worn.value")&&(n.system.worn.value=!1),i?(await this.updateTargetTransaction(t,n,r,e,s),await this.updateSourceTransaction(e,t,n,s,a,r),await this.transferNotification(n,t,e,i,s,r,l),await this.selfDestruction(e)):(await this.updateSourceTransaction(e,t,n,s,a,r),await this.updateTargetTransaction(t,n,r,e,s),await this.transferNotification(n,e,t,i,s,r,l)))}}static isTemporaryToken(e){return getProperty(e.system,"merchant.merchantType")=="loot"&&getProperty(e.system,"merchant.temporary")}static async selfDestruction(e){if(this.isTemporaryToken(e)&&!e.items.some(s=>v.equipmentCategories.includes(s.type)||s.type=="money"&&s.system.quantity>0)){game.socket.emit("system.dsk",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(e)}});let s=e.getActiveTokens().map(a=>a.id);await canvas.scene.deleteEmbeddedDocuments("Token",s),await game.actors.get(e.id).delete(),this.hideDeletedSheet(e)}}static async hideDeletedSheet(e){e.sheet.close(!0)}static async transferNotification(e,t,s,a,i,r,n){let l=game.settings.get("dsk","merchantNotification");if(l==0||getProperty(e,"system.category")=="service")return;let c="dsk.MERCHANT."+(a?"buy":"sell")+(n?"Loot":"")+"Notification",u=game.i18n.format(c,{item:e.name,source:t.name,target:s.name,amount:r,price:i,buy:a}),d=g.chatDataSetup(u);l==2&&(d.whisper=ChatMessage.getWhisperRecipients("GM").map(p=>p.id)),await ChatMessage.create(d)}static noNeedToPay(e,t,s){return s==0||getProperty(e.system,"merchant.merchantType")=="loot"||getProperty(t.system,"merchant.merchantType")=="loot"}static async updateSourceTransaction(e,t,s,a,i,r){let n=duplicate(s);Number(n.system.quantity)>r||n.type=="money"?(n.system.quantity=Number(n.system.quantity)-r,await e.updateEmbeddedDocuments("Item",[n])):await e.deleteEmbeddedDocuments("Item",[i]),this.noNeedToPay(e,t,a)||await P.getMoney(e,a,!0)}static async updateTargetTransaction(e,t,s,a,i){let r=duplicate(t);if(getProperty(r,"system.category")=="service"){let l=game.i18n.format("dsk.MERCHANT.buyNotification",{item:r.name,amount:s,source:e.name,target:a.name,price:i});ChatMessage.create(g.chatDataSetup(l))}else{let l=e.items.find(c=>C.areEquals(r,c));r.system.quantity=s,l?await C.stackItems(l,r,e):await e.createEmbeddedDocuments("Item",[r])}}getTradeFriend(){return this.otherTradeFriend||game.user.character}async _manageDragItems(e,t){switch(t){case"creature":case"npc":case"character":this.setTradeFriend(e);break;default:return super._manageDragItems(e,t)}}setTradeFriend(e){let t=game.actors.get(e._id);t.isOwner&&(this.otherTradeFriend=t,this.render(!0))}async _render(e=!1,t={}){if(!game.user.isGM&&getProperty(this.actor.system,"merchant.merchantType")=="loot"&&getProperty(this.actor.system,"merchant.locked")){AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1);return}await super._render(e,t)}_getHeaderButtons(){let e=super._getHeaderButtons();return this.actor.isOwner&&e.unshift({class:"playerview",icon:"fas fa-toggle-on",onclick:async t=>this._togglePlayerview(t)}),e}_togglePlayerview(e){this.actor.update({"system.merchant.playerView":!getProperty(this.actor.system,"merchant.playerView")})}async randomGoods(e){let t=await renderTemplate("systems/dsk/templates/dialog/randomGoods-dialog.html",{categories:v.equipmentCategories});new Dialog({title:game.i18n.localize("dsk.MERCHANT.randomGoods"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:s=>this.addRandomGoods(this.actor,s,e)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async clearInventory(e){new Dialog({title:game.i18n.localize("dsk.MERCHANT.clearInventory"),content:game.i18n.localize("dsk.MERCHANT.deleteAllGoods"),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{this.removeAllGoods(this.actor,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}async addRandomGoods(e,t,s){let a=$(s.currentTarget).text();$(s.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let i=[];t.find('input[type="checkbox"]:checked').each(function(){let c=$(this).val();i.push({name:c,count:Number(t.find(`input[name="each_${c}"]`).val()),number:Number(t.find(`input[name="number_${c}"]`).val())})});let r=game.dsk.itemLibrary;r.equipmentBuild||await r.buildEquipmentIndex();let n=[];for(let c of i){let u=(await r.getRandomItems(c.name,c.number)).map(d=>{let p=d.toObject();return p.system.quantity=c.count,p});n.push(...u)}let l={};n=n.filter(function(c){let u=getProperty(c,"system.effect");u=typeof u=="object"&&u!==null&&getProperty(u,"attributes")||"";let d=Number(getProperty(c,"system.price"))||0;if(u!=""||d>1e4)return!1;let p=`${c.type}_${c.name}`;return(l.hasOwnProperty(p)?!1:l[p]=!0)&&e.items.filter(function(f){return f.type==c.type&&f.name==c.name}).length==0}),await e.createEmbeddedDocuments("Item",n),$(s.currentTarget).text(a)}async removeAllGoods(e,t){let s=$(t.currentTarget).text();$(t.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let a=e.items.filter(i=>v.equipmentCategories.includes(i.type)&&!getProperty(i,"worn.value")).map(i=>i.id);await e.deleteEmbeddedDocuments("Item",a),$(t.currentTarget).text(s)}async getData(e){let t=await super.getData(e);return t.merchantType=getProperty(this.actor.system,"merchant.merchantType")||"none",t.merchantTypes={none:game.i18n.localize("dsk.MERCHANT.typeNone"),merchant:game.i18n.localize("dsk.MERCHANT.typeMerchant"),loot:game.i18n.localize("dsk.MERCHANT.typeLoot"),epic:game.i18n.localize("dsk.MERCHANT.typeEpic")},t.invName=t.merchantTypes[t.merchantType],t.players=game.users.filter(s=>!s.isGM).map(s=>(s.allowedMerchant=this.actor.testUserPermission(s,"LIMITED",!1),s.buyingFactor=getProperty(this.actor.system,`merchant.factors.buyingFactor.${s.id}`),s.sellingFactor=getProperty(this.actor.system,`merchant.factors.sellingFactor.${s.id}`),s)),t.merchantType!="epic"?(this.prepareStorage(t),this.merchantSheetActivated()&&(this.filterWornEquipment(t),this.prepareTradeFriend(t),t.prepare.inventory.misc.items.length==0&&(t.prepare.inventory.misc.show=!1))):this.prepareStorage(t),t.hasOtherTradeFriend=!!this.otherTradeFriend,t}filterWornEquipment(e){for(let[t,s]of Object.entries(e.prepare.inventory))s.items=s.items.filter(a=>!getProperty(a,"system.worn.value"))}prepareStorage(e){if(e.merchantType=="merchant")for(let[t,s]of Object.entries(e.prepare.inventory))for(let a of s.items)a.defaultPrice=this.getItemPrice(a),a.calculatedPrice=Number(parseFloat(`${a.defaultPrice*(getProperty(this.actor.system,"merchant.sellingFactor")||1)}`).toFixed(2))*(getProperty(this.actor.system,`merchant.factors.sellingFactor.${game.user.id}`)||1),a.priceTag=` / ${a.calculatedPrice}`;else if(e.merchantType=="loot")for(let[t,s]of Object.entries(e.prepare.inventory))for(let a of s.items)a.calculatedPrice=this.getItemPrice(a)}getItemPrice(e){return Number(getProperty(e,"flags.dsk.customPriceTag"))||Number(e.system.price)*(e.type=="consumable"?Number(e.system.QL)||0:1)}prepareTradeFriend(e){let t=this.getTradeFriend();if(t){let s=t.prepareItems({details:[]}),a=getProperty(this.actor.system,"merchant.merchantType")=="loot"?1:(getProperty(this.actor.system,"merchant.buyingFactor")||1)*(getProperty(this.actor.system,`merchant.factors.buyingFactor.${game.user.id}`)||1),i=this.prepareSellPrices(s.inventory,a);i.misc.items.length==0&&(i.misc.show=!1),mergeObject(e,{tradeFriend:{img:t.img,name:t.name,inventory:i,money:t.system.money}})}else mergeObject(e,{tradeFriend:{inventory:[],money:""}})}prepareSellPrices(e,t){for(let[s,a]of Object.entries(e))for(let i of a.items)i.calculatedPrice=Number(parseFloat(`${this.getItemPrice(i)*t}`).toFixed(2));return e}},"MerchantSheetMixin"),Re=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{}),e}static async getDialog(e){let t=await game.dsk.apps.gameMasterMenu?.getTrackedHeros();if(!t)return ui.notifications.warn("The required functionality is not yet available.");let s=new Re({title:game.i18n.localize("dsk.DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsk/templates/dialog/selectTradeFriend.html",{users:t}),default:"yes",buttons:{}});return s.actor=e,s}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){this.actor.setTradeFriend({_id:e.currentTarget.dataset.id}),this.close()}};m(Re,"SelectTradefriendDialog");var ce=class extends Le(re){};m(ce,"MerchantSheetDSK");function _s(){Hooks.once("ready",async()=>{game.socket.on("system.dsk",o=>{switch(o.type){case"hideDeletedSheet":let e=o.payload.target.token?game.actors.tokens[o.payload.target.token]:game.actors.get(o.payload.target.actor);ce.hideDeletedSheet(e);break}}),game.user.isGM&&game.socket.on("system.dsk",o=>{if(!!g.isActiveGM())switch(o.type){case"target":{let e=game.scenes.get(o.payload.scene);new Token(e.getEmbeddedDocument("Token",o.payload.target)).actor.update({"flags.oppose":o.payload.opposeFlag})}break;case"addEffect":_DSKActiveEffectConfig.applyEffect(o.payload.id,o.payload.mode,o.payload.actors);break;case"hideQueryButton":L.hideReactionButton(o.payload.id);break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(o.payload.speaker);break;case"updateMsg":game.messages.get(o.payload.id).update(o.payload.updateData);break;case"deleteMsg":game.messages.get(o.payload.id).delete();break;case"showDamage":L.showDamage(game.messages.get(o.payload.id),o.payload.hide);break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"trade":{let e=o.payload.source.token?game.actors.tokens[o.payload.source.token]:game.actors.get(o.payload.source.actor),t=o.payload.target.token?game.actors.tokens[o.payload.target.token]:game.actors.get(o.payload.target.actor);ce.finishTransaction(e,t,o.payload.price,o.payload.itemId,o.payload.buy,o.payload.amount)}break;case"playWhisperSound":o.payload.whisper.includes(game.user.id)&&AudioHelper.play({src:o.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(o.payload.id).then(e=>{new V(e).socketedConditionAddActor(o.payload.actors.map(s=>game.actors.get(s)),o.payload.data)});break;case"socketedConditionAdd":fromUuid(o.payload.id).then(e=>{new V(e).socketedConditionAdd(o.payload.targets,o.payload.data)});break;case"socketedRemoveCondition":fromUuid(o.payload.id).then(e=>{new V(e).socketedRemoveCondition(o.payload.targets,o.payload.coreId)});break;case"socketedActorTransformation":fromUuid(o.payload.id).then(e=>{new V(e).socketedActorTransformation(o.payload.targets,o.payload.update)});break;case"itemDrop":{let e=o.payload.sourceActorId?game.actors.get(o.payload.sourceActorId):void 0;fromUuid(o.payload.itemId).then(t=>{vs(e,t,o.payload.data,o.payload.amount)})}break;default:console.warn(`Unhandled socket data type ${o.type}`)}}),await ne.firstTimeMessage(),Se.showOneMessage(),g.moduleEnabled("vtta-tokenizer")&&!await game.settings.get("dsk","tokenizerSetup")&&game.user.isGM&&(await game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsk/icons/backgrounds/token_green.webp"),await game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsk/icons/backgrounds/token_black.webp"),await game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsk/icons/backgrounds/token_blue.webp"),await game.settings.set("dsk","tokenizerSetup",!0)),g.moduleEnabled("dice-so-nice")&&!await game.settings.get("dsk","diceSetup")&&game.user.isGM&&(await game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0),await game.settings.set("dsk","diceSetup",!0)),C.setupSubClasses(),he.connectHooks(),Ps(),X.registerTokenHotbar(),Cs(),Es()})}m(_s,"initReady");var Fe=class extends Application{constructor(e){super(e),this.adventures=[],this.books=[],this.rshs=[]}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsk","largeDialog","noscrollWizard","bookWizardsheet","dskjournalbrowser"]),width:800,height:880,template:"systems/dsk/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("dsk.Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),e}static initHook(){Fe.wizard=new Fe,game.dsk.apps.journalBrowser=Fe.wizard,Hooks.on("renderJournalDirectory",(e,t)=>{let s=$('<div class="header-actions action-buttons flexrow"></div>'),a=$(`<button id="openJournalBrowser"><i class="fa fa-book"></i>${game.i18n.localize("dsk.Book.Wizard")}</button>`);a.click(()=>{Fe.wizard.render(!0)}),s.append(a),t.find(".header-actions:first-child").after(s)})}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({label:"Library",class:"library",icon:"fas fa-book",onclick:async t=>this._showBooks()}),e}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".library").attr("data-tooltip",game.i18n.localize("dsk.Book.home"))}_showBooks(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!0,this.currentType=void 0,this.loadPage(this._element)}async toggleBookVisibility(e,t,s){let a=game.settings.get("dsk","expansionPermissions");a[e]=s,await game.settings.set("dsk","expansionPermissions",a);let i=this[t].find(l=>l.id==e),r=await(await fetch(i.path)).json(),n=["actors","journal","scenes"];for(let l of n){if(!r[l])continue;let c=game.packs.get(r[l]),u=s?"OBSERVER":"NONE",d={ownership:{PLAYER:u,TRUSTED:u}};await c.configure(d)}this.render()}activateListeners(e){super.activateListeners(e),e.on("click",".toggleVisibility",async t=>{let s=t.currentTarget.dataset.itemid,a=t.currentTarget.dataset.type,i=$(t.currentTarget).find("i").hasClass("fa-toggle-off");this.toggleBookVisibility(s,a,i)}),e.on("click",".showMapNote",t=>{game.journal.get(t.currentTarget.dataset.entryid).panToNote()}),e.on("search keyup",".filterJournals",t=>{this.filterToc($(t.currentTarget).val())}),e.on("click",".loadBook",t=>{this.selectedChapter=void 0,this.selectedType=void 0,this.content=void 0,this.loadBook($(t.currentTarget).text(),e,$(t.currentTarget).attr("data-type"))}),e.on("click",".getChapter",t=>{this.selectedType=$(t.currentTarget).closest(".toc").attr("data-type"),this.selectedChapter=$(t.currentTarget).attr("data-id"),this.content=void 0,this.loadPage(e)}),e.on("click",".subChapter",t=>{let s=$(t.currentTarget).text(),a=$(t.currentTarget).attr("data-jid");a?this.loadJournalById(a):($(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-id="${s}"]`).addClass("selected"),this.loadJournal(s))}),B.bindRollCommands(e),e.find(".tocCollapser").click(t=>{$(t.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),e.find(".tocCollapsing").toggleClass("expanded")}),e.on("mousedown",".openPin",async t=>{let s=t.currentTarget.dataset.uuid;t.button==0?this.showJournal(await fromUuid(s)):t.button==2&&this.unpinJournal(s)}),e.on("click",".showJournal",t=>{this.popJournal($(t.currentTarget).closest("h1").attr("data-uuid"))}),e.on("click",".pinJournal",t=>{let s=$(t.currentTarget).closest("h1"),a=s.attr("data-uuid"),i=s.text();this.pinJournal(a,i)}),e.on("click",".activateScene",t=>{this.showSzene($(t.currentTarget).attr("data-id"),$(t.currentTarget).attr("data-mode"))}),e.on("click",".fulltextsearch",t=>{this.fulltextsearch=!this.fulltextsearch,$(t.currentTarget).toggleClass("on"),this.filterToc(e.find(".filterJournals").val())}),e.on("mousedown",".chapter img",t=>{let s=this.book.id;t.button==2&&game.dsk.apps.DSKUtility.showArtwork({name:s,uuid:"",img:$(t.currentTarget).attr("src")})}),O.bindButtons(e),e.on("click",".importBook",async()=>this.importBook()),ve(e),As(e,".breadcrumbs",this.resaveBreadCrumbs),this.heightFix()}heightFix(){let e=$(this._element).find(".breadcrumbs").height();$(this._element).find(".col.seventy.scrollable").css({"margin-bottom":`${e}px`})}async loadJournal(e){await this.showJournal(this.journals.find(t=>t.name==e&&t.flags.dsk.parent==this.selectedChapter))}async loadJournalById(e){await this.showJournal(this.journals.find(t=>t.id==e))}async resaveBreadCrumbs(e){let t={};for(let s of e.getElementsByTagName("div"))t[s.dataset.uuid]=s.innerText;await game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(t))}async filterToc(e){if(e!=null){e=e.toLowerCase().trim();let t;if(e!=""){let s=[];this.fulltextsearch?(this.journalIndex||(this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),await this.journalIndex.add(this.journals.map(a=>new cs(a)))),s=await this.journalIndex.search(e)):s=this.journals.filter(a=>a.name.toLowerCase().trim().indexOf(e)!=-1),s=s.map(a=>`<li class="fas fa-caret-right"><a data-jid="${a.id}" class="subChapter">${a.name}</a></li>`),$(this._element).find(".tocContent").html(`<ul>${s.join(`
`)}</ul>`)}else t=await this.getToc(),$(this._element).find(".adventureWizard > .row-section > .toc").html(t).find(".filterJournals").focus()}}async showJournal(e){let t="";for(let r of e.pages){let n=r.sheet,l=await n.getData(),c=(await n._renderInner(l)).get(),u=$(c[c.length-1]).html();r.type=="video"&&(u=`<div class="video-container">${u}</div>`),t+=u}let s=this.findSceneNote(e.getFlag("dsk","initId")),a=await TextEditor.enrichHTML(t,{secrets:game.user.isGM,async:!0});this.content=`<div><h1 class="journalHeader" data-uuid="${e.uuid}">${e.name}<div class="jrnIcons">${s}<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>${a}`;let i=$(this._element).find(".chapter");i.html(this.content),ve(i),i.find(".documentName-link, .entity-link, .content-link").click(r=>{let n=$(r.currentTarget);this.bookData&&n.attr("data-pack")==this.bookData.journal&&(r.stopPropagation(),this.loadJournalById(n.attr("data-id")))})}findSceneNote(e){if(e){let t=game.journal.find(s=>s.getFlag("dsk","initId")==e);if(t&&t.sceneNote)return`<a class="showMapNote" data-entryId="${t.id}"><i class="fas fa-map-pin"></i></a>`}return""}async importBook(){game.user.isGM&&new ls().render(this.bookData.moduleName)}async loadBook(e,t,s){s||(s=this.currentType),this.currentType=s,this.book=this[s].find(a=>a.id==e),await fetch(this.book.path).then(async a=>a.json()).then(async a=>{this.bookData=a;let i=game.packs.get(a.journal),r=await i.getIndex(),n=await i.getDocuments();this.journals=n,a.actors&&(i=game.packs.get(a.actors),n=await i.getIndex(),this.actors=n),a.scenes&&(i=game.packs.get(a.scenes),n=await i.getIndex(),this.scenes=n),this.loadPage(t)})}async prefillActors(e){if(!e.actors)return[];let t=[],s=await game.folders.contents.find(i=>i.name==game.i18n.localize(`${this.bookData.moduleName}.name`)&&i.type=="Actor"&&i.folder==null),a=s?await game.folders.contents.filter(i=>i.type=="Actor"&&i.folder?.id==s.id).map(i=>i.id):void 0;for(let i of e.actors){let r=a?.length?game.actors.contents.find(u=>u.name==i&&a.includes(u.folder?.id)):void 0,n,l=r?.id,c=r?.uuid;r||(r=this.actors.find(u=>u.name==i),n=this.bookData.actors,l=r?._id,c=r?`Compendium.${n}.${l}`:void 0),t.push({name:i,actor:r,pack:n,id:l,uuid:c})}return t}async popJournal(e){(await fromUuid(e)).sheet.render(!0)}async showSzene(e,t="activate"){let s=game.scenes.contents.find(a=>a.name==e);if(!s)return ui.notifications.error(game.i18n.localize("dsk.DSKError.sceneNotInitialized"));switch(t){case"activate":s.activate();break;case"view":s.view();break;case"toggle":s.update({navigation:!s.navigation});break}}async getChapter(){if(this.book){if(this.content)return this.content;if(this.selectedChapter){if(this.selectedChapter=="prep"){let s={initDescr:game.i18n.format(`${this.bookData.moduleName}.importContent`,{defaultText:game.i18n.localize("dsk.importDefault")})},a=this.bookData.modules;for(let i of a)i.enabled=this.moduleEnabled(i.id);return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_preparation.html",{modules:a,info:s})}else if(this.selectedChapter=="foundryUsage")return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_foundry.html");let e=this.bookData.chapters.find(s=>s.name==this.selectedType).content.find(s=>s.id==this.selectedChapter),t=this.getSubChapters();return e.scenes||e.actors||t.length==0?await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_chapter.html",{chapter:e,subChapters:this.getSubChapters(),actors:await this.prefillActors(e)}):await this.loadJournal(t[0].name)}return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData})}else return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),isGM:game.user.isGM})}filterBooks(e){let t=game.settings.get("dsk","expansionPermissions");for(let s of e)t[s.id]!=null&&(s.visible=t[s.id]);return game.user.isGM?e:e.filter(s=>s.visible==null||s.visible).sort((s,a)=>s.id.localeCompare(a.id))}getSubChapters(){return this.journals.filter(e=>e.flags.dsk.parent==this.selectedChapter).sort((e,t)=>e.flags.dsk.sort>t.flags.dsk.sort?1:-1).map(e=>({name:e.name,id:e.id}))}async getToc(){let e=[];if(this.book){if(e.push(...duplicate(this.bookData.chapters)),this.selectedChapter){let t;for(let s of e)if(t=s.content.find(a=>a.id==this.selectedChapter),t)break;t.cssClass="selected",t.subChapters=this.getSubChapters()}return await renderTemplate("systems/dsk/templates/wizard/adventure/adventure_toc.html",{chapters:e,book:this.book,fulltextsearch:this.fulltextsearch?"on":""})}else return'<div class="libraryImg"></div>'}async loadPage(e){let t=await this.getChapter(),s=await this.getToc();e.find(".toc").html(s),e.find(".chapter").html(t)}async getData(e){let t=await super.getData(e),s=await this.getChapter(),a=await this.getToc();return mergeObject(t,{adventure:this.bookData,currentChapter:s,breadcrumbs:this.renderBreadcrumbs(),toc:a}),t}async pinJournal(e,t=void 0){let s=this.readBreadCrumbs();t||(t=(await fromUuid(e))?.name||""),s[e]=t,game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(s)),this.render(!0)}unpinJournal(e){let t=this.readBreadCrumbs();delete t[e],game.settings.set("dsk",`breadcrumbs_${game.world.id}`,JSON.stringify(t)),this.render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain"))}catch{return!1}t.type=="JournalEntry"&&this.pinJournal(t.pack?`Compendium.${t.pack}.${t.id}`:`JournalEntry.${t.id}`)}readBreadCrumbs(){let e={};try{e=JSON.parse(game.settings.get("dsk",`breadcrumbs_${game.world.id}`))}catch{console.log("No Journalbrowser notes found")}return e}renderBreadcrumbs(){let e=this.readBreadCrumbs(),t=Object.entries(e).map(s=>`<div data-tooltip="${s[1]}" data-uuid="${s[0]}" class="openPin item">${s[1]}</div>`);return t.length>0?`<div id="breadcrumbs" class="breadcrumbs wrap row-section">${t.join("")}</div>`:""}moduleEnabled(e){return g.moduleEnabled(e)}},Me=Fe;m(Me,"BookWizard"),z(Me,"wizard");var ls=class extends FormApplication{render(e){new game.dsk.apps.DSKInitializer("DSK Module Initialization",game.i18n.format(`${e}.importContent`,{defaultText:game.i18n.localize("dsk.importDefault")}),e,game.i18n.lang).render(!0)}};m(ls,"InitializerForm");var cs=class{constructor(e){let t=e.pages.find(s=>!0).text.content;this.document={name:e.name,data:$("<div>").html(t).text(),id:e.id}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}};m(cs,"JournalSearch");function Rs(){game.settings.register("dsk","migrationVersion",{name:"migrationVersion",scope:"world",config:!1,default:24,type:Number}),game.settings.register("dsk","firstTimeStart",{name:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","informationDistribution",{name:"dsk.SETTINGS.informationDistribution",hint:"dsk.SETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.SETTINGS.information0"),1:game.i18n.localize("dsk.SETTINGS.information1"),2:game.i18n.localize("dsk.SETTINGS.information2")}}),game.settings.register("dsk","defaultConfigFinished",{name:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","limitCombatSpecAbs",{name:"dsk.SETTINGS.limitCombatSpecAbs",hint:"dsk.SETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","merchantNotification",{name:"dsk.SETTINGS.merchantNotification",hint:"dsk.SETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.no"),1:game.i18n.localize("dsk.yes"),2:game.i18n.localize("dsk.MERCHANT.onlyGM")}}),game.settings.register("dsk","expandChatModifierlist",{name:"dsk.SETTINGS.expandChatModifierlist",hint:"dsk.SETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","enableCombatFlow",{name:"dsk.SETTINGS.enableCombatFlow",hint:"dsk.SETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:o=>{game.dsk.apps.initTracker&&(game.dsk.apps.initTracker.close(),game.dsk.apps.initTracker=void 0)}}),game.settings.register("dsk","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","inventorySound",{name:"dsk.SETTINGS.inventorySound",hint:"dsk.SETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","scrollingFontsize",{name:"dsk.SETTINGS.scrollingFontsize",hint:"dsk.SETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsk","statusEffectCounterColor",{name:"dsk.SETTINGS.statusEffectCounterColor",hint:"dsk.SETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsk","playerCanEditSpellMacro",{name:"dsk.SETTINGS.playerCanEditSpellMacro",hint:"dsk.SETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsk",`breadcrumbs_${game.world.id}`,{name:"dsk.SETTINGS.breadcrumbs",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsk","soundConfig",{name:"dsk.SETTINGS.soundConfig",hint:"dsk.SETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:async()=>{q.loadSoundConfig()}}),game.settings.register("dsk","allowPhysicalDice",{name:"dsk.SETTINGS.allowPhysicalDice",hint:"dsk.SETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","enableItemDropToCanvas",{name:"dsk.SETTINGS.enableItemDropToCanvas",hint:"dsk.SETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","hideEffects",{name:"dsk.SETTINGS.hideEffects",hint:"dsk.SETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","hideOpposedDamage",{name:"dsk.SETTINGS.hideOpposedDamage",hint:"dsk.SETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","indexDescription",{name:"dsk.SETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsk","enableDPS",{name:"dsk.SETTINGS.enableDPS",hint:"dsk.SETTINGS.enableDPSHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","indexWorldItems",{name:"dsk.SETTINGS.indexWorldItems",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsk","tokenizerSetup",{name:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsk","forceLanguage",{name:"dsk.SETTINGS.forceLanguage",hint:"dsk.SETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German"}}),game.settings.register("dsk","enableCombatPan",{name:"dsk.SETTINGS.enableCombatPan",hint:"dsk.SETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsk","iniTrackerSize",{name:"dsk.SETTINGS.iniTrackerSize",hint:"dsk.SETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:async o=>{game.dsk.apps.tokenHotbar.constructor.defaultOptions.itemWidth=o}}),game.settings.register("dsk","iniTrackerPosition",{name:"iniTrackerPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsk","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.registerMenu("dsk","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("dsk.SETTINGS.changelog"),type:ds,restricted:!1}),game.settings.register("dsk","disableDidYouKnow",{name:"dsk.SETTINGS.disableDidYouKnow",hint:"dsk.SETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsk","tokenhotbarSize",{name:"dsk.SETTINGS.tokenhotbarSize",hint:"dsk.SETTINGS.tokenhotbarSizeHint",scope:"client",config:!0,default:35,type:Number,range:{min:15,max:100,step:5},onChange:async o=>{game.dsk.apps.tokenHotbar.constructor.defaultOptions.itemWidth=o}}),game.settings.register("dsk","obfuscateTokenNames",{name:"dsk.SETTINGS.obfuscateTokenNames",hint:"dsk.SETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("dsk.no"),1:game.i18n.localize("dsk.SETTINGS.yesNumbered"),2:game.i18n.localize("dsk.SETTINGS.renameNumbered"),3:game.i18n.localize("dsk.yes"),4:game.i18n.localize("dsk.SETTINGS.rename")}}),game.settings.register("dsk","tokenhotbarLayout",{name:"dsk.SETTINGS.tokenhotbarLayout",hint:"dsk.SETTINGS.tokenhotbarLayoutHint",scope:"client",config:!0,default:0,type:Number,choices:{0:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("dsk.SETTINGS.tokenhotbarLayout3")}})}m(Rs,"setupConfiguration");var ds=class extends FormApplication{render(){Je()}};m(ds,"ChangelogForm");var Ts=class extends FormApplication{async render(){await game.settings.set("dsk","tokenhotbarPosition",{}),await game.settings.set("dsk","tokenhotbarLayout",0),await game.settings.set("dsk","tokenhotbarSize",35),game.dsk.apps.tokenHotbar.resetPosition(),game.dsk.apps.tokenHotbar.render(!0)}};m(Ts,"ResetTokenbar");function Fs(){game.keybindings.register("dsk","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:()=>Ls("nextTurn")}),game.keybindings.register("dsk","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:()=>Ls("previousTurn")}),game.keybindings.register("dsk","attacktest",{name:"attacktest",hint:game.i18n.localize("dsk.KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:()=>te.runActAttackDialog()}),game.keybindings.register("dsk","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("dsk.KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:()=>g.renderToggle(game.dsk.apps.journalBrowser)}),game.keybindings.register("dsk","library",{name:"ItemLibrary",hint:game.i18n.localize("dsk.KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:()=>g.renderToggle(game.dsk.itemLibrary)})}m(Fs,"setupKeybindings");var Ls=m(o=>{game.combat?.combatant?.isOwner&&game.combat[o]()},"combatTurn");function Hs(){Hooks.on("preCreateScene",function(o,e,t,s){e.grid?.units||o.updateSource({grid:{units:game.i18n.localize("dsk.gridUnits")}}),!t.dskInit&&e.notes?.some(a=>getProperty(a,"flags.dsk.initName"))&&ui.notifications.warn(game.i18n.localize("dsk.DSKError.mapsViaJournalbrowser"))}),Hooks.on("preCreateActiveEffect",function(o,e,t,s){if(o.parent.documentName!="Actor")return;let a={duration:{}};if(o.duration.startTime||(a.duration.startTime=game.time.worldTime),!game.combat){o.updateSource(a);return}a.duration.combat=game.combat.id,a.duration.startRound=game.combat.round,a.duration.startTurn=game.combat.turn,!o.duration.rounds&&o.duration.seconds&&(a.duration.rounds=o.duration.seconds/5),o.updateSource(a)})}m(Hs,"setupScene");function js(){Hooks.once("setup",()=>{if(Rs(),!["de"].includes(game.i18n.lang))console.warn(`DSK - ${game.i18n.lang} is not a supported language. Falling back to default language.`),da();else{let o=game.settings.get("dsk","forceLanguage");["de"].includes(o)&&game.i18n.lang!=o&&ca(o)}Fs(),Hs(),Me.initHook(),CONFIG.Canvas.lightAnimations.daylight={label:"dsk.LIGHT.daylight",illuminationShader:at},E.setupFunctions(),x.setupFunctions()})}m(js,"initSetup");var ca=m(o=>{let e={title:game.i18n.localize("dsk.SETTINGS.forceLanguage"),content:game.i18n.format("dsk.DSKError.wrongLanguage",{lang:o}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.ok"),callback:async()=>{await game.settings.set("core","language",o),foundry.utils.debouncedReload()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}};new Dialog(e).render(!0)},"showWrongLanguageDialog"),ms=class extends Dialog{async close(e={}){if(!!["de"].includes(game.i18n.lang))return super.close(e)}};m(ms,"ForbiddenLanguageDialog");var da=m(()=>{let o={title:game.i18n.localize("language"),content:"Your foundry language is not supported by this system. Due to technical reasons your foundry language setting has to be switched to german.",buttons:{de:{icon:'<i class="fa fa-check"></i>',label:"en",callback:async()=>{await game.settings.set("core","language","de"),foundry.utils.debouncedReload()}},logout:{icon:'<i class="fas fa-door-closed"></i>',label:game.i18n.localize("SETTINGS.Logout"),callback:async()=>{ui.menu.items.logout.onClick()}}}};new ms(o).render(!0)},"showForbiddenLanguageDialog"),He=class extends AdaptiveIlluminationShader{},at=He;m(at,"DaylightIlluminationShader"),z(at,"fragmentShader",`
    ${He.SHADER_HEADER}
    ${He.PERCEIVED_BRIGHTNESS}

    void main() {
        ${He.FRAGMENT_BEGIN}
        ${He.TRANSITION}
       
        // Darkness
        framebufferColor = max(framebufferColor, colorBackground);        
        // Elevation
        finalColor = mix(finalColor, max(finalColor, smoothstep( 0.1, 1.0, finalColor ) * 10.0), 1.0) * depth;        
        // Final
        gl_FragColor = vec4(finalColor, 1.0);
      }`);function Bs(){Hooks.on("renderSettings",(o,e,t)=>{let s=$(`<button id="reportADSKBug"><i class="fas fa-bug"></i> ${game.i18n.localize("dsk.DSKError.reportBug")}</button>`);s.click(()=>{window.open("https://github.com/Plushtoast/dsk-foundryVTT/issues","_blank")}),e.find("#settings-documentation").append(s),s=$('<button class="fshopButton"><div></div> F-Shop</button>'),s.click(()=>{window.open(game.i18n.localize("dsk.fshopLink"),"_blank")}),e.find("#settings-documentation").append(s);let a=game.system.title.split("/")[game.i18n.lang=="de"?0:1],i=e.find("#game-details .system .system-info").html();e.find("#game-details .system").html(`<span class="system-title">${a}</span><span class="system-info">${i}</span>`)}),Hooks.on("renderCompendiumDirectory",(o,e,t)=>{let s=$(`<button id="openLibrary"><i class="fas fa-university"></i>${game.i18n.localize("dsk.ItemLibrary")}</button>`);e.find(".header-actions").append(s),s.click(()=>{game.dsk.itemLibrary.render(!0)})}),Hooks.once("renderCompendiumDirectory",(o,e,t)=>{let s=game.i18n.lang=="de"?"en":"de",a=game.packs.filter(i=>getProperty(i.metadata,"flags.dsklang")==s);for(let i of a){let r=`${i.metadata.packageName}.${i.metadata.name}`;game.packs.delete(r),game.data.packs=game.data.packs.filter(n=>n.id!=r),e.find(`li[data-pack="${r}"]`).remove()}}),Hooks.on("renderActorDirectory",(o,e,t)=>{if(!game.user.isGM)for(let s of o.documents.filter(a=>a.isMerchant()&&getProperty(a,"system.merchant.hidePlayer")))e.find(`[data-document-id="${s.id}"]`).remove()})}m(Bs,"initSidebar");function Gs(){Hooks.on("deleteActiveEffect",(i,r)=>{if(!g.isActiveGM()||r.noHook)return;let n=i.parent;if(n&&n.documentName=="Actor"){let l=[...i.statuses][0];if(l=="bloodrush")return n.addCondition("stunned",4,!1,!1),!1;if(l=="dead"&&game.combat)return n.markDead(!1),!1;if(_DSKActiveEffectConfig.onEffectRemove(n,i),Hooks.call("deleteActorActiveEffect",n,i)===!1)return!1}}),Hooks.on("updateActor",(i,r)=>{!game.user.isGM&&i.limited&&hasProperty(r,"system.merchant.hidePlayer")&&ui.sidebar.render(!0)}),Hooks.on("dropActorSheetData",(i,r,n)=>{switch(n.data?.type){case"condition":return i.addCondition(n.data.payload.id,1,!1,!1),!1;case"lookup":return r._handleLookup(n.data),!1;case"fullpack":return r._addFullPack(n.data),!1}}),Hooks.on("createActiveEffect",(i,r,n)=>{!g.isActiveGM()||(o(i),e(i))}),Hooks.on("deleteActiveEffect",(i,r,n)=>{!g.isActiveGM()||o(i)}),Hooks.on("updateActiveEffect",(i,r,n)=>{!g.isActiveGM()||(o(i),t(i))});function o(i){if(!!game.user.isGM&&game.combat&&i.changes.some(r=>/(system\.stats\.ini|system\.characteristics.mu|system\.characteristics\.ge)/.test(r.key))){let r=i.parent.id,n=game.combat.combatants.find(l=>l.actor.id==r);n&&n.recalcInitiative()}}m(o,"checkIniChange");let e=m(async i=>{let r=i.parent;if(!r)return;await t(i,{},r);let n=[...i.statuses][0];n=="dead"&&game.combat?await r.markDead(!0):n=="unconscious"&&await r.addCondition("prone")},"createEffects"),t=m(async(i,r={},n)=>{if(n||(n=i.parent),!n||n.documentName!="Actor")return;let l=/^system\.condition\./;for(let c of i.changes||[])l.test(c.key)&&c.mode==2&&(r[c.key.split(".")[2]]=Number(c.value));for(let c of Object.keys(r))if(n.system.condition[c]>=8&&(c=="inpain"?await n.addCondition("incapacitated"):c=="stunned"?await n.addCondition("unconscious"):c=="feared"?await n.addCondition("panic"):c=="encumbered"&&await n.addCondition("fixated")),(Number(r.inpain)||0)>0&&!n.hasCondition("bloodrush")&&n.system.condition.inpain>0&&E.hasVantage(n,game.i18n.localize("dsk.LocalizedIDs.frenzy"))){await n.addCondition("bloodrush");let u=g.replaceConditions(`${game.i18n.format("dsk.CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+n.name+"</b>"})}`);ChatMessage.create(g.chatDataSetup(u))}},"countableDependentEffects"),s=m(async(i,r)=>{(game.dsk.apps.AskForNameDialog||us).getDialog(i,r)},"askForName"),a=m(async(i,r)=>{if(!g.isActiveGM())return;let n=i.actor;if(n.hasPlayerOwner)return;let l=Number(game.settings.get("dsk","obfuscateTokenNames"));if(l==0||getProperty(n,"merchant.merchantType")=="loot")return;let c=canvas.scene.tokens.filter(d=>d.actor&&d.actor.id===n.id),u=game.i18n.localize("dsk.unknown");if([2,4].includes(l)){if(!(i.id||i._id))return;s(i,l);return}c.length>0&&l<3&&(u=`${c[0].name.replace(/ \d{1,}$/)} ${c.length+1}`),r.name=u},"obfuscateName");Hooks.on("preCreateToken",(i,r,n,l)=>{let c=i.actor;if(!c)return;let u={};getProperty(c,"system.merchant.merchantType")=="loot"?mergeObject(u,{displayBars:0}):getProperty(c,"system.config.autoBar")&&(mergeObject(u,{bar1:{attribute:"stats.LeP"}}),c.system.isMage?mergeObject(u,{bar2:{attribute:"stats.AeP"}}):mergeObject(u,{bar2:{attribute:"tbd"}})),getProperty(c,"system.config.autoSize")&&g.calcTokenSize(c,u),a(i,u),i.updateSource(u)}),Hooks.on("createToken",(i,r,n)=>{r.noHook||a(i,{})})}m(Gs,"initActorHooks");var us=class extends Dialog{static async getDialog(e,t){new Dialog({title:game.i18n.localize("dsk.SETTINGS.obfuscateTokenNames"),content:`<label for="name">${game.i18n.localize("dsk.SETTINGS.rename")}</label> <input dtype="string" name="name" type="text" value="${e.actor.name}"/>`,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:async s=>{let a=e.id||e._id,i=s.find('[name="name"]').val();if(t==2){let n=canvas.scene.tokens.filter(l=>l.name===i);n.length>0&&(i=`${i.replace(/ \d{1,}$/)} ${n.length+1}`)}await canvas.scene.tokens.get(a).update({name:i})}},unknown:{icon:'<i class="fa fa-question"></i>',label:game.i18n.localize("dsk.unknown"),callback:async s=>{let a=e.id||e._id;await canvas.scene.tokens.get(a).update({name:game.i18n.localize("dsk.unknown")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel")}}}).render(!0)}};m(us,"AskForNameDialog");function Ws(){Hooks.once("init",()=>{game.dsk.apps.DiceSoNiceCustomization=new de}),Hooks.once("diceSoNiceReady",(o,e,t,s)=>{o.addColorset({name:"mu",description:"DSK.mu",category:"DSK.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"kl",description:"DSK.kl",category:"DSK.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"in",description:"DSK.in",category:"DSK.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ch",description:"DSK.ch",category:"DSK.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ff",description:"DSK.ff",category:"DSK.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ge",description:"DSK.ge",category:"DSK.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"ko",description:"DSK.ko",category:"DSK.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"kk",description:"DSK.kk",category:"DSK.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),o.addColorset({name:"attack",description:"DSK.attack",category:"DSK.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),game.dsk.apps.DiceSoNiceCustomization.initConfigs(),de.onConnect()})}m(Ws,"initDSN");var ye=class extends Application{initConfigs(){let e=game.dice3d.exports.Utils.prepareColorsetList();this.choices={};for(let[s,a]of Object.entries(e))mergeObject(this.choices,a);let t={damage:"black"};game.settings.registerMenu("dsk","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("dsk.SETTINGS.dicesonicesettings"),type:ps,restricted:!1});for(let s of ye.attrs)game.settings.register("dsk",`dice3d_${s}`,{name:`CHAR.${s.toUpperCase()}`,scope:"client",config:!1,default:t[s]||s,type:String}),game.settings.register("dsk",`dice3d_system_${s}`,{name:`CHAR.${s.toUpperCase()}`,scope:"client",config:!1,default:"standard",type:String})}getAttributeConfiguration(e){return g.moduleEnabled("dice-so-nice")?{colorset:game.settings.get("dsk",`dice3d_${e}`),appearance:{colorset:game.settings.get("dsk",`dice3d_${e}`),system:game.settings.get("dsk",`dice3d_system_${e}`)}}:{colorset:e}}activateListeners(e){super.activateListeners(),e.find('[name="entryselection"]').change(async t=>{await game.settings.set("dsk",`dice3d_${t.currentTarget.dataset.attr}`,t.currentTarget.value)}),e.find('[name="systemselection"]').change(async t=>{await game.settings.set("dsk",`dice3d_system_${t.currentTarget.dataset.attr}`,t.currentTarget.value),ye.preloadDiceAssets([t.currentTarget.value]),game.socket.emit("system.dsk",{type:"preloadDice3d",payload:{toPreload:[t.currentTarget.value]}})})}static onConnect(){game.socket.on("system.dsk",e=>{switch(e.type){case"preloadDice3d":console.warn("Preloading forced DSK dice assets"),ye.preloadDiceAssets(e.payload);break;case"getPreloadDice3d":ye.requestDicePreloads();break}}),this.collectPreloads(),game.socket.emit("system.dsk",{type:"getPreloadDice3d"})}static collectPreloads(e=!0){let t=new Set;for(let s of ye.attrs)t.add(game.settings.get("dsk",`dice3d_system_${s}`));t=Array.from(t),e&&this.preloadDiceAssets(t),game.socket.emit("system.dsk",{type:"preloadDice3d",payload:t})}static requestDicePreloads(){this.collectPreloads(!1)}static async preloadDiceAssets(e,t=[]){console.warn("loading",e);for(let s of e){let a=game.dice3d.DiceFactory.systems[s];if(!a){this.unloadedModels.push(s);continue}let i=a.dice.filter(r=>t.length==0||t.includes(r.type));for(let r of i)try{r.modelFile?await r.loadModel(game.dice3d.DiceFactory.loaderGLTF):await r.loadTextures()}catch{console.warn("Unable to load dice model",s,r)}}this.unloadedModels.length&&this.retries<6&&!this.retrying&&(this.retrying=!0,setTimeout(()=>{this.retries+=1;let s=new Set(this.unloadedModels);this.unloadedModels=[],this.retrying=!1,this.preloadDiceAssets(s)},1e4))}async getData(e){let t=await super.getData(e);t.choices=this.choices,t.systems=game.dice3d.DiceFactory.systems,t.selections={};for(let s of ye.attrs)t.selections[s]={color:game.settings.get("dsk",`dice3d_${s}`),system:game.settings.get("dsk",`dice3d_system_${s}`)};return t}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{template:"systems/dsk/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("dsk.SETTINGS.dicesonicesettings"),width:600}),e}},de=ye;m(de,"DiceSoNiceCustomization"),z(de,"unloadedModels",[]),z(de,"retries",0),z(de,"retrying",!1),z(de,"attrs",["mu","kl","in","ch","ff","ge","ko","kk","attack","damage"]);var ps=class extends FormApplication{render(){game.dsk.apps.DiceSoNiceCustomization.render(!0)}};m(ps,"DiceSoNiceForm");function Ks(){Hooks.on("renderChatLog",(o,e,t)=>{_DiceDSK.chatListeners(e),P.chatListeners(e);let s=new B;Hooks.call("startDSKChatAutoCompletion",s),s.chatListeners(e),F.chatListeners(e)}),Hooks.on("renderChatMessage",(o,e,t)=>{if(game.user.isGM)e.find(".chat-button-player").remove();else{e.find(".chat-button-gm").remove();let s,a=e.find(".chat-button-target");a.length&&(s=ge.getTargetActor(t.message),s&&s.actor&&!s.actor.isOwner&&a.remove());let i=g.getSpeaker(t.message.speaker);i&&!i.isOwner&&(e.find(".selfButton").remove(),e.find(".d20").data("tooltip",""));let r=e.find(".onlyTarget");r.length&&(s=g.getSpeaker({token:r.attr("data-token"),actor:r.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}),s&&!s.isOwner&&r.remove()),e.find(".hideData").remove(),getProperty(t.message,`flags.dsk.userHidden.${game.user.id}`)&&e.find(".payButton").remove()}game.settings.get("dsk","expandChatModifierlist")&&(e.find(".expand-mods i").toggleClass("fa-minus fa-plus"),e.find(".expand-mods + ul").css({display:"block"})),O.bindButtons(e)}),Hooks.on("chatMessage",(o,e,t)=>{let s=e.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(s=s?s[0]:"",s){case"/pay":return game.user.isGM?P.createPayChatMessage(e):P.payMoney(g.getSpeaker(t.speaker),e),!1;case"/getPaid":return game.user.isGM?P.createGetPaidChatMessage(e):P.getMoney(g.getSpeaker(t.speaker),e),!1;case"/help":return F.getHelp(),!1;case"/conditions":return F.showConditions(),!1;case"/tables":return F.showTables(),!1}})}m(Ks,"initChatlogHooks");function Us(){Token.prototype.drawEffects=async function(){this.effects.removeChildren().forEach(i=>i.destroy()),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.overlay=null;let t=this.document.effects,s=this.actor?await this.actor.actorEffects():[],a={src:this.document.overlayEffect,tint:null};if(t.length||s.length){let i=[];for(let r of s){if(!r.icon)continue;let n=Color.from(r.tint??null);if(r.getFlag("core","overlay")){a={src:r.icon,tint:n};continue}i.push(this._drawEffect(r.icon,n,getProperty(r,"flags.dsk.value")))}for(let r of t)i.push(this._drawEffect(r,null));await Promise.all(i)}this.effects.overlay=await this._drawOverlay(a.src,a.tint),this._refreshEffects()},Token.prototype._refreshEffects=function(){let t=0,s=Math.round(canvas.dimensions.size/2/5)*2,a=Math.floor(this.document.height*5),i=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0);for(let r of this.effects.children)if(r!==i&&!r.isCounter)if(r===this.effects.overlay){let n=Math.min(this.w*.6,this.h*.6);r.width=r.height=n,r.position.set((this.w-n)/2,(this.h-n)/2)}else{if(r.width=r.height=s,r.x=Math.floor(t/a)*s,r.y=t%a*s,i.drawRoundedRect(r.x+1,r.y+1,s-2,s-2,2),r.counter>1&&!r.counterDrawn){let n=game.dsk.config.effectTextStyle,l=game.settings.get("dsk","statusEffectCounterColor");n._fill=/^#[0-9A-F]+$/.test(l)?l:"#000000";let c=this.effects.addChild(new PreciseText(r.counter,n));c.x=r.x,c.y=r.y,c.isCounter=!0,r.counterDrawn=!0}t++}},Token.prototype._drawEffect=async function(t,s,a){if(!t)return;let i=await loadTexture(t,{fallback:"icons/svg/hazard.svg"}),r=new PIXI.Sprite(i);return s&&(r.tint=s),r.counter=a,this.effects.addChild(r)},TokenHUD.prototype._onToggleEffect=function(t,{overlay:s=!1}={}){t.preventDefault();let a=t.currentTarget,i=a.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find(r=>r.id===a.dataset.statusId):a.getAttribute("src");if(!!i.flags.dsk.editable){if(t.button==0)return this.object.incrementCondition(i);if(t.button==2)return this.object.decrementCondition(i)}},Token.prototype.incrementCondition=async function(t,{active:s,overlay:a=!1}={}){let i=this.actor.effects.find(r=>r.statuses.has(t.id));return!i||Number.isNumeric(getProperty(i,"flags.dsk.value"))?await this.actor.addCondition(t.id,1,!1,!1):i&&await this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),s},Token.prototype.decrementCondition=async function(t,{active:s,overlay:a=!1}={}){return this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),s};let o=Token.prototype._onClickLeft2,e=m(t=>t?["merchant","loot"].includes(getProperty(t.system,"merchant.merchantType")):!1,"isMerchant");Token.prototype._onClickLeft2=function(t){if(!(game.user.isGM||!game.settings.get("dsk","enableDPS")||!e(this.actor)||W.inDistance(this)))return ui.notifications.warn(game.i18n.localize("dsk.DSKError.notInRangeToLoot"));o.call(this,t)}}m(Us,"initTokenHook");function Vs(){Hooks.on("renderTokenHUD",(o,e,t)=>{let s=o.object.actor;s&&game.dsk.apps.LightDialog&&game.dsk.apps.LightDialog.lightHud(e,s,t),e.find('.control-icon[data-action="target"]').mousedown(a=>{a.button==2&&(game.user.updateTokenTargets([]),$(a.currentTarget).click(),a.preventDefault())}),e.find(".attribute input").off("change")})}m(Vs,"initTokenHUD");function Ys(){Roll.prototype.editRollAtIndex=function(o){let e=[];for(let t of o){let{index:s,val:a}=t,i=0;for(let r of this.terms){let n=r instanceof DiceTerm||r.class=="DiceTerm"||r instanceof Die||r.class=="Die",l=r instanceof OperatorTerm;if(n||r.faces){if(r.results[s-i]){let c=r.results[s-i].result;r.results[s-i].result=a,e.push(c)}n||(r.total=r.results.reduce((c,u)=>c+u.result,0)),i+=r.results.length}else!l&&(r.class=="OperatorTerm"||r.operator)&&(r.total=r.operator)}e.push(0)}return this._total=this._evaluateTotal(),e}}m(Ys,"initRollsFunction");var je=class extends Le(ie){static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/creature-merchant-sheet.html"}};m(je,"CreatureMerchantSheetDSK");var Be=class extends Le(ee){static get merchantTemplate(){return"systems/dsk/templates/actors/merchant/character-merchant-sheet.html"}};m(Be,"CharacterMerchantSheetDSK");function Js(){let o=m((h,y)=>g.fateAvailable(h,y),"fateAvailable"),e=m(function(h){let y=game.messages.get(h.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&h.find(".opposed-card").length||h.find(".dice-roll").length)&&(getProperty(y,"damage.value")||0)>0},"canHurt"),t=m(function(h){let y=game.messages.get(h.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&h.find(".opposed-card").length||h.find(".dice-roll").length)&&(getProperty(y,"damage.sp")||0)>0},"canHurtSP"),s=m(function(h){let y=game.messages.get(h.attr("data-message-id"));return y.speaker.actor&&y.flags.data&&(game.actors.get(y.speaker.actor).isOwner||game.user.isGM)?["ahnengabe"].includes(y.flags.data.preData.source.type)||getProperty(y.flags.data.preData,"calculatedSpellModifiers.costsMana"):!1},"canCostMana"),a=m(function(h){if(game.user.isGM&&game.settings.get("dsk","hideOpposedDamage")){let y=game.messages.get(h.attr("data-message-id"));return"hideData"in y.flags&&y.flags.hideData}return!1},"canUnhideData"),i=m(function(h){if(game.user.isGM&&game.settings.get("dsk","hideOpposedDamage")){let y=game.messages.get(h.attr("data-message-id"));return"hideData"in y.flags&&!y.flags.hideData}return!1},"canHideData"),r=m(function(h){let y=game.messages.get(h.attr("data-message-id"));if(y.speaker.actor&&y.flags.data){let b=game.actors.get(y.speaker.actor);if(b.isOwner)return b.items.find(w=>w.name==`${game.i18n.localize("dsk.LocalizedIDs.aptitude")} (${y.flags.data.preData.source.name})`)!=null&&!y.flags.data.talentedRerollUsed}return!1},"isTalented"),n=m(function(h,y=!1){let b=game.messages.get(h.attr("data-message-id"));if(b.speaker.actor&&b.flags.data){let w=game.actors.get(b.speaker.actor);if(w.isOwner&&o(w,y))return b.flags.data.postData.damageRoll!=null&&!b.flags.data.fatePointDamageRerollUsed}return!1},"canRerollDamage"),l=m(function(h,y=!1){let b=game.messages.get(h.attr("data-message-id"));if(b.speaker.actor&&b.flags.data){let w=game.actors.get(b.speaker.actor);if(w.isOwner&&o(w,y))return!b.flags.data.fatePointRerollUsed&&b.flags.data.postData.rollType!="regenerate"}return!1},"canReroll"),c=m(function(h){let y=game.messages.get(h.attr("data-message-id"));return y.speaker.actor&&y.flags.data&&game.actors.get(y.speaker.actor).isOwner&&["LeP","AeP"].some(w=>getProperty(y.flags,`data.postData.${w}`)!=null)?!y.flags.data.healApplied:!1},"canHeal"),u=m(function(h){if(game.user.isGM){let y=game.messages.get(h.attr("data-message-id"));if("hideData"in y.flags){let b=!y.flags.hideData,w=$(y.content);w.find(".hideAnchor")[b?"addClass":"removeClass"]("hideData"),w=$("<div></div>").append(w),y.update({content:w.html(),"flags.hideData":b})}}},"showHideData"),d=m(h=>{let y=game.messages.get(h.data("messageId"));return!y||!canvas.tokens?!1:y.isRoll&&y.isContentVisible&&canvas.tokens.controlled.length&&h.find(".dice-roll").length},"canApplyDefaultRolls"),p=m((h,y,b=0)=>{let w=game.messages.get(h.attr("data-message-id"));game.actors.get(w.speaker.actor).useFateOnRoll(w,y,b)},"useFate"),f=m(async(h,y)=>{let b=game.messages.get(h.attr("data-message-id")),w=b.flags.opposeData,I=w.speakerDefend.speaker,K=g.getSpeaker(I);if(!K.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));await K.applyDamage(w.damage[y]),await b.update({"flags.data.damageApplied":!0,content:b.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${game.i18n.localize("damageApplied")}"></i>`)})},"applyDamage"),k=m((h,y)=>{let w=game.messages.get(h.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map(I=>{let K=I.actor,S=y!="sp"?w.total-D.armorValue(K).armor:w.total;return K.applyDamage(Math.max(0,S))}))},"applyChatCardDamage"),T=m(async h=>{let y=game.messages.get(h.attr("data-message-id")),b=y.flags.data,w=g.getSpeaker(y.speaker);if(!w.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));let I=["ritual","spell"].includes(b.preData.source.type)||getProperty(b.preData.calculatedSpellModifiers,"costsMana")?"AeP":"KaP",K=await w.applyMana(b.preData.calculatedSpellModifiers.finalcost,I);await y.update({"flags.data.manaApplied":!0,content:y.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')})},"payMana");Hooks.on("getChatLogEntryContext",(h,y)=>{y.push({name:game.i18n.localize("dsk.CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:i,callback:b=>{u(b)}},{name:game.i18n.localize("dsk.CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:a,callback:b=>{u(b)}},{name:game.i18n.localize("dsk.regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:c,callback:async b=>{let w=await game.messages.get(b.attr("data-message-id")),I=g.getSpeaker(w.speaker);if(!I.isOwner)return ui.notifications.error(game.i18n.localize("dsk.DSKError.DamagePermission"));await w.update({"flags.data.healApplied":!0,content:w.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')}),await I.applyRegeneration(w.flags.data.postData.LeP,w.flags.data.postData.AeP,w.flags.data.postData.KaP)}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:s,callback:async b=>{T(b)}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:e,callback:b=>{f(b,"value")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:t,callback:b=>{f(b,"sp")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:d,callback:b=>{k(b,"value")}},{name:game.i18n.localize("dsk.CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:d,callback:b=>{k(b,"sp")}},{name:game.i18n.localize("dsk.CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:l,callback:b=>{p(b,"reroll")}},{name:game.i18n.localize("dsk.CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:r,callback:b=>{p(b,"isTalented")}},{name:game.i18n.localize("dsk.CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:n,callback:b=>{p(b,"rerollDamage")}})})}m(Js,"initChatContext");var fs=class extends ControlIcon{async draw(){return this.bg.clear(),await super.draw()}};m(fs,"TransparentControlIcon");var Zs=m(()=>{Note.prototype._drawControlIcon=function(){let o=this.document.getFlag("dsk","noBG"),e=Color.from(this.document.texture.tint||null),t={texture:this.document.texture.src,size:this.size,tint:e},s=o?new fs(t):new ControlIcon(t);return s.x-=this.size/2,s.y-=this.size/2,s}},"initHook");function Xs(){xs(),Os(),Ns(),Bs(),Gs(),Ws(),Ks(),Us(),Vs(),Ys(),ys(),Js(),Hooks.once("init",()=>{loadTemplates(["systems/dsk/templates/items/item-equipment.html","systems/dsk/templates/items/item-header.html","systems/dsk/templates/items/item-description.html","systems/dsk/templates/items/item-effects.html","systems/dsk/templates/items/item-stat.html","systems/dsk/templates/actors/parts/healthbar.html","systems/dsk/templates/actors/actor-talents.html","systems/dsk/templates/actors/actor-combat.html","systems/dsk/templates/actors/actor-equipment.html","systems/dsk/templates/actors/parts/gearSearch.html","systems/dsk/templates/actors/parts/purse.html","systems/dsk/templates/actors/parts/characteristics-small.html","systems/dsk/templates/actors/parts/status_effects.html","systems/dsk/templates/actors/parts/containerContent.html","systems/dsk/templates/actors/actor-notes.html","systems/dsk/templates/actors/creature/creature-combat.html","systems/dsk/templates/actors/creature/creature-main.html","systems/dsk/templates/actors/creature/creature-magic.html","systems/dsk/templates/status/advanced_functions.html","systems/dsk/templates/actors/creature/creature-loot.html","systems/dsk/templates/dialog/default-dialog.html","systems/dsk/templates/actors/character/actor-magic.html","systems/dsk/templates/actors/parts/characteristics-large.html","systems/dsk/templates/actors/npc/npc-main.html","systems/dsk/templates/actors/parts/rollhead.html","systems/dsk/templates/actors/actor-main.html","systems/dsk/templates/chat/roll/test-card.html","systems/dsk/templates/dialog/parts/targets.html","systems/dsk/templates/dialog/default-combat-dialog.html","systems/dsk/templates/actors/creature/creature-notes.html","systems/dsk/templates/dialog/enhanced-default-dialog.html","systems/dsk/templates/actors/parts/information.html","systems/dsk/templates/actors/merchant/merchant-commerce.html","systems/dsk/templates/actors/parts/normalhead.html"])}),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsk",ee,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsk",ie,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsk",re,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsk",ce,{types:["npc"]}),Actors.registerSheet("dsk",je,{types:["creature"]}),Actors.registerSheet("dsk",Be,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsk",_DSKActiveEffectConfig,{makeDefault:!0}),Journal.registerSheet("dsk",ze,{makeDefault:!0}),R.setupSheets(),_s(),js(),Zs(),W.initDoorMinDistance()}m(Xs,"initHooks");var Qs={};Hooks.once("ready",()=>{Promise.all([g.allSkillsList()]).then(o=>{let e=o[0].skills.reduce((i,r)=>({...i,[r]:r}),{}),t=o[0].rangeSkills.reduce((i,r)=>({...i,[r]:r}),{}),s=o[0].meleeSkills.reduce((i,r)=>({...i,[r]:r}),{}),a=o[0].rangeSkills.concat(o[0].meleeSkills).reduce((i,r)=>({...i,[r]:r}),{});mergeObject(Qs,{ammunition:[{label:"dsk.ammunitionType",attr:"ammunitionType",type:"select",options:v.ammunitiongroups}],equipment:[{label:"dsk.category",attr:"category",type:"select",options:v.equipmentTypes}],rangeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill",type:"select",options:t},{label:"dsk.ammunitionType",attr:"ammunitionType",type:"select",options:v.ammunitiongroups}],meleeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill",type:"select",options:s},{label:"dsk.range",attr:"rw",type:"select",options:v.meleeRanges}],poison:[{label:"dsk.resistanceModifier",attr:"resist",type:"select",options:v.magicResistanceModifiers}],trait:[],profession:[],specialability:[{label:"dsk.category",attr:"category",type:"select",options:v.specialAbilityCategories},{label:"TYPES.Item.combatskill",attr:"subcategory",type:"select",options:a,notStrict:!0}],ahnengabe:[{label:"dsk.resistanceModifier",attr:"resist",type:"select",options:v.magicResistanceModifiers},{label:"dsk.targetCategory",attr:"targetCategory",type:"text"},{label:"dsk.distribution",attr:"distribution",type:"text"}],ahnengeschenk:[],npc:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"TYPES.Item.profession",attr:"details.profession",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture",type:"text"}],character:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"TYPES.Item.profession",attr:"details.profession",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture",type:"text"}],creature:[{label:"TYPES.Item.species",attr:"details.species",type:"text"},{label:"dsk.sizeCategory",attr:"details.size",type:"select",options:v.sizeCategories}],armor:[{label:"dsk.protection",attr:"rs",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}}]})})});var gs=Qs;var Ge=class{constructor(e,t={}){let s=e.documentName||e.type;switch(e.documentName){case"Actor":case"Item":s=e.type;break}let a="";if(game.settings.get("dsk","indexDescription"))switch(s){case"creature":case"npc":case"character":a=getProperty(e,"system.description.value");break;case"JournalEntry":a=getProperty(e,"system.content");break;default:a=getProperty(e,"description.value")}this.document={name:e.name,filterType:s,data:$("<div>").html(a).text(),id:e.id||e._id,visible:e.visible?e.visible:!0,compendium:e.compendium?e.compendium.metadata.packageName:t.packageName||"",pack:e.pack||(t.packageName?t.id:void 0),img:e.img}}get uuid(){if(this.document.compendium)return`Compendium.${this.document.pack}.${this.document.id}`;switch(this.itemType){case"character":case"creature":case"npc":return`Actor.${this.id}`;case"JournalEntry":return`JournalEntry.${this.id}`;default:return`Item.${this.id}`}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}get itemType(){return this.document.filterType}async getItem(){return await fromUuid(this.uuid)}hasPermission(){return this.document.visible}async render(){(await this.getItem()).sheet.render(!0)}get compendium(){return this.document.compendium}get img(){return this.itemType=="JournalEntry"?"systems/dsk/icons/categories/DSK-Auge.webp":this.document.img}};m(Ge,"SearchDocument");var it=class extends Ge{constructor(e,t){super(e);let s=gs[t]||[];for(let a of s)this[a.attr]=a.attr.split(".").reduce((i,r)=>i[r]===void 0?{}:i[r],e.system)}};m(it,"AdvancedSearchDocument");var qe=class extends Application{constructor(e){super(e),this.advancedFiltering=!1,this.journalBuild=!1,this.journalWorldBuild=!1,this.equipmentBuild=!1,this.equipmentWorldBuild,this.zooBuild=!1,this.zooWorldBuild=!1,this.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),this.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.detailFilter={},this.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},this.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1},filterBy:{search:""}},character:{categories:{profession:!1,advantage:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1},filterBy:{search:""}},spell:{categories:{ahnengabe:!1,ahnengeschenk:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}}}async getData(e){let t=await super.getData(e);return t.categories=this.translateFilters(),t.isGM=game.user.isGM,t.items=this.items,t.advancedMode=this.advancedFiltering?"on":"",t.worldIndexed=game.settings.get("dsk","indexWorldItems")?"on":"",t.fullTextEnabled=game.settings.get("dsk","indexDescription")?"on":"",this.advancedFiltering&&(t.advancedFilter=await this.buildDetailFilter("tbd",this.subcategory)),t}translateFilters(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo),journal:this.buildFilter(this.filters.journal)}}purgeAdvancedFilters(){for(let e in this.filters)for(let t in this.filters[e].categories)this.filters[e].categories[t]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then(e=>{$(this._element).find(".advancedSearch .groupbox").html(e)})}buildFilter(e){let t=[];return Object.keys(e.categories).forEach(function(s){t.push({label:game.i18n.localize(`TYPES.Item.${s}`),selected:e.categories[s],key:s})}),t=t.sort(function(s,a){return s.label.localeCompare(a.label)}),t}static get defaultOptions(){let e=super.defaultOptions;return e.id="DSKItemLibrary",e.classes.push("dsk","itemlibrary"),e.height=800,e.width=800,e.resizable=!0,e.title=game.i18n.localize("dsk.ItemLibrary"),e.template="systems/dsk/templates/system/itemlibrary.html",e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],e}async getRandomItems(e,t){let s=[],a=this.equipmentIndex;return s.push(...await a.search(e,{field:["itemType"]})),(await Promise.all(this.shuffle(s.filter(i=>i.hasPermission)).slice(0,t+5).map(i=>i.getItem()))).filter(i=>{let r=i.getFlag("dsk","enchantments");return!r||!r.find(n=>n.talisman)}).slice(0,t)}shuffle(e){let t=e.length,s,a;for(;t!==0;)a=Math.floor(Math.random()*t),t-=1,s=e[t],e[t]=e[a],e[a]=s;return e}async findCompendiumItem(e,t,s=!0){this.equipmentBuild||await this.buildEquipmentIndex();let a={field:["name"],where:{itemType:t}},i=await this.equipmentIndex.search(e,a);return s&&(i=i.filter(r=>r.compendium!="")),await Promise.all(i.map(r=>r.getItem()))}async getCategoryItems(e,t=!1){return await this.buildEquipmentIndex(),t?(await Promise.all(this.equipmentIndex.search(e,{field:["itemType"]}).map(s=>s.getItem()))).map(s=>s.toObject()):this.equipmentIndex.search(e,{field:["itemType"]})}async executeAdvancedFilter(e,t,s,a,i,r=[]){let n=m(f=>{for(let k of s)if(k[2]?f[k[0]]!=k[1]:f[k[0]].indexOf(k[1])==-1)return!1;return!0},"selFnct"),l=m(f=>{for(let k of a)if(f[k[0]].toLowerCase().indexOf(k[1])==-1)return!1;return!0},"txtFnct"),c=m(f=>{for(let k of i)if(f[k[0]]!=k[1])return!1;return!0},"cbFnct"),u=m(f=>{for(let k of r)if(f[k[0]]<k[1]||f[k[0]]>k[2])return!1;return!0},"rangeFct"),p=t.where(f=>(e==""||f.name.toLowerCase().indexOf(e)!=-1)&&n(f)&&l(f)&&c(f)&&u(f));return p=p.filter(f=>f.hasPermission).sort((f,k)=>f.name.toLowerCase()>k.name.toLowerCase()?1:-1),p}async advancedFilterStuff(e,t){let s=$(this._element).find(".detailFilters"),a=s.attr("data-subc"),i=this.filters[e].filterBy.search.toLowerCase(),r=this.detailFilter[a],n=[],l=[],c=[];for(let d of s.find("select")){let p=$(d).val();p!=""&&n.push([$(d).attr("name"),p,d.dataset.notstrict!="true"])}for(let d of s.find('input[type="text"]:not(.manualFilter)')){let p=$(d).val();p!=""&&l.push([$(d).attr("name"),p.toLowerCase()])}for(let d of s.find('input[type="checkbox"]:checked:not(.manualFilter)')){let p=$(d).val();p!=""&&c.push([$(d).attr("name"),p.toLowerCase()])}let u=await this.executeAdvancedFilter(i,r,n,l,c);return this.setBGImage(u,e),u}async filterStuff(e,t,s){let a=this.filters[e].filterBy.search,i={field:["name","data"]},r=[],n=!1;for(let l in this.filters[e].categories){if(this.filters[e].categories[l]){let c,u=null;a==""?c=t.search(l,{field:["itemType"],sort:"name",where:{itemType:l}}):c=t.search(a,{...i,sort:"name",where:{itemType:l}});let d=Number(s)||0;c=c.slice(d,Math.min(d+60,c.length)),c.length==60&&(u=`${d+60}`),this.pages[e].next=u,r.push(...c)}n=this.filters[e].categories[l]||n}return n||(r=t.search(a,{...i,limit:60,page:s||!0,sort:"name"}),this.pages[e].next=r.next),r=r.result?r.result:r,r=r.filter(l=>l.hasPermission),this.setBGImage(r,e),r}setBGImage(e,t){$(this._element).find(`.${t} .libcontainer`)[`${e.length>0?"remove":"add"}Class`]("libraryImg")}renderResult(e,t,{index:s,itemType:a},i){let r=e.find(".searchResult .item-list");renderTemplate("systems/dsk/templates/system/libraryItem.html",{items:t}).then(n=>{i||r.empty(),n=$(n),n.each(function(){let l=$(this);l.attr("draggable",!0).on("dragstart",c=>{let u=s.find($(l).attr("data-item-id"));c.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:a,uuid:u.uuid}))})}),r.append(n)})}async filterItems(e,t,s){let a=this.selectIndex(t);if(this.advancedFiltering&&t!="journal"){let i=await this.advancedFilterStuff(t,s);return this.renderResult(e,i,a,s),i}else{let i=await this.filterStuff(t,a.index,s);return this.renderResult(e,i,a,s),i}}selectIndex(e){let t="Item",s=this.equipmentIndex;switch(e){case"zoo":t="Actor",s=this.zooIndex;break;case"journal":t="JournalEntry",s=this.journalIndex;break}return{index:s,itemType:t}}async _render(e=!1,t={}){await super._render(e,t),this.buildEquipmentIndex()}async buildEquipmentIndex(){await this._createIndex("equipment","Item",game.items)}async _createIndex(e,t,s){if(this[`${e}Build`])return;SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:""}),pct:0});let a=$(this._element).find(`*[data-tab="${e}"]`);this.showLoading(a,e);let i=game.packs.filter(p=>p.documentName==t&&(game.user.isGM||!p.private)),r=100/(i.length+1),n=r,l=["name","system.type","system.description.value","img"],c;t=="Actor"?c=m(p=>p.getIndex({actorFields:l}),"func"):t=="JournalEntry"?c=m(p=>p.getDocuments(),"func"):c=m(p=>p.getDocuments({type__in:game.system.documentTypes.Item}),"func");let u=this.indexWorldItems(s,e);SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:"world items"}),pct:Math.round(r)});let d=i.map(async p=>{let f=await c(p);n+=r,SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:`${p.metadata.label} (${p.metadata.id})`}),pct:Math.round(n)}),u.push(...f.map(k=>new Ge(k,p.metadata)))});return Promise.all(d).then(p=>{this[`${e}Index`].add(u),this[`${e}Build`]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("dsk.Library.loading",{item:""}),pct:100}),this.hideLoading(a,e)})}subcategoryFields(e){let t=["name","itemType"],s=gs[e]||[];for(let a of s)t.push(a.attr);return t}indexWorldItems(e,t){let s=[];return game.settings.get("dsk","indexWorldItems")&&(s.push(...e.filter(a=>a.visible).map(a=>new Ge(a))),this[`${t}WorldBuild`]=!0),s}async createDetailIndex(e,t){if(!this.detailFilter[t]){let s=this.subcategoryFields(t),a=$(this._element).find(`*[data-tab="${e}"]`);a.find(".searchResult ul").html(""),this.showLoading(a,e),this.detailFilter[t]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:s}});let{index:i,itemType:r}=this.selectIndex(e),l=(r=="Item"?game.items:game.actors).filter(f=>f.visible&&f.type==t).map(f=>new it(f,t)),c=i.search(t,{field:["itemType"]}),u={};for(let f of c)!f.document.pack||(u[f.document.pack]||(u[f.document.pack]=[]),u[f.document.pack].push(f.document.id));let d=[];for(let f of Object.entries(u))d.push(game.packs.get(f[0]).getDocuments({_id__in:f[1],type:t}));let p=await Promise.all(d);for(let f of p)l.push(...f.map(k=>new it(k,t)));this.detailFilter[t].add(l),this.hideLoading(a,e)}}async buildDetailFilter(e,t){let s=gs[t]||[];if(s){let a=this.createDetailIndex(e,t),i=await renderTemplate("systems/dsk/templates/system/detailFilter.html",{fields:s,subcategory:t});return await a,i}else return`<p>${game.i18n.localize("dsk.Library.selectAdvanced")}</p>`}checkWorldStuffIndex(){game.settings.get("dsk","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}activateListeners(e){super.activateListeners(e),e.on("click",".toggleAdvancedMode",()=>{this.advancedFiltering=!this.advancedFiltering,this.advancedFiltering?($(this._element).find(".toggleAdvancedMode").addClass("on"),$(this._element).find(".advancedSearch").fadeIn(),this.purgeAdvancedFilters()):($(this._element).find(".toggleAdvancedMode").removeClass("on"),$(this._element).find(".advancedSearch").fadeOut())}),e.on("change",".detailFilters input, .detailFilters select",()=>{let s=$(this._element).find(".tab.active"),a=s.attr("data-tab");this.filterItems(s,a)}),e.on("click",".filter",async s=>{let a=$(s.currentTarget).closest(".tab"),i=a.attr("data-tab"),r=$(s.currentTarget).attr("data-category"),n=$(s.currentTarget).is(":checked");this.advancedFiltering&&n&&(this.purgeAdvancedFilters(),this.subcategory=r,$(s.currentTarget).prop("checked",n),$(this._element).find(".advancedSearch .groupbox").html(await this.buildDetailFilter(i,r))),this.filters[i].categories[r]=n,this.filterItems(a,i)}),e.on("click",".item-name",s=>{this.getItemFromHTML(s).render()}),e.on("mousedown",".item-name",s=>{s.button==2&&g.showArtwork(this.getItemFromHTML(s))}),e.on("keyup",".filterBy-search",s=>{let a=$(s.currentTarget).closest(".tab"),i=a.attr("data-tab");this.filters[i].filterBy.search=$(s.currentTarget).val(),this.filterItems(a,i)}),e.find('*[data-tab="journal"]').click(s=>{this._createIndex("journal","JournalEntry",game.journal)}),e.find('*[data-tab="zoo"]').click(s=>{this._createIndex("zoo","Actor",game.actors)}),e.find(".showDetails").click(s=>{let a=$(s.currentTarget).attr("data-btn");$(s.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),e.find(`.${a} .detailBox`).toggleClass("dskhidden")}),e.find(".toggleWorldIndex").click(s=>{game.settings.set("dsk","indexWorldItems",!game.settings.get("dsk","indexWorldItems")),this.checkWorldStuffIndex(),$(s.currentTarget).toggleClass("on")}),e.find(".fulltextsearch").click(s=>{game.settings.set("dsk","indexDescription",!game.settings.get("dsk","indexDescription")),$(s.currentTarget).toggleClass("on")});let t=this;$(this._element).find(".window-content").on("scroll.infinit",debounce(function(s){if(t.advancedFiltering)return;let a=$(s.target),i=a.scrollTop()+a.innerHeight()>=a[0].scrollHeight-100,r=e.find(".tabs .item.active").attr("data-tab");if(i&&t.pages[r].next){let n=e.find(".tab.active");t.filterItems.call(t,n,r,t.pages[r].next)}},100))}getItemFromHTML(e){let t=$(e.currentTarget).parents(".browser-item").attr("data-item-id");switch($(e.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(t);case"journal":return this.journalIndex.find(t);default:return this.equipmentIndex.find(t)}}showLoading(e,t){this.setBGImage([1],t),$(`<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>${game.i18n.localize("dsk.Library.buildingIndex")}</div>`).appendTo(e.find(".searchResult"))}hideLoading(e,t){this.setBGImage([],t),e.find(".loader").remove()}};m(qe,"DSKItemLibrary");var hs=class extends ActiveEffect{apply(e,t){if(hs.itemChangeRegex.test(t.key)){let s=this._getModifiedItems(e,t);for(let a of s.items){let i=foundry.utils.flattenObject(a.overrides||{});i[s.key]=Number.isNumeric(a.value)?Number(s.value):s.value;let r={...t,key:s.key,value:s.value};super.apply(a,r),a.overrides=foundry.utils.expandObject(i)}}else return super.apply(e,t)}_getModifiedItems(e,t){let s=t.key.split("."),a=s.shift();a=a.replace("@","").toLowerCase();let i=s.shift(),r=s.join("."),n=t.value;return{items:e?.items?.filter(c=>c.type==a&&(c.name==i||c.id==i))||[],key:r,value:n}}async _preUpdate(e,t,s){super._preUpdate(e,t,s),this._clearModifiedItems()}_clearModifiedItems(){if(this.parent instanceof CONFIG.Actor.documentClass){for(let e of this.changes)if(hs.itemChangeRegex.test(e.key)){let t=this._getModifiedItems(this.parent,e);for(let s of t.items){let a=foundry.utils.flattenObject(s.overrides||{}),i=t.key;delete a[i];let r=getProperty(s._source,i);setProperty(s,i,r),s.overrides=foundry.utils.expandObject(a),s.sheet?.rendered&&s.sheet.render(!0)}}}}async _preDelete(e,t){super._preDelete(e,t),this._clearModifiedItems()}},ke=hs;m(ke,"DSKActiveEffect"),z(ke,"itemChangeRegex",/^@/);var ma=m((o,e)=>{let t=getProperty(o,e.key)||null;t==null&&/^system\.(vulnerabilities|resistances)/.test(e.key)&&(t=[],setProperty(o,e.key,t));let s=getType(t),a=null;switch(s){case"Array":let i=[],r=e.effect.name;for(let n of`${e.value}`.split(/[;,]+/)){let l=n.split(" "),c=l.pop(),u=l.join(" ");i.push({source:r,value:c,target:u})}a=t.concat(i)}return a!==null&&setProperty(o,e.key,a),a},"applyCustomEffect");Hooks.on("applyActiveEffect",(o,e)=>ma(o,e));var We=class extends Hotbar{async collapse(){return this._collapsed?!0:($(this.element).addClass("collapsedHotbar"),super.collapse())}async expand(){return this._collapsed?($(this.element).removeClass("collapsedHotbar"),super.expand()):!0}};m(We,"DSKHotbar");var Ke=class extends Dialog{constructor(e,t,s,a=""){let i={title:e,content:t,buttons:{initialize:{label:game.i18n.localize("dsk.initialize"),callback:async()=>{this.lock||await this.initialize()}},cancel:{label:game.i18n.localize("dsk.cancel"),callback:async()=>{this.lock||await this.dontInitialize()}}}};super(i),this.module=s,this.lang=a,this.folders={},this.journals={},this.scenes={},this.actors={},this.lock=!1}async initialize(){this.lock=!0;let e=$(this._element).find(".initialize");e.prepend('<i class="fas fa-spinner fa-spin"></i>');let t={};try{game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0)}catch{}try{await fetch(`modules/${this.module}/adventure${this.lang}.json`).then(async s=>s.json()).then(async s=>{t=s})}catch{try{await fetch(`modules/${this.module}/adventure.json`).then(async s=>s.json()).then(async s=>{t=s})}catch{console.warn(`Could not find book data for ${this.module} import.`)}}await fetch(`modules/${this.module}/initialization${this.lang}.json`).then(async s=>s.json()).then(async s=>{let a=s.folders;if(a){let i=await this.getFolderForType("JournalEntry"),r=s.folders[0].name;i&&(this.folders[i.data.name]=i,s.folders.shift());let n=await Folder.create(a);Array.isArray(n)||(n=[n]);for(let c of n)this.folders[c.data.name]=c;let l=[];for(let c in this.folders){let u=this.folders[c].getFlag("dsk","parent"),d=u==r?game.i18n.localize(`${this.module}.name`):u;d&&l.push({_id:this.folders[c].id,parent:this.folders[d].id})}await Folder.updateDocuments(l)}if(s.items){let i=await this.getFolderForType("Item"),r=[],n=[];for(let l of s.items){l.folder=i.id;let c=game.items.find(u=>u.name==l.name&&u.folder?.id==i.id);c?(l._id=c.id,n.push(l)):r.push(l)}await C.create(r),await C.updateDocuments(n)}if(s.playlists){let i=await this.getFolderForType("Playlist"),r=[],n=[],c=(await game.packs.get(s.playlists).getDocuments()).map(u=>u.toObject());for(let u of c){u.folder=i.id;let d=game.playlists.find(p=>p.name==u.name&&p.folder?.id==i.id);d?(u._id=d._id,n.push(u)):r.push(u)}await Playlist.create(r,{keepId:!0}),await Playlist.updateDocuments(n)}if(s.scenes){let i=await this.getFolderForType("Scene"),n=(await game.packs.get(s.scenes).getDocuments()).map(h=>h.toObject()),c=(await game.packs.get(s.journal).getDocuments()).map(h=>h.toObject()),u=await this.getFolderForType("JournalEntry"),d=[],p=[],f=new Map,k=!1;for(let h of n){let y=k,b=game.scenes.find(w=>w.name==h.name&&w.folder?.id==i.id);if(!k&&b&&([y,k]=await new Promise((w,I)=>{new Dialog({title:game.i18n.localize("dsk.Book.sceneReset"),content:game.i18n.format("dsk.Book.sceneResetDescription",{name:h.name}),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.yes"),callback:()=>{w([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("dsk.LocalizedIDs.all"),callback:()=>{w([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("dsk.cancel"),callback:()=>{w([!1,!1])}}},close:()=>{w([!1,!1])}}).render(!0)})),b&&!y){this.scenes[b.name]=b;continue}h.folder=i.id;for(let w of h.notes)try{let I=c.find(K=>K.flags.dsk.initId==w.entryId);if(!f.has(I._id)){let K=getProperty(I,"flags.dsk.parent"),S=u;this.folders[K]?S=this.folders[K]:K&&(S=await this.getFolderForType("JournalEntry",u.id,K,0,getProperty(I,"flags.dsk.foldercolor")||"")),I.folder=S.id;let H=game.journal.find(Ye=>Ye.name==I.name&&Ye.folder?.id==S.id&&Ye.flags.dsk.initId==w.entryId);if(H)await H.update(I),f.set(I._id,H.id);else{let Ye=await JournalEntry.create(I);f.set(I._id,Ye.id)}}w.entryId=f.get(I._id)}catch(I){console.warn(`Could not initialize Scene Notes for scene :${h.name}`+I)}b?(h._id=b.id,p.push(h)):d.push(h)}let T=await Scene.create(d,{dskInit:!0});for(let h of T){this.scenes[h.name]=h;let y=await h.createThumbnail();await h.update({thumb:y.thumb},{diff:!1})}for(let h of p)await game.scenes.get(h._id).update(h),this.scenes[h.name]=game.scenes.get(h._id);if(s.initialScene){let h=this.scenes[s.initialScene];await game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0),await h.activate(),await h.update({navigation:!0})}}if(s.actors){let i=await this.getFolderForType("Actor"),n=(await game.packs.get(s.actors).getDocuments()).map(f=>f.toObject()),l=[],c=[],u=new Map,d=0;if(getProperty(t,"chapters")){for(let f of t.chapters)for(let k of f.content)if(k.actors){let T=!1;for(let h of k.actors)u.has(h)||(u.set(h,k.name),T=!0);T&&(await this.getFolderForType("Actor",i.id,k.name,d),d+=1)}}for(let f of n){let k=u.has(f.name)?await this.getFolderForType("Actor",i.id,u.get(f.name)):i;f.folder=k.id,f._id&&delete f._id;let T=game.actors.find(h=>h.name==f.name&&[i.id,k.id].includes(h.folder?.id));T?(f._id=T.id,await T.deleteEmbeddedDocuments("Item",T.items.map(h=>h.id)),c.push(f)):l.push(f)}let p=await Actor.create(l);await Actor.updateDocuments(c);for(let f of p)this.actors[f.name]=f}}),this.lock=!1,e.find("i").remove(),ui.notifications.notify(game.i18n.localize("dsk.initComplete")),await this.close()}async dontInitialize(){game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0),ui.notifications.notify(game.i18n.localize("dsk.initSkipped")),await this.close()}submit(e){try{e.callback&&e.callback(this.options.jQuery?this.element:this.element[0])}catch(t){throw ui.notifications.error(t),new Error(t)}}async getFolderForType(e,t=null,s=null,a=0,i=""){return s||(s=game.i18n.localize(`${this.module}.name`)),g.getFolderForType(e,t,s,a,i)}};m(Ke,"DSKInitializer");var me=class{constructor(){this.tokens={},this.actors={}}static get wantedKeys(){let e=[];return game.settings.get("dsk","enableDPS")||e.push("distance"),e}getPath(e,t,s){let a=s||"",i=t._id||t.type;return e.token?`tokens.${e.token||e.actor}.${i}${a}`:`actors.${e.actor}.${i}${a}`}remember(e,t,s,a){let i=this.formDataSerialize(a);Object.entries(i).length>0&&setProperty(this,this.getPath(e,t,s),i)}recall(e,t,s){return getProperty(this,this.getPath(e,t,s))}formDataSerialize(e){let t=e.find("form"),s={};return t.find("select").each(function(){let a=$(this).attr("name");me.wantedKeys.includes(a)&&(s[a]=$(this).val())}),t.find('input[type="checkbox"]').each(function(){let a=$(this).attr("name");me.wantedKeys.includes(a)&&(s[a]=this.checked)}),t.find(".specAbs.active").each(function(){s.specAbs||(s.specAbs=[]),s.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})}),e.find('[name="situationalModifiers"] option').each(function(){s.situationalModifiers||(s.situationalModifiers=[]),s.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})}),s}};m(me,"RollMemory");var Ue=class{static requestRoll(e,t=0){Z.showRQMessage(e,t)}static rollCh(e,t={}){F.check3D20(void 0,e,t)}static itemMacroById(e,t,s,a){let i=game.actors.get(e),r=i?i.items.find(n=>n.name===t&&n.type==s):null;this.runItem(i,r,t,a)}static itemMacro(e,t,s){let a=ChatMessage.getSpeaker(),i;a.token&&(i=game.actors.tokens[a.token]),i||(i=game.actors.get(a.actor));let r=i?i.items.find(n=>n.name===e&&n.type==t):null;this.runItem(i,r,e,s,a.token)}static runItem(e,t,s,a,i){if(!e)return ui.notifications.error(game.i18n.format("dsk.DSKError.MacroItemMissing",{item:s}));switch(t.type){case"combatskill":case"trait":case"meleeweapon":return e.setupWeapon(t,a.mod,a,i).then(r=>{e.basicTest(r)});case"rangeweapon":return e.setupWeapon(t,"attack",a,i).then(r=>{e.basicTest(r)});case"skill":return e.setupSkill(t,a,i).then(r=>{e.basicTest(r)});case"ahnengabe":return e.setupSpell(t,a,i).then(r=>{e.basicTest(r)})}}};m(Ue,"MacroDSK");var Ve=class extends Pause{static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsk/templates/system/pause.html",e}};m(Ve,"DSKPause");Hooks.once("init",()=>{console.log("Initializing DSK system"),CONFIG.statusEffects=v.statusEffects,game.dsk={apps:{DSKUtility:g,DSKInitializer:Ke,DSKChatListeners:F,SpecialabilityRulesDSK:x,AdvantageRulesDSK:E,Migrakel:pe,DPS:W,DiceDSK:_DiceDSK,DSKStatusEffects:O},documents:{ActorDSK:D,ItemDSK:C},sheets:{ActorSheetDSK:ae,ItemSheetDSK:R,ActorSheetCreature:ie,ActorSheetCharacter:ee,ActorSheetNPC:re},config:v,macro:Ue,memory:new me,itemLibrary:new qe},CONFIG.Actor.documentClass=D,CONFIG.Item.documentClass=C,CONFIG.ActiveEffect.documentClass=ke,CONFIG.ui.combat=te,CONFIG.ui.hotbar=We,CONFIG.ui.pause=Ve,CONFIG.Combat.documentClass=tt,CONFIG.Combatant.documentClass=st,CONFIG.ActiveEffect.documentClass=ke,CONFIG.ChatMessage.template="systems/dsk/templates/chat/chat-message.html",CONFIG.ActiveEffect.legacyTransferral=!1});Xs();
